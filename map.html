<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte ‚Äî Postes & Appareils</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root {
      --accent: #4f46e5;
      --bg: #0b0c0e;
      --ink: #f9fafb;
      --glass: rgba(17, 19, 23, 0.65);
      --border: rgba(255, 255, 255, 0.12);
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, sans-serif;
      background: var(--bg);
      color: var(--ink);
    }
    #map { width: 100%; height: 100%; }

    /* Barre style iOS */
    .topbar {
      position: fixed;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--glass);
      backdrop-filter: blur(10px);
      padding: .4rem .6rem;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
      width: calc(100% - 24px);
      max-width: 500px;
      z-index: 1000;
    }
    .left, .right {
      display: flex;
      align-items: center;
      gap: .4rem;
    }
    .topbar button {
      border: none;
      font-size: 1.1rem;
      cursor: pointer;
      border-radius: 9999px;
      padding: .4rem .8rem;
      transition: all .2s ease;
    }
    .topbar button.active {
      background: var(--accent);
      color: #fff;
    }
    .topbar button:hover {
      background: rgba(255,255,255,0.15);
    }

    /* Ic√¥nes rondes */
    .icon-circle {
      width: 26px; height: 26px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 15px; font-weight: bold;
    }
    .poste { background: #e11d48; }    /* rouge */
    .appareil { background: #facc15; } /* jaune */
    .acces { background: #3b82f6; }    /* bleu */
  </style>
</head>
<body>

  <!-- Barre sup√©rieure -->
  <div class="topbar">
    <div class="left">
      <button onclick="window.location.href='index.html'">üè†</button>
    </div>
    <div class="right">
      <button id="btn-postes" class="active">üìç</button>
      <button id="btn-appareils" class="active">‚ö°</button>
      <button id="btn-acces" class="active">üöô</button>
    </div>
  </div>

  <!-- Carte -->
  <div id="map"></div>

  <script>
    // Initialisation carte
    const map = L.map('map').setView([46.8, 2.5], 6);

    // Fond IGN Orthophotos (cl√© publique "ortho")
    L.tileLayer(
      "https://data.geopf.fr/wmts/orthophotos/1.0.0/ORTHOIMAGERY.ORTHOPHOTOS/default/PM/{z}/{x}/{y}.jpeg",
      {
        attribution: "¬© IGN",
        tileSize: 256,
        minZoom: 0,
        maxZoom: 19
      }
    ).addTo(map);

    // Groupes
    const postesLayer = L.layerGroup().addTo(map);
    const appareilsLayer = L.layerGroup().addTo(map);
    const accesLayer = L.layerGroup().addTo(map);

    // Ic√¥nes
    const iconPoste = L.divIcon({className:"icon-circle poste", html:"üìç"});
    const iconAppareil = L.divIcon({className:"icon-circle appareil", html:"‚ö°"});
    const iconAcces = L.divIcon({className:"icon-circle acces", html:"üöô"});

    // Charger postes.json (acc√®s + gu√©rite)
    fetch("postes.json")
      .then(r => r.json())
      .then(data => {
        data.forEach(item => {
          // Acc√®s
          if(item.latitude && item.longitude) {
            const popupAcces = `<b>${item.nom || "Sans nom"}</b><br>Acc√®s<br>Ligne: ${item.lignes || ""}<br>PK: ${item.pk || ""}`;
            L.marker([item.latitude, item.longitude], {icon: iconAcces})
              .bindPopup(popupAcces)
              .addTo(accesLayer);
          }
          // Gu√©rite / Poste
          if(item.poste_latitude && item.poste_longitude) {
            const popupPoste = `<b>${item.nom || "Sans nom"}</b><br>Poste / Gu√©rite<br>Ligne: ${item.lignes || ""}<br>PK: ${item.pk || ""}`;
            L.marker([item.poste_latitude, item.poste_longitude], {icon: iconPoste})
              .bindPopup(popupPoste)
              .addTo(postesLayer);
          }
        });
      });

    // Charger appareils.json
    fetch("appareils.json")
      .then(r => r.json())
      .then(data => {
        data.forEach(item => {
          if(item.latitude && item.longitude) {
            const popup = `<b>${item.nom || "Sans nom"}</b><br>Appareil (${item.type || ""})<br>Ligne: ${item.lignes || ""}<br>PK: ${item.pk || ""}`;
            L.marker([item.latitude, item.longitude], {icon: iconAppareil})
              .bindPopup(popup)
              .addTo(appareilsLayer);
          }
        });
      });

    // Filtres
    const btnPostes = document.getElementById("btn-postes");
    const btnAppareils = document.getElementById("btn-appareils");
    const btnAcces = document.getElementById("btn-acces");

    btnPostes.onclick = () => {
      if(map.hasLayer(postesLayer)) { map.removeLayer(postesLayer); btnPostes.classList.remove("active"); }
      else { map.addLayer(postesLayer); btnPostes.classList.add("active"); }
    };
    btnAppareils.onclick = () => {
      if(map.hasLayer(appareilsLayer)) { map.removeLayer(appareilsLayer); btnAppareils.classList.remove("active"); }
      else { map.addLayer(appareilsLayer); btnAppareils.classList.add("active"); }
    };
    btnAcces.onclick = () => {
      if(map.hasLayer(accesLayer)) { map.removeLayer(accesLayer); btnAcces.classList.remove("active"); }
      else { map.addLayer(accesLayer); btnAcces.classList.add("active"); }
    };
  </script>
</body>
</html>