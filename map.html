<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Carte ‚Äî Postes & Appareils</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>

    /* Boutons ronds √† gauche (ON = blanc, OFF = noir translucide) */
.btn-toggle{
  background: rgba(0,0,0,.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;          /* taille identique */
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;                    /* emoji inchang√© */
  color: #fff;
  cursor: pointer;
  margin: 10px 5px;                   /* ‚Üë plus d‚Äôespace vertical */
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.btn-toggle.active {
  background: #fff;
  color: #111;
}
    
    :root { --accent:#4f46e5; --bg:#0b0c0e; --ink:#f9fafb; --glass:rgba(17,19,23,.65); --border:rgba(255,255,255,.12); }
    html, body { height:100%; margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif; background:var(--bg); color:var(--ink); }
    #map { width:100%; height:100%; }

    .icon-circle { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:15px; font-weight:bold; }
    .poste { background:#e11d48; } .appareil { background:#facc15; } .acces { background:#3b82f6; }
   .leaflet-control-custom{
  background: rgba(0,0,0,0.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;             /* + grand = touch friendly */
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  color: #fff;
  cursor: pointer;
  margin: 5px;
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;                         /* √©vite l‚Äôemoji coup√© */
  -webkit-tap-highlight-color: transparent;
}
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
const map = L.map('map', { zoomControl: false }).setView([46.8, 2.5], 6);

    // --- FONDS DE CARTE ------------------------------------------------------

    // PLAN IGN (WMTS GetTile)
    const planIGN = L.tileLayer(
      "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
      + "&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png"
      + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
      {
        attribution: "¬© IGN ‚Äì G√©oplateforme",
        maxZoom: 19,
        tileSize: 256,
        crossOrigin: 'anonymous'
      }
    );

    // ORTHO IGN (vue a√©rienne)
    const orthoIGN = L.tileLayer(
      "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
      + "&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&STYLE=normal&FORMAT=image/jpeg"
      + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
      {
        attribution: "¬© IGN ‚Äì G√©oplateforme",
        maxZoom: 19,
        tileSize: 256,
        crossOrigin: 'anonymous'
      }
    );

    // OpenStreetMap (secours)
    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { attribution: "¬© OpenStreetMap contributors", maxZoom: 19 }
    );

    // Afficher PLAN IGN par d√©faut
    planIGN.addTo(map);

    // S√©lecteur de fonds
    L.control.layers(
      { "Plan IGN": planIGN, "Ortho IGN": orthoIGN, "OpenStreetMap": osm },
      {}
    ).addTo(map);

    // Zoom sous le s√©lecteur de fonds (m√™me coin)
L.control.zoom({ position: 'topright' }).addTo(map);

    // Logs d'erreurs de tuiles (debug)
    planIGN.on("tileerror", e => console.warn("IGN PLAN tile error", e));
    orthoIGN.on("tileerror", e => console.warn("IGN ORTHO tile error", e));

    // --- COUCHES M√âTIER ------------------------------------------------------

    const postesLayer = L.layerGroup().addTo(map);
    const appareilsLayer = L.layerGroup().addTo(map);
    const accesLayer = L.layerGroup().addTo(map);
    const allMarkers = [];

    const iconPoste   = L.divIcon({className:"icon-circle poste",   html:"üìç"});
    const iconAppareil= L.divIcon({className:"icon-circle appareil",html:"‚ö°"});
    const iconAcces   = L.divIcon({className:"icon-circle acces",   html:"üöô"});

    // Postes (acc√®s + gu√©rite)
    fetch("postes.json")
      .then(r => r.json())
      .then(data => {
        data.forEach(item => {
          if (item.latitude && item.longitude) {
            const lat = item.latitude, lon = item.longitude;
            let content = `<b>${item.nom || "Sans nom"}</b><br>Acc√®s`;
            if (item.lignes) content += `<br>Ligne: ${item.lignes}`;
            if (item.pk)     content += `<br>PK: ${item.pk}`;
            content += `<br><a href="https://www.google.com/maps?q=&layer=c&cbll=${lat},${lon}" target="_blank">üì∑ Street View</a>`;
            if (item.nom)    content += `<br><a href="index.html?nom=${encodeURIComponent(item.nom)}" target="_blank">‚Ü©Ô∏è Retour fiche</a>`;
            const m = L.marker([lat, lon], {icon: iconAcces}).bindPopup(content).addTo(accesLayer);
            allMarkers.push(m);
          }
          if (item.poste_latitude && item.poste_longitude) {
            let content = `<b>${item.nom || "Sans nom"}</b><br>`;
            if (item.type)      content += `Type: ${item.type}<br>`;
            if (item.SAT)       content += `SAT: ${item.SAT}<br>`;
            if (item.lignes)    content += `Ligne: ${item.lignes}<br>`;
            if (item.pk)        content += `PK: ${item.pk}<br>`;
            if (item.rss)       content += `RSS: ${item.rss}<br>`;
            if (item.contact)   content += `Contact: ${item.contact}<br>`;
            if (item.portail)   content += `Portail: ${item.portail}<br>`;
            if (item.description) content += `<i>${item.description}</i><br>`;
            if (item.nom)       content += `<br><a href="index.html?nom=${encodeURIComponent(item.nom)}" target="_blank">‚Ü©Ô∏è Retour fiche</a>`;
            const m = L.marker([item.poste_latitude, item.poste_longitude], {icon: iconPoste}).bindPopup(content).addTo(postesLayer);
            allMarkers.push(m);
          }
        });
      });

    // Appareils
    fetch("appareils.json")
      .then(r => r.json())
      .then(data => {
        data.forEach(item => {
          if (item.latitude && item.longitude) {
            let content = `<b>${item.nom || "Sans nom"}</b><br>`;
            if (item.type)      content += `Type: ${item.type}<br>`;
            if (item.SAT)       content += `SAT: ${item.SAT}<br>`;
            if (item.appareil)  content += `Appareil: ${item.appareil}<br>`;
            if (item.lignes)    content += `Ligne: ${item.lignes}<br>`;
            if (item.pk)        content += `PK: ${item.pk}<br>`;
            if (item.description) content += `<i>${item.description}</i><br>`;
            if (item.nom)       content += `<br><a href="index.html?nom=${encodeURIComponent(item.nom)}" target="_blank">‚Ü©Ô∏è Retour fiche</a>`;
            const m = L.marker([item.latitude, item.longitude], {icon: iconAppareil}).bindPopup(content).addTo(appareilsLayer);
            allMarkers.push(m);
          }
        });
      });

 // Recentrer
const recenterControl = L.control({position: "topleft"});
recenterControl.onAdd = function() {
  const div = L.DomUtil.create("div", "leaflet-control-custom");
  div.innerHTML = "üéØ";
  div.onclick = () => {
    if (allMarkers.length > 0) {
      const group = L.featureGroup(allMarkers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  };

  // Emp√™che la propagation des clics/scroll sur ce bouton
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.disableScrollPropagation(div);

  return div;
};
recenterControl.addTo(map);
    
 // Boutons de visibilit√© des couches √† gauche
const toggleControls = L.control({ position: "topleft" });
toggleControls.onAdd = function() {
  const div = L.DomUtil.create("div");

  function makeBtn(emoji, layer, initiallyOn = true) {
    const b = L.DomUtil.create("div", "btn-toggle" + (initiallyOn ? " active" : ""), div);
    b.innerHTML = emoji;
    b.onclick = () => {
      if (map.hasLayer(layer)) {
        map.removeLayer(layer);
        b.classList.remove("active");
      } else {
        map.addLayer(layer);
        b.classList.add("active");
      }
    };
    return b;
  }

  // boutons (l'ordre = vertical, de haut en bas)
  makeBtn("üìç", postesLayer, true);
  makeBtn("‚ö°", appareilsLayer, true);
  makeBtn("üöô", accesLayer, true);

  // Emp√™che la propagation
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.disableScrollPropagation(div);

  return div;
};
toggleControls.addTo(map);
    
   // Localisation (avec toggle ON/OFF)
let userMarker;
let geoWatchId = null; // √©vite empilement

const locateControl = L.control({position: "topleft"});
locateControl.onAdd = function() {
  const div = L.DomUtil.create("div", "leaflet-control-custom");
  div.innerHTML = "üìç";
  div.onclick = () => {
    if (!navigator.geolocation) return alert("G√©olocalisation non support√©e.");

    if (geoWatchId !== null) {
      // si d√©j√† en cours ‚Üí stop
      navigator.geolocation.clearWatch(geoWatchId);
      geoWatchId = null;
      return;
    }

    geoWatchId = navigator.geolocation.watchPosition(pos => {
      const lat = pos.coords.latitude, lng = pos.coords.longitude;
      if (userMarker) userMarker.setLatLng([lat, lng]);
      else userMarker = L.circleMarker([lat, lng], {
        radius: 8, color: "#3b82f6", fillColor: "#3b82f6", fillOpacity: 0.6
      }).addTo(map);
      map.setView([lat, lng], 15);
    });
  };

  // bloque propagation
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.disableScrollPropagation(div);

  return div;
};
locateControl.addTo(map);
    
  </script>
</body>
</html>
