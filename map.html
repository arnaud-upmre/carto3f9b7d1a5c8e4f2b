<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Nono Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <style>

    .leaflet-popup-content a.cluster-link {
  display: block;
  padding: 8px 12px;
  border-radius: 8px;
  background: #f3f4f6;
  color: #007aff;
  text-decoration: none;
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif;
  font-size: 14px;
  margin: 2px 0;
  transition: background 0.2s;
}

.leaflet-popup-content a.cluster-link:hover,
.leaflet-popup-content a.cluster-link:active {
  background: #e5e7eb; /* gris clair au survol */
}

#streetview-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);     
  -webkit-backdrop-filter: blur(6px);
  display: none;
  z-index: 9999;

  display: flex;             
  align-items: center;
  justify-content: center;
}

#streetview-box {
  width: 90%;
  max-width: 900px;
  height: 70%;
  background: rgba(20,20,20,0.95);
  border-radius: 16px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  overflow: hidden;
  position: relative;
}

#streetview-box iframe {
  width: 100%;
  height: 100%;
  border: none;
}

#streetview-close {
  position: absolute;
  top: 12px; right: 12px;
  font-size: 24px;
  background: rgba(0,0,0,0.6);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px; height: 40px;
  cursor: pointer;
  z-index: 2;
}

.btn-return {
  position: relative;
  animation: pulseHalo 1.8s infinite;
}

@keyframes pulseHalo {
  0%   { box-shadow: 0 0 0px rgba(255,255,255,0.6); }
  50%  { box-shadow: 0 0 15px rgba(255,255,255,0.9), 0 0 30px rgba(255,255,255,0.4); }
  100% { box-shadow: 0 0 0px rgba(255,255,255,0.6); }
}
  
    .icon-halo {
  width: 48px;  
  height: 48px;
  filter: drop-shadow(0 0 2px white) drop-shadow(0 0 4px white);
}
    .icon-halo-appareil {
  width: 24px;  
  height: 24px;
  filter: drop-shadow(0 0 4px white) drop-shadow(0 0 8px white);
}
    
.icon-wrapper {
  display: inline-block;
  border-radius: 50%;         
  padding: 4px;            
  background: white;       
  box-shadow: 0 0 6px rgba(0,0,0,0.4); 
}

.icon-wrapper img {
  width: 44px;
  height: 44px;
  display: block;
}

.marker-cluster {
  background: transparent !important; 
  border-radius: 50%;
}

.marker-cluster div {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, sans-serif;
  font-weight: 600;
  font-size: 14px;
  color: #ffffff;
  text-shadow: 0 0 3px rgba(0,0,0,0.8), 0 0 6px rgba(0,0,0,0.6); 
  background: rgba(255, 255, 255, 0.15);   
  backdrop-filter: blur(10px);             
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  transition: transform 0.25s ease, background 0.3s ease;
}

.marker-cluster:hover div {
  transform: scale(1.12);
  background: rgba(255, 255, 255, 0.25);
}

    .control-group {
  margin-bottom: 10px; 
}
    .control-group + .control-group {
  margin-top: 45px; 
}
    
#version-label {
  position: fixed;
  bottom: 6px;
  left: 8px;   
  font-size: 11px;
  color: rgba(255,255,255,0.45);
  font-family: system-ui, sans-serif;
  pointer-events: none;
  user-select: none;
}

.btn-toggle{
  background: rgba(0,0,0,.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;       
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;                
  color: #fff;
  cursor: pointer;
  margin: 10px 5px;              
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.btn-toggle.active {
  background: #fff;
  color: #111;
}
    
    :root { --accent:#4f46e5; --bg:#0b0c0e; --ink:#f9fafb; --glass:rgba(17,19,23,.65); --border:rgba(255,255,255,.12); }
    html, body { height:100%; margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif; background:var(--bg); color:var(--ink); }
    #map { width:100%; height:100%; }

    .icon-circle { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:15px; font-weight:bold; }
    .poste { background:#e11d48; } .appareil { background:#facc15; } .acces { background:#3b82f6; }
   .leaflet-control-custom{
  background: rgba(0,0,0,0.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;          
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  color: #fff;
  cursor: pointer;
  margin: 5px;
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;                   
  -webkit-tap-highlight-color: transparent;
}
  </style>
</head>
<body>
  <div id="map"></div>
  

<div id="streetview-overlay">
  <div id="streetview-box">
    <button id="streetview-close">‚ùå</button>
    <iframe id="streetview-frame"></iframe>
  </div>
</div>
  <script>
const defaultCenter = [49.8, 2.5]; 
const defaultZoom = 8;          

const map = L.map('map', { zoomControl: false, attributionControl: false })
             .setView(defaultCenter, defaultZoom);
    const allMarkers = [];


function makeTelHtml(labelEmoji, value) {
  if (!value) return "";

  if (value.indexOf("#") !== -1) return `<div>${labelEmoji} ${value}</div>`;


  const digitsOnly = ("" + value).replace(/\D/g, "");
  if (digitsOnly.length < 10) return `<div>${labelEmoji} ${value}</div>`;

 const hrefSafe = ("" + value).replace(/[^\d+]/g, "");

  if (!hrefSafe) return `<div>${labelEmoji} ${value}</div>`;

  return `<div>${labelEmoji} <a href="tel:${hrefSafe}" style="color:#007aff; text-decoration:none;">${value}</a></div>`;
}

const params = new URLSearchParams(window.location.search);
const lat = parseFloat(params.get("lat"));
const lon = parseFloat(params.get("lon"));
const zoom = parseInt(params.get("z")) || 19;
const id = params.get("id") ? decodeURIComponent(params.get("id")) : null;

  const planIGN = L.tileLayer(
  "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
  + "&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png"
  + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
  {
    attribution: "",
    maxZoom: 21,       
    maxNativeZoom: 19, 
    tileSize: 256,
    crossOrigin: 'anonymous'
  }
);

const orthoIGN = L.tileLayer(
  "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
  + "&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&STYLE=normal&FORMAT=image/jpeg"
  + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
  {
    attribution: "¬© IGN ‚Äì G√©oplateforme",
    maxZoom: 21,      
    maxNativeZoom: 19, 
    tileSize: 256,
    crossOrigin: 'anonymous'
  }
);

const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { 
    attribution: "¬© OpenStreetMap contributors", 
    maxZoom: 21,        
    maxNativeZoom: 19   
  }
);

const esriSat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {
    attribution: "¬© Esri, Maxar, Earthstar Geographics",
    maxZoom: 21,       
    maxNativeZoom: 19, 
    tileSize: 256
  }
);

const mixte = L.layerGroup([
  orthoIGN,
  L.tileLayer(
    "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
    + "&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png"
    + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
    {
      attribution: "¬© IGN ‚Äì G√©oplateforme",
      maxZoom: 19,
      tileSize: 256,
      crossOrigin: 'anonymous',
      opacity: 0.4  
    }
  )
]);

orthoIGN.addTo(map);


    L.control.layers(
      { 
        "üõ∞Ô∏è Satellite IGN": orthoIGN,
        "üõ∞Ô∏è Satellite Open": esriSat,
        "üó∫Ô∏è Plan IGN (d√©faut)": planIGN,
        "üåç Plan Open": osm,
        "üõ∞Ô∏è+üó∫Ô∏è Mixte": mixte
      },
      {}
    ).addTo(map);

    L.control.zoom({ position: 'topright' }).addTo(map);

    planIGN.on("tileerror", e => console.warn("IGN PLAN tile error", e));
    orthoIGN.on("tileerror", e => console.warn("IGN ORTHO tile error", e));


const postesLayer = L.markerClusterGroup({
  disableClusteringAtZoom: 18
});
const appareilsLayer = L.markerClusterGroup({
  disableClusteringAtZoom: 18
});
const accesLayer = L.markerClusterGroup({
  spiderfyOnMaxZoom: false,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: true
});

accesLayer.on('clusterclick', function (a) {
  const currentZoom = map.getZoom();
  const childMarkers = a.layer.getAllChildMarkers();

  const first = childMarkers[0].getLatLng();
  const allSameCoords = childMarkers.every(m => {
    const ll = m.getLatLng();
    return ll.lat === first.lat && ll.lng === first.lng;
  });

  if (!(currentZoom >= 18 && allSameCoords)) return;

  // Emp√™cher le zoom auto
  a.originalEvent.preventDefault();

  // Construire la liste tri√©e
  const items = childMarkers.map((m, i) => {
    let label = m.options.customId || `Acc√®s ${i + 1}`;
    return { label: label.replace(/\bposte\b/gi, "").trim(), idx: i };
  }).sort((a, b) => a.label.localeCompare(b.label, "fr", { numeric: true, sensitivity: "base" }));

  const html = `<div style="min-width:220px;display:flex;flex-direction:column;gap:6px">
    ${items.map(it => `<a href="#" class="cluster-link" data-idx="${it.idx}">${it.label}</a>`).join("")}
  </div>`;

  // Retirer le cluster et ajouter un marker temporaire
  const tempMarker = L.marker(first, { icon: iconAcces }).addTo(map);
  tempMarker.bindPopup(html).openPopup();

// Quand la popup se ferme ‚Üí seulement si elle affichait la liste
tempMarker.on("popupclose", () => {
  // Supprimer le marker seulement si la popup affichait la liste
  const popupContent = tempMarker.getPopup() ? tempMarker.getPopup().getContent() : "";
  if (popupContent.includes("cluster-link")) {
    map.removeLayer(tempMarker);
  }
});

  // Brancher les clics sur les liens
  setTimeout(() => {
    document.querySelectorAll(".leaflet-popup-content a.cluster-link").forEach(link => {
link.addEventListener("click", (e) => {
  e.preventDefault();
  const idx = +e.currentTarget.dataset.idx;
  const target = childMarkers[idx];

  const content = target.getPopup() ? target.getPopup().getContent() : "";
  tempMarker.setLatLng(target.getLatLng());
  tempMarker.bindPopup(content).openPopup();
  map.panTo(target.getLatLng());
}, { passive: false });
    });
  }, 0);
});


map.addLayer(postesLayer);
map.addLayer(appareilsLayer);
map.addLayer(accesLayer);


const iconPoste = L.divIcon({
  html: `<img src="ico/poste.png" class="icon-halo">`,
  className: "",  // pas de CSS par d√©faut
  iconAnchor: [24, 48],
  popupAnchor: [0, -48]
});

const iconAppareil= L.divIcon({className:"icon-circle appareil",html:"‚ö°"});

const iconAcces = L.divIcon({
  html: `<img src="ico/acces.png" class="icon-halo">`,
  className: "",
  iconAnchor: [24, 48],
  popupAnchor: [0, -48]
});

fetch("postes.json")
  .then(r => r.json())
  .then(data => {
    const seenPostes = new Set();

    data.forEach(item => {

      // === ACC√àS ===
      if (item.latitude && item.longitude) {
        const accesVal = (item["acc√®s"] ?? item.acces ?? "").toString().trim();
        const cid = accesVal
          ? [item.nom, item.type, item.SAT, "acces", accesVal].filter(Boolean).join(" ")
          : [item.nom, item.type, item.SAT, "poste"].filter(Boolean).join(" ");
        
        let content = `
          <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
                      font-size:14px; color:#111; line-height:1.4; max-width:240px;">
            <div style="font-weight:600; font-size:15px; margin-bottom:4px;">
              üìç ${item.nom || "Sans nom"}
              ${item.type ? " " + item.type : ""}
              ${item.SAT ? " " + item.SAT : ""}
              ${accesVal ? " ‚Äì acc√®s " + accesVal : ""}
            </div>

            ${ makeTelHtml("üîë", item.portail) }
            ${ makeTelHtml("üìû", item.contact) }
            ${item.description ? `<div>‚ÑπÔ∏è ${item.description}</div>` : ""}

            <div style="margin-top:8px;">
              <button onclick="openStreetView(${item.latitude}, ${item.longitude})"
                style="background:#007aff;color:#fff;padding:6px 12px;border:none;
                       border-radius:6px;cursor:pointer;">
                Street View
              </button>
            </div>

            <div style="margin-top:6px;">
              <a href="index.html?id=${encodeURIComponent(
   (`${item.nom || ''} ${item.type || ''} ${item.SAT || ''}${accesVal ? ' ‚Äì acc√®s ' + accesVal : ''}`)
    .replace(/\s+/g, " ")
    .trim()
  )}"
                style="color:#007aff; text-decoration:underline;">
                üîó Fiche d√©taill√©e
              </a>
            </div>
          </div>
        `;

        const m = L.marker([item.latitude, item.longitude], {
          icon: iconAcces,
          customId: cid
        }).bindPopup(content).addTo(accesLayer);

        allMarkers.push(m);
      }

      // === POSTES (on garde seulement le premier poste par coordonn√©es) ===
      if (item.poste_latitude && item.poste_longitude) {
        const key = `${item.poste_latitude}_${item.poste_longitude}`;
        
        if (!seenPostes.has(key)) {
          seenPostes.add(key);

          const cid = [item.nom, item.type, item.SAT, "poste"].filter(Boolean).join(" ");

          let content = `
            <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
                        font-size:14px; color:#111; line-height:1.4; max-width:240px;">
              <div style="font-weight:600; font-size:15px; margin-bottom:4px;">
                üìç ${item.nom || "Sans nom"} 
                ${item.type ? " " + item.type : ""} 
                ${item.SAT ? " " + item.SAT : ""}
              </div>

              <div style="margin-bottom:6px; color:#333;">
                ${item.pk 
                  ? `üöÑ PK ${item.pk} sur la ligne n¬∞${item.numero_ligne || ""} ‚Äì ${item.lignes || ""}`
                  : `üöÑ ligne n¬∞${item.numero_ligne || ""} ‚Äì ${item.lignes || ""}`}
              </div>

              ${ makeTelHtml("üîë", item.portail) }
              ${ makeTelHtml("üìû", item.contact) }
              ${item.description ? `<div>‚ÑπÔ∏è ${item.description}</div>` : ""}
            </div>
          `;

          const m = L.marker([item.poste_latitude, item.poste_longitude], {
            icon: iconPoste,
            customId: cid
          }).bindPopup(content).addTo(postesLayer);

          allMarkers.push(m);
        }
      }

    });
  });
    
    
    fetch("appareils.json")
  .then(r => r.json())
  .then(data => {

    data.forEach(item => {
  const cid = [item.nom, item.type, item.SAT, "appareil", item.appareil].filter(Boolean).join(" ");

  let content = `
    <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
                font-size:14px; color:#111; line-height:1.4; max-width:240px;">
      <div style="font-size:15px; margin-bottom:6px;">
        <span style="font-weight:600;">
          ${item.appareil || "Sans r√©f√©rence"}
        </span>
        <span>
          ${item.nom ? " " + item.nom : ""} 
          ${item.type ? " " + item.type : ""} 
          ${item.SAT ? " (" + item.SAT + ")" : ""}
        </span>
      </div>

      ${item.description ? `<div style="margin-bottom:6px;">‚ÑπÔ∏è ${item.description}</div>` : ""}
    </div>
  `;

let appareilIcon;
if (item.appareil && item.appareil.toUpperCase().startsWith("I")) {
  appareilIcon = L.divIcon({
    html: `<img src="ico/int.png" class="icon-halo-appareil">`,
    className: "",
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  });
} else if (
  item.appareil &&
  (item.appareil.toUpperCase().startsWith("TT") ||
   item.appareil.toUpperCase().startsWith("TSA") ||
   item.appareil.toUpperCase().startsWith("TC")  ||
   item.appareil.toUpperCase().startsWith("TRA"))
) {
  appareilIcon = L.divIcon({
    html: `<img src="ico/TT.png" class="icon-halo-appareil">`,
    className: "",
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  });
} else if (
  item.appareil &&
  (
    /^[0-9]/.test(item.appareil) ||
    item.appareil.toUpperCase().startsWith("S") ||
    item.appareil.toUpperCase().startsWith("ST") ||
    item.appareil.toUpperCase().startsWith("F IL") ||
    /^P[0-9]+/i.test(item.appareil) ||
    item.appareil.toUpperCase().startsWith("FB") ||
    item.appareil.toUpperCase().startsWith("B")
  )
) {
  appareilIcon = L.divIcon({
    html: `<img src="ico/sect.png" class="icon-halo-appareil">`,
    className: "",
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  });
  } else if (item.appareil && item.appareil.toUpperCase().startsWith("ALIM")) {
  appareilIcon = L.divIcon({
    html: `<img src="ico/alim.png" class="icon-halo-appareil">`,
    className: "",
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  });
  } else if (item.appareil && item.appareil.toUpperCase().startsWith("DU")) {
  appareilIcon = L.divIcon({
    html: `<img src="ico/stop.png" class="icon-halo-appareil">`,
    className: "",
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  });
} else if (item.appareil && item.appareil.toUpperCase().startsWith("SI")) {
  appareilIcon = L.divIcon({
    html: `<img src="ico/int.png" class="icon-halo-appareil">`,
    className: "",
    iconAnchor: [16, 32],
    popupAnchor: [0, -32]
  });
} else {
  appareilIcon = iconAppareil;
}

  const m = L.marker([item.latitude, item.longitude], {
    icon: appareilIcon,
    customId: cid
  }).bindPopup(content).addTo(appareilsLayer);
  allMarkers.push(m);
});

if (!isNaN(lat) && !isNaN(lon)) {
  setTimeout(() => {
    postesLayer.refreshClusters();
    accesLayer.refreshClusters();
    appareilsLayer.refreshClusters();

    allMarkers.forEach(m => {
      const ll = m.getLatLng();
      if (ll && ll.lat === lat && ll.lng === lon) {
        map.setView(ll, zoom);
        m.openPopup(); 
      }
    });
  }, 300);
}
      }); 


const leftControls = L.control({ position: "topleft" });
leftControls.onAdd = function() {
  const container = L.DomUtil.create("div");
  const topGroup = L.DomUtil.create("div", "control-group", container);
const backBtn = L.DomUtil.create("div", "btn-toggle btn-return", topGroup);
backBtn.innerHTML = "üîç";

backBtn.onclick = () => {
  window.location.href = "index.html";
};
L.DomEvent.disableClickPropagation(backBtn);
L.DomEvent.disableScrollPropagation(backBtn);
  

const recenterBtn = L.DomUtil.create("div", "btn-toggle", topGroup);
recenterBtn.innerHTML = "üéØ";

recenterBtn.onclick = () => {
  if (allMarkers.length > 0) {
    recenterBtn.classList.add("active"); 
 map.setView(defaultCenter, defaultZoom);


    setTimeout(() => {
      recenterBtn.classList.remove("active");
    }, 800); // 
  }
};

L.DomEvent.disableClickPropagation(recenterBtn);
L.DomEvent.disableScrollPropagation(recenterBtn);

let userMarker;
let geoWatchId = null;
const locateBtn = L.DomUtil.create("div", "btn-toggle", topGroup);
locateBtn.innerHTML = "üìç";

locateBtn.onclick = () => {
  if (!navigator.geolocation) return alert("G√©olocalisation non support√©e.");

  if (geoWatchId !== null) {
    navigator.geolocation.clearWatch(geoWatchId);
    geoWatchId = null;
    if (userMarker) {
      map.removeLayer(userMarker);
      userMarker = null;
    }
    locateBtn.classList.remove("active");
    return;
  }

  geoWatchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    if (userMarker) {
      userMarker.setLatLng([lat, lng]);
    } else {
      userMarker = L.circleMarker([lat, lng], {
        radius: 8,
        color: "#3b82f6",
        fillColor: "#3b82f6",
        fillOpacity: 0.6
      }).addTo(map);
    }
    map.setView([lat, lng], 15);
  });

  locateBtn.classList.add("active");
};

L.DomEvent.disableClickPropagation(locateBtn);
L.DomEvent.disableScrollPropagation(locateBtn);

  const bottomGroup = L.DomUtil.create("div", "control-group", container);

  function makeBtn(emoji, layer, initiallyOn = true) {
    const b = L.DomUtil.create("div", "btn-toggle" + (initiallyOn ? " active" : ""), bottomGroup);
    b.innerHTML = emoji;
    b.onclick = () => {
      if (map.hasLayer(layer)) {
        map.removeLayer(layer);
        b.classList.remove("active");
      } else {
        map.addLayer(layer);
        b.classList.add("active");
      }
    };
    return b;
  }

  makeBtn("üöô", accesLayer, true);
  makeBtn("üìç", postesLayer, true);
  makeBtn("‚ö°", appareilsLayer, true);

  return container;
};
leftControls.addTo(map);


if (!id) {
  map.whenReady(() => {
    if (allMarkers.length > 0) {
      const group = L.featureGroup(allMarkers);
      map.fitBounds(group.getBounds());
    }
  });
}

 function openStreetView(lat, lng) {
    const iframe = document.getElementById("streetview-frame");
    iframe.src = `https://www.google.com/maps?q=&layer=c&cbll=${lat},${lng}&cbp=11,0,0,0,0&output=svembed`;
    document.getElementById("streetview-overlay").style.display = "flex";
  }


  document.getElementById("streetview-close").onclick = () => {
    document.getElementById("streetview-overlay").style.display = "none";
    document.getElementById("streetview-frame").src = ""; 
  };

document.getElementById("streetview-overlay").style.display = "none";
document.getElementById("streetview-frame").src = "";
</script>

</body>
</html>
