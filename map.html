<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Nono Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <style>

.leaflet-popup-content {
  max-width: 240px !important; 
  min-width: 240px; 
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif;
  font-size: 14px;
  line-height: 1.4;
  color: #111;
  overflow: hidden;    
  text-align: left;      
}

.leaflet-popup-content div,
.leaflet-popup-content p {
  display: flex;
  align-items: center;
  gap: 6px;           
  margin: 4px 0;
  flex-wrap: wrap;      
}

.leaflet-popup-content img,
.leaflet-popup-content svg,
.leaflet-popup-content i {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
}

.leaflet-popup-content a {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  text-decoration: none;
}

    .leaflet-popup-content a.cluster-link {
  display: block;
  padding: 8px 12px;
  border-radius: 8px;
  background: #f3f4f6;
  color: #007aff;
  text-decoration: none;
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif;
  font-size: 14px;
  margin: 2px 0;
  transition: background 0.2s;
}

.leaflet-popup-content a.cluster-link:hover,
.leaflet-popup-content a.cluster-link:active {
  background: #e5e7eb; /* gris clair au survol */
}

#streetview-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);     
  -webkit-backdrop-filter: blur(6px);
  display: none;
  z-index: 9999;

  display: flex;             
  align-items: center;
  justify-content: center;
}


#streetview-box {
  width: 90%;
  max-width: 900px;
  height: 70%;
  background: rgba(20,20,20,0.95);
  border-radius: 16px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  overflow: hidden;
  position: relative;
}

#streetview-box iframe {
  width: 100%;
  height: 100%;
  border: none;
}

#streetview-close {
  position: absolute;
  top: 12px; right: 12px;
  font-size: 24px;
  background: rgba(0,0,0,0.6);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px; height: 40px;
  cursor: pointer;
  z-index: 2;
}

.btn-return {
  position: relative;
  animation: pulseHalo 1.8s infinite;
}

@keyframes pulseHalo {
  0%   { box-shadow: 0 0 0px rgba(255,255,255,0.6); }
  50%  { box-shadow: 0 0 15px rgba(255,255,255,0.9), 0 0 30px rgba(255,255,255,0.4); }
  100% { box-shadow: 0 0 0px rgba(255,255,255,0.6); }
}
  
    .icon-halo {
  width: 48px;  
  height: 48px;
  filter: drop-shadow(0 0 2px white) drop-shadow(0 0 4px white);
}
    .icon-halo-appareil {
  width: 24px;  
  height: 24px;
  filter: drop-shadow(0 0 4px white) drop-shadow(0 0 8px white);
}
    
.icon-wrapper {
  display: inline-block;
  border-radius: 50%;         
  padding: 4px;            
  background: white;       
  box-shadow: 0 0 6px rgba(0,0,0,0.4); 
}

.icon-wrapper img {
  width: 44px;
  height: 44px;
  display: block;
}

.marker-cluster {
  background: transparent !important; 
  border-radius: 50%;
}

.marker-cluster div {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, sans-serif;
  font-weight: 600;
  font-size: 14px;
  color: #ffffff;
  text-shadow: 0 0 3px rgba(0,0,0,0.8), 0 0 6px rgba(0,0,0,0.6); 
  background: rgba(255, 255, 255, 0.15);   
  backdrop-filter: blur(10px);             
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  transition: transform 0.25s ease, background 0.3s ease;
}

.marker-cluster:hover div {
  transform: scale(1.12);
  background: rgba(255, 255, 255, 0.25);
}

    .control-group {
  margin-bottom: 10px; 
}
    .control-group + .control-group {
  margin-top: 45px; 
}
    
#version-label {
  position: fixed;
  bottom: 6px;
  left: 8px;   
  font-size: 11px;
  color: rgba(255,255,255,0.45);
  font-family: system-ui, sans-serif;
  pointer-events: none;
  user-select: none;
}

.btn-toggle{
  background: rgba(0,0,0,.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;       
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;                
  color: #fff;
  cursor: pointer;
  margin: 10px 5px;              
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.btn-toggle.active {
  background: #fff;
  color: #111;
}
    
    :root { --accent:#4f46e5; --bg:#0b0c0e; --ink:#f9fafb; --glass:rgba(17,19,23,.65); --border:rgba(255,255,255,.12); }
    html, body { height:100%; margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif; background:var(--bg); color:var(--ink); }
    #map { width:100%; height:100%; }

    .icon-circle { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:15px; font-weight:bold; }
    .poste { background:#e11d48; } .appareil { background:#facc15; } .acces { background:#3b82f6; }
   .leaflet-control-custom{
  background: rgba(0,0,0,0.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;          
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  color: #fff;
  cursor: pointer;
  margin: 5px;
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;                   
  -webkit-tap-highlight-color: transparent;
}
  </style>
</head>
<body>

    <div id="video-overlay" style="display:none;
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.7);z-index:10000;align-items:center;justify-content:center;">
  <div style="width:90%;max-width:800px;height:70%;position:relative;">
    <button id="video-close" style="position:absolute;top:8px;right:8px;
      font-size:24px;background:#000;color:#fff;border:none;border-radius:50%;
      width:40px;height:40px;cursor:pointer;">‚ùå</button>
    <iframe id="video-frame" width="100%" height="100%" 
      src="" frameborder="0" allowfullscreen></iframe>
  </div>
</div>
  
  <div id="map"></div>
  

<div id="streetview-overlay">
  <div id="streetview-box">
    <button id="streetview-close">‚ùå</button>
    <iframe id="streetview-frame"></iframe>
  </div>
</div>
  <script>
const defaultCenter = [49.8, 2.5]; 
const defaultZoom = 8;          

const map = L.map('map', { zoomControl: false, attributionControl: false })
             .setView(defaultCenter, defaultZoom);
    const allMarkers = [];

let _datasetsLoaded = 0;
function _tryOpenFromURL() {
  _datasetsLoaded++;
  if (_datasetsLoaded < 2) return; // attendre postes + appareils

  if (!isNaN(lat) && !isNaN(lon)) {
    const matches = allMarkers.filter(m => {
      const ll = m.getLatLng();
      return ll.lat === lat && ll.lng === lon;
    });

if (matches.length > 0) {
  const first = matches[0].getLatLng();
  const allSameCoords = matches.every(m => m.getLatLng().equals(first));

  map.setView(first, Math.max(zoom, 21));

 setTimeout(() => {
  if (matches.length === 1) {
    // üëâ Cas : un seul marker ‚Üí popup normale
    matches[0].openPopup();

  } else if (allSameCoords) {
    // üëâ Cas : plusieurs markers exactement au m√™me endroit ‚Üí liste
    const items = matches.map((m, i) => {
      let label = m.options.customId || `√âl√©ment ${i + 1}`;
      return { label: label.replace(/\bposte\b/gi, "").trim(), idx: i };
    }).sort((a, b) => a.label.localeCompare(b.label, "fr", { numeric: true, sensitivity: "base" }));

    const html = `<div style="min-width:220px;display:flex;flex-direction:column;gap:6px">
      ${items.map(it => {
       const marker = matches[it.idx];
        const id = (marker.options.customId || "").toUpperCase();
        
let iconFile = null;

if (marker.options.isAcces) {
  iconFile = "acces.png";
} else if (id.includes("POSTE")) {
  iconFile = "poste.png";
} else {
  // r√®gles appareils
  if (id.startsWith("I") || id.startsWith("SI")) {
    iconFile = "int.png";
  } else if (id.startsWith("TT") || id.startsWith("TSA") || id.startsWith("TC") || id.startsWith("TRA")) {
    iconFile = "TT.png";
  } else if (/^[0-9]/.test(id) || id.startsWith("S") || id.startsWith("ST") || id.startsWith("FIL") || id.startsWith("P") || id.startsWith("FB") || id.startsWith("B")) {
    iconFile = "sect.png";
  } else if (id.startsWith("ALIM")) {
    iconFile = "alim.png";
  } else if (id.startsWith("DU")) {
    iconFile = "stop.png";
  }
}

        return `
          <a href="#" class="cluster-link" data-idx="${it.idx}" style="display:flex;align-items:center;gap:6px;">
            ${iconFile ? `<img src="ico/${iconFile}" style="width:16px;height:16px;">` : ""}
            <span>${it.label}</span>
          </a>`;
      }).join("")}
    </div>`;

    L.popup()
      .setLatLng(first)
      .setContent(html)
      .openOn(map);

    setTimeout(() => {
      document.querySelectorAll(".leaflet-popup-content a.cluster-link").forEach(link => {
        link.addEventListener("click", (ev) => {
          ev.preventDefault();
          const idx = +ev.currentTarget.dataset.idx;
          const target = matches[idx];
          const content = target.getPopup() ? target.getPopup().getContent() : "";
          L.popup({ maxWidth: 240 })
            .setLatLng(target.getLatLng())
            .setContent(content)
            .openOn(map);
          map.panTo(target.getLatLng());
        });
      });
    }, 0);
  } else {
    // üëâ Cas : markers proches mais pas identiques
    const group = L.featureGroup(matches);
    map.fitBounds(group.getBounds());
  }
}, 300);

   
} else {
  map.setView([lat, lon], zoom);
}
  }
}

function makeTelHtml(labelEmoji, value) {
  if (!value) return "";

  if (value.indexOf("#") !== -1) return `<div>${labelEmoji} ${value}</div>`;


  const digitsOnly = ("" + value).replace(/\D/g, "");
  if (digitsOnly.length < 10) return `<div>${labelEmoji} ${value}</div>`;

 const hrefSafe = ("" + value).replace(/[^\d+]/g, "");

  if (!hrefSafe) return `<div>${labelEmoji} ${value}</div>`;

  return `<div>${labelEmoji} <a href="tel:${hrefSafe}" style="color:#007aff; text-decoration:none;">${value}</a></div>`;
}

const params = new URLSearchParams(window.location.search);
const lat = parseFloat(params.get("lat"));
const lon = parseFloat(params.get("lon"));
const zoom = parseInt(params.get("z")) || 19;
const id = params.get("id") ? decodeURIComponent(params.get("id")) : null;

  const planIGN = L.tileLayer(
  "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
  + "&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png"
  + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
  {
    attribution: "",
    maxZoom: 21,       
    maxNativeZoom: 19, 
    tileSize: 256,
    crossOrigin: 'anonymous'
  }
);

const orthoIGN = L.tileLayer(
  "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
  + "&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&STYLE=normal&FORMAT=image/jpeg"
  + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
  {
    attribution: "¬© IGN ‚Äì G√©oplateforme",
    maxZoom: 21,      
    maxNativeZoom: 19, 
    tileSize: 256,
    crossOrigin: 'anonymous'
  }
);

const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { 
    attribution: "¬© OpenStreetMap contributors", 
    maxZoom: 21,        
    maxNativeZoom: 19   
  }
);

const esriSat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {
    attribution: "¬© Esri, Maxar, Earthstar Geographics",
    maxZoom: 21,       
    maxNativeZoom: 19, 
    tileSize: 256
  }
);

const mixte = L.layerGroup([
  orthoIGN,
  L.tileLayer(
    "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
    + "&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png"
    + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
    {
      attribution: "¬© IGN ‚Äì G√©oplateforme",
      maxZoom: 19,
      tileSize: 256,
      crossOrigin: 'anonymous',
      opacity: 0.4  
    }
  )
]);

orthoIGN.addTo(map);


    L.control.layers(
      { 
        "üõ∞Ô∏è Satellite IGN": orthoIGN,
        "üõ∞Ô∏è Satellite Open": esriSat,
        "üó∫Ô∏è Plan IGN (d√©faut)": planIGN,
        "üåç Plan Open": osm,
        "üõ∞Ô∏è+üó∫Ô∏è Mixte": mixte
      },
      {}
    ).addTo(map);

    L.control.zoom({ position: 'topright' }).addTo(map);

    planIGN.on("tileerror", e => console.warn("IGN PLAN tile error", e));
    orthoIGN.on("tileerror", e => console.warn("IGN ORTHO tile error", e));


const postesLayer = L.markerClusterGroup({
  disableClusteringAtZoom: 18
});
const appareilsLayer = L.markerClusterGroup({
  spiderfyOnMaxZoom: true, 
  showCoverageOnHover: false,
  disableClusteringAtZoom: null  
});
const accesLayer = L.markerClusterGroup({
  spiderfyOnMaxZoom: false,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: false
});

accesLayer.on('clusterclick', function (e) {
  const childMarkers = e.layer.getAllChildMarkers();
  if (childMarkers.length === 0) return;

  const first = childMarkers[0].getLatLng();
  const allSameCoords = childMarkers.every(m => m.getLatLng().equals(first));

  if (allSameCoords) {
    const items = childMarkers.map((m, i) => {
      let label = m.options.customId || `Acc√®s ${i + 1}`;
      return { label: label.replace(/\bposte\b/gi, "").trim(), idx: i };
    }).sort((a, b) => a.label.localeCompare(b.label, "fr", { numeric: true, sensitivity: "base" }));

    const html = `<div style="min-width:220px;display:flex;flex-direction:column;gap:6px">
      ${items.map(it => `
        <a href="#" class="cluster-link" data-idx="${it.idx}" 
           style="display:flex;align-items:center;gap:6px;">
          <img src="ico/acces.png" style="width:16px;height:16px;">
          <span>${it.label}</span>
        </a>`).join("")}
    </div>`;

    L.popup()
      .setLatLng(first)
      .setContent(html)
      .openOn(map);

setTimeout(() => {
  document.querySelectorAll(".leaflet-popup-content a.cluster-link").forEach(link => {
    link.addEventListener("click", (ev) => {
      ev.preventDefault();
      const idx = +ev.currentTarget.dataset.idx;
      const target = childMarkers[idx];

      const content = target.getPopup() ? target.getPopup().getContent() : "";
      L.popup({ maxWidth: 240 })
        .setLatLng(target.getLatLng())
        .setContent(content)
        .openOn(map);

      map.panTo(target.getLatLng());
    });
  });
}, 0);

  } else {
    map.fitBounds(e.layer.getBounds());
  }
});


map.addLayer(postesLayer);
map.addLayer(appareilsLayer);
map.addLayer(accesLayer);


const iconPoste = L.divIcon({
  html: `<img src="ico/poste.png" class="icon-halo">`,
  className: "", 
  iconAnchor: [24, 48],
  popupAnchor: [0, -48]
});

const iconAppareil= L.divIcon({className:"icon-circle appareil",html:"‚ö°"});

const iconAcces = L.divIcon({
  html: `<img src="ico/acces.png" class="icon-halo">`,
  className: "",
  iconAnchor: [24, 48],
  popupAnchor: [0, -48]
});

fetch("postes.json")
  .then(r => r.json())
  .then(data => {
    const seenPostes = new Set();

    data.forEach(item => {

     if (item.latitude && item.longitude) {
  const accesVal = (item["acc√®s"] ?? item.acces ?? "").toString().trim();

const cid = [item.nom, item.type, item.SAT, accesVal]
  .filter(Boolean)
  .join(" ");

let content = `
<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
            font-size:14px; color:#111; line-height:1.4; position:relative;">

<!-- Titre -->
<div style="font-weight:600; font-size:16px; margin-bottom:14px; padding-right:32px;">
  üöô ${item.nom || "Sans nom"}
  ${item.type ? " " + item.type : ""}
  ${item.SAT ? " " + item.SAT : ""}
  ${accesVal ? " ‚Äì acc√®s " + accesVal : ""}
</div>

<!-- Ic√¥ne Street View -->
<span onclick="openStreetView(${item.latitude}, ${item.longitude})"
      style="cursor:pointer; position:absolute; top:10px; right:12px;
             font-size:26px; line-height:1;">üì∑</span>
             
<!-- Information -->
<div style="margin-bottom:10px;">
  ‚úçüèª <strong>Information :</strong> ${ renderPortail(item.description) }
</div>

<!-- Portail -->
<div style="margin-bottom:10px;">
  üîë <strong>Portail :</strong> ${ renderPortail(item.portail) }
</div>

  <!-- Bouton Voir plus -->
  <a href="index.html?id=${encodeURIComponent(
    (`${item.nom || ''} ${item.type || ''} ${item.SAT || ''}${accesVal ? ' ‚Äì acc√®s ' + accesVal : ''}`)
      .replace(/\s+/g, " ")
      .trim()
  )}"
     style="display:flex;align-items:center;justify-content:center;gap:6px;
            background:#007aff;color:#fff;padding:10px 14px;border-radius:8px;
            text-decoration:none;width:100%;font-size:15px;font-weight:500;">
    ‚ûï Voir plus
  </a>
</div>
`;

const m = L.marker([item.latitude, item.longitude], {
  icon: iconAcces,
  customId: cid,
  isAcces: true   
}).bindPopup(content).addTo(accesLayer);

  allMarkers.push(m);
}

      if (item.poste_latitude && item.poste_longitude) {
        const key = `${item.poste_latitude}_${item.poste_longitude}`;
        
        if (!seenPostes.has(key)) {
          seenPostes.add(key);

  const cid = [item.nom, item.type, item.SAT, "poste"].filter(Boolean).join(" ");

let content = `
<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
            font-size:14px; color:#111; line-height:1.4;">

  <!-- Nom + type + SAT -->
  <div style="font-weight:600; font-size:16px; margin-bottom:14px;">
    üìç ${item.nom || "Sans nom"} 
    ${item.type ? " " + item.type : ""} 
    ${item.SAT ? " " + item.SAT : ""}
  </div>

<!-- PK + Ligne -->
<div style="margin-bottom:10px;">
  üöÑ PK <strong>${item.pk || "(non renseign√©)"}</strong>
  sur la ligne n¬∞<strong>${item.numero_ligne || "(non renseign√©)"}</strong>
  ${item.lignes ? " ‚Äì " + item.lignes : ""}
</div>

 <!-- Information -->
  <div style="margin-bottom:10px;">
    ‚úçüèª <strong>Information :</strong> ${ renderPortail(item.description) }
  </div>

  <!-- Contact -->
  <div style="margin-bottom:10px;">
    üìû <strong>Contact :</strong> ${ renderContact(item.contact) }
  </div>

  <!-- Portail -->
  <div style="margin-bottom:10px;">
    üîë <strong>Portail :</strong> ${ renderPortail(item.portail) }
  </div>

  <!-- Bouton Voir plus -->
  <a href="index.html?id=${encodeURIComponent(
    (`${item.nom || ''} ${item.type || ''} ${item.SAT || ''}`)
      .replace(/\s+/g, " ")
      .trim()
  )}"
     style="display:flex;align-items:center;justify-content:center;gap:6px;
            background:#007aff;color:#fff;padding:10px 14px;border-radius:8px;
            text-decoration:none;width:100%;font-size:15px;font-weight:500;">
    ‚ûï Voir plus
  </a>
</div>
`;

const m = L.marker([item.poste_latitude, item.poste_longitude], {
  icon: iconPoste,
  customId: cid
}).bindPopup(content).addTo(postesLayer);

allMarkers.push(m);
        }
      }

    });
_tryOpenFromURL();
  });
    
   fetch("appareils.json")
  .then(r => r.json())
  .then(data => {
    data.forEach(item => {
      if (!item.latitude || !item.longitude) return;


let appareilIcon;
const ref = (item.appareil || "").toUpperCase();

if (ref.startsWith("I") || ref.startsWith("SI")) {
  appareilIcon = L.divIcon({ html:`<img src="ico/int.png" class="icon-halo-appareil">`, className:"", iconAnchor:[16,32], popupAnchor:[0,-32] });
} else if (ref.startsWith("TT") || ref.startsWith("TSA") || ref.startsWith("TC") || ref.startsWith("TRA")) {
  appareilIcon = L.divIcon({ html:`<img src="ico/TT.png" class="icon-halo-appareil">`, className:"", iconAnchor:[16,32], popupAnchor:[0,-32] });
} else if (/^[0-9]/.test(ref) || ref.startsWith("S") || ref.startsWith("ST") || ref.startsWith("FIL") || ref.startsWith("P") || ref.startsWith("FB") || ref.startsWith("B")) {
  appareilIcon = L.divIcon({ html:`<img src="ico/sect.png" class="icon-halo-appareil">`, className:"", iconAnchor:[16,32], popupAnchor:[0,-32] });
} else if (ref.startsWith("ALIM")) {
  appareilIcon = L.divIcon({ html:`<img src="ico/alim.png" class="icon-halo-appareil">`, className:"", iconAnchor:[16,32], popupAnchor:[0,-32] });
} else if (ref.startsWith("DU")) {
  appareilIcon = L.divIcon({ html:`<img src="ico/stop.png" class="icon-halo-appareil">`, className:"", iconAnchor:[16,32], popupAnchor:[0,-32] });
} else {
  appareilIcon = iconAppareil; // ‚ö° d√©faut
}

      // Contenu popup
let content = `
<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
            font-size:14px; color:#111; line-height:1.4;">

  <!-- Titre appareil -->
  <div style="font-size:15px; margin-bottom:10px; font-weight:600;">
    ‚ö° ${item.appareil || "Sans r√©f√©rence"}
    ${item.nom ? " " + item.nom : ""}
    ${item.type ? " " + item.type : ""}
    ${item.SAT ? " (" + item.SAT + ")" : ""}
  </div>

  <!-- Description -->
  ${item.description ? `<div style="margin-bottom:14px;">‚úçüèª <strong>Information :</strong> ${item.description}</div>` : ""}

  <!-- Bouton Voir le poste -->
  <a href="index.html?id=${encodeURIComponent(
    (`${item.nom || ''} ${item.type || ''} ${item.SAT || ''}`)
      .replace(/\s+/g, " ")
      .trim()
  )}"
     style="display:flex;align-items:center;justify-content:center;gap:6px;
            background:#10b981;color:#fff;padding:10px 14px;border-radius:8px;
            text-decoration:none;width:100%;font-size:15px;font-weight:500;margin-bottom:8px;">
    üìç Voir le poste
  </a>

  <!-- Bouton Voir plus (appareil) -->
  <a href="index.html?id=${encodeURIComponent(
    (`${item.appareil || ''} ${item.nom || ''} ${item.type || ''} ${item.SAT || ''}`)
      .replace(/\s+/g, " ")
      .trim()
  )}"
     style="display:flex;align-items:center;justify-content:center;gap:6px;
            background:#007aff;color:#fff;padding:10px 14px;border-radius:8px;
            text-decoration:none;width:100%;font-size:15px;font-weight:500;">
    ‚ûï Voir plus
  </a>
</div>
`;

      const cid = [item.appareil, item.nom, item.type, item.SAT].filter(Boolean).join(" ");
      const m = L.marker([item.latitude, item.longitude], {
        icon: appareilIcon,
        customId: cid
      }).bindPopup(content);

      appareilsLayer.addLayer(m);
      allMarkers.push(m);
    });

    _tryOpenFromURL();
  });
// üëâ Gestion cluster appareils comme pour acc√®s
appareilsLayer.on('clusterclick', function (e) {
  const childMarkers = e.layer.getAllChildMarkers();
  if (childMarkers.length === 0) return;

  const first = childMarkers[0].getLatLng();
  const allSameCoords = childMarkers.every(m => m.getLatLng().equals(first));

  if (allSameCoords) {
    const items = childMarkers.map((m, i) => {
      let label = m.options.customId || `Appareil ${i + 1}`;
      return { label: label.trim(), idx: i };
    }).sort((a, b) => a.label.localeCompare(b.label, "fr", { numeric:true, sensitivity:"base" }));

   const html = `<div style="min-width:220px;display:flex;flex-direction:column;gap:6px">
  ${items.map(it => {
const marker = childMarkers[it.idx];
const id = (marker.options.customId || "").toUpperCase();
    let iconFile = null;
   if (marker.options.isAcces) {
  iconFile = "acces.png";
} else if (id.includes("POSTE")) {
  iconFile = "poste.png";
} else {
  // r√®gles appareils
  if (id.startsWith("I") || id.startsWith("SI")) {
    iconFile = "int.png";
  } else if (id.startsWith("TT") || id.startsWith("TSA") || id.startsWith("TC") || id.startsWith("TRA")) {
    iconFile = "TT.png";
  } else if (/^[0-9]/.test(id) || id.startsWith("S") || id.startsWith("ST") || id.startsWith("FIL") || id.startsWith("P") || id.startsWith("FB") || id.startsWith("B")) {
    iconFile = "sect.png";
  } else if (id.startsWith("ALIM")) {
    iconFile = "alim.png";
  } else if (id.startsWith("DU")) {
    iconFile = "stop.png";
  }
}

    return `
      <a href="#" class="cluster-link" data-idx="${it.idx}" style="display:flex;align-items:center;gap:6px;">
        ${iconFile ? `<img src="ico/${iconFile}" style="width:16px;height:16px;">` : ""}
        <span>${it.label}</span>
      </a>`;
  }).join("")}
</div>`;

    L.popup()
      .setLatLng(first)
      .setContent(html)
      .openOn(map);

    setTimeout(() => {
      document.querySelectorAll(".leaflet-popup-content a.cluster-link").forEach(link => {
        link.addEventListener("click", (ev) => {
          ev.preventDefault();
          const idx = +ev.currentTarget.dataset.idx;
          const target = childMarkers[idx];
          const content = target.getPopup() ? target.getPopup().getContent() : "";
          L.popup({ maxWidth: 240 })
            .setLatLng(target.getLatLng())
            .setContent(content)
            .openOn(map);
          map.panTo(target.getLatLng());
        });
      });
    }, 0);

  } else {
    map.fitBounds(e.layer.getBounds());
  }
});


const leftControls = L.control({ position: "topleft" });
leftControls.onAdd = function() {
  const container = L.DomUtil.create("div");
  const topGroup = L.DomUtil.create("div", "control-group", container);
const backBtn = L.DomUtil.create("div", "btn-toggle btn-return", topGroup);
backBtn.innerHTML = "üîç";

backBtn.onclick = () => {
  window.location.href = "index.html";
};
L.DomEvent.disableClickPropagation(backBtn);
L.DomEvent.disableScrollPropagation(backBtn);
  

const recenterBtn = L.DomUtil.create("div", "btn-toggle", topGroup);
recenterBtn.innerHTML = "üéØ";

recenterBtn.onclick = () => {
  if (allMarkers.length > 0) {
    recenterBtn.classList.add("active"); 
 map.setView(defaultCenter, defaultZoom);


    setTimeout(() => {
      recenterBtn.classList.remove("active");
    }, 800); 
  }
};

L.DomEvent.disableClickPropagation(recenterBtn);
L.DomEvent.disableScrollPropagation(recenterBtn);

let userMarker;
let geoWatchId = null;
const locateBtn = L.DomUtil.create("div", "btn-toggle", topGroup);
locateBtn.innerHTML = "üìç";

locateBtn.onclick = () => {
  if (!navigator.geolocation) return alert("G√©olocalisation non support√©e.");

  if (geoWatchId !== null) {
    navigator.geolocation.clearWatch(geoWatchId);
    geoWatchId = null;
    if (userMarker) {
      map.removeLayer(userMarker);
      userMarker = null;
    }
    locateBtn.classList.remove("active");
    return;
  }

  geoWatchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    if (userMarker) {
      userMarker.setLatLng([lat, lng]);
    } else {
      userMarker = L.circleMarker([lat, lng], {
        radius: 8,
        color: "#3b82f6",
        fillColor: "#3b82f6",
        fillOpacity: 0.6
      }).addTo(map);
    }
    map.setView([lat, lng], 15);
  });

  locateBtn.classList.add("active");
};

L.DomEvent.disableClickPropagation(locateBtn);
L.DomEvent.disableScrollPropagation(locateBtn);

  const bottomGroup = L.DomUtil.create("div", "control-group", container);

  function makeBtn(emoji, layer, initiallyOn = true) {
    const b = L.DomUtil.create("div", "btn-toggle" + (initiallyOn ? " active" : ""), bottomGroup);
    b.innerHTML = emoji;
    b.onclick = () => {
      if (map.hasLayer(layer)) {
        map.removeLayer(layer);
        b.classList.remove("active");
      } else {
        map.addLayer(layer);
        b.classList.add("active");
      }
    };
    return b;
  }

  makeBtn("üöô", accesLayer, true);
  makeBtn("üìç", postesLayer, true);
  makeBtn("‚ö°", appareilsLayer, true);

  return container;
};
leftControls.addTo(map);

if (!id) {
  map.whenReady(() => {
    if (allMarkers.length > 0) {
      const group = L.featureGroup(allMarkers);
      map.fitBounds(group.getBounds());
    }
  });
}
    
 function openStreetView(lat, lng) {
    const iframe = document.getElementById("streetview-frame");
    iframe.src = `https://www.google.com/maps?q=&layer=c&cbll=${lat},${lng}&cbp=11,0,0,0,0&output=svembed`;
    document.getElementById("streetview-overlay").style.display = "flex";
  }

  document.getElementById("streetview-close").onclick = () => {
    document.getElementById("streetview-overlay").style.display = "none";
    document.getElementById("streetview-frame").src = ""; 
  };
document.getElementById("streetview-overlay").style.display = "none";
document.getElementById("streetview-frame").src = "";

// --- KIT DEBUG √âCLAIR ---
console.info("[Nono Maps] boot", {
  leaflet: L.version,
  clusters: { postes: !!postesLayer, appareils: !!appareilsLayer, acces: !!accesLayer }
});

// Attrape toutes les erreurs JS et les affiche joliment √† l'√©cran
window.onerror = function(msg, src, line, col, err){
  const box = document.createElement("div");
  box.style = "position:fixed;z-index:10000;left:8px;bottom:8px;max-width:90%;"+
              "background:#111;color:#fff;padding:10px 12px;border:1px solid #333;"+
              "font:12px/1.4 system-ui;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,.4)";
  box.textContent = "‚ùó "+ msg + " [" + (src||"inline") + ":" + line + ":" + col + "]";
  document.body.appendChild(box);
  console.error("‚ùó Uncaught error", {msg, src, line, col, err});
};

// V√©rifie qu‚Äôon charge bien les jeux de donn√©es et combien de marqueurs arrivent
Promise.allSettled([
  fetch("postes.json").then(r => r.json()).then(d => { console.log("postes.json OK", d.length); return d; })
    .catch(e => { console.error("postes.json KO", e); return []; }),
  fetch("appareils.json").then(r => r.json()).then(d => { console.log("appareils.json OK", d.length); return d; })
    .catch(e => { console.error("appareils.json KO", e); return []; })
]);

// Petite garde anti-NaN dans l‚ÄôURL (√©vite des comportements bizarres)
if (isNaN(lat) || isNaN(lon)) { console.warn("URL lat/lon invalides", {lat, lon}); }



    function makeTelHtml(labelEmoji, value) {
  if (!value) return "";

  if (value.indexOf("#") !== -1) return `<div>${labelEmoji} ${value}</div>`;

  const digitsOnly = ("" + value).replace(/\D/g, "");
  if (digitsOnly.length < 10) return `<div>${labelEmoji} ${value}</div>`;

  const hrefSafe = ("" + value).replace(/[^\d+]/g, "");
  if (!hrefSafe) return `<div>${labelEmoji} ${value}</div>`;

  return `<div>${labelEmoji} <a href="tel:${hrefSafe}" style="color:#007aff; text-decoration:none;">${value}</a></div>`;
}

function renderPortail(value) {
  if (!value) {
    return `<span style="color:#777;font-style:italic;">Non renseign√©</span>`;
  }
  const str = String(value);

  // Cas avec #
  if (str.includes("#")) return str;

  // Cas YouTube
  const ytMatch = str.match(/(?:youtube\.com\/(?:watch\?v=|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]+)/);
  if (ytMatch) {
    const videoId = ytMatch[1];
    return `<a href="#" class="open-video" data-video="${videoId}" 
              style="color:#007aff; text-decoration:none;">Voir vid√©o explicative ICI</a>`;
  }

  // Cas lien http(s)
  const urlMatch = str.match(/https?:\/\/[^\s]+/i);
  if (urlMatch) {
    const url = urlMatch[0];
    const withoutUrl = str.replace(url, "").trim(); // ex: "Code 594"
    const link = `<a href="${url}" target="_blank" style="color:#007aff; text-decoration:none;">Lien portail</a>`;
    return withoutUrl ? `${withoutUrl} ‚Äì ${link}` : link;
  }

  // Cas num√©ro de t√©l√©phone
  const digits = str.replace(/\D/g, "");
  if (digits.length >= 10) {
    const tel = str.replace(/[^\d+]/g, "");
    return `<a href="tel:${tel}" style="color:#007aff; text-decoration:none;">${str}</a>`;
  }

  // Sinon afficher brut
  return str;
}

    // Gestion ouverture/fermeture overlay vid√©o
document.addEventListener("click", e => {
  if (e.target.classList.contains("open-video")) {
    e.preventDefault();
    const videoId = e.target.dataset.video;
    const iframe = document.getElementById("video-frame");
    iframe.src = `https://www.youtube.com/embed/${videoId}`;
    document.getElementById("video-overlay").style.display = "flex";
  }
});

document.getElementById("video-close").onclick = () => {
  document.getElementById("video-overlay").style.display = "none";
  document.getElementById("video-frame").src = "";
};

    function renderContact(value) {
  if (!value) {
    return `<span style="color:#777;font-style:italic;">Non renseign√©</span>`;
  }

  const str = String(value);

  // On d√©coupe le texte en s√©parant les num√©ros (format fran√ßais 10 chiffres)
  return str.split(/(\d{2}(?:\s?\d{2}){4})/g).map(part => {
    const digits = part.replace(/\D/g, "");
    if (digits.length === 10) {
      // C'est un num√©ro ‚Üí rendre cliquable
      return `<a href="tel:${digits}" style="color:#007aff; text-decoration:none;">${part.trim()}</a>`;
    }
    return part; // Sinon on garde tel quel
  }).join("");
}
    
</script>

</body>
</html>
