<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Nono Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>

    .control-group {
  margin-bottom: 10px; /* espace entre localisation et filtres */
}
    
#version-label {
  position: fixed;
  bottom: 6px;
  left: 8px;    /* üëà affichage √† gauche */
  font-size: 11px;
  color: rgba(255,255,255,0.45);
  font-family: system-ui, sans-serif;
  pointer-events: none;
  user-select: none;
}
    /* Boutons ronds √† gauche (ON = blanc, OFF = noir translucide) */
.btn-toggle{
  background: rgba(0,0,0,.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;          /* taille identique */
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;                    /* emoji inchang√© */
  color: #fff;
  cursor: pointer;
  margin: 10px 5px;                   /* ‚Üë plus d‚Äôespace vertical */
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.btn-toggle.active {
  background: #fff;
  color: #111;
}
    
    :root { --accent:#4f46e5; --bg:#0b0c0e; --ink:#f9fafb; --glass:rgba(17,19,23,.65); --border:rgba(255,255,255,.12); }
    html, body { height:100%; margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif; background:var(--bg); color:var(--ink); }
    #map { width:100%; height:100%; }

    .icon-circle { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:15px; font-weight:bold; }
    .poste { background:#e11d48; } .appareil { background:#facc15; } .acces { background:#3b82f6; }
   .leaflet-control-custom{
  background: rgba(0,0,0,0.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;             /* + grand = touch friendly */
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  color: #fff;
  cursor: pointer;
  margin: 5px;
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;                         /* √©vite l‚Äôemoji coup√© */
  -webkit-tap-highlight-color: transparent;
}
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
const map = L.map('map', { zoomControl: false }).setView([46.8, 2.5], 6);

    // --- FONDS DE CARTE ------------------------------------------------------

    // PLAN IGN (WMTS GetTile)
    const planIGN = L.tileLayer(
      "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
      + "&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png"
      + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
      {
        attribution: "¬© IGN ‚Äì G√©oplateforme",
        maxZoom: 19,
        tileSize: 256,
        crossOrigin: 'anonymous'
      }
    );

    // ORTHO IGN (vue a√©rienne)
    const orthoIGN = L.tileLayer(
      "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
      + "&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&STYLE=normal&FORMAT=image/jpeg"
      + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
      {
        attribution: "¬© IGN ‚Äì G√©oplateforme",
        maxZoom: 19,
        tileSize: 256,
        crossOrigin: 'anonymous'
      }
    );

    // OpenStreetMap (secours)
    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { attribution: "¬© OpenStreetMap contributors", maxZoom: 19 }
    );

// Afficher ORTHO IGN (vue satellite) par d√©faut
orthoIGN.addTo(map);

// S√©lecteur de fonds (ordre : Satellite, Plan, OSM)
L.control.layers(
  { 
    "Vue satellite IGN": orthoIGN,
    "Plan IGN": planIGN,
    "OpenStreetMap": osm
  },
  {}
).addTo(map);

    // Zoom sous le s√©lecteur de fonds (m√™me coin)
L.control.zoom({ position: 'topright' }).addTo(map);

    // Logs d'erreurs de tuiles (debug)
    planIGN.on("tileerror", e => console.warn("IGN PLAN tile error", e));
    orthoIGN.on("tileerror", e => console.warn("IGN ORTHO tile error", e));

    // --- COUCHES M√âTIER ------------------------------------------------------

    const postesLayer = L.layerGroup().addTo(map);
    const appareilsLayer = L.layerGroup().addTo(map);
    const accesLayer = L.layerGroup().addTo(map);
    const allMarkers = [];

    const iconPoste   = L.divIcon({className:"icon-circle poste",   html:"üìç"});
    const iconAppareil= L.divIcon({className:"icon-circle appareil",html:"‚ö°"});
    const iconAcces   = L.divIcon({className:"icon-circle acces",   html:"üöô"});

    // Postes (acc√®s + gu√©rite)
    fetch("postes.json")
      .then(r => r.json())
      .then(data => {
        data.forEach(item => {
         if (item.latitude && item.longitude) {
  const lat = item.latitude, lon = item.longitude;
  let content = `
    <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
                font-size:14px; color:#111; line-height:1.4; max-width:240px;">
  <div style="font-weight:600; font-size:15px; margin-bottom:4px;">
  üìç ${item.nom || "Sans nom"} 
  ${item.type ? item.type : ""} 
  ${item.SAT ? " " + item.SAT : ""} 
  ${item.acces ? " ‚Äì " + item.acces : ""}
</div>

      <div style="margin-bottom:6px; color:#333;">
        ${item.pk 
          ? `üöÑ PK ${item.pk} sur la ligne n¬∞${item.numero_ligne || ""} ‚Äì ${item.lignes || ""}`
          : `üöÑ ligne n¬∞${item.numero_ligne || ""} ‚Äì ${item.lignes || ""}`}
      </div>

      ${item.portail ? `<div>üîë Portail : ${item.portail}</div>` : ""}
      ${item.contact ? `<div>üìû Contact : ${item.contact}</div>` : ""}
      ${item.description ? `<div>‚ÑπÔ∏è ${item.description}</div>` : ""}

      <div style="margin-top:6px;">
        <a href="https://www.google.com/maps?q=&layer=c&cbll=${lat},${lon}" target="_blank"
           style="color:#007aff; text-decoration:none; margin-right:8px;">üì∑ Street View</a>
        <a href="index.html?nom=${encodeURIComponent(item.nom)}" target="_blank"
           style="color:#007aff; text-decoration:none;">‚Ü©Ô∏è Retour fiche</a>
      </div>
    </div>
  `;

  const m = L.marker([lat, lon], {icon: iconAcces}).bindPopup(content).addTo(accesLayer);
  allMarkers.push(m);
}
          if (item.poste_latitude && item.poste_longitude) {
            let content = `<b>${item.nom || "Sans nom"}</b><br>`;
            if (item.type)      content += `Type: ${item.type}<br>`;
            if (item.SAT)       content += `SAT: ${item.SAT}<br>`;
            if (item.lignes)    content += `Ligne: ${item.lignes}<br>`;
            if (item.pk)        content += `PK: ${item.pk}<br>`;
            if (item.rss)       content += `RSS: ${item.rss}<br>`;
            if (item.contact)   content += `Contact: ${item.contact}<br>`;
            if (item.portail)   content += `Portail: ${item.portail}<br>`;
            if (item.description) content += `<i>${item.description}</i><br>`;
            if (item.nom)       content += `<br><a href="index.html?nom=${encodeURIComponent(item.nom)}" target="_blank">‚Ü©Ô∏è Retour fiche</a>`;
            const m = L.marker([item.poste_latitude, item.poste_longitude], {icon: iconPoste}).bindPopup(content).addTo(postesLayer);
            allMarkers.push(m);
          }
        });
      });

    // Appareils
    fetch("appareils.json")
      .then(r => r.json())
      .then(data => {
        data.forEach(item => {
          if (item.latitude && item.longitude) {
            let content = `<b>${item.nom || "Sans nom"}</b><br>`;
            if (item.type)      content += `Type: ${item.type}<br>`;
            if (item.SAT)       content += `SAT: ${item.SAT}<br>`;
            if (item.appareil)  content += `Appareil: ${item.appareil}<br>`;
            if (item.lignes)    content += `Ligne: ${item.lignes}<br>`;
            if (item.pk)        content += `PK: ${item.pk}<br>`;
            if (item.description) content += `<i>${item.description}</i><br>`;
            if (item.nom)       content += `<br><a href="index.html?nom=${encodeURIComponent(item.nom)}" target="_blank">‚Ü©Ô∏è Retour fiche</a>`;
            const m = L.marker([item.latitude, item.longitude], {icon: iconAppareil}).bindPopup(content).addTo(appareilsLayer);
            allMarkers.push(m);
          }
        });
      });

// Colonne de gauche : recentrer + localisation + filtres
const leftControls = L.control({ position: "topleft" });
leftControls.onAdd = function() {
  const container = L.DomUtil.create("div");

  // Groupe haut : üéØ recentrer + üìç localisation
  const topGroup = L.DomUtil.create("div", "control-group", container);

// üéØ Recentrer (bouton clignote actif le temps du centrage)
const recenterBtn = L.DomUtil.create("div", "btn-toggle", topGroup);
recenterBtn.innerHTML = "üéØ";

recenterBtn.onclick = () => {
  if (allMarkers.length > 0) {
    recenterBtn.classList.add("active"); // ON ‚Üí bouton blanc
    const group = L.featureGroup(allMarkers);
    map.fitBounds(group.getBounds().pad(0.2));

    // apr√®s un court d√©lai, on d√©sactive pour revenir en noir
    setTimeout(() => {
      recenterBtn.classList.remove("active");
    }, 800); // 0.8s = assez pour voir l'effet
  }
};

L.DomEvent.disableClickPropagation(recenterBtn);
L.DomEvent.disableScrollPropagation(recenterBtn);

// üìç Localisation (toggle ON/OFF avec bouton actif/inactif)
let userMarker;
let geoWatchId = null;
const locateBtn = L.DomUtil.create("div", "btn-toggle", topGroup);
locateBtn.innerHTML = "üìç";

locateBtn.onclick = () => {
  if (!navigator.geolocation) return alert("G√©olocalisation non support√©e.");

  if (geoWatchId !== null) {
    // üî¥ D√©sactivation
    navigator.geolocation.clearWatch(geoWatchId);
    geoWatchId = null;
    if (userMarker) {
      map.removeLayer(userMarker);
      userMarker = null;
    }
    locateBtn.classList.remove("active");
    return;
  }

  // üü¢ Activation
  geoWatchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    if (userMarker) {
      userMarker.setLatLng([lat, lng]);
    } else {
      userMarker = L.circleMarker([lat, lng], {
        radius: 8,
        color: "#3b82f6",
        fillColor: "#3b82f6",
        fillOpacity: 0.6
      }).addTo(map);
    }
    map.setView([lat, lng], 15);
  });

  locateBtn.classList.add("active");
};

L.DomEvent.disableClickPropagation(locateBtn);
L.DomEvent.disableScrollPropagation(locateBtn);

  // Groupe bas : üöô, üìç, ‚ö°
  const bottomGroup = L.DomUtil.create("div", "control-group", container);

  function makeBtn(emoji, layer, initiallyOn = true) {
    const b = L.DomUtil.create("div", "btn-toggle" + (initiallyOn ? " active" : ""), bottomGroup);
    b.innerHTML = emoji;
    b.onclick = () => {
      if (map.hasLayer(layer)) {
        map.removeLayer(layer);
        b.classList.remove("active");
      } else {
        map.addLayer(layer);
        b.classList.add("active");
      }
    };
    return b;
  }

  makeBtn("üöô", accesLayer, true);
  makeBtn("üìç", postesLayer, true);
  makeBtn("‚ö°", appareilsLayer, true);

  return container;
};
leftControls.addTo(map);

    
    // Au chargement ‚Üí centrer automatiquement comme üéØ
map.whenReady(() => {
  if (allMarkers.length > 0) {
    const group = L.featureGroup(allMarkers);
    map.fitBounds(group.getBounds().pad(0.2));
  }
});
    
  </script>
  <div id="version-label">Nono Maps V1</div>
</body>
</html>
