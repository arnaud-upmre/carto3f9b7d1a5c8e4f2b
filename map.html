<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Nono Maps</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <style>
  
    .icon-halo {
  width: 48px;   /* üëà adapte la taille ici */
  height: 48px;
  filter: drop-shadow(0 0 2px white) drop-shadow(0 0 4px white);
}
    .icon-halo-appareil {
  width: 24px;   /* üëà taille r√©duite seulement pour les appareils */
  height: 24px;
  filter: drop-shadow(0 0 4px white) drop-shadow(0 0 8px white);
}
    
.icon-wrapper {
  display: inline-block;
  border-radius: 50%;          /* halo arrondi */
  padding: 4px;                /* espace autour */
  background: white;           /* halo blanc */
  box-shadow: 0 0 6px rgba(0,0,0,0.4); /* ombre discr√®te */
}

.icon-wrapper img {
  width: 44px;
  height: 44px;
  display: block;
}
/* === CLUSTERS LIQUID GLASS iOS === */
.marker-cluster {
  background: transparent !important; /* pas de fond autour */
  border-radius: 50%;
}

.marker-cluster div {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, sans-serif;
  font-weight: 600;
  font-size: 14px;
  color: #ffffff;
  text-shadow: 0 0 3px rgba(0,0,0,0.8), 0 0 6px rgba(0,0,0,0.6); /* contour autour des chiffres */
  background: rgba(255, 255, 255, 0.15);   /* bulle translucide claire */
  backdrop-filter: blur(10px);             
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  transition: transform 0.25s ease, background 0.3s ease;
}

/* Survol / tap ‚Üí bulle l√©g√®rement plus claire et grossit */
.marker-cluster:hover div {
  transform: scale(1.12);
  background: rgba(255, 255, 255, 0.25);
}

    .control-group {
  margin-bottom: 10px; /* espace entre localisation et filtres */
}
    .control-group + .control-group {
  margin-top: 45px; /* espace entre le groupe haut et le groupe bas */
}
    
#version-label {
  position: fixed;
  bottom: 6px;
  left: 8px;    /* üëà affichage √† gauche */
  font-size: 11px;
  color: rgba(255,255,255,0.45);
  font-family: system-ui, sans-serif;
  pointer-events: none;
  user-select: none;
}
    /* Boutons ronds √† gauche (ON = blanc, OFF = noir translucide) */
.btn-toggle{
  background: rgba(0,0,0,.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;          /* taille identique */
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;                    /* emoji inchang√© */
  color: #fff;
  cursor: pointer;
  margin: 10px 5px;                   /* ‚Üë plus d‚Äôespace vertical */
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.btn-toggle.active {
  background: #fff;
  color: #111;
}
    
    :root { --accent:#4f46e5; --bg:#0b0c0e; --ink:#f9fafb; --glass:rgba(17,19,23,.65); --border:rgba(255,255,255,.12); }
    html, body { height:100%; margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif; background:var(--bg); color:var(--ink); }
    #map { width:100%; height:100%; }

    .icon-circle { width:26px; height:26px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:15px; font-weight:bold; }
    .poste { background:#e11d48; } .appareil { background:#facc15; } .acces { background:#3b82f6; }
   .leaflet-control-custom{
  background: rgba(0,0,0,0.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;             /* + grand = touch friendly */
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  color: #fff;
  cursor: pointer;
  margin: 5px;
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;                         /* √©vite l‚Äôemoji coup√© */
  -webkit-tap-highlight-color: transparent;
}
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
const defaultCenter = [49.8, 2.5]; // ajuste latitude/longitude
const defaultZoom = 8;             // ajuste niveau de zoom

const map = L.map('map', { zoomControl: false, attributionControl: false })
             .setView(defaultCenter, defaultZoom);
    const allMarkers = [];

    // helper : cr√©e un HTML cliquable si la valeur ressemble √† un vrai t√©l√©phone
function makeTelHtml(labelEmoji, value) {
  if (!value) return "";
  // si contient # => on refuse (ex: 4242#)
  if (value.indexOf("#") !== -1) return `<div>${labelEmoji} ${value}</div>`;

  // compter les chiffres pour s'assurer que c'est bien un num√©ro (min 10 chiffres)
  const digitsOnly = ("" + value).replace(/\D/g, "");
  if (digitsOnly.length < 10) return `<div>${labelEmoji} ${value}</div>`;

  // autoriser dans le href : chiffres, +, comma (,) et √©toile (*)
  // retirer tout le reste (espaces, points, slash, parenth√®ses, etc.)
  const hrefSafe = ("" + value).replace(/[^\d,+*+]/g, "").replace(/\s+/g, "");

  // si apr√®s nettoyage on a rien -> afficher texte simple
  if (!hrefSafe) return `<div>${labelEmoji} ${value}</div>`;

  return `<div>${labelEmoji} <a href="tel:${hrefSafe}" style="color:#007aff; text-decoration:none;">${value}</a></div>`;
}

    // --- Lecture param√®tres URL ---
const params = new URLSearchParams(window.location.search);
const lat = parseFloat(params.get("lat"));
const lon = parseFloat(params.get("lon"));
const zoom = parseInt(params.get("z")) || 19;
const id = params.get("id") ? decodeURIComponent(params.get("id")) : null;

// Si coordonn√©es fournies ‚Üí recentrer la carte
if (!isNaN(lat) && !isNaN(lon)) {
  map.setView([lat, lon], zoom);
}
    
        // --- FONDS DE CARTE ------------------------------------------------------

    // PLAN IGN (WMTS GetTile)
    const planIGN = L.tileLayer(
      "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
      + "&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png"
      + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
      {
        attribution: "",
        maxZoom: 19,
        tileSize: 256,
        crossOrigin: 'anonymous'
      }
    );

    // ORTHO IGN (vue a√©rienne)
    const orthoIGN = L.tileLayer(
      "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
      + "&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&STYLE=normal&FORMAT=image/jpeg"
      + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
      {
        attribution: "¬© IGN ‚Äì G√©oplateforme",
        maxZoom: 19,
        tileSize: 256,
        crossOrigin: 'anonymous'
      }
    );

    // OpenStreetMap (plan secours)
    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { attribution: "¬© OpenStreetMap contributors", maxZoom: 19 }
    );

    // Satellite Open (Esri World Imagery)
    const esriSat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        attribution: "¬© Esri, Maxar, Earthstar Geographics",
        maxZoom: 19
      }
    );

// Vue mixte = satellite IGN + Plan IGN en transparence
const mixte = L.layerGroup([
  orthoIGN,
  L.tileLayer(
    "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
    + "&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png"
    + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
    {
      attribution: "¬© IGN ‚Äì G√©oplateforme",
      maxZoom: 19,
      tileSize: 256,
      crossOrigin: 'anonymous',
      opacity: 0.4  // üëà ajuste la transparence
    }
  )
]);

 // Afficher ORTHO IGN (satellite) par d√©faut
orthoIGN.addTo(map);

    // S√©lecteur de fonds
    L.control.layers(
      { 
        "üõ∞Ô∏è Satellite IGN": orthoIGN,
        "üõ∞Ô∏è Satellite Open": esriSat,
        "üó∫Ô∏è Plan IGN (d√©faut)": planIGN,
        "üåç Plan Open": osm,
        "üõ∞Ô∏è+üó∫Ô∏è Mixte": mixte
      },
      {}
    ).addTo(map);

    // Zoom sous le s√©lecteur de fonds (m√™me coin)
    L.control.zoom({ position: 'topright' }).addTo(map);

    
    // Logs d'erreurs de tuiles (debug)
    planIGN.on("tileerror", e => console.warn("IGN PLAN tile error", e));
    orthoIGN.on("tileerror", e => console.warn("IGN ORTHO tile error", e));

    // --- COUCHES M√âTIER ------------------------------------------------------

const postesLayer = L.markerClusterGroup({
  disableClusteringAtZoom: 18
});
const appareilsLayer = L.markerClusterGroup({
  disableClusteringAtZoom: 18
});
const accesLayer = L.markerClusterGroup({
  spiderfyOnMaxZoom: true,   // cercle √©clat√© m√™me au max zoom
  showCoverageOnHover: false,
  zoomToBoundsOnClick: false
  // ‚ö†Ô∏è on ne met pas disableClusteringAtZoom
});

map.addLayer(postesLayer);
map.addLayer(appareilsLayer);
map.addLayer(accesLayer);


// Ic√¥ne gu√©rite personnalis√©e avec halo
const iconPoste = L.divIcon({
  html: `<img src="ico/poste.png" class="icon-halo">`,
  className: "",  // pas de CSS par d√©faut
  iconAnchor: [24, 48],
  popupAnchor: [0, -48]
});

// On garde les autres en bulles color√©es
const iconAppareil= L.divIcon({className:"icon-circle appareil",html:"‚ö°"});

    // Ic√¥ne acc√®s personnalis√©e avec halo
const iconAcces = L.divIcon({
  html: `<img src="ico/acces.png" class="icon-halo">`,
  className: "",
  iconAnchor: [24, 48],
  popupAnchor: [0, -48]
});

// Postes (acc√®s + gu√©rite)
fetch("postes.json")
  .then(r => r.json())
  .then(data => {
    data.forEach(item => {

      // === Bloc ACC√àS ===
      if (item.latitude && item.longitude) {
      const cid = [item.nom, item.type, item.SAT, item["acc√®s"]].filter(Boolean).join(" ");

        let content = `
          <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
                      font-size:14px; color:#111; line-height:1.4; max-width:240px;">
<div style="font-weight:600; font-size:15px; margin-bottom:4px;">
  üìç ${item.nom || "Sans nom"} 
  ${item.type ? " " + item.type : ""} 
  ${item.SAT ? " " + item.SAT : ""} 
  ${item["acc√®s"] ? " ‚Äì acc√®s " + item["acc√®s"] : ""}
</div>

            <div style="margin-bottom:6px; color:#333;">
              ${item.pk 
                ? `üöÑ PK ${item.pk} sur la ligne n¬∞${item.numero_ligne || ""} ‚Äì ${item.lignes || ""}`
                : `üöÑ ligne n¬∞${item.numero_ligne || ""} ‚Äì ${item.lignes || ""}`}
            </div>

            ${ makeTelHtml("üîë", item.portail) }
            ${ makeTelHtml("üìû", item.contact) }
            ${item.description ? `<div>‚ÑπÔ∏è ${item.description}</div>` : ""}

            <div style="margin-top:6px;">
              <a href="index.html?id=${encodeURIComponent(cid)}"
                 style="color:#007aff; text-decoration:none;">‚Ü©Ô∏è Retour fiche</a>
            </div>
          </div>
        `;

        const m = L.marker([item.latitude, item.longitude], {
          icon: iconAcces,
          customId: cid
        }).bindPopup(content).addTo(accesLayer);

        allMarkers.push(m);
      }

      // === Bloc POSTE (gu√©rite) ===
      if (item.poste_latitude && item.poste_longitude) {
        const cid = [item.nom, item.type, item.SAT, "poste"].filter(Boolean).join(" ");

        let content = `
          <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
                      font-size:14px; color:#111; line-height:1.4; max-width:240px;">
        <div style="font-weight:600; font-size:15px; margin-bottom:4px;">
  üìç ${item.nom || "Sans nom"} 
  ${item.type ? " " + item.type : ""} 
  ${item.SAT ? " " + item.SAT : ""}
</div>

            <div style="margin-bottom:6px; color:#333;">
              ${item.pk 
                ? `üöÑ PK ${item.pk} sur la ligne n¬∞${item.numero_ligne || ""} ‚Äì ${item.lignes || ""}`
                : `üöÑ ligne n¬∞${item.numero_ligne || ""} ‚Äì ${item.lignes || ""}`}
            </div>

            ${ makeTelHtml("üîë", item.portail) }
            ${ makeTelHtml("üìû", item.contact) }
            ${item.description ? `<div>‚ÑπÔ∏è ${item.description}</div>` : ""}

            <div style="margin-top:6px;">
              <a href="index.html?id=${encodeURIComponent(cid)}"
                 style="color:#007aff; text-decoration:none;">‚Ü©Ô∏è Retour fiche</a>
            </div>
          </div>
        `;

        const m = L.marker([item.poste_latitude, item.poste_longitude], {
          icon: iconPoste,
          customId: cid
        }).bindPopup(content).addTo(postesLayer);

        allMarkers.push(m);
      }

    });
  });

// Appareils
fetch("appareils.json")
  .then(r => r.json())
  .then(data => {

    data.forEach(item => {
  const cid = [item.nom, item.type, item.SAT, "appareil", item.appareil].filter(Boolean).join(" ");

  let content = `
    <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
                font-size:14px; color:#111; line-height:1.4; max-width:240px;">
      <div style="font-size:15px; margin-bottom:6px;">
        <span style="font-weight:600;">
          ${item.appareil || "Sans r√©f√©rence"}
        </span>
        <span>
          ${item.nom ? " " + item.nom : ""} 
          ${item.type ? " " + item.type : ""} 
          ${item.SAT ? " (" + item.SAT + ")" : ""}
        </span>
      </div>

      ${item.description ? `<div style="margin-bottom:6px;">‚ÑπÔ∏è ${item.description}</div>` : ""}

      <div style="margin-top:6px;">
        <a href="index.html?id=${encodeURIComponent(cid)}"
           style="color:#007aff; text-decoration:none;">‚Ü©Ô∏è Retour fiche</a>
      </div>
    </div>
  `;

  // Choix de l‚Äôic√¥ne selon le type d‚Äôappareil
  let appareilIcon;
  if (item.appareil && item.appareil.toUpperCase().startsWith("I")) {
    appareilIcon = L.divIcon({
      html: `<img src="ico/int.png" class="icon-halo-appareil">`,
      className: "",
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
  } else if (
    item.appareil &&
    (item.appareil.toUpperCase().startsWith("TT") ||
     item.appareil.toUpperCase().startsWith("TSA") ||
     item.appareil.toUpperCase().startsWith("TC"))
  ) {
    appareilIcon = L.divIcon({
      html: `<img src="ico/TT.png" class="icon-halo-appareil">`,
      className: "",
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
  } else if (
    item.appareil &&
    (
      /^[0-9]/.test(item.appareil) ||
      item.appareil.toUpperCase().startsWith("S") ||
      item.appareil.toUpperCase().startsWith("ST") ||
      item.appareil.toUpperCase().startsWith("F IL") ||
      /^P[0-9]+/i.test(item.appareil)
    )
  ) {
    appareilIcon = L.divIcon({
      html: `<img src="ico/sect.png" class="icon-halo-appareil">`,
      className: "",
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
  } else if (item.appareil && item.appareil.toUpperCase().startsWith("SI")) {
    appareilIcon = L.divIcon({
      html: `<img src="ico/int.png" class="icon-halo-appareil">`,
      className: "",
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
  } else {
    appareilIcon = iconAppareil;
  }

  const m = L.marker([item.latitude, item.longitude], {
    icon: appareilIcon,
    customId: cid
  }).bindPopup(content).addTo(appareilsLayer);
  allMarkers.push(m);
});

    // Une fois que tous les markers (postes + appareils) sont charg√©s
    if (id) {
      setTimeout(() => {
        let found = false;
        allMarkers.forEach(m => {
          const cid = (m.options.customId || "").trim().toLowerCase();
          if (cid === id.trim().toLowerCase()) {
            const ll = m.getLatLng();
            if (ll) {
              m.openPopup();
              map.setView(ll, zoom);
              found = true;
            }
          }
        });
        if (!found) {
          console.warn("‚ö†Ô∏è Aucun marker trouv√© pour id=", id);
        }
      }, 300); // d√©lai pour √™tre s√ªr que tout est charg√©
    }
      }); 

// Colonne de gauche : recentrer + localisation + filtres
const leftControls = L.control({ position: "topleft" });
leftControls.onAdd = function() {
  const container = L.DomUtil.create("div");

  

  // Groupe haut : üéØ recentrer + üìç localisation
  const topGroup = L.DomUtil.create("div", "control-group", container);
// üîç Retour √† l‚Äôindex
const searchBtn = L.DomUtil.create("div", "btn-toggle", topGroup);
searchBtn.innerHTML = "üîç";

searchBtn.onclick = () => {
  window.location.href = "index.html";  // redirection vers la page d‚Äôaccueil
};

L.DomEvent.disableClickPropagation(searchBtn);
L.DomEvent.disableScrollPropagation(searchBtn);
// üéØ Recentrer (bouton clignote actif le temps du centrage)
const recenterBtn = L.DomUtil.create("div", "btn-toggle", topGroup);
recenterBtn.innerHTML = "üéØ";

recenterBtn.onclick = () => {
  if (allMarkers.length > 0) {
    recenterBtn.classList.add("active"); // ON ‚Üí bouton blanc
 map.setView(defaultCenter, defaultZoom);

    // apr√®s un court d√©lai, on d√©sactive pour revenir en noir
    setTimeout(() => {
      recenterBtn.classList.remove("active");
    }, 800); // 0.8s = assez pour voir l'effet
  }
};

L.DomEvent.disableClickPropagation(recenterBtn);
L.DomEvent.disableScrollPropagation(recenterBtn);

// üìç Localisation (toggle ON/OFF avec bouton actif/inactif)
let userMarker;
let geoWatchId = null;
const locateBtn = L.DomUtil.create("div", "btn-toggle", topGroup);
locateBtn.innerHTML = "üìç";

locateBtn.onclick = () => {
  if (!navigator.geolocation) return alert("G√©olocalisation non support√©e.");

  if (geoWatchId !== null) {
    // üî¥ D√©sactivation
    navigator.geolocation.clearWatch(geoWatchId);
    geoWatchId = null;
    if (userMarker) {
      map.removeLayer(userMarker);
      userMarker = null;
    }
    locateBtn.classList.remove("active");
    return;
  }

  // üü¢ Activation
  geoWatchId = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    if (userMarker) {
      userMarker.setLatLng([lat, lng]);
    } else {
      userMarker = L.circleMarker([lat, lng], {
        radius: 8,
        color: "#3b82f6",
        fillColor: "#3b82f6",
        fillOpacity: 0.6
      }).addTo(map);
    }
    map.setView([lat, lng], 15);
  });

  locateBtn.classList.add("active");
};

L.DomEvent.disableClickPropagation(locateBtn);
L.DomEvent.disableScrollPropagation(locateBtn);

  // Groupe bas : üöô, üìç, ‚ö°
  const bottomGroup = L.DomUtil.create("div", "control-group", container);

  function makeBtn(emoji, layer, initiallyOn = true) {
    const b = L.DomUtil.create("div", "btn-toggle" + (initiallyOn ? " active" : ""), bottomGroup);
    b.innerHTML = emoji;
    b.onclick = () => {
      if (map.hasLayer(layer)) {
        map.removeLayer(layer);
        b.classList.remove("active");
      } else {
        map.addLayer(layer);
        b.classList.add("active");
      }
    };
    return b;
  }

  makeBtn("üöô", accesLayer, true);
  makeBtn("üìç", postesLayer, true);
  makeBtn("‚ö°", appareilsLayer, true);

  return container;
};
leftControls.addTo(map);

// Au chargement ‚Üí centrer automatiquement UNIQUEMENT si pas d'ID dans l'URL
if (!id) {
  map.whenReady(() => {
    if (allMarkers.length > 0) {
      const group = L.featureGroup(allMarkers);
      map.fitBounds(group.getBounds());
    }
  });
}
    
  </script>
  <div id="version-label">Nono Maps V1.01</div>
</body>
</html>
