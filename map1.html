<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de travail d’avancement – v1.3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Inter, system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    h1 { margin-bottom: 10px; font-size: 22px; }

    .counters {
      font-size: 15px;
      margin-bottom: 15px;
      font-weight: 600;
      color: #374151;
    }

    .actions {
      margin-bottom: 22px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 8px 12px;
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border: none;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 8px 14px;
      background: #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active {
      background: #3b82f6;
      color: white;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 18px;
    }

    .poste-card {
      background: white;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: all .2s ease;
    }

    .poste-card.collapsed .sat-group { display: none; }
    .poste-card.collapsed .poste-title { margin-bottom: 0; }

    .poste-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .type-badge {
      background: #dbeafe;
      border: 1px solid #bfdbfe;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #1e40af;
      white-space: nowrap;
    }

    .sat-group {
      background: #f9fafb;
      border: 1px dashed #d1d5db;
      padding: 10px;
      border-radius: 10px;
      margin-top: 8px;
    }

    .sat-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sat-badge {
      background: #fef9c3;
      border: 1px solid #facc15;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
    }

    .principal-badge {
      background: #e5e7eb;
      border: 1px solid #d1d5db;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    .device-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .device-pill {
      background: white;
      border: 1px solid #d1d5db;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease-in-out;
    }

    .device-pill:hover {
      transform: scale(1.06);
      background: #e8f1ff;
      border-color: #93c5fd;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .device-pill a {
      text-decoration: none;
      color: inherit;
    }

    .hp {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #b91c1c;
    }

    .empty-msg {
      font-size: 12px;
      color: #6b7280;
      font-style: italic;
    }
  </style>
</head>

<body>

<h1>Tableau de travail d’avancement – v1.3</h1>

<div id="counters" class="counters">Chargement…</div>

<div class="actions">
  <button class="btn" id="btnExpand">Tout déplier</button>
  <button class="btn" id="btnCollapse">Tout plier</button>
</div>

<div class="tabs">
  <div id="tabPatrimoine" class="tab active">Patrimoine</div>
  <div id="tabHP" class="tab">Hors patrimoine</div>
</div>

<div id="boardPatrimoine" class="board"></div>
<div id="boardHP" class="board" style="display:none;"></div>

<script>

const postesURL = "postes.json";
const appareilsURL = "appareils.json";

let postes = [];
let appareils = [];

/* --- Tri SAT : Poste principal → SAT → SAT1 → SAT2 → SAT10 --- */
function sortSatKeys(keys) {
  return keys.sort((a, b) => {
    if (a === "_principal") return -1;
    if (b === "_principal") return 1;
    const ex = s => {
      const m = s.match(/^sat(\d*)$/i);
      return m ? { base: "sat", num: m[1] ? parseInt(m[1],10) : 0 }
               : { base: s.toLowerCase(), num: null };
    };
    const A = ex(a), B = ex(b);
    if (A.base !== B.base) return A.base.localeCompare(B.base);
    if (A.num === null && B.num !== null) return -1;
    if (B.num === null && A.num !== null) return 1;
    if (A.num === null && B.num === null) return a.localeCompare(b);
    return A.num - B.num;
  });
}

Promise.all([fetch(postesURL), fetch(appareilsURL)])
  .then(async ([pRes, aRes]) => {
    postes = await pRes.json();
    appareils = await aRes.json();
    build();
  });

  /* --- Onglets --- */
document.getElementById("tabPatrimoine").onclick = () => switchTab("patrimoine");
document.getElementById("tabHP").onclick = () => switchTab("hp");

function switchTab(tab) {
  const isPat = tab === "patrimoine";
  document.getElementById("tabPatrimoine").classList.toggle("active", isPat);
  document.getElementById("tabHP").classList.toggle("active", !isPat);
  document.getElementById("boardPatrimoine").style.display = isPat ? "grid" : "none";
  document.getElementById("boardHP").style.display = isPat ? "none" : "grid";
}

/* --- Tout plier / déplier --- */
document.getElementById("btnExpand").onclick = () => {
  document.querySelectorAll(".poste-card").forEach(div => div.classList.remove("collapsed"));
};
document.getElementById("btnCollapse").onclick = () => {
  document.querySelectorAll(".poste-card").forEach(div => div.classList.add("collapsed"));
};

/* --- Construction globale --- */
function build() {

  /* INDEX des postes (hors special:true) */
  const metaMap = new Map();
  postes.forEach(p => {
    if (p.special === true) return;
    const key = `${p.nom}||${p.type}`;
    if (!metaMap.has(key)) {
      metaMap.set(key, {
        nom: p.nom,
        type: p.type,
        hors: p.hors_patrimoine === true
      });
    }
  });

  /* Appareils hors special:true */
  const validApps = appareils.filter(a => !a.special);

  /* Construction Postes → SAT → Appareils */
  const postesMap = new Map();

  // Appareils
  validApps.forEach(a => {
    const key = `${a.nom}||${a.type}`;
    if (!postesMap.has(key)) {
      const meta = metaMap.get(key) || { nom:a.nom, type:a.type, hors:false };
      postesMap.set(key, { ...meta, sats:{} });
    }
    const p = postesMap.get(key);
    const sat = a.SAT && a.SAT.trim() !== "" ? a.SAT.trim() : "_principal";
    if (!p.sats[sat]) p.sats[sat] = [];
    p.sats[sat].push(a);
  });

  // Postes n’ayant aucun appareil
  metaMap.forEach((meta, key) => {
    if (!postesMap.has(key)) {
      postesMap.set(key, { ...meta, sats:{} });
    }
  });

  const arr = Array.from(postesMap.values());

  /* Compteurs Patrimoine */
  const postesPat = arr.filter(p => !p.hors);
  const appsPat = validApps.filter(a => !a.hors_patrimoine);
  const satSetPat = new Set();
  appsPat.forEach(a => {
    if (!metaMap.get(`${a.nom}||${a.type}`).hors) {
      if (a.SAT?.trim()) satSetPat.add(`${a.nom}||${a.type}||${a.SAT}`);
    }
  });

  /* Compteurs HP */
  const postesHP = arr.filter(p => p.hors);
  const appsHP = validApps.filter(a => a.hors_patrimoine);
  const satSetHP = new Set();
  appsHP.forEach(a => {
    if (a.SAT?.trim()) satSetHP.add(`${a.nom}||${a.type}||${a.SAT}`);
  });

  document.getElementById("counters").textContent =
    `Patrimoine : ${postesPat.length} postes · ${satSetPat.size} SAT · ${appsPat.length} appareils  |  ` +
    `Hors patrimoine : ${postesHP.length} postes · ${satSetHP.size} SAT · ${appsHP.length} appareils`;

  /* Affichage Patrimoine */
  const boardP = document.getElementById("boardPatrimoine");
  boardP.innerHTML = "";
  postesPat.sort((a,b)=>a.nom.localeCompare(b.nom,"fr")).forEach(p=>{
    boardP.appendChild(renderPoste(p,false));
  });

  /* Affichage Hors Patrimoine */
  const boardH = document.getElementById("boardHP");
  boardH.innerHTML = "";

  arr.forEach(p=>{
    const hasHP = Object.values(p.sats).some(g => g.some(a=>a.hors_patrimoine));
    if (p.hors || hasHP) {
      boardH.appendChild(renderPoste(p,true));
    }
  });
}

/* --- Rendu d'un Poste entier --- */
function renderPoste(poste, isHP){
  const card = document.createElement("div");
  card.className = "poste-card";

  const title = document.createElement("div");
  title.className = "poste-title";
  title.innerHTML = `
    <span>${poste.nom}</span>
    ${poste.type ? `<span class="type-badge">${poste.type}</span>` : ""}
  `;
  card.appendChild(title);

  /* Clic sur le titre => plier/déplier */
  title.onclick = () => card.classList.toggle("collapsed");

  const sats = poste.sats;
  let keys = Object.keys(sats);
  if (keys.length === 0) keys = ["_principal"];
  keys = sortSatKeys(keys);

  keys.forEach(sat => {
    const groupHP = isHP
      ? (sats[sat] || []).filter(a => a.hors_patrimoine)
      : (sats[sat] || []).filter(a => !a.hors_patrimoine);

    const satDiv = document.createElement("div");
    satDiv.className = "sat-group";

    const titleDiv = document.createElement("div");
    titleDiv.className = "sat-title";

    const badge = sat === "_principal"
      ? `<span class="principal-badge">Poste principal</span>`
      : `<span class="sat-badge">${sat}</span>`;

    titleDiv.innerHTML = `
      ${badge}
      <span class="sat-count">${groupHP.length} appareil(s)</span>
    `;

    titleDiv.onclick = () => satDiv.classList.toggle("collapsed");

    const list = document.createElement("div");
    list.className = "device-list";

    if (groupHP.length === 0) {
      const msg = document.createElement("div");
      msg.className = "empty-msg";
      msg.textContent = "Aucun appareil enregistré pour le moment.";
      list.appendChild(msg);
    } else {
      groupHP.sort((a,b)=>a.appareil.localeCompare(b.appareil,"fr",{numeric:true})).forEach(a=>{
        const pill = document.createElement("div");
        pill.className = "device-pill";
        if (a.hors_patrimoine) pill.classList.add("hp");

        const id = `${a.appareil} ${a.nom} ${a.type || ""} ${a.SAT || ""}`.trim();
        const url = `index.html?id=${encodeURIComponent(id)}`;

        pill.innerHTML = `<a href="${url}">${a.appareil}</a>`;
        list.appendChild(pill);
      });
    }

    satDiv.appendChild(titleDiv);
    satDiv.appendChild(list);
    card.appendChild(satDiv);
  });

  return card;
}

</script>
</body>
</html>
