<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de travail d‚Äôavancement ‚Äì v1.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Inter, system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    h1 { margin-bottom: 10px; font-size: 22px; }

    .counters {
      font-size: 15px;
      margin-bottom: 15px;
      font-weight: 600;
      color: #374151;
    }

    /* Boutons plier / d√©plier */
    .actions {
      margin-bottom: 22px;
      display: flex;
      gap: 12px;
    }
    .btn {
      padding: 8px 12px;
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      border: none;
    }

    /* Onglets */
    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 8px 14px;
      background: #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active {
      background: #3b82f6;
      color: white;
    }

    /* Grille de postes */
    .board {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 18px;
    }

    .poste-card {
      background: white;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .poste-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .type-badge {
      background: #dbeafe;
      border: 1px solid #bfdbfe;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #1e40af;
    }

    /* SAT */
    .sat-group {
      background: #f9fafb;
      border: 1px dashed #d1d5db;
      padding: 10px;
      border-radius: 10px;
      margin-top: 8px;
      transition: all .2s ease;
    }
    .collapsed .device-list {
      display: none;
    }

    .sat-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      cursor: pointer;
    }

    .sat-badge {
      background: #fef9c3;
      border: 1px solid #facc15;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
    }

    .principal-badge {
      background: #e5e7eb;
      border: 1px solid #d1d5db;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Appareils */
    .device-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .device-pill {
      background: white;
      border: 1px solid #d1d5db;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease-in-out;
    }

    .device-pill:hover {
      transform: scale(1.06);
      background: #e8f1ff;
      border-color: #93c5fd;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .device-pill a {
      color: inherit;
      text-decoration: none;
    }

    .hp {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #b91c1c;
    }
  </style>
</head>

<body>

<h1>Tableau de travail d‚Äôavancement ‚Äì v1.2</h1>

<div id="counters" class="counters">Chargement‚Ä¶</div>

<div class="actions">
  <button class="btn" id="btnExpand">Tout d√©plier</button>
  <button class="btn" id="btnCollapse">Tout plier</button>
</div>

<div class="tabs">
  <div id="tabPatrimoine" class="tab active">Patrimoine</div>
  <div id="tabHP" class="tab">Hors patrimoine</div>
</div>

<div id="boardPatrimoine" class="board"></div>
<div id="boardHP" class="board" style="display:none;"></div>

<script>
const postesURL = "postes.json";
const appareilsURL = "appareils.json";

let postes = [];
let appareils = [];

/* Tri des SAT */
function sortSatKeys(keys) {
  return keys.sort((a, b) => {
    if (a === "_principal") return -1;
    if (b === "_principal") return 1;

    const ex = s => {
      const m = s.match(/^sat(\d*)$/i);
      return m ? { base: "sat", num: m[1] ? parseInt(m[1]) : 0 }
               : { base: s.toLowerCase(), num: null };
    };

    const A = ex(a), B = ex(b);

    if (A.base !== B.base) return A.base.localeCompare(B.base);
    if (A.num === null && B.num !== null) return -1;
    if (B.num === null && A.num !== null) return 1;
    if (A.num === null && B.num === null) return a.localeCompare(b);

    return A.num - B.num;
  });
}

Promise.all([fetch(postesURL), fetch(appareilsURL)])
.then(async ([pRes, aRes]) => {
  postes = await pRes.json();
  appareils = await aRes.json();
  build();
});

  function build() {
  // Exclure les special:true
  postes = postes.filter(p => !p.special);
  appareils = appareils.filter(a => !a.special);

  const mapHP = new Map();
  postes.forEach(p => mapHP.set(p.nom, !!p.hors_patrimoine));

  // Regrouper les appareils par poste
  const mapPostes = new Map();
  appareils.forEach(a => {
    const nom = a.nom?.trim();
    if (!nom) return;
    const sat = a.SAT && a.SAT.trim() !== "" ? a.SAT.trim() : "_principal";
    if (!mapPostes.has(nom)) mapPostes.set(nom, { sats: {}, horsPatrimoine: mapHP.get(nom) || false, type: a.type || "" });
    const p = mapPostes.get(nom);
    if (!p.sats[sat]) p.sats[sat] = [];
    p.sats[sat].push(a);
  });

  // Calcul des compteurs
  const postesPatrimoine = postes.filter(p => !p.hors_patrimoine).length;
  const postesHP = postes.filter(p => p.hors_patrimoine).length;

  const satsPatrimoine = new Set();
  const satsHP = new Set();
  appareils.forEach(a => {
    if (a.SAT && !a.hors_patrimoine) satsPatrimoine.add(a.nom + "_" + a.SAT);
    if (a.SAT && a.hors_patrimoine) satsHP.add(a.nom + "_" + a.SAT);
  });

  const appPatrimoine = appareils.filter(a => !a.hors_patrimoine).length;
  const appHP = appareils.filter(a => a.hors_patrimoine).length;

  document.getElementById("counters").innerHTML = `
  Patrimoine : üìç ${postesPatrimoine} postes ‚Ä¢ üõ∞Ô∏è ${satsPatrimoine.size} SAT ‚Ä¢ üîå ${appPatrimoine} appareils<br>
  Hors patrimoine : üìç ${postesHP} postes ‚Ä¢ üõ∞Ô∏è ${satsHP.size} SAT ‚Ä¢ üîå ${appHP} appareils
  `;

  // Construire cartes
  const boardP = document.getElementById("boardPatrimoine");
  const boardH = document.getElementById("boardHP");
  boardP.innerHTML = boardH.innerHTML = "";

  mapPostes.forEach((p, nom) => {
    const card = renderPoste(nom, p.type, p.sats, p.horsPatrimoine);
    if (p.horsPatrimoine) boardH.appendChild(card);
    else boardP.appendChild(card);
  });
}

// Rend une carte de poste
function renderPoste(nom, type, sats, horsP = false) {
  const card = document.createElement("div");
  card.className = "poste-card";

  const head = document.createElement("div");
  head.className = "poste-title";
  head.innerHTML = `<span>${nom}</span>${type ? `<span class="type-badge">${type}</span>` : ""}`;
  card.appendChild(head);

  const keys = sortSatKeys(Object.keys(sats));
  keys.forEach(sat => {
    const group = sats[sat] || [];
    const div = document.createElement("div");
    div.className = "sat-group collapsed";

    const title = document.createElement("div");
    title.className = "sat-title";
    title.innerHTML = sat === "_principal" ? `<span class="principal-badge">Poste principal</span>` : `<span class="sat-badge">${sat}</span>`;
    title.onclick = () => div.classList.toggle("collapsed");
    div.appendChild(title);

    const list = document.createElement("div");
    list.className = "device-list";
    if (group.length === 0) {
      list.innerHTML = `<div style="font-size:12px;color:#6b7280">Aucun appareil enregistr√© pour le moment.</div>`;
    } else {
      group.forEach(a => {
        const pill = document.createElement("div");
        pill.className = "device-pill" + (a.hors_patrimoine ? " hp" : "");
        const url = `index.html?id=${encodeURIComponent(a.appareil || a.nom || "")}`;
        pill.innerHTML = `<a href="${url}">${a.appareil || a.nom}</a>`;
        list.appendChild(pill);
      });
    }
    div.appendChild(list);
    card.appendChild(div);
  });
  return card;
}

// Tabs
document.getElementById("tabPatrimoine").onclick = () => tab("Patrimoine");
document.getElementById("tabHP").onclick = () => tab("HP");

function tab(which) {
  document.getElementById("tabPatrimoine").classList.toggle("active", which === "Patrimoine");
  document.getElementById("tabHP").classList.toggle("active", which === "HP");
  document.getElementById("boardPatrimoine").style.display = which === "Patrimoine" ? "grid" : "none";
  document.getElementById("boardHP").style.display = which === "HP" ? "grid" : "none";
}

// Boutons plier / d√©plier
document.getElementById("btnExpand").onclick = () => {
  document.querySelectorAll(".sat-group").forEach(g => g.classList.remove("collapsed"));
};
document.getElementById("btnCollapse").onclick = () => {
  document.querySelectorAll(".sat-group").forEach(g => g.classList.add("collapsed"));
};
</script>
</body>
</html>
