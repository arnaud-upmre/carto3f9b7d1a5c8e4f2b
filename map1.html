<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Nono Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  
  
<link rel="icon" href="favicon/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" as="script" crossorigin="anonymous">
<link rel="preload" href="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js" as="script">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<style>

  html, body {
  height: 100%;
  margin: 0;
  background: transparent;
}

  #map {
  width:100%;
  height:100%;
}


.fab-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 10000;
  display: flex;
  flex-direction: column-reverse; 
  align-items: center;
  gap: 20px; 
}

.fab {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: rgba(0,0,0,0.75);
  color: white;
  font-size: 28px;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.fab-options {
  width: 70px;
  background: rgba(0,0,0,0.7);
  border-radius: 40px;
  padding: 12px 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 14px;
  opacity: 0;
  max-height: 0;
  overflow: hidden;
  pointer-events: none;
  transition: all 0.35s ease;
}
.fab-options.show {
  opacity: 1;
  max-height: 400px;
  pointer-events: auto;
}

.fab-options button {
  border: none;
  background: none;   
  padding: 0;
  margin: 0;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}


.fab-options button img {
  width: 36px;
  height: 36px;
  transition: opacity .2s, filter .2s;
}


.fab-options button:not(.active) img {
  opacity: 0.5;
  filter: none;
}


.fab-options button.active {
  background: rgba(255,255,255,0.50); 
}
.fab-options button.active img {
  opacity: 1;  /* remet l‚Äôic√¥ne normale */
}
  
.toast {
  position: fixed;
  bottom: 140px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(37,99,235,0.9);
  color: white;
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 14px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.5s;
  z-index: 10001;
}
.toast.show {
  opacity: 1;
}


.leaflet-popup-content-wrapper {
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0.8) 0%,
    rgba(255, 255, 255, 0.7) 100%
  );
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.45);
  box-shadow: inset 0 1px 4px rgba(255,255,255,0.4),
              0 8px 24px rgba(0,0,0,0.25);
}
.leaflet-popup-tip {
  background: linear-gradient(
    135deg,
    rgba(255, 255, 255, 0.8) 0%,
    rgba(255, 255, 255, 0.7) 100%
  );
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);
  border: 1px solid rgba(255, 255, 255, 0.45);
}
.leaflet-popup-content {
  max-width: 240px !important; 
  min-width: 240px; 
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif;
  font-size: 14px;
  line-height: 1.4;
  color: #111;
  overflow: hidden;    
  text-align: left;      
}
.leaflet-popup-content div,
.leaflet-popup-content p {
  display: flex;
  align-items: center;
  gap: 6px;           
  margin: 4px 0;
  flex-wrap: wrap;      
}
.leaflet-popup-content img,
.leaflet-popup-content svg,
.leaflet-popup-content i {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
}
.leaflet-popup-content a {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  text-decoration: none;
}
.leaflet-popup-content a.cluster-link {
  display: block;
  padding: 8px 12px;
  border-radius: 8px;
  background: #f3f4f6;
  color: #007aff;
  text-decoration: none;
  font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif;
  font-size: 14px;
  margin: 2px 0;
  transition: background 0.2s;
}
.leaflet-popup-content a.cluster-link:hover,
.leaflet-popup-content a.cluster-link:active {
  background: #e5e7eb;
}

#streetview-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);     
  -webkit-backdrop-filter: blur(6px);
  display: none;
  z-index: 9999;
  display: flex;             
  align-items: center;
  justify-content: center;
}
#streetview-box {
  width: 90%;
  max-width: 900px;
  height: 70%;
  background: rgba(20,20,20,0.95);
  border-radius: 16px;
  box-shadow: 0 12px 40px rgba(0,0,0,0.5);
  overflow: hidden;
  position: relative;
}
#streetview-box iframe {
  width: 100%;
  height: 100%;
  border: none;
}
#streetview-close {
  position: absolute;
  top: 12px; right: 12px;
  font-size: 24px;
  background: rgba(0,0,0,0.6);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px; height: 40px;
  cursor: pointer;
  z-index: 2;
}

.btn-return {
  position: relative;
  animation: pulseHalo 1.8s infinite;
}
@keyframes pulseHalo {
  0%   { box-shadow: 0 0 0px rgba(255,255,255,0.6); }
  50%  { box-shadow: 0 0 15px rgba(255,255,255,0.9), 0 0 30px rgba(255,255,255,0.4); }
  100% { box-shadow: 0 0 0px rgba(255,255,255,0.6); }
}
.icon-halo {
  width: 36px;  
  height: 36px;
  filter: drop-shadow(0 0 2px white) drop-shadow(0 0 4px white);
}
.icon-halo-appareil {
  width: 24px;  
  height: 24px;
  filter: drop-shadow(0 0 4px white) drop-shadow(0 0 8px white);
}

.marker-cluster {
  background: transparent !important; 
  border-radius: 50%;
}
.marker-cluster div {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: -apple-system, BlinkMacSystemFont,"Segoe UI",Roboto,Inter,sans-serif;
  font-weight: 600;
  font-size: 14px;
  color: #ffffff;
  text-shadow: 0 0 3px rgba(0,0,0,0.8), 0 0 6px rgba(0,0,0,0.6); 
  background: rgba(255, 255, 255, 0.15);   
  backdrop-filter: blur(10px);             
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  transition: transform 0.25s ease, background 0.3s ease;
}
.marker-cluster:hover div {
  transform: scale(1.12);
  background: rgba(255, 255, 255, 0.25);
}

.control-group {
  margin-bottom: 10px; 
}


.btn-toggle{
  background: rgba(0,0,0,.7);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 50%;
  width: 44px; height: 44px;       
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;                
  color: #fff;
  cursor: pointer;
  margin: 10px 5px;              
  box-shadow: 0 4px 12px rgba(0,0,0,.25);
  user-select: none;
  line-height: 1;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.btn-toggle.active {
  background: #fff;
  color: #111;
}

:root {
  --accent:#4f46e5;
  --ink:#f9fafb;
  --glass:rgba(17,19,23,.65);
  --border:rgba(255,255,255,.12);
}

.icon-circle {
  width:26px;
  height:26px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  color:white;
  font-size:15px;
  font-weight:bold;
}

.appareil { background:#facc15; }

</style>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EMSCVXG71V"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EMSCVXG71V');
</script>
</head>
<body>
  
  <div id="map"></div>

<div class="fab-container">
  <button class="fab" id="fabBtn">‚ò∞</button>

  <div class="fab-options" id="fabOptions">
    <button class="btn-toggle active" onclick="toggleLayer(accesLayer, this, 'Acc√®s routiers')">
      <img src="ico/acces.png" alt="Acc√®s routiers">
    </button>
    <button class="btn-toggle active" onclick="toggleLayer(postesLayer, this, 'Postes')">
      <img src="ico/poste.png" alt="Postes">
    </button>
    <button class="btn-toggle active" onclick="toggleLayer(appareilsLayer, this, 'Appareils')">
      <img src="ico/int.png" alt="Appareils">
    </button>
<button class="btn-toggle" onclick="chargerPN(this)">
  <img src="ico/pn.png" alt="Passages √† niveau">
</button>

<button class="btn-toggle" id="btn-lignes" title="Afficher les lignes ferroviaires">
  <img src="ico/ligne.png" alt="Lignes ferroviaires">
</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<div id="streetview-overlay">
  <div id="streetview-box">
    <button id="streetview-close">‚ùå</button>
    <iframe id="streetview-frame"></iframe>
  </div>
</div>
  <script>
const defaultCenter = [50.3, 2.6];
const defaultZoom = 9;      


const boundsFrance = [
  [41.0, -5.5],  
  [51.5, 9.5]    
];

const map = L.map('map', {
  zoomControl: false,
  attributionControl: false,
  minZoom: 5,                  
  maxZoom: 21,                 
  maxBounds: boundsFrance,     
  maxBoundsViscosity: 1.0      
}).setView(defaultCenter, defaultZoom);

    
let editMode = false;   
  

const editBanner = document.createElement("div");
editBanner.style = `
  position: fixed;
  bottom: 10px; left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: white;
  font-family: system-ui, sans-serif;
  font-size: 13px;
  padding: 6px 12px;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  z-index: 9999;
  display: none;
`;
document.body.appendChild(editBanner);

const editIcon = document.createElement("div");
editIcon.textContent = "‚úèÔ∏è";
editIcon.style = `
  position: fixed;
  bottom: 40px; left: 12px;
  font-size: 18px;
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 6px 8px;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  z-index: 9999;
  display: none;
  font-family: system-ui, sans-serif;
`;
document.body.appendChild(editIcon);

document.addEventListener("keydown", function(e) {
  if (e.key.toLowerCase() === "i") {
    editMode = !editMode;

    editBanner.textContent = editMode ? "‚ÑπÔ∏è Mode information activ√©" : "‚ùå Mode information d√©sactiv√©";
    editBanner.style.display = "block";
    setTimeout(() => { editBanner.style.display = "none"; }, 2000);

    editIcon.textContent = "‚ÑπÔ∏è";
    editIcon.style.display = editMode ? "block" : "none";
  }


  if (e.key === "Escape" && editMode) {
    editMode = false;
    editBanner.textContent = "‚ùå Mode information d√©sactiv√©";
    editBanner.style.display = "block";
    setTimeout(() => { editBanner.style.display = "none"; }, 2000);
    editIcon.style.display = "none";
  }
});
    
    const allMarkers = [];

let _datasetsLoaded = 0;
function _tryOpenFromURL() {
  _datasetsLoaded++;
  if (_datasetsLoaded < 2) return; 

  if (!isNaN(lat) && !isNaN(lon)) {
    const matches = allMarkers.filter(m => {
      const ll = m.getLatLng();
      return ll.lat === lat && ll.lng === lon;
    });

if (matches.length > 0) {
  const first = matches[0].getLatLng();
  const allSameCoords = matches.every(m => m.getLatLng().equals(first));

map.setView(first, zoom);

 setTimeout(() => {
  if (matches.length === 1) {

    matches[0].openPopup();

  } else if (allSameCoords) {

    const items = matches.map((m, i) => {
      let label = m.options.customId || `√âl√©ment ${i + 1}`;
      return { label: label.replace(/\bposte\b/gi, "").trim(), idx: i };
    }).sort((a, b) => a.label.localeCompare(b.label, "fr", { numeric: true, sensitivity: "base" }));

    const html = `<div style="min-width:220px;display:flex;flex-direction:column;gap:6px">
      ${items.map(it => {
       const marker = matches[it.idx];
        const id = (marker.options.customId || "").toUpperCase();
        
let iconFile = null;

if (marker.options.isAcces) {
  iconFile = "acces.png";
} else if (id.includes("POSTE")) {
  iconFile = "poste.png";
} else {

if (id.startsWith("DU")) {
  iconFile = "stop.png";
} else if (id.startsWith("I") || id.startsWith("SI") || id.startsWith("D")) {
  iconFile = "int.png";
} else if (id.startsWith("TT") || id.startsWith("TSA") || id.startsWith("TC") || id.startsWith("TRA")) {
  iconFile = "TT.png";
} else if (/^[0-9]/.test(id) || id.startsWith("S") || id.startsWith("ST") || id.startsWith("F") || id.startsWith("P") || id.startsWith("FB") || id.startsWith("B")) {
  iconFile = "sect.png";
} else if (id.startsWith("ALIM")) {
  iconFile = "alim.png";
}
}

        return `
          <a href="#" class="cluster-link" data-idx="${it.idx}" style="display:flex;align-items:center;gap:6px;">
            ${iconFile ? `<img src="ico/${iconFile}" style="width:16px;height:16px;">` : ""}
            <span>${it.label}</span>
          </a>`;
      }).join("")}
    </div>`;

    L.popup()
      .setLatLng(first)
      .setContent(html)
      .openOn(map);

    setTimeout(() => {
      document.querySelectorAll(".leaflet-popup-content a.cluster-link").forEach(link => {
        link.addEventListener("click", (ev) => {
          ev.preventDefault();
          const idx = +ev.currentTarget.dataset.idx;
          const target = matches[idx];
          const content = target.getPopup() ? target.getPopup().getContent() : "";
          L.popup({ maxWidth: 240 })
            .setLatLng(target.getLatLng())
            .setContent(content)
            .openOn(map);
          map.panTo(target.getLatLng());
        });
      });
    }, 0);
  } else {

    const group = L.featureGroup(matches);
    map.fitBounds(group.getBounds());
  }
}, 300);

   
} else {
  map.setView([lat, lon], zoom);
}
  }
}



const params = new URLSearchParams(window.location.search);
const lat = parseFloat(params.get("lat"));
const lon = parseFloat(params.get("lon"));
const zoom = parseInt(params.get("z")) || 19;


  const planIGN = L.tileLayer(
  "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
  + "&LAYER=GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2&STYLE=normal&FORMAT=image/png"
  + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
  {
    attribution: "",
    maxZoom: 21,       
    maxNativeZoom: 19, 
    tileSize: 256,
    crossOrigin: 'anonymous'
  }
);

const orthoIGN = L.tileLayer(
  "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
  + "&LAYER=ORTHOIMAGERY.ORTHOPHOTOS&STYLE=normal&FORMAT=image/jpeg"
  + "&TILEMATRIXSET=PM&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
  {
    attribution: "¬© IGN ‚Äì G√©oplateforme",
    maxZoom: 21,      
    maxNativeZoom: 19, 
    tileSize: 256,
    crossOrigin: 'anonymous'
  }
);

const osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  { 
    attribution: "¬© OpenStreetMap contributors", 
    maxZoom: 21,        
    maxNativeZoom: 19   
  }
);

const esriSat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  {
    attribution: "¬© Esri, Maxar, Earthstar Geographics",
    maxZoom: 21,       
    maxNativeZoom: 19, 
    tileSize: 256
  }
);

const ignLabels = L.tileLayer(
  "https://data.geopf.fr/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0"
  + "&LAYER=GEOGRAPHICALNAMES.NAMES"
  + "&STYLE=normal"
  + "&FORMAT=image/png"
  + "&TILEMATRIXSET=PM"
  + "&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}",
  {
    attribution: "¬© IGN ‚Äì G√©oplateforme",
    maxZoom: 21,
    maxNativeZoom: 19,
    tileSize: 256,
    transparent: true,
    zIndex: 500,
    opacity: 1
  }
);

const satelliteIGN_labels = L.layerGroup([orthoIGN, ignLabels]);
    satelliteIGN_labels.addTo(map);

    

    L.control.layers(
      { 
        "üõ∞Ô∏è Satellite IGN": orthoIGN,
        "üõ∞Ô∏è Satellite IGN + labels": satelliteIGN_labels,
        "üõ∞Ô∏è Satellite Open": esriSat,
        "üó∫Ô∏è Plan IGN (d√©faut)": planIGN,
        "üåç Plan Open": osm,
      },
      {}
    ).addTo(map);

    L.control.zoom({ position: 'topright' }).addTo(map);

    planIGN.on("tileerror", e => console.warn("IGN PLAN tile error", e));
    orthoIGN.on("tileerror", e => console.warn("IGN ORTHO tile error", e));


const postesLayer = L.markerClusterGroup({
  disableClusteringAtZoom: 18
});

const appareilsLayer = L.markerClusterGroup({
  spiderfyOnMaxZoom: false,    
  spiderfyOnEveryZoom: false,  
  showCoverageOnHover: false,
  zoomToBoundsOnClick: false,   
  disableClusteringAtZoom: 22, 
  maxClusterRadius: function (zoom) {
    return zoom > 18 ? 20 : 60;
  }
});
 
const accesLayer = L.markerClusterGroup({
  spiderfyOnMaxZoom: false,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: false
});

    const pnLayer = L.markerClusterGroup({
  spiderfyOnMaxZoom: false,
  showCoverageOnHover: false,
  zoomToBoundsOnClick: true
});

accesLayer.on('clusterclick', function (e) {
  const childMarkers = e.layer.getAllChildMarkers();
  if (childMarkers.length === 0) return;

  const first = childMarkers[0].getLatLng();
  const allSameCoords = childMarkers.every(m => m.getLatLng().equals(first));

  if (allSameCoords) {
    const items = childMarkers.map((m, i) => {
      let label = m.options.customId || `Acc√®s ${i + 1}`;
      return { label: label.replace(/\bposte\b/gi, "").trim(), idx: i };
    }).sort((a, b) => a.label.localeCompare(b.label, "fr", { numeric: true, sensitivity: "base" }));

    const html = `<div style="min-width:220px;display:flex;flex-direction:column;gap:6px">
      ${items.map(it => `
        <a href="#" class="cluster-link" data-idx="${it.idx}" 
           style="display:flex;align-items:center;gap:6px;">
          <img src="ico/acces.png" style="width:16px;height:16px;">
          <span>${it.label}</span>
        </a>`).join("")}
    </div>`;

    L.popup()
      .setLatLng(first)
      .setContent(html)
      .openOn(map);

setTimeout(() => {
  document.querySelectorAll(".leaflet-popup-content a.cluster-link").forEach(link => {
    link.addEventListener("click", (ev) => {
      ev.preventDefault();
      const idx = +ev.currentTarget.dataset.idx;
      const target = childMarkers[idx];

      const content = target.getPopup() ? target.getPopup().getContent() : "";
      L.popup({ maxWidth: 240 })
        .setLatLng(target.getLatLng())
        .setContent(content)
        .openOn(map);

      map.panTo(target.getLatLng());
    });
  });
}, 0);

  } else {
    map.fitBounds(e.layer.getBounds());
  }
});

map.addLayer(postesLayer);
map.addLayer(appareilsLayer);
map.addLayer(accesLayer);

const iconPoste = L.divIcon({
  html: `<img src="ico/poste.png" class="icon-halo">`,
  className: "",
  iconSize: [36, 36],
  iconAnchor: [18, 36],   
  popupAnchor: [0, -10]
});

const iconAppareil= L.divIcon({className:"icon-circle appareil",html:"‚ö°"});

const iconAcces = L.divIcon({
  html: `<img src="ico/acces.png" class="icon-halo">`,
  className: "",
  iconSize: [36, 36],
  iconAnchor: [18, 28], 
  popupAnchor: [0, -10]
});
 
fetch("postes.json")
  .then(r => r.json())
  .then(data => {
    const seenPostes = new Set();

    data.forEach(item => {

     if (item.latitude && item.longitude) {
  const accesVal = (item["acc√®s"] ?? item.acces ?? "").toString().trim();

const cid = [item.nom, item.type, item.SAT, accesVal]
  .filter(Boolean)
  .join(" ");

let content = `
<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
            font-size:14px; color:#111; line-height:1.4; position:relative;">


<div style="font-weight:600; font-size:16px; margin-bottom:14px; padding-right:32px;">
  üöô ${item.nom || "Sans nom"}
  ${item.type ? " " + item.type : ""}
  ${item.SAT ? " " + item.SAT : ""}
  ${accesVal ? " ‚Äì acc√®s " + accesVal : ""}
</div>

<span onclick="openStreetView(${item.latitude}, ${item.longitude})"
      style="cursor:pointer; position:absolute; top:10px; right:12px;">
  <img src="ico/street.png" alt="Street View" style="width:26px; height:26px;">
</span>
             

<div style="margin-bottom:10px;">
‚úçüèª <strong>Information :</strong> ${ renderInformation(item.description) }
</div>

  <a href="index.html?id=${encodeURIComponent(
    (`${item.nom || ''} ${item.type || ''} ${item.SAT || ''}${accesVal ? ' ‚Äì acc√®s ' + accesVal : ''}`)
      .replace(/\s+/g, " ")
      .trim()
  )}"
     style="display:flex;align-items:center;justify-content:center;gap:6px;
            background:#007aff;color:#fff;padding:10px 14px;border-radius:8px;
            text-decoration:none;width:100%;font-size:15px;font-weight:500;">
    ‚ûï Voir plus
  </a>
</div>
`;

const m = L.marker([item.latitude, item.longitude], {
  icon: iconAcces,
  customId: cid,
  isAcces: true   
}).bindPopup(content).addTo(accesLayer);

  allMarkers.push(m);
}

      if (item.poste_latitude && item.poste_longitude) {
        const key = `${item.poste_latitude}_${item.poste_longitude}`;
        
        if (!seenPostes.has(key)) {
          seenPostes.add(key);

  const cid = [item.nom, item.type, item.SAT, "poste"].filter(Boolean).join(" ");

let content = `
<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
            font-size:14px; color:#111; line-height:1.4;">


  <div style="font-weight:600; font-size:16px; margin-bottom:14px;">
    üìç ${item.nom || "Sans nom"} 
    ${item.type ? " " + item.type : ""} 
    ${item.SAT ? " " + item.SAT : ""}
  </div>


<div style="margin-bottom:10px;">
  üöÑ PK <strong>${item.pk || "(non renseign√©)"}</strong>
  sur la ligne n¬∞<strong>${item.numero_ligne || "(non renseign√©)"}</strong>
  ${item.lignes ? " ‚Äì " + item.lignes : ""}
</div>


  <div style="margin-bottom:10px;">
‚úçüèª <strong>Information :</strong> ${ renderInformation(item.description) }
  </div>
 
  <a href="index.html?id=${encodeURIComponent(
    (`${item.nom || ''} ${item.type || ''} ${item.SAT || ''}`)
      .replace(/\s+/g, " ")
      .trim()
  )}"
     style="display:flex;align-items:center;justify-content:center;gap:6px;
            background:#007aff;color:#fff;padding:10px 14px;border-radius:8px;
            text-decoration:none;width:100%;font-size:15px;font-weight:500;">
    ‚ûï Voir plus
  </a>
</div>
`;

const m = L.marker([item.poste_latitude, item.poste_longitude], {
  icon: iconPoste,
  customId: cid
}).bindPopup(content).addTo(postesLayer);

allMarkers.push(m);
        }
      }

    });
_tryOpenFromURL();
  });
    
fetch("appareils.json")
  .then(r => r.json())
  .then(data => {
    data.forEach(item => {
      if (!item.latitude || !item.longitude) return;

      let appareilIcon;
      const ref = (item.appareil || "").toUpperCase();

if (ref.startsWith("DU")) {
  appareilIcon = L.divIcon({ html:`<img src="ico/stop.png" class="icon-halo-appareil">`, className:"", iconAnchor:[16,38], popupAnchor:[0,-20] });
} else if (ref.startsWith("I") || ref.startsWith("SI") || ref.startsWith("D")) {
  appareilIcon = L.divIcon({ html:`<img src="ico/int.png" class="icon-halo-appareil">`, className:"", iconAnchor:[16,38], popupAnchor:[0,-20] });
} else if (ref.startsWith("TT") || ref.startsWith("TSA") || ref.startsWith("TC") || ref.startsWith("TRA")) {
  appareilIcon = L.divIcon({ html:`<img src="ico/TT.png" class="icon-halo-appareil">`, className:"", iconAnchor:[16,38], popupAnchor:[0,-20] });
} else if (/^[0-9]/.test(ref) || ref.startsWith("S") || ref.startsWith("ST") || ref.startsWith("F") || ref.startsWith("P") || ref.startsWith("FB") || ref.startsWith("B")) {
  appareilIcon = L.divIcon({ html:`<img src="ico/sect.png" class="icon-halo-appareil">`, className:"", iconAnchor:[16,38], popupAnchor:[0,-20] });
} else if (ref.startsWith("ALIM")) {
  appareilIcon = L.divIcon({ html:`<img src="ico/alim.png" class="icon-halo-appareil">`, className:"", iconAnchor:[16,38], popupAnchor:[0,-20] });
} else {
  appareilIcon = iconAppareil;
}

      let content = `
<div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
            font-size:14px; color:#111; line-height:1.4;">

<div style="font-size:15px; margin-bottom:10px;">
  ‚ö° <span style="font-weight:600;">${item.appareil || "Sans r√©f√©rence"}</span>
  ${item.nom || item.type || item.SAT 
    ? " (" + 
        [item.nom, item.type, item.SAT]
          .filter(Boolean)               
          .join(" ")                     
          .trim() + ")"                  
    : ""}
</div>

  ${item.description ? `<div style="margin-bottom:14px;">‚úçüèª <strong>Information :</strong> ${item.description}</div>` : ""}

  <a href="index.html?id=${encodeURIComponent(
    [item.appareil, item.nom, item.type, item.SAT].filter(Boolean).join(" ").trim()
  )}"
     style="display:flex;align-items:center;justify-content:center;gap:6px;
            background:#007aff;color:#fff;padding:10px 14px;border-radius:8px;
            text-decoration:none;width:100%;font-size:15px;font-weight:500;
            margin-top:10px;">
    ‚ûï Voir plus
  </a>
</div>
`;

      const cid = [item.appareil, item.nom, item.type, item.SAT]
        .filter(Boolean)
        .join(" ");

      const m = L.marker([item.latitude, item.longitude], {
        icon: appareilIcon,
        customId: cid
      }).bindPopup(content);

      appareilsLayer.addLayer(m);
      allMarkers.push(m);
      });
    _tryOpenFromURL();
  });

const pnClasses = {
  10: "PN public pour voitures sans barri√®res (protection assur√©e par un agent)",
  11: "PN public pour voitures avec barri√®res gard√© sans passage pi√©tons accol√© (man≈ìuvr√© √† pied d'≈ìuvre)",
  12: "PN public pour voitures avec barri√®res gard√© sans passage pi√©tons accol√© (man≈ìuvr√© √† distance)",
  13: "PN public pour voitures avec barri√®res gard√© sans passage pi√©tons accol√© (man≈ìuvr√© pied d'≈ìuvre + distance)",
  14: "PN public pour voitures avec barri√®res gard√© avec passage pi√©tons accol√© (man≈ìuvr√© √† pied d'≈ìuvre)",
  15: "PN public pour voitures avec barri√®res gard√© avec passage pi√©tons accol√© (man≈ìuvr√© √† distance)",
  16: "PN public pour voitures avec barri√®res gard√© avec passage pi√©tons accol√© (man≈ìuvr√© pied d'≈ìuvre + distance)",
  17: "PN public pour voitures avec barri√®res ou 1/2 barri√®res non gard√© √† SAL 2 / SAL 2B",
  18: "PN public pour voitures avec barri√®res ou 1/2 barri√®res non gard√© √† SAL 2 + √Ælot s√©parateur",
  19: "PN public pour voitures avec barri√®res ou 1/2 barri√®res non gard√© √† SAL 4",
  20: "PN public pour voitures sans barri√®res sans SAL",
  21: "PN public pour voitures sans barri√®res avec SAL 0",
  31: "PN public isol√© pour pi√©tons sans portillons",
  32: "PN public isol√© pour pi√©tons avec portillons",
  41: "PN priv√© pour voitures sans barri√®res",
  42: "PN priv√© pour voitures avec barri√®res sans passage pi√©tons accol√©",
  43: "PN priv√© pour voitures avec barri√®res avec passage pi√©tons accol√© public",
  44: "PN priv√© pour voitures avec barri√®res avec passage pi√©tons accol√© priv√©",
  45: "PN priv√© isol√© pour pi√©tons sans portillons",
  46: "PN priv√© isol√© pour pi√©tons avec portillons"
};
    

appareilsLayer.on('clusterclick', function (e) {
  const markers = e.layer.getAllChildMarkers();
  if (markers.length <= 1) return;

  const first = markers[0].getLatLng();
  const allSameCoords = markers.every(m => m.getLatLng().equals(first));
  const zoom = map.getZoom();

  if (allSameCoords && zoom >= 19) {
    e.originalEvent.preventDefault();
    e.originalEvent.stopPropagation();
    map.closePopup();

    if (!e.layer._spiderfied) e.layer.spiderfy();
    else e.layer.unspiderfy();
    return;
  }

  map.fitBounds(e.layer.getBounds());
});


let pnLoaded = false; 

function chargerPN(btn) {
  console.log("üîÑ D√©clenchement du chargement PN (lazy load)");


  if (pnLoaded) {
    toggleLayer(pnLayer, btn, "Passages √† niveau");
    return;
  }

  pnLoaded = true;
  toast.textContent = "‚è≥ Chargement des passages √† niveau en cours...";
  toast.classList.add("show");

fetch("https://ressources.data.sncf.com/api/records/1.0/search/"
  + "?dataset=liste-des-passages-a-niveau"
  + "&geofilter.bbox=49.4,1.4,51.2,4.5"
  + "&rows=3000")
  
  .then(r => r.json())
  .then(data => {
      let records = data.records || [];

      console.info(`‚úÖ ${records.length} PN filtr√©s (Hauts-de-France + 10 km au sud)`);
  
  
      records.forEach(pn => {
        const f = pn.fields;
        if (!f || !f.geo_point_2d) return;
        const lat = f.geo_point_2d[0];
        const lon = f.geo_point_2d[1];

        const iconPN = L.divIcon({
          html: `<img src="ico/pn.png" class="icon-halo-appareil">`,
          className: "",
          iconAnchor: [16, 32],
          popupAnchor: [0, -32]
        });

        const classeCode = (f.mnemo || "").replace("CLASSE ", "").trim();
        const classeTexte = pnClasses[classeCode]
          ? `üõë Classe ${classeCode} : ${pnClasses[classeCode]}`
          : "";

        let libelle = (f.libelle || "").trim();
        if (/^PN\s*/i.test(libelle)) libelle = libelle.replace(/^PN\s*/i, "");

        const popup = `
  <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
              font-size:14px; color:#111; line-height:1.5; text-align:left;">
  
    <div style="font-weight:700; font-size:16px; margin-bottom:8px;">
      üöß PN ${libelle}
    </div>

    <div>üöÑ PK ${f.pk || "?"} sur la ligne n¬∞${f.code_ligne || "?"}</div>
    ${classeTexte ? `<div>${classeTexte}</div>` : ""}

<div style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:16px;width:100%;">
  <a href="https://gecko.imajnet.net/#map=OSM;zoom=18;loc=${f.geo_point_2d[0]},${f.geo_point_2d[1]};"
     target="_blank"
     style="display:inline-flex;align-items:center;justify-content:center;
            gap:6px;padding:10px 16px;border-radius:8px;
            background:#10b981;color:white;text-decoration:none;
            font-size:14px;font-weight:500;min-width:180px;">
    üöÑ Voir sur Imajnet
  </a>
  <button onclick="openStreetView(${f.geo_point_2d[0]},${f.geo_point_2d[1]})"
     style="display:inline-flex;align-items:center;justify-content:center;
            gap:6px;padding:10px 16px;border:none;border-radius:8px;
            background:#3b82f6;color:white;cursor:pointer;
            font-size:14px;font-weight:500;min-width:180px;">
    üåç Voir en Street View
  </button>
</div>
  </div>`;

        const marker = L.marker([lat, lon], { icon: iconPN }).bindPopup(popup);
        pnLayer.addLayer(marker);
        allMarkers.push(marker);
      });

      toast.textContent = `‚úÖ ${records.length} passages √† niveau charg√©s`;
      setTimeout(() => {
        toast.classList.remove("show");
        toggleLayer(pnLayer, btn, "Passages √† niveau");
      }, 1500);
    })
    .catch(err => {
      console.error("‚ùå Erreur API PN SNCF :", err);
      toast.textContent = "‚ö†Ô∏è Erreur de chargement depuis le site SNCF Open Data";
      setTimeout(() => toast.classList.remove("show"), 2500);
    });
}



    
// === LIGNES FERROVIAIRES ===
document.addEventListener("DOMContentLoaded", () => {
  const btnLignes = document.getElementById("btn-lignes");
  if (!btnLignes) return console.error("‚ùå Bouton Lignes introuvable");

  let lignesLayer = L.markerClusterGroup({
    disableClusteringAtZoom: 16,
    spiderfyOnMaxZoom: false,
  });
  let lignesLoaded = false;

  btnLignes.addEventListener("click", () => {
    if (!lignesLoaded) {
      btnLignes.classList.add("loading");

      fetch("https://ressources.data.sncf.com/api/records/1.0/search/"
        + "?dataset=lignes-par-type"
        + "&geofilter.bbox=49.4,1.4,51.2,4.5"
        + "&rows=3000")
        .then(r => r.json())
        .then(data => {
          data.records.forEach(record => {
            const f = record.fields || {};
            if (!f.geo_shape) return;

            // Couleur flashy + trait plus √©pais
            const couleur =
              (f.type_ligne || "").toLowerCase().includes("raccordement") ? "#ff9800" :
              (f.type_ligne || "").toLowerCase().includes("desserte")     ? "#00e676" :
              (f.type_ligne || "").toLowerCase().includes("embranchement") ? "#f50057" :
              "#00bcd4"; // cyan vif par d√©faut

            const poly = L.geoJSON(f.geo_shape, {
              style: { color: couleur, weight: 6, opacity: 0.9 }
            });

            poly.on("click", (e) => {
              const lat = e.latlng.lat.toFixed(5);
              const lng = e.latlng.lng.toFixed(5);
              const code = f.code_ligne ?? "?";
              const lib  = f.lib_ligne ?? "‚Äî";
              const pkd  = f.pkd ?? "‚Äî";
              const pkf  = f.pkf ?? "‚Äî";
              const type = f.type_ligne ?? "‚Äî";

              const html = `
                <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
                            font-size:14px;color:#111;line-height:1.5;min-width:230px;text-align:left;">
                  <div style="font-weight:700;font-size:16px;margin-bottom:8px;">
                    üöß Ligne n¬∞${code}
                  </div>
                  <div style="margin-bottom:6px;">${lib}</div>
                  <div style="margin-bottom:6px;">üìè PKD <strong>${pkd}</strong> ‚Äî PKF <strong>${pkf}</strong></div>
                  <div style="margin-bottom:14px;">üè∑Ô∏è Type : <strong>${type}</strong></div>

<div style="display:flex;justify-content:center;width:100%;margin-top:14px;">
  <a href="https://gecko.imajnet.net/#map=OSM;zoom=18;loc=${lat},${lng};"
     target="_blank"
     style="display:inline-flex;align-items:center;justify-content:center;
            gap:6px;padding:10px 16px;border-radius:8px;
            background:#10b981;color:white;text-decoration:none;
            font-size:14px;font-weight:500;text-align:center;
            box-sizing:border-box;min-width:160px;">
    üöÑ Voir sur Imajnet
  </a>
</div>

                </div>`;
              L.popup({ maxWidth: 280 })
                .setLatLng(e.latlng)
                .setContent(html)
                .openOn(map);
            });

            lignesLayer.addLayer(poly);
          });

          map.addLayer(lignesLayer);
          lignesLoaded = true;
          btnLignes.classList.remove("loading");
          btnLignes.classList.add("active");
          showToast("‚úÖ Lignes ferroviaires affich√©es");
        })
        .catch(err => {
          console.error("Erreur chargement lignes :", err);
          btnLignes.classList.remove("loading");
          showToast("‚ö†Ô∏è Erreur de chargement");
        });
    } else {
      toggleLayer(lignesLayer, btnLignes, "Lignes ferroviaires");
    }
  });
});


    
    
const leftControls = L.control({ position: "topleft" });
leftControls.onAdd = function() {
  const container = L.DomUtil.create("div");
  const topGroup = L.DomUtil.create("div", "control-group", container);
const backBtn = L.DomUtil.create("div", "btn-toggle btn-return", topGroup);
backBtn.innerHTML = "üîç";

backBtn.onclick = () => {
  window.location.href = "index.html";
};
L.DomEvent.disableClickPropagation(backBtn);
L.DomEvent.disableScrollPropagation(backBtn);
  

const recenterBtn = L.DomUtil.create("div", "btn-toggle", topGroup);
recenterBtn.innerHTML = "üéØ";

recenterBtn.onclick = () => {
  if (allMarkers.length > 0) {
    recenterBtn.classList.add("active"); 
 map.setView(defaultCenter, defaultZoom);


    setTimeout(() => {
      recenterBtn.classList.remove("active");
    }, 800); 
  }
};

L.DomEvent.disableClickPropagation(recenterBtn);
L.DomEvent.disableScrollPropagation(recenterBtn);


let userMarker = null;
let watchId = null;

const locateBtn = L.DomUtil.create("a", "leaflet-control-zoom-in", container);
locateBtn.href = "#";
locateBtn.title = "Me localiser";
locateBtn.innerHTML = `<img src="ico/arrow.png" style="width:18px;height:18px;">`;

locateBtn.onclick = e => {
  e.preventDefault();

  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    if (userMarker) {
      map.removeLayer(userMarker);
      userMarker = null;
    }
    return;
  }

  if (!navigator.geolocation) return alert("G√©olocalisation non support√©e.");

  watchId = navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude } = pos.coords;

    if (!userMarker) {
      userMarker = L.circleMarker([latitude, longitude], {
        radius: 8,
        color: "#3b82f6",
        fillColor: "#3b82f6",
        fillOpacity: 0.6
      }).addTo(map);
    } else {
      userMarker.setLatLng([latitude, longitude]);
    }

    map.setView([latitude, longitude], 16);
  });
};

  

L.DomEvent.disableClickPropagation(locateBtn);
L.DomEvent.disableScrollPropagation(locateBtn);


  return container;
};
leftControls.addTo(map);
    
 function openStreetView(lat, lng) {
    const iframe = document.getElementById("streetview-frame");
    iframe.src = `https://www.google.com/maps?q=&layer=c&cbll=${lat},${lng}&cbp=11,0,0,0,0&output=svembed`;
    document.getElementById("streetview-overlay").style.display = "flex";
  }

  document.getElementById("streetview-close").onclick = () => {
    document.getElementById("streetview-overlay").style.display = "none";
    document.getElementById("streetview-frame").src = ""; 
  };
document.getElementById("streetview-overlay").style.display = "none";
document.getElementById("streetview-frame").src = "";


console.info("[Nono Maps] boot", {
  leaflet: L.version,
  clusters: { postes: !!postesLayer, appareils: !!appareilsLayer, acces: !!accesLayer }
});


if (isNaN(lat) || isNaN(lon)) { console.warn("URL lat/lon invalides", {lat, lon}); }


function renderInformation(value) {
  if (!value) {
    return `<span style="color:#777;font-style:italic;">Non renseign√©</span>`;
  }

  return escHtml(String(value));
}

let activeEditPopup = null; 

function escHtml(s){return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}


map.on('click', (e) => {
  if (!editMode) return;

  const lat = Number(e.latlng.lat.toFixed(5));
  const lng = Number(e.latlng.lng.toFixed(5));
  const coordsText = `${lat}, ${lng}`;

  const popupContent = `
  <div style="font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Inter,sans-serif;
              font-size:14px;min-width:240px;">

    <div style="font-weight:600; font-size:16px; margin-bottom:12px;"> ‚ÑπÔ∏è Information : </div>

    <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
      <pre style="margin:0; background:#f3f4f6; padding:6px 10px; border-radius:6px; font-size:13px; flex:1;">
${coordsText}</pre>
      <button id="btn-copy"
        style="padding:6px 10px; border:none; border-radius:6px; background:#f59e0b; color:white; cursor:pointer;">
        üìã Copier
      </button>
    </div>

    <div style="display:flex; flex-direction:column; gap:8px;">
      <button id="btn-gmaps" 
        style="padding:8px 12px; border:none; border-radius:6px; background:#3b82f6; color:white; cursor:pointer;">
        üîé Google Maps
      </button>

      <button id="btn-imajnet" 
        style="padding:8px 12px; border:none; border-radius:6px; background:#10b981; color:white; cursor:pointer;">
        üõ£Ô∏è Imajnet
      </button>
    </div>
  </div>`;

  if (activeEditPopup) map.closePopup(activeEditPopup);

  activeEditPopup = L.popup({ autoClose: false, closeOnClick: false })
    .setLatLng(e.latlng)
    .setContent(popupContent)
    .openOn(map);


  setTimeout(() => {
    const flash = (txt) => {
      editBanner.textContent = txt;
      editBanner.style.display = "block";
      setTimeout(() => { editBanner.style.display = "none"; }, 1200);
    };

    document.getElementById('btn-copy')?.addEventListener('click', () => {
      navigator.clipboard.writeText(coordsText).then(() => flash("‚úÖ Coordonn√©es copi√©es"));
    });

    document.getElementById('btn-gmaps')?.addEventListener('click', () => {
      window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
    });

    document.getElementById('btn-imajnet')?.addEventListener('click', () => {
      window.open(`https://gecko.imajnet.net/#map=OSM;zoom=18;loc=${lat},${lng};`, '_blank');
    });
  }, 50); 
});

const fabBtn = document.getElementById("fabBtn");
const fabOptions = document.getElementById("fabOptions");
const toast = document.getElementById("toast");

fabBtn.addEventListener("click", () => {
  fabOptions.classList.toggle("show");
});

function toggleLayer(layer, btn, label) {
  if (map.hasLayer(layer)) {
    map.removeLayer(layer);
    btn.classList.remove("active");
    showToast(`‚ùå ${label} masqu√©s`);
  } else {
    map.addLayer(layer);
    btn.classList.add("active");
    showToast(`‚úÖ ${label} affich√©s`);
  }
}

function showToast(message) {
  toast.textContent = message;
  toast.classList.add("show");
  setTimeout(() => {
    toast.classList.remove("show");
  }, 2000);
}
</script>

</body>
</html>
