<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Tableau de travail d’avancement – v1.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>

    .device-pill {
  background: white;
  border: 1px solid #d1d5db;
  padding: 4px 8px;
  border-radius: 999px;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  transition: all 0.15s ease-in-out;
}

.device-pill:hover {
  transform: scale(1.03);
  background: #e8f1ff;
  border-color: #93c5fd;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
}

.device-pill a {
  text-decoration: none;
  color: inherit;
}
    
    body {
      margin: 0;
      padding: 20px;
      font-family: Inter, system-ui, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    h1 { margin-bottom: 10px; }

    /* Onglets */
    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 8px 14px;
      background: #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .tab.active {
      background: #3b82f6;
      color: white;
    }

    /* Grille Postes */
    .board {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .poste-card {
      background: white;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .poste-title {
      font-size: 17px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .type-badge {
      background: #dbeafe;
      border: 1px solid #bfdbfe;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #1e40af;
    }

    /* SAT + Poste principal */
    .sat-group {
      background: #f9fafb;
      border: 1px dashed #d1d5db;
      padding: 10px;
      border-radius: 10px;
      margin-top: 8px;
    }
    .sat-title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .sat-badge {
      background: #fef9c3;
      border: 1px solid #facc15;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
    }

    .principal-badge {
      background: #e5e7eb;
      border: 1px solid #d1d5db;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Pills appareils */
    .device-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .device-pill {
      background: white;
      border: 1px solid #d1d5db;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .device-pill a {
      text-decoration: none;
      color: inherit;
    }

    .hp {
      background: #fee2e2;
      border-color: #fca5a5;
      color: #b91c1c;
    }
  </style>
</head>
<body>

<h1>Tableau de travail d’avancement – v1.1</h1>

<div class="tabs">
  <div id="tabPatrimoine" class="tab active">Patrimoine</div>
  <div id="tabHP" class="tab">Hors patrimoine</div>
</div>

<div id="boardPatrimoine" class="board"></div>
<div id="boardHP" class="board" style="display:none;"></div>

<script>
const postesURL = "postes.json";
const appareilsURL = "appareils.json";

let postes = [];
let appareils = [];

/* --------- SAT SORTING --------- */
function sortSatKeys(keys) {
  return keys.sort((a, b) => {
    if (a === "_principal") return -1;
    if (b === "_principal") return 1;

    const extract = s => {
      const m = s.match(/^sat(\d*)$/i);
      return m ? { base: "sat", num: m[1] ? parseInt(m[1]) : 0 } 
               : { base: s.toLowerCase(), num: null };
    };

    const A = extract(a);
    const B = extract(b);

    if (A.base !== B.base) return A.base.localeCompare(B.base);
    if (A.num === null && B.num !== null) return -1;
    if (B.num === null && A.num !== null) return 1;
    if (A.num === null && B.num === null) return a.localeCompare(b);

    return A.num - B.num;
  });
}

/* --------- LOAD JSON --------- */
Promise.all([fetch(postesURL), fetch(appareilsURL)])
  .then(async ([pRes, aRes]) => {
    postes = await pRes.json();
    appareils = await aRes.json();
    build();
  });

/* ---------- TABS ---------- */
document.getElementById("tabPatrimoine").onclick = () => {
  tab("Patrimoine");
};
document.getElementById("tabHP").onclick = () => {
  tab("HP");
};

function tab(which) {
  document.getElementById("tabPatrimoine").classList.toggle("active", which==="Patrimoine");
  document.getElementById("tabHP").classList.toggle("active", which==="HP");
  document.getElementById("boardPatrimoine").style.display = which==="Patrimoine" ? "grid" : "none";
  document.getElementById("boardHP").style.display = which==="HP" ? "grid" : "none";
}

/* ---------- BUILD DATA ---------- */
function build() {

  /* Poste → HP ? */
  const mapPoste = new Map();
  postes.forEach(p => {
    mapPoste.set(p.nom, p.hors_patrimoine === true);
  });

  /* Exclure special:true */
  const validAppareils = appareils.filter(a => !a.special);

  /* Regroupement */
  const postesMap = new Map();

  validAppareils.forEach(a => {
    const nom = a.nom || "Inconnu";

    if (!postesMap.has(nom)) {
      postesMap.set(nom, {
        nom,
        type: a.type || "",
        horsPatrimoine: mapPoste.get(nom) || false,
        sats: {}
      });
    }

    const poste = postesMap.get(nom);
    const sat = a.SAT && a.SAT.trim() !== "" ? a.SAT.trim() : "_principal";

    if (!poste.sats[sat]) poste.sats[sat] = [];
    poste.sats[sat].push(a);
  });

  /* --- ONGLET PATRIMOINE --- */
  const boardP = document.getElementById("boardPatrimoine");
  boardP.innerHTML = "";

  postesMap.forEach(poste => {

    if (poste.horsPatrimoine) return;

    const satsClean = {};
    for (const key in poste.sats) {
      const filtered = poste.sats[key].filter(a => !a.hors_patrimoine);
      satsClean[key] = filtered;
    }

    const has = Object.values(satsClean).some(g => g.length > 0);
    if (!has) return;

    boardP.appendChild(renderPoste(poste.nom, poste.type, satsClean));
  });

  /* --- ONGLET HP --- */
  const boardH = document.getElementById("boardHP");
  boardH.innerHTML = "";

  postesMap.forEach(poste => {
    const satsHP = {};
    let hasHP = false;

    for (const key in poste.sats) {
      satsHP[key] = poste.sats[key].filter(a => a.hors_patrimoine);
      if (satsHP[key].length > 0) hasHP = true;
    }

    if (!poste.horsPatrimoine && !hasHP) return;

    boardH.appendChild(renderPoste(poste.nom, poste.type, satsHP, true));
  });

}

/* ---------- RENDER POSTE ---------- */
function renderPoste(nom, type, sats, isHP=false) {

  const card = document.createElement("div");
  card.className = "poste-card";

  card.innerHTML = `
    <div class="poste-title">
      <span>${nom}</span>
      ${type ? `<span class="type-badge">${type}</span>` : ""}
    </div>
  `;

  const satKeys = sortSatKeys(Object.keys(sats));

  satKeys.forEach(sat => {

    const group = sats[sat];

    const div = document.createElement("div");
    div.className = "sat-group";

    const title = document.createElement("div");
    title.className = "sat-title";

    if (sat === "_principal") {
      title.innerHTML = `<span class="principal-badge">Poste principal</span>`;
    } else {
      title.innerHTML = `<span class="sat-badge">${sat}</span>`;
    }

    const list = document.createElement("div");
    list.className = "device-list";

    group.forEach(a => {
      const pill = document.createElement("div");
      pill.className = "device-pill";
      if (a.hors_patrimoine) pill.classList.add("hp");

      const params = `${a.appareil} ${a.nom} ${a.type || ""} ${a.SAT || ""}`.trim();
      const url = `index.html?id=${encodeURIComponent(params)}`;

      pill.innerHTML = `<a href="${url}">${a.appareil}</a>`;
      list.appendChild(pill);
    });

    if (list.children.length === 0) {
      const msg = document.createElement("div");
      msg.style.fontSize = "12px";
      msg.style.color = "#6b7280";
      msg.textContent = "Aucun appareil enregistré pour le moment.";
      list.appendChild(msg);
    }

    div.appendChild(title);
    div.appendChild(list);
    card.appendChild(div);
  });

  return card;
}
</script>

</body>
</html>
