<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tableau Blanc – Nono Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

   /* ===============================
   FAB Smart Hide
================================ */
.home-fab{
    will-change:transform, opacity;
}

.home-fab.hide{
    transform:translateX(-50%) translateY(120%);
    opacity:0;
    pointer-events:none;
}

   /* ===============================
   FAB Accueil — standard NonoMaps
================================ */
.home-fab{
    position:fixed;
    left:50%;
bottom:calc(18px + env(safe-area-inset-bottom, 0px));
    transform:translateX(-50%);
    z-index:999;

    padding:12px 22px;
    border-radius:999px;
    font-weight:700;
    font-size:15px;
    text-decoration:none;

    color:var(--text);
    background:rgba(255,255,255,0.75);
    border:1px solid var(--border);

    backdrop-filter:blur(12px);
    -webkit-backdrop-filter:blur(12px);

    box-shadow:0 10px 30px var(--shadow);
    transition:all .18s ease;
}

/* Hover desktop */
.home-fab:hover{
    transform:translateX(-50%) translateY(-2px);
    box-shadow:0 14px 36px var(--shadow);
    border-color:var(--accent);
}

/* Active mobile */
.home-fab:active{
    transform:translateX(-50%) scale(0.96);
}

   /* ===============================
   FAB compact mobile
================================ */
@media (max-width:480px){
    .home-fab{
        padding:9px 16px;
        font-size:13px;
 bottom:calc(14px + env(safe-area-inset-bottom, 0px));
        box-shadow:0 6px 18px var(--shadow);
    }
}

/* ===============================
   Dark mode — vrai dark moderne
================================ */
@media (prefers-color-scheme: dark){
  :root{
    /* Fond */
    --bg:#121212;
    --card-bg:rgba(28,28,28,0.75);

    /* Texte */
    --text:#FFFFFF;
    --muted:#B8B8B8;

    /* Pills appareils (bleu SNCF lisible dark) */
    --pill-bg:#1E2A44;
    --pill-text:#8FA8FF;

    /* SAT */
    --sat-bg:#2A1E12;
    --sat-text:#FFB784;

    /* Hors patrimoine */
    --hp-bg:rgba(200,14,14,0.25);
    --hp-text:#FF8A8A;

    /* Accent */
    --accent:#5068F5;

    /* Bordures */
    --border:#2A2A2A;

    /* Ombres */
    --shadow:rgba(0,0,0,0.6);
  }
}
   

/* ===============================
   Variables thème SNCF (version UI pâle)
================================ */
:root{
    --bg:#FFFFFF;
    --card-bg:#FFFFFF;

    /* Texte Carbone SNCF */
    --text:#3C3732;

    /* Bleu SNCF adouci */
    --pill-bg:#EAF4FB;
    --pill-text:#264FC4;

    /* Jaune or adouci */
    --sat-bg:#F6E4B5;
    --sat-text:#DE511D;

    /* Rouge feu adouci */
    --hp-bg:rgba(200,14,14,0.12);
    --hp-text:#C80E0E;

    /* Accent */
    --accent:#5068F5;

    /* Bordures douces (vert lichen clair) */
    --border:#B0CC93;

    --shadow:rgba(0,0,0,0.10);
}

@media (prefers-color-scheme: dark){
    :root{
        --bg:#015147;
        --card-bg:#0F3F39;
        --text:#FFFFFF;

        --pill-bg:#2F6F8F;
        --pill-text:#FFFFFF;

        --sat-bg:#DE511D;
        --sat-text:#FFFFFF;

        --hp-bg:rgba(200,14,14,0.30);
        --hp-text:#F08992;

        --accent:#5068F5;
        --border:#28A092;

        --shadow:rgba(0,0,0,0.45);
    }
}

/* ===============================
   Cartes ville
================================ */
.ville-card{
    background:#EAF4FB !important;
}

@media (prefers-color-scheme: dark){
    .ville-card{
        background:#264FC4 !important;
    }
}

/* ===============================
   Espacement entre compteurs et champ de recherche
================================ */
.board-row{
    margin-top:18px;
}

/* ===============================
   Liens cliquables (poste / sat)
================================ */
.section-title,
.sat-pill{
    text-decoration:none;
    color:inherit;
    cursor:pointer;
    transition:0.15s;
}

/* ===============================
   Base layout
================================ */
body{
    font-family:Inter,sans-serif;
    margin:0;
    padding:20px;
    padding-bottom:90px; /* sécurité FAB */
    background:var(--bg);
    color:var(--text);
}

/* ===============================
   Pills
================================ */
.pill,
.sat-pill,
.section-title,
.type-pill{
    display:inline-block;
}

.pill{
    padding:4px 8px;
    background:var(--pill-bg);
    color:var(--pill-text);
    border-radius:10px;
    font-size:12px;
    margin:4px 6px 4px 0;
    cursor:pointer;
    transition:0.15s;
}

.pill:hover,
.sat-pill:hover,
.section-title:hover{
    transform:translateY(-2px) scale(1.02);
    box-shadow:0 3px 10px var(--shadow);
}

.type-pill{
    background:#E6ECEF;          /* gris SNCF doux */
    color:#3C3732;               /* carbone */
    border:1px solid #B0CC93;    /* vert lichen */
    padding:3px 10px;
    border-radius:8px;
    font-size:11px;
    font-weight:700;
    letter-spacing:0.3px;
    margin-left:6px;
}

.sat-pill,
.section-title{
    background:var(--sat-bg);
    color:var(--sat-text);
    padding:4px 10px;
    font-size:12px;
    border-radius:10px;
    font-weight:600;
    margin-bottom:8px;
}

   
.hp .pill{
    background:var(--hp-bg);
    color:var(--hp-text);
}

/* ===============================
   Cartes / grille
================================ */
.post-container{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
    gap:20px;
}

.card{
    background:var(--card-bg);
    padding:14px;
    border-radius:14px;
    box-shadow:0 4px 12px var(--shadow);
    border:1px solid rgba(255,255,255,0.05);
    opacity:0;
    transform:translateY(10px);
    animation:fadeIn 0.45s ease forwards;
}

.card-title{
    font-size:18px;
    font-weight:700;
    margin-bottom:14px;
}

.sat-block{
    margin-top:16px;
    padding-top:12px;
    border-top:1px dashed var(--border);
}

@keyframes fadeIn{
    to{
        opacity:1;
        transform:translateY(0);
    }
}

#search{
    width:100%;
    padding:12px 18px;
    font-size:15px;
    border-radius:14px;
    border:1px solid var(--border);
    background:var(--card-bg);
    color:var(--text);
}

#search:focus{
    border-color:var(--accent);
    box-shadow:0 0 0 3px rgba(80,104,245,0.18);
}

.filters{
    display:flex;
    gap:10px;
    margin-bottom:20px;
    flex-wrap:wrap;
}

.filters button{
    padding:8px 16px;
    border-radius:10px;
    background:var(--card-bg);
    border:1px solid var(--border);
    cursor:pointer;
    font-weight:600;
}

.filters button.activeFilter{
    background:var(--accent);
    color:#FFFFFF;
}

/* ===============================
   Header / navigation
================================ */
.board-header{
    position:sticky;
    top:0;
    z-index:50;
    margin-bottom:16px;
    padding:14px;
    border-radius:18px;
    backdrop-filter:blur(8px);
    box-shadow:0 10px 26px var(--shadow);
}

.board-top,
.board-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
}

.board-title{
    font-size:22px;
    font-weight:800;
    transform:rotate(-0.4deg);
    font-family:"Comic Sans MS","Bradley Hand","Segoe Print",Inter,system-ui,sans-serif;
}


/* ===============================
   Mobile
================================ */
@media (max-width:480px){
    .card{
        padding:14px;
        border-radius:14px;
    }

    .card-title{
        font-size:16px;
    }

    .pill{
        font-size:12px;
        padding:4px 8px;
    }

    .sat-pill,
    .section-title{
        font-size:12px;
        padding:4px 10px;
    }
}

</style>

    
</head>
<body>

<div class="board-header">
  <div class="board-top">
    <div>
      <div class="board-title">Tableau blanc — Nono Maps</div>
      <div class="board-sub" id="counters">Chargement…</div>
    </div>
  </div>


  <div class="board-row">
    <input id="search" type="text" placeholder="Rechercher...">
  </div>
</div> 


<div class="filters">
    <button data-sort="az">A → Z</button>
    <button data-sort="za">Z → A</button>
    <button data-sort="appmax">+ appareils</button>
    <button data-sort="appmin">- appareils</button>
</div>

<div id="postesZone" class="post-container patrimoine"></div>

<script>

const URL_POSTES = "postes.json";
const URL_APPAREILS = "appareils.json";

const postesZone = document.getElementById("postesZone");
const searchEl = document.getElementById("search");
const countersEl = document.getElementById("counters");

// Helpers
const norm = (v) => (v ?? "").toString().trim();
const normKey = (s) => norm(s).toLowerCase().replace(/\s+/g, " ");
const makePosteKey = (nom, type) => `${normKey(nom)}__${normKey(type)}`;

// Données en mémoire
let postesMap = {};          // { key: { nom, type, sats:Set, principal:[], satApp:{sat:[]}} }
let postesList = [];         // [{key, ...}] triée
let viewKeys = [];           // keys affichés après recherche
let triActif = "az"; // az | za | appmax | appmin

// 1) Charger postes.json et construire la structure
async function chargerPostes(){
  const res = await fetch(URL_POSTES, { cache: "no-store" });
  let postes = await res.json();

  //EXCLUSION DES POSTES NON VOULUS
  postes = postes.filter(p =>
    p.special !== true &&
    p.hors_patrimoine !== true
  );

  const map = {};

  postes.forEach(p => {
    const nom = norm(p.nom);
    const type = norm(p.type); // peut être ""
    const sat = norm(p.SAT);

    const key = makePosteKey(nom, type);
    if(!map[key]){
      map[key] = {
        key,
        nom,
        type,
        sats: new Set(),
        principal: [],
        satApp: {},
        appCount: 0
      };
    }

    if(sat){
      map[key].sats.add(sat);
      if(!map[key].satApp[sat]) map[key].satApp[sat] = [];
    }
  });

  postesMap = map;

  postesList = Object.values(postesMap)
    .sort((a,b) =>
      `${a.nom} ${a.type}`.localeCompare(`${b.nom} ${b.type}`, "fr", { sensitivity:"base" })
    );

  viewKeys = postesList.map(p => p.key);
}


// 2) Charger appareils.json et injecter
async function chargerAppareils(){
  const res = await fetch(URL_APPAREILS, { cache: "no-store" });
  const appareils = await res.json();

  appareils.forEach(a => {
    const nom = norm(a.nom);
    const type = norm(a.type);     // peut être ""
    const sat = norm(a.SAT);       // "" => principal
    const key = makePosteKey(nom, type);

    // si le poste n’existe pas dans postes.json, on le crée quand même (sécurité)
    if(!postesMap[key]){
          postesMap[key] = {
        key,
        nom,
        type,
        sats: new Set(),
        principal: [],
        satApp: {},
        appCount: 0
      };

      postesList.push(postesMap[key]);
    }

    const poste = postesMap[key];

    if(sat){
      poste.sats.add(sat);
      if(!poste.satApp[sat]) poste.satApp[sat] = [];
      poste.satApp[sat].push(a);
      poste.appCount++;
    }else{
      poste.principal.push(a);
      poste.appCount++;
    }

  });

  // retri (au cas où des postes “fallback” ont été ajoutés)
  postesList = Object.values(postesMap)
    .sort((a,b) => `${a.nom} ${a.type}`.localeCompare(`${b.nom} ${b.type}`, "fr", { sensitivity:"base" }));

  postesList.forEach(preparerTriPourAffichage);

  viewKeys = postesList.map(p => p.key);
}


function preparerTriPourAffichage(poste){
  poste.principalSorted = [...poste.principal].sort((a,b) =>
    norm(a.appareil).localeCompare(norm(b.appareil), "fr", { sensitivity:"base" })
  );

  poste.satNamesSorted = Array.from(poste.sats).sort((a,b) =>
    a.localeCompare(b, "fr", { sensitivity:"base" })
  );

  poste.satAppSorted = {};
  poste.satNamesSorted.forEach(sat => {
    poste.satAppSorted[sat] = (poste.satApp[sat] || []).slice().sort((a,b) =>
      norm(a.appareil).localeCompare(norm(b.appareil), "fr", { sensitivity:"base" })
    );
  });
}

// Liens vers index

    
function hrefPoste(nom, type){
  const id = `${norm(nom)} ${norm(type)}`.trim();
  return `index.html?id=${encodeURIComponent(id)}`;
}
function hrefSat(nom, type, sat){
  const id = `${norm(nom)} ${norm(type)} ${norm(sat)}`.trim();
  return `index.html?id=${encodeURIComponent(id)}`;
}
function hrefAppareil(appareil, nom, type, sat){
  const id = `${norm(appareil)} ${norm(nom)} ${norm(type)} ${norm(sat)}`.trim();
  return `index.html?id=${encodeURIComponent(id)}`;
}

// UI builders
function pillHtml(a){
  const label = norm(a.appareil) || "Appareil";
  const sat = norm(a.SAT);
  const hp = (a.hors_patrimoine === true);
  const inner = `<span class="pill" onclick="location.href='${hrefAppareil(label, a.nom, a.type, sat)}'">${escapeHtml(label)}</span>`;
  return hp ? `<span class="hp">${inner}</span>` : inner;
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

   function trierKeys(keys){
  return [...keys].sort((ka, kb) => {
    const a = postesMap[ka];
    const b = postesMap[kb];

    if(triActif === "az"){
      return `${a.nom} ${a.type}`.localeCompare(
        `${b.nom} ${b.type}`, "fr", { sensitivity:"base" }
      );
    }

    if(triActif === "za"){
      return `${b.nom} ${b.type}`.localeCompare(
        `${a.nom} ${a.type}`, "fr", { sensitivity:"base" }
      );
    }

    if(triActif === "appmax") return b.appCount - a.appCount;
    if(triActif === "appmin") return a.appCount - b.appCount;


    return 0;
  });
}
   
function render(){
  // Compteurs
  let nbPostes = 0, nbSats = 0, nbApp = 0, nbHp = 0;
  let html = "";

  trierKeys(viewKeys).forEach(key => {
    const p = postesMap[key];
    if(!p) return;

    if (p.type) {
      nbPostes++;
    }
    nbSats += p.sats.size;

    nbApp += p.principal.length;
    p.principal.forEach(a => { if(a.hors_patrimoine === true) nbHp++; });

    Object.keys(p.satApp).forEach(s => {
      nbApp += p.satApp[s].length;
      p.satApp[s].forEach(a => { if(a.hors_patrimoine === true) nbHp++; });
    });

    html += renderPosteCard(p);
  });

  postesZone.innerHTML = html;
  countersEl.textContent = `Postes : ${nbPostes} • SAT : ${nbSats} • Appareils : ${nbApp}${nbHp ? ` • HP : ${nbHp}` : ""}`;
}


function renderPosteCard(p){
  const hasType = !!norm(p.type);

  const title = hasType
    ? `${escapeHtml(p.nom)} <span class="type-pill">${escapeHtml(p.type)}</span>`
    : `${escapeHtml(p.nom)} (Ville de)`;

  // principal : déjà trié au chargement
  const principal = p.principalSorted || [];
  const principalPills = principal.map(pillHtml).join("");

  // SAT : déjà trié au chargement
  const satNames = p.satNamesSorted || [];


let html = `
    <div class="card ${hasType ? "" : "ville-card"}">
      <div class="card-title">${title}</div>

  ${hasType
  ? `<a class="section-title" href="${hrefPoste(p.nom, p.type)}">Poste principal</a>
     ${principalPills}`
  : principalPills
}
  `;

  satNames.forEach((sat, idx) => {
    const list = (p.satAppSorted && p.satAppSorted[sat]) ? p.satAppSorted[sat] : [];

    const pills = list.map(pillHtml).join("");

    // séparateur : seulement si ça a du sens visuellement
const needSep = true;
    html += `
      <div class="${needSep ? "sat-block" : ""}">
        <a class="sat-pill" href="${hrefSat(p.nom, p.type, sat)}">${escapeHtml(sat)}</a>
        ${pills}
      </div>
    `;
  });

  html += `</div>`;
  return html;
}

/* =========================Recherche========================= */
function appliquerRecherche(){
  const q = norm(searchEl.value).toLowerCase();
  if(!q){
    viewKeys = postesList.map(p => p.key);
    render();
    return;
  }

  const hits = [];

  postesList.forEach(p => {
    const hayPoste = `${p.nom} ${p.type}`.toLowerCase();

    // match poste/type direct
    let ok = hayPoste.includes(q);

    // match sat
    if(!ok){
      for(const sat of p.sats){
        if(sat.toLowerCase().includes(q)){ ok = true; break; }
      }
    }

    // match appareils principal
    if(!ok){
      ok = p.principal.some(a => (norm(a.appareil).toLowerCase().includes(q)));
    }

    // match appareils SAT
    if(!ok){
      for(const sat of Object.keys(p.satApp)){
        if(p.satApp[sat].some(a => (norm(a.appareil).toLowerCase().includes(q)))){
          ok = true; break;
        }
      }
    }

    if(ok) hits.push(p.key);
  });

  viewKeys = hits;
  render();
}

let searchTimer;
searchEl?.addEventListener("input", () => {
  clearTimeout(searchTimer);
  searchTimer = setTimeout(appliquerRecherche, 150);
});

/* =========================Lancement========================= */
(async function init(){
  try{
    countersEl.textContent = "Chargement…";
    await chargerPostes();     // affiche les postes/SAT même vides
    await chargerAppareils();  // injecte les appareils
    render();
  }catch(e){
    console.error(e);
    countersEl.textContent = "Erreur de chargement (postes/appareils).";
  }
})();


   // =========================Boutons de tri ========================= //
const sortButtons = document.querySelectorAll(".filters button");

sortButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    // reset visuel
    sortButtons.forEach(b => b.classList.remove("activeFilter"));

    // activation du bouton cliqué
    btn.classList.add("activeFilter");

    // mode de tri actif
    triActif = btn.dataset.sort;

    // re-render avec le tri
    render();
  });
});

// A → Z actif par défaut
document
  .querySelector('[data-sort="az"]')
  ?.classList.add("activeFilter");

</script>

   <a href="index.html" class="home-fab">
  ← Accueil
</a>

   <script>
/* ===============================
   Smart hide FAB — NonoMaps
================================ */
(function(){
  const fab = document.querySelector('.home-fab');
  if(!fab) return;

  let lastScroll = window.scrollY;
  let ticking = false;
  const SHOW_DELTA = 6; // tolérance micro scroll

  function update(){
    const current = window.scrollY;
    const maxScroll = document.documentElement.scrollHeight - window.innerHeight;

    // Toujours visible en haut
    if(current <= 10){
      fab.classList.remove('hide');
    }
    // Toujours visible proche du bas
    else if(current >= maxScroll - 20){
      fab.classList.remove('hide');
    }
    // Scroll vers le bas → on cache
    else if(current > lastScroll + SHOW_DELTA){
      fab.classList.add('hide');
    }
    // Scroll vers le haut → on montre
    else if(current < lastScroll - SHOW_DELTA){
      fab.classList.remove('hide');
    }

    lastScroll = current;
    ticking = false;
  }

  window.addEventListener('scroll', () => {
    if(!ticking){
      window.requestAnimationFrame(update);
      ticking = true;
    }
  }, { passive:true });
})();
</script>

</body>
</html>
