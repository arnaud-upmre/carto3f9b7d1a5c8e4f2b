<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tableau Blanc – Nono Maps</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

<style>

   /* Espacement entre compteurs et champ de recherche */
.board-row + .board-row{
    margin-top:18px;
}


/* ===============================
   Liens cliquables (poste / sat)
================================ */
.section-title,
.sat-pill{
    text-decoration:none;
    color:inherit;
    cursor:pointer;
}


/* ===============================
   Popup bienvenue
================================ */
.welcome-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.45);
    backdrop-filter:blur(4px);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
}
.welcome-overlay.hidden{
    display:none;
}

.welcome-modal{
    background:var(--card-bg);
    color:var(--text);
    max-width:460px;
    width:90%;
    padding:24px 26px;
    border-radius:20px;
    box-shadow:0 20px 50px rgba(0,0,0,0.35);
    animation:popupIn 0.35s ease;
    text-align:center;
}

.welcome-modal h2{
    margin:0 0 14px;
    font-size:22px;
    font-weight:800;
    font-family:"Comic Sans MS","Bradley Hand","Segoe Print",Inter,system-ui,sans-serif;
}

.welcome-modal p{
    font-size:14px;
    line-height:1.5;
    margin-bottom:14px;
}

.welcome-modal button{
    margin-top:10px;
    padding:10px 18px;
    border:none;
    border-radius:14px;
    background:#1a73e8;
    color:white;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(26,115,232,0.4);
}

.welcome-modal button:active{
    transform:translateY(1px);
}

@keyframes popupIn{
    from{
        opacity:0;
        transform:translateY(10px) scale(0.97);
    }
    to{
        opacity:1;
        transform:translateY(0) scale(1);
    }
}


/* ===============================
   Variables thème
================================ */
:root{
    --bg:#f2f3f7;
    --card-bg:#ffffff;
    --text:#111;
    --pill-bg:#e5ebff;
    --pill-text:#1a4ce8;
    --sat-bg:#fff6c4;
    --sat-text:#8a6d00;
    --shadow:rgba(0,0,0,0.12);
}

@media (prefers-color-scheme: dark){
    :root{
        --bg:#1c1d20;
        --card-bg:#2a2b2e;
        --text:#f5f5f5;
        --pill-bg:#2f3b57;
        --pill-text:#9bb8ff;
        --sat-bg:#695a00;
        --sat-text:#ffe58a;
        --shadow:rgba(0,0,0,0.45);
    }
}


/* ===============================
   Base layout
================================ */
body{
    font-family:Inter,sans-serif;
    margin:0;
    padding:20px;
    background:var(--bg);
    color:var(--text);
}

h1{
    display:none;
}


/* ===============================
   Pills
================================ */
.pill,
.sat-pill,
.section-title,
.type-pill{
    display:inline-block;
}

.pill{
    padding:4px 8px;
    background:var(--pill-bg);
    color:var(--pill-text);
    border-radius:10px;
    font-size:12px;
    margin:4px 6px 4px 0;
    cursor:pointer;
    transition:0.15s;
}

.pill:hover{
    transform:translateY(-2px);
    box-shadow:0 3px 10px rgba(0,0,0,0.25);
}

.type-pill{
    background:var(--pill-bg);
    color:var(--pill-text);
    padding:4px 10px;
    border-radius:8px;
    font-size:12px;
    margin-left:6px;
}

.sat-pill,
.section-title{
    background:var(--sat-bg);
    color:var(--sat-text);
    padding:4px 10px;
    font-size:12px;
    border-radius:10px;
    font-weight:600;
    margin-bottom:8px;
}

.hp .pill{
    background:rgba(220,53,69,0.18);
    color:#b02a37;
}

@media (prefers-color-scheme: dark){
    .hp .pill{
        background:rgba(220,53,69,0.35);
        color:#ffb3b8;
    }
}


/* ===============================
   Cartes / grille
================================ */
.post-container{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
    gap:20px;
}

.card{
    background:var(--card-bg);
    padding:14px;
    border-radius:14px;
    box-shadow:0 4px 12px var(--shadow);
    border:1px solid rgba(255,255,255,0.05);
    opacity:0;
    transform:translateY(10px);
    animation:fadeIn 0.45s ease forwards;
}

.card-title{
    font-size:18px;
    font-weight:700;
    margin-bottom:14px;
}

.sat-block{
    margin-top:16px;
    padding-top:12px;
    border-top:1px dashed #ccc;
}

@keyframes fadeIn{
    to{
        opacity:1;
        transform:translateY(0);
    }
}


/* ===============================
   Tabs / filtres / search
================================ */
.tabs{
    display:flex;
    gap:10px;
    margin-bottom:20px;
}

.tab{
    padding:8px 16px;
    background:#d0d2d8;
    border-radius:12px;
    cursor:pointer;
    font-weight:600;
    transition:0.2s;
}

.tab.active{
    background:#1a73e8;
    color:white;
    box-shadow:0 3px 8px rgba(0,0,0,0.25);
}

#search{
    width:100%;
    padding:12px 18px;
    font-size:15px;
    border-radius:14px;
    border:1px solid #bbb;
    background:var(--card-bg);
    color:var(--text);
}

#search:focus{
    border-color:#1a73e8;
    box-shadow:0 0 0 3px #1a73e825;
}

.filters{
    display:flex;
    gap:10px;
    margin-bottom:20px;
    flex-wrap:wrap;
}

.filters button{
    padding:8px 16px;
    border-radius:10px;
    background:var(--card-bg);
    border:1px solid #bbb;
    cursor:pointer;
    font-weight:600;
}

.filters button.activeFilter{
    background:#1a73e8;
    color:white;
}


/* ===============================
   Header / navigation
================================ */
.board-header{
    position:sticky;
    top:0;
    z-index:50;
    margin-bottom:16px;
    padding:14px;
    border-radius:18px;
    backdrop-filter:blur(8px);
    box-shadow:0 10px 26px rgba(0,0,0,0.10);
}

.board-top,
.board-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
}

.board-title{
    font-size:22px;
    font-weight:800;
    transform:rotate(-0.4deg);
    font-family:"Comic Sans MS","Bradley Hand","Segoe Print",Inter,system-ui,sans-serif;
}

.btn-home{
    border-radius:14px;
    padding:10px 12px;
    font-weight:800;
    cursor:pointer;
}


/* ===============================
   Switch
================================ */
.mode-switch{
    display:flex;
    align-items:center;
    gap:10px;
    margin-top:8px;
}

.mode-label{
    font-size:13px;
    font-weight:600;
    opacity:0.5;
}

.mode-label.active{
    opacity:1;
}

.switch{
    width:44px;
    height:24px;
    background:#d0d2d8;
    border-radius:999px;
    position:relative;
    cursor:pointer;
}

.switch .knob{
    width:18px;
    height:18px;
    background:white;
    border-radius:50%;
    position:absolute;
    top:3px;
    left:3px;
}

.switch.hp{
    background:#1a73e8;
}

.switch.hp .knob{
    left:23px;
}


/* ===============================
   Mobile
================================ */
@media (max-width:480px){
    .card{
        padding:14px;
        border-radius:14px;
    }

    .card-title{
        font-size:16px;
    }

    .pill{
        font-size:12px;
        padding:4px 8px;
    }

    .sat-pill,
    .section-title{
        font-size:12px;
        padding:4px 10px;
    }
}

</style>

    
</head>
<body>

<div class="board-header">
  <div class="board-top">
    <div>
      <div class="board-title">Tableau blanc — Nono Maps</div>
      <div class="board-sub" id="counters">Chargement…</div>
    </div>

    <button class="btn-home" onclick="location.href='index.html'">← Accueil</button>
  </div>


  <div class="board-row">
    <input id="search" type="text" placeholder="Rechercher...">
  </div>
</div> 


<div class="filters">
    <button data-sort="az">A → Z</button>
    <button data-sort="za">Z → A</button>
    <button data-sort="appmax">+ appareils</button>
    <button data-sort="appmin">- appareils</button>
</div>

<div id="postesZone" class="post-container patrimoine"></div>

<script>
/* ============================================
   Tableau Blanc (v2) — From scratch
   Source de vérité : postes.json
   Injection : appareils.json
   Recherche : poste/type/SAT/appareils
============================================ */

const URL_POSTES = "postes.json";
const URL_APPAREILS = "appareils.json";

const postesZone = document.getElementById("postesZone");
const searchEl = document.getElementById("search");
const countersEl = document.getElementById("counters");

// Helpers
const norm = (v) => (v ?? "").toString().trim();
const normKey = (s) => norm(s).toLowerCase().replace(/\s+/g, " ");
const makePosteKey = (nom, type) => `${normKey(nom)}__${normKey(type)}`;

// Données en mémoire
let postesMap = {};          // { key: { nom, type, sats:Set, principal:[], satApp:{sat:[]}} }
let postesList = [];         // [{key, ...}] triée
let appareilsAll = [];       // brut
let viewKeys = [];           // keys affichés après recherche

// 1) Charger postes.json et construire la structure
async function chargerPostes(){
  const res = await fetch(URL_POSTES, { cache: "no-store" });
  let postes = await res.json();

  // ⛔ EXCLUSION DES POSTES NON VOULUS
  postes = postes.filter(p =>
    p.special !== true &&
    p.hors_patrimoine !== true
  );

  const map = {};

  postes.forEach(p => {
    const nom = norm(p.nom);
    const type = norm(p.type); // peut être ""
    const sat = norm(p.SAT);

    const key = makePosteKey(nom, type);
    if(!map[key]){
      map[key] = {
        key,
        nom,
        type,
        sats: new Set(),
        principal: [],
        satApp: {}
      };
    }

    if(sat){
      map[key].sats.add(sat);
      if(!map[key].satApp[sat]) map[key].satApp[sat] = [];
    }
  });

  postesMap = map;

  postesList = Object.values(postesMap)
    .sort((a,b) =>
      `${a.nom} ${a.type}`.localeCompare(`${b.nom} ${b.type}`, "fr", { sensitivity:"base" })
    );

  viewKeys = postesList.map(p => p.key);
  render();
}

// 2) Charger appareils.json et injecter
async function chargerAppareils(){
  const res = await fetch(URL_APPAREILS, { cache: "no-store" });
  const appareils = await res.json();
  appareilsAll = appareils;

  appareils.forEach(a => {
    const nom = norm(a.nom);
    const type = norm(a.type);     // peut être ""
    const sat = norm(a.SAT);       // "" => principal
    const key = makePosteKey(nom, type);

    // si le poste n’existe pas dans postes.json, on le crée quand même (sécurité)
    if(!postesMap[key]){
      postesMap[key] = {
        key,
        nom,
        type,
        sats: new Set(),
        principal: [],
        satApp: {}
      };
      postesList.push(postesMap[key]);
    }

    const poste = postesMap[key];

    if(sat){
      poste.sats.add(sat);
      if(!poste.satApp[sat]) poste.satApp[sat] = [];
      poste.satApp[sat].push(a);
    }else{
      poste.principal.push(a);
    }
  });

  // retri (au cas où des postes “fallback” ont été ajoutés)
  postesList = Object.values(postesMap)
    .sort((a,b) => `${a.nom} ${a.type}`.localeCompare(`${b.nom} ${b.type}`, "fr", { sensitivity:"base" }));

  viewKeys = postesList.map(p => p.key);
  render();
}

// Liens vers index
function hrefPoste(nom, type){
  const id = `${norm(nom)} ${norm(type)}`.trim();
  return `index.html?id=${encodeURIComponent(id)}`;
}
function hrefSat(nom, type, sat){
  const id = `${norm(nom)} ${norm(type)} ${norm(sat)}`.trim();
  return `index.html?id=${encodeURIComponent(id)}`;
}
function hrefAppareil(appareil, nom, type, sat){
  const id = `${norm(appareil)} ${norm(nom)} ${norm(type)} ${norm(sat)}`.trim();
  return `index.html?id=${encodeURIComponent(id)}`;
}

// UI builders
function pillHtml(a){
  const label = norm(a.appareil) || "Appareil";
  const sat = norm(a.SAT);
  const hp = (a.hors_patrimoine === true);

  // Astuce: on garde ton CSS (.hp .pill) sans le toucher :
  // si HP => wrapper .hp autour de la pill
  const inner = `<span class="pill" onclick="location.href='${hrefAppareil(label, a.nom, a.type, sat)}'">${escapeHtml(label)}</span>`;
  return hp ? `<span class="hp">${inner}</span>` : inner;
}

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function render(){
  postesZone.innerHTML = "";

  // Compteurs
  let nbPostes = 0, nbSats = 0, nbApp = 0, nbHp = 0;

  viewKeys.forEach(key => {
    const p = postesMap[key];
    if(!p) return;

    nbPostes++;
    nbSats += p.sats.size;

    nbApp += p.principal.length;
    p.principal.forEach(a => { if(a.hors_patrimoine === true) nbHp++; });

    Object.keys(p.satApp).forEach(s => {
      nbApp += p.satApp[s].length;
      p.satApp[s].forEach(a => { if(a.hors_patrimoine === true) nbHp++; });
    });

    postesZone.insertAdjacentHTML("beforeend", renderPosteCard(p));
  });

  countersEl.textContent = `Postes : ${nbPostes} • SAT : ${nbSats} • Appareils : ${nbApp}${nbHp ? ` • HP : ${nbHp}` : ""}`;
}

function renderPosteCard(p){
  const hasType = !!norm(p.type);

  const title = hasType
    ? `${escapeHtml(p.nom)} <span class="type-pill">${escapeHtml(p.type)}</span>`
    : `${escapeHtml(p.nom)} (Ville de)`;

  // principal : tri alpha
  const principal = [...p.principal].sort((a,b) => norm(a.appareil).localeCompare(norm(b.appareil), "fr", { sensitivity:"base" }));
  const principalPills = principal.map(pillHtml).join("");

  // SAT : tri alpha par nom de SAT
  const satNames = Array.from(p.sats).sort((a,b)=>a.localeCompare(b,"fr",{sensitivity:"base"}));

  let html = `
    <div class="card">
      <div class="card-title">${title}</div>

      <a class="section-title" href="${hrefPoste(p.nom, p.type)}">Poste principal</a>
      ${principalPills}
  `;

  satNames.forEach((sat, idx) => {
    const list = (p.satApp[sat] || []).slice().sort((a,b) => norm(a.appareil).localeCompare(norm(b.appareil), "fr", { sensitivity:"base" }));
    const pills = list.map(pillHtml).join("");

    // séparateur : seulement si ça a du sens visuellement
    const needSep = (principal.length > 0 && idx === 0) || (idx > 0);
    html += `
      <div class="${needSep ? "sat-block" : ""}">
        <a class="sat-pill" href="${hrefSat(p.nom, p.type, sat)}">${escapeHtml(sat)}</a>
        ${pills}
      </div>
    `;
  });

  html += `</div>`;
  return html;
}

/* =========================
   Recherche (garde ton champ)
========================= */
function appliquerRecherche(){
  const q = norm(searchEl.value).toLowerCase();
  if(!q){
    viewKeys = postesList.map(p => p.key);
    render();
    return;
  }

  const hits = [];

  postesList.forEach(p => {
    const hayPoste = `${p.nom} ${p.type}`.toLowerCase();

    // match poste/type direct
    let ok = hayPoste.includes(q);

    // match sat
    if(!ok){
      for(const sat of p.sats){
        if(sat.toLowerCase().includes(q)){ ok = true; break; }
      }
    }

    // match appareils principal
    if(!ok){
      ok = p.principal.some(a => (norm(a.appareil).toLowerCase().includes(q)));
    }

    // match appareils SAT
    if(!ok){
      for(const sat of Object.keys(p.satApp)){
        if(p.satApp[sat].some(a => (norm(a.appareil).toLowerCase().includes(q)))){
          ok = true; break;
        }
      }
    }

    if(ok) hits.push(p.key);
  });

  viewKeys = hits;
  render();
}

searchEl?.addEventListener("input", appliquerRecherche);

/* =========================
   Boot
========================= */
(async function init(){
  try{
    countersEl.textContent = "Chargement…";
    await chargerPostes();     // affiche les postes/SAT même vides
    await chargerAppareils();  // injecte les appareils
  }catch(e){
    console.error(e);
    countersEl.textContent = "Erreur de chargement (postes/appareils).";
  }
})();
</script>


</body>
</html>
