<!DOCTYPE html>
<html lang="fr">
<head>
  <meta name="robots" content="noindex, nofollow" />
  <meta charset="UTF-8" />
  <title>Cartographie des postes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
 
  <!-- Open Graph (aper√ßu lors du partage) -->
  <meta property="og:title" content="Nono Maps">
  <meta property="og:description" content="Cartographie collaborative des postes et acc√®s.">
  <meta property="og:image" content="https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/icon-512.png">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/index.html">
  
<!-- Favicon multi-tailles -->
<link rel="icon" href="https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/favicon/favicon.ico" type="image/x-icon" sizes="16x16 32x32 48x48 64x64 128x128">
<link rel="icon" type="image/png" sizes="16x16" href="https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/favicon/favicon-96x96.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/favicon/favicon-180x180.png">

<!-- Ic√¥nes pour mobiles et PWA -->
<link rel="apple-touch-icon" sizes="192x192" href="https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/favicon/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/favicon/icon-512.png">
  
<!-- Manifest PWA -->
<link rel="manifest" href="https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/manifest.json">

  <!-- Couleur adaptative -->
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0c0e">

 <!-- WebApp -->
  <meta name="mobile-web-app-capable" content="yes"> <!-- Android -->
  <meta name="apple-mobile-web-app-capable" content="yes"> <!-- iOS -->
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
   <meta name="apple-mobile-web-app-title" content="Nono Maps">

  <!-- Police & Scripts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
   
  <style id="eale-intro-styles">
    #counters {
  text-align: center;
}
  :root{--eale-intro-bg:#fff;--eale-intro-fg:#222}
  @media (prefers-color-scheme: dark){
    :root{--eale-intro-bg:#0b0b0b;--eale-intro-fg:#eee}
  }
  .eale-intro-overlay{
    position:fixed; inset:0;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:var(--eale-intro-bg); color:var(--eale-intro-fg);
    z-index:99999; user-select:none; touch-action:none;
  }
  .eale-intro-img{
    width:min(60vw,260px); height:auto; object-fit:contain; pointer-events:none;
    animation:eale-zoomIn 1.8s ease-out forwards;
  }
  .eale-intro-text{
    position:fixed; bottom:12vh; left:50%; transform:translateX(-50%);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    font-size:0.95rem; font-style:italic; text-align:center; opacity:.95; max-width:90%;
  }
  @keyframes eale-zoomIn{from{transform:scale(.6);opacity:0}to{transform:scale(1);opacity:1}}
  .eale-intro-hide{opacity:0; transition:opacity .35s ease}

.inline-links.pills-3 {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;   /* centre horizontalement */
  align-items: center;       /* centre verticalement */
  text-align: center;
  gap: 8px;
}

.inline-links.pills-3 a {
  display: inline-flex;       /* ‚úÖ force l‚Äôemoji et le texte √† s‚Äôaligner */
  align-items: center;        /* ‚úÖ centrage vertical dans le bouton */
  vertical-align: middle;     /* ‚úÖ √©limine le flottement */
  padding: 6px 10px;
}
  
    
/* Force une seule ligne d√®s qu‚Äôil y a la place */
@media (min-width: 420px){
  .inline-links.pills-3{ flex-wrap: nowrap; }
}

/* Ultra compact sur √©crans ‚â§ 390px */
@media (max-width: 390px){
  .inline-links.pills-3 a{
    padding: 6px 8px;
    font-size: 13.5px;
  }
}
    
    /* Supprime l‚Äôespace vertical quand il n‚Äôy a aucune suggestion */
ul#suggestions:empty {
  margin: 0;
  padding: 0;
}
    /* Marges compactes quand il y a des suggestions */
ul#suggestions:not(:empty){
  margin: .4rem 0 .6rem 0;
}

.editable-halo {
  display: inline-block;
  padding: 2px 4px;
  border-radius: 6px;
  position: relative;

  /* ‚úÖ halo fin + lumineux */
  box-shadow: 0 0 6px rgba(26,115,232,0.8),
              0 0 12px rgba(26,115,232,0.5);

  /* ‚úÖ pulsation plus douce */
  animation: pulseHalo 1.6s ease-in-out infinite;
}

/* üîÑ nouvelle animation plus fluide */
@keyframes pulseHalo {
  0%   { box-shadow: 0 0 4px rgba(26,115,232,0.6), 0 0 8px rgba(26,115,232,0.4); }
  50%  { box-shadow: 0 0 10px rgba(26,115,232,0.9), 0 0 18px rgba(26,115,232,0.6); }
  100% { box-shadow: 0 0 4px rgba(26,115,232,0.6), 0 0 8px rgba(26,115,232,0.4); }
}

.editable-wiggle {
  animation: wiggle 0.3s infinite; /* wiggle seul */
}

/* Tremblement fa√ßon iOS */
@keyframes wiggle {
  0%, 100% { transform: rotate(-2deg); }
  50% { transform: rotate(2deg); }
}
    
/* Style discret fa√ßon Wikip√©dia pour le lien [modifier] */
#edit-toggle {
  font-size: 13px;
  font-style: italic;
  color: #777;
  margin-left: 6px;
  text-decoration: none;
  cursor: pointer;
}

#edit-toggle:hover {
  color: #1a73e8;  /* bleu Google */
  text-decoration: underline;
}
    /* Barre d‚Äô√©dition centr√©e en bas */
#edit-buttons {
  display: none;
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;

  background: rgba(255, 255, 255, 0.8); /* fond translucide clair */
  backdrop-filter: blur(8px);            /* effet flou derri√®re */
  -webkit-backdrop-filter: blur(8px);    /* compatibilit√© iOS */

  border-radius: 16px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  padding: 12px 20px;
  display: flex;
  justify-content: center;
  gap: 16px;
  border: 1px solid #ddd;
}

/* Mode sombre */
@media (prefers-color-scheme: dark) {
  #edit-buttons {
    background: rgba(30, 30, 30, 0.8);  /* translucide fonc√© */
    border: 1px solid #444;
    box-shadow: 0 6px 20px rgba(0,0,0,0.6);
  }
}
/* Centrer proprement les titres "Rep√©rer..." */
.rep-block {
  display: block;              /* ‚¨ÖÔ∏è plus de flex ici */
  margin: 1.5rem 0 0.5rem 0;
  text-align: center;          /* ‚¨ÖÔ∏è centre juste le contenu */
}

.rep-block p {
  font-weight: 600;
  margin: 0 0 6px 0;
  text-align: center;   /* ‚úÖ centrage simple et propre */
}

    .rep-block p .emoji {
  display: inline-block;
  width: 1.6em;   /* ‚úÖ m√™me largeur pour tous */
  text-align: center;
}

    .rep-block.poste-only p {
  transform: translateX(-14px);  /* d√©cale le texte vers la gauche */
}
.placeholder {
  color: #888;
  font-style: italic;
}
    
</style>
  <style>
body {
  font-family: 'Inter', sans-serif;
  background-color: #fff;
  padding: 1rem;
  color: #333;
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: stretch;   /* ‚úÖ laisse les √©l√©ments prendre leur largeur */
  width: 100%;
  max-width: 100%;        /* ‚úÖ emp√™che le centrage forc√© */
  box-sizing: border-box;
}
    #train-container {
      width: 100%;
      max-width: 600px;
      height: 48px;
      overflow: hidden;
      margin-bottom: 3rem;
      position: relative;
    }
    /* R√©duit l‚Äôespace sous le train sur petits √©crans */
@media (max-width: 600px){
  #train-container { margin-bottom: .8rem; }
  h1 { margin-bottom: .4rem; }
}
    #train {
      position: absolute;
      top: 0;
      left: 0;
      height: 42px;
      animation: trainVaEtVient 28s ease-in-out infinite;
    }
    @keyframes trainVaEtVient {
      0%, 100% { left: 0; }
      45%, 50% { left: calc(100% - 140px); }
      95% { left: 0; }
    }
    h1 {
      font-size: 20px;
      margin: 0 0 0.8rem 0;
      font-weight: 600;
      width: 100%;
      max-width: 600px;
      padding: 0 1rem;
      text-align: left;
    }
input[type="text"] {
  width: 100%;
  max-width: 600px;   /* ‚úÖ limite √† 600px comme avant */
  padding: 12px 16px;
  font-size: 16px;
  border-radius: 10px;
  border: 1px solid #ccc;
  box-sizing: border-box;
  outline: none;
  transition: border-color 0.3s ease;
}
  
    input[type="text"]:focus {
      border-color: #1a73e8;
      box-shadow: 0 4px 14px rgba(26,115,232,0.4);
    }

    #result {
      display: none;
      background: #ffffff;
      padding: 1rem 1.1rem;
      border-radius: 18px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      max-width: 600px;
      width: 100%;
      color: #444;
      font-size: 15px;
      line-height: 1.5;
    }
#result h2 {
  margin-top: 0;
  font-size: 22px;
  font-weight: 700;
  color: #1a73e8;
  text-align: left;   /* ‚úÖ remet le titre √† gauche */
}

    /* ‚Äî‚Äî‚Äî Uniformiser exactement la largeur avec le champ ‚Äî‚Äî‚Äî */
#search,
#suggestions,
#result,
#counters {
  width: 100%;
  max-width: 600px;     /* m√™me limite partout */
}

/* Les paddings ne doivent PAS √©largir visuellement le bloc */
#suggestions,
#result {
  box-sizing: border-box;
}

/* Optionnel : m√™me ¬´ bordure ¬ª visuelle que le champ */
#result {
  border: 1px solid transparent; /* √©vite les micro-d√©calages sur mobile */
}
    
    .inline-links {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 14px;
      padding: 0 1rem 0 0;
    }
    .inline-links a {
      padding: 6px 10px;
      font-size: 14px;
      text-decoration: none;
      color: #1a73e8;
      border: 1px solid #1a73e8;
      border-radius: 10px;
      transition: 0.3s;
      white-space: nowrap;
    }
    .inline-links a:hover {
      background-color: #1a73e8;
      color: white;
    }
    .separator {
      border: none;
      border-top: 1px solid #eee;
      margin: .8rem 0;
    }

    /* Style de la liste de suggestions */
ul#suggestions {
  list-style: none;
  padding: 0;
  margin: 0 0 0.5rem 0;
  max-width: 600px;
  width: 100%;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  background-color: #fff;
  font-size: 15px;
  color: #333;
}
ul#suggestions li {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid #eee;
}
ul#suggestions li:hover {
  background-color: #f0f8ff;
  color: #1a73e8;
}
/* Variante sombre */
@media (prefers-color-scheme: dark){
  ul#suggestions {
    background-color: #1e1e1e;
    color: #e5e5e5;
    box-shadow: 0 6px 15px rgba(255,255,255,0.05);
  }
  ul#suggestions li { border-bottom:1px solid #333; }
  ul#suggestions li:hover { background-color:#1e2a36; color:#90caf9; }
}
        /* surbrillance du meilleur r√©sultat */
li.best {
  background-color: #e6f0ff;
  font-weight: 600;
}
@media (prefers-color-scheme: dark){
  li.best {
    background-color: #1b2836; /* bleu fonc√© doux */
  }
}
    @media (prefers-color-scheme: dark) {
  #result {
    background: #1e1e1e;   /* gris fonc√© au lieu de blanc */
    color: #e5e5e5;        /* texte clair */
    box-shadow: 0 8px 24px rgba(255,255,255,0.05); /* ombre douce */
  }
}
    /* --- MODE SOMBRE AUTOMATIQUE --- */
@media (prefers-color-scheme: dark) {
  body {
    background-color: #121212;
    color: #e5e5e5;
  }

  h1,
  #result h2 {
    color: #90caf9;
  }

  input[type="text"] {
    background-color: #1e1e1e;
    color: #e5e5e5;
    border: 1px solid #555;
  }

  .inline-links a {
    color: #90caf9;
    border-color: #90caf9;
  }

  .inline-links a:hover {
    background-color: #90caf9;
    color: #121212;
  }
}/* === Liens : m√™me couleur en normal / visited === */

  /* Lien de titre invisible visuellement */
.titre-lien{
  color:inherit;
  text-decoration:none;
}
.titre-lien:hover,
.titre-lien:focus{ opacity:.85; }


/* Encadr√© "Appareil manquant" */
.missing-box {
  background-color:#e6f0ff;
  border-radius:12px;
  padding:12px 16px;
  margin-top:1.2rem;
  text-align:center;
  font-size:15px;
}
.missing-box a {
  color:#1a73e8; 
  font-weight:600;
}
    
#about-footer {
  width: 100%;
  text-align: center;
  padding: 15px 0;
  font-size: 13px;
  background: #121212; /* sera √©cras√© par le mode clair/sombre */
  border-top: 1px solid #333;
  margin-top: 40px; /* espace avant le footer */
}

.footer-version {
  color: #999; /* gris clair comme avant */
  font-size: 11px;
}

/* Si la page est tr√®s courte, pousse le footer en bas */
html, body {
  height: 100%;
  margin: 0;
  display: flex;
  flex-direction: column;
}

main {
  flex: 1; /* pousse le footer vers le bas */
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Variante claire / sombre pour lisibilit√© */
@media (prefers-color-scheme: light) {
  #about-footer {
    background: #fff;
    color: #333;
    border-top: 1px solid #ddd;
  }
}

@media (prefers-color-scheme: dark) {
  #about-footer {
    background: #121212;
    color: #aaa;
    border-top: 1px solid #333;
  }
}
/* --- Dark mode sp√©cial liens et box --- */
@media (prefers-color-scheme: dark){
  a, a:visited { 
    color:#90caf9; 
  }

  .inline-links a:hover { 
    background-color:#90caf9; 
    color:#121212; 
  }

  .missing-box {
    background-color:#16202c;
    border:1px solid #243447;
  }
  .missing-box a { 
    color:#90caf9; 
  }
}
    /* Style des boutons */
.btn-primary {
  margin: 8px 0;
  padding: 10px 16px;
  border-radius: 10px;
  border: 1px solid #1a73e8;
  background: #f5f9ff;   /* clair */
  color: #1a73e8;
  font-weight: 600;
  cursor: pointer;
  font-size: 15px;
  transition: background 0.2s, color 0.2s;
  text-decoration: none; /* üëà enl√®ve le soulignement */
}

.btn-primary:hover {
  background: #1a73e8;
  color: #fff;
}

    
/* üåô Mode sombre */
@media (prefers-color-scheme: dark) {
  .btn-primary {
    background: #1e1e1e;   /* gris tr√®s fonc√© */
    color: #90caf9;        /* bleu clair */
    border: 1px solid #90caf9;
  }
  .btn-primary:hover {
    background: #90caf9;
    color: #121212;
  }
}
    #btn-localiser { margin-top: 4rem; }  /* plus d‚Äôespace au-dessus */

  #notification {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  min-width: 240px;
  max-width: 90%;
  padding: 12px 18px;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 500;
  text-align: center;
  display: none;
  z-index: 99999;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

/* Succ√®s */
#notification.success {
  background: #e6f4ea;
  color: #137333;
  border: 1px solid #137333;
}

/* Erreur */
#notification.error {
  background: #fce8e6;
  color: #b00020;
  border: 1px solid #b00020;
}

/* Info (pour annulation) */
#notification.info {
  background: #e8f0fe;
  color: #174ea6;
  border: 1px solid #174ea6;
}

/* Mode sombre */
@media (prefers-color-scheme: dark) {
  #notification.success {
    background: #1e2a21;
    color: #8dd39c;
    border: 1px solid #8dd39c;
  }
  #notification.error {
    background: #3a1c1c;
    color: #ff8a80;
    border: 1px solid #ff8a80;
  }
  #notification.info {
    background: #1a237e;
    color: #90caf9;
    border: 1px solid #90caf9;
  }
}
    .rep-block.horizontal {
  flex-direction: row;          
  justify-content: center;      
  align-items: center;          
  gap: 12px;                    
}

.rep-block.horizontal p {
  margin: 0; 
  font-weight: 600;
}
  
  </style>
</head>
<body> <main>
  <div id="train-container">
 <img id="train"
     src="images/train1.gif"
     alt="Train anim√©"
     title="Clique pour changer de train"
     style="cursor:pointer" />
  </div>

<h1>
  üöò <a href="itineraire.html" style="color:inherit; text-decoration:none;">
    Itin√©raire et infos
  </a>
</h1>
<input type="text" id="search" placeholder="Entrer un poste ou un appareil" autocomplete="off" />
<ul id="suggestions"></ul>
<div id="result"></div>


  <!-- Boutons flottants pour √©dition -->
<div id="edit-buttons" style="display:none;">
  <button id="btn-save" class="btn-primary">üíæ Sauvegarder</button>
  <button id="btn-cancel" class="btn-primary">‚ùå Annuler √©dition</button>
</div>


<!-- Bouton localiser -->
<button id="btn-localiser" class="btn-primary">
  üìç √Ä proximit√©
</button>
<div id="proximite" style="margin-top:1rem; font-size:14px;"></div>
<div id="proximite-actions" style="text-align:center; margin:10px 0;">
  <button id="voir-plus" class="btn-primary" style="display:none;">‚ûï Voir plus</button>
</div>
  <script>
const jsonUrl = "https://raw.githubusercontent.com/arnaud-upmre/carto3f9b7d1a5c8e4f2b/main/postes.json";
const appareilsUrl = "https://raw.githubusercontent.com/arnaud-upmre/carto3f9b7d1a5c8e4f2b/main/appareils.json";
const compteurURL = "https://script.google.com/macros/s/AKfycbzUFaek89LYosR0FSw9gyxn2IZXlFlWXA_dIFIDwox-szE3DgH-l8IVbGfaoIgGK04h/exec";
const compteurAppareilURL = "https://script.google.com/macros/s/AKfycbwJIlvcfNYREJn1oPiVAhQqHACXXar8ZbRl6aChwYw4TFSAaMTFEHTT5X2T7BKLJ3gsJw/exec";

let lieux = [], appareils = [];
    let currentItem = null; // ‚úÖ m√©morise la fiche affich√©e

function myMapsViewer(lat, lon, z = 19, id = "") {
  let url = `map.html?lat=${lat}&lon=${lon}&z=${z}`;
  if (id) url += `&id=${encodeURIComponent(id)}`;
  return url;
}
    
// Pagination proximit√©
let proximiteIndex = 0;
const PROX_STEP = 10;
let proximiteSorted = [];
    
function formatContact(val) {
  if (!val) return `<p><strong id="editable-contact">üë§ Contact :</strong> <span class="placeholder">(non renseign√©)</span></p>`;

  const phoneRegex = /\d{2}\s?\d{2}\s?\d{2}\s?\d{2}\s?\d{2}/g;
  const matches = val.match(phoneRegex);

  if (!matches) {
    return `<p><strong id="editable-contact">üë§ Contact :</strong> ${val}</p>`;
  }

  const texteSansNum = val.replace(phoneRegex, "").trim();

  const boutons = matches.map(num => {
    const cleaned = num.replace(/\s+/g, "");
    return `<a href="tel:${cleaned}">${num}</a>`;
  }).join(" ");

  return `<p><strong id="editable-contact">üë§ Contact :</strong> ${texteSansNum} ${boutons}</p>`;
}

function formatPortail(val) {
  if (!val) return `<p><strong id="editable-portail">üöß Portail :</strong> <span class="placeholder">(non renseign√©)</span></p>`;

  // Cherche une URL dans la cha√Æne
  const urlRegex = /(https?:\/\/[^\s]+)/;
  const urlMatch = val.match(urlRegex);
  const video = urlMatch ? urlMatch[0] : null;

  const code = val.replace(urlRegex, "").trim();

  const phoneRegex = /^(\d{10}|\d{2}(\s?\d{2}){4})([,\;\*#0-9]*)?$/;
  let content = "";

  if (phoneRegex.test(code)) {
    const cleaned = code.replace(/\s+/g, "");
    content = `<a href="tel:${cleaned}">${code}</a>`;
  } else {
    content = code;
  }

  if (video) {
    content += ` <a href="${video}" target="_blank" rel="noopener">‚ñ∂Ô∏è Explication</a>`;
  }

  return `<p><strong id="editable-portail">üöß Portail :</strong> ${content}</p>`;
}

    function formatDescription(val) {
  return `<p><strong id="editable-description">‚ÑπÔ∏è Informations :</strong> 
    ${val ? `<span class="desc-value">${val}</span>` : '<span class="placeholder">(non renseign√©)</span>'}
  </p>`;
}
    
function normalize(str) {
  return str
    .normalize("NFD")
    .replace(/[ÃÄ-ÕØ]/g, "")     // supprime accents
    .replace(/[^a-z0-9\s]/gi, "") // conserve les espaces !
    .toLowerCase()
    .trim()
    .replace(/\s+/g, " ");    // r√©duit multiples espaces en un seul
}

    // Normalisation sp√©ciale pour comparer les noms de postes sans tenir compte du type
function normalizeNomPoste(name) {
  if (!name) return "";
  return name
    .normalize("NFD")
    .replace(/[ÃÄ-ÕØ]/g, "")       // supprime accents
    .toLowerCase()
    .trim()
    
    // supprime les suffixes en fin de nom (SP, SSP, PRCI, etc.)
    .replace(/\b(?:a|p|sp|ssp|sspa|l|l-a|prci|lgv|ss|sst)\b$/i, "")
    .trim();
}

    
// Requ√™te qui ressemble √† un APPAREIL ? (pr√©fixe connu ou pr√©sence de chiffres)
function isAppareilLike(raw){
  if(!raw) return false;
  const s = raw.trim().toLowerCase();
  const prefixes = ["tt","i","tc","tsa","il","ip","imp","s"]; // m√™mes que ton filtre
  const first = s.split(/\s+/)[0];
  const hasDigits = /\d/.test(s);
  return prefixes.includes(first) || hasDigits;
}

// Requ√™te qui ressemble √† un POSTE ? (‚â•3 caract√®res et pas ¬´ appareil-like ¬ª)
function isPosteLike(raw){
  if(!raw) return false;
  const s = raw.trim();
  return s.length >= 3 && !isAppareilLike(s);
}

function formatNomCompletLieu(obj) {
  const base = `${obj.nom || ''} ${obj.type || ''} ${obj.SAT || ''}`.trim();
  return obj.acc√®s ? `${base} ‚Äì acc√®s ${obj.acc√®s}` : base;
}

function formatNomComplet(obj) {
  return `${obj.nom || ''} ${obj.type || ''}`.trim();
}
function formatRSS(table, showPhones = true) {
  const tables = {
    "A": ["03 28 55 82 56", "03 28 55 82 57"],
    "B": ["03 28 55 82 58", "03 28 55 82 59"],
    "C": ["03 28 55 82 53", "03 28 55 82 54"]
  };
  const tableNum = { "A": "1", "B": "2", "C": "3" };

  if (!tables[table]) {
    return `<p><strong id="editable-rss">üìû RSS :</strong> ${table}</p>`;
  }

  let html = `<p><strong id="editable-rss">üìû RSS Table ${tableNum[table] || table}</strong></p>`;

  if (showPhones) {
    const nums = tables[table]
      .map(num => `<a href="tel:${num.replace(/\s+/g, '')}">${num}</a>`)
      .join(" ");
    html += `<div id="rss-phones" class="inline-links">${nums}</div>`;
  }
  return html;
}
    
function generateAppareilListHTML(currentLieu) {
  const matchingApps = appareils.filter(app => 
    app.nom  === currentLieu.nom  &&
    app.type === currentLieu.type
  );

  const isSAT = currentLieu.SAT && currentLieu.SAT !== "";

  // ‚úÖ Si on est dans un SAT, on ne compte que les appareils de CE SAT
  const matchingAppsForScope = isSAT
    ? matchingApps.filter(app => (app.SAT || "") === currentLieu.SAT)
    : matchingApps;

  // Aucun appareil trouv√© dans le scope (SAT pr√©cis ou poste entier)
  if (matchingAppsForScope.length === 0) {
    return `
      <div class="missing-box">
        ü§ù Appareil manquant ?
       <a href="ajout_appareil.html?poste=${encodeURIComponent(formatNomCompletLieu(currentLieu))}">Aidez-nous √† l‚Äôajouter.</a>
      </div>
    `;
  }

  // Il y a au moins un appareil dans le scope ‚Üí titre + liste
  let grouped = {};
  matchingAppsForScope.forEach(app => {
    const sat = app.SAT || 'Poste';
    if (!grouped[sat]) grouped[sat] = [];
    grouped[sat].push(app);
  });

  let html = `<p><strong>üß© Appareils trouv√©s dans ce ${isSAT ? 'SAT' : 'poste'} :</strong></p>`;

  for (const [sat, list] of Object.entries(grouped)) {
    if (!isSAT) {
      html += `<p><strong>${sat === "Poste" ? "Poste" : sat} :</strong> `;
    } else {
      html += `<p>`;
    }
    html += list
      .map(app => `<a href="#" onclick='showAppareil(${JSON.stringify(app)})'>${app.appareil}</a>`)
      .join(", ") + `</p>`;
  }

  // Carte bleue toujours pr√©sente en dessous
  html += `
    <div class="missing-box">
      ü§ù Appareil manquant ?
      <a href="ajout_appareil.html?poste=${encodeURIComponent(formatNomCompletLieu(currentLieu))}">Aidez-nous √† l‚Äôajouter.</a>
    </div>
  `;

  return html;
}
    
function generateAlias(appareil, nom, sat, posteType) {
  const alias = new Set();
  const norm = str => (str || "").toLowerCase().trim();

  const a = norm(appareil); 
  const n = norm(nom);    
  const s = norm(sat);
  const t = norm(posteType);

  // S√©pare lettres et chiffres
  const match = a.match(/^([a-z]+)(\d+)?$/i);
  const letters = match ? match[1].toLowerCase() : a; // ex. "tt"
  const root = a.split(/[\s\-]/)[0]; // ex. "tt5631"

  // --- alias de base ---
  alias.add(a);                                // tt5631
  alias.add(a.replace(/([a-z]+)(\d+)/, "$1 $2")); // tt 5631
  alias.add(letters);                          // tt

  // --- combinaisons appareil + nom complet ---
  if (n) {
    alias.add(`${a} ${n}`);
    alias.add(`${n} ${a}`);
    alias.add(`${root} ${n}`);
    alias.add(`${n} ${root}`);
    alias.add(`${letters} ${n}`);
    alias.add(`${n} ${letters}`);
  }

  // --- alias automatiques pour les interrupteurs ---
  if (/^(i|ia|il|ip|imp)/i.test(a)) {
    alias.add("interrupteur");
    alias.add("inter");                       // ‚úÖ abr√©viation
    alias.add(`interrupteur ${a}`);
    alias.add(`inter ${a}`);                  // ‚úÖ abr√©viation + code
    if (n) {
      alias.add(`interrupteur ${n}`);
      alias.add(`inter ${n}`);                // ‚úÖ abr√©viation + nom du poste
    }
  }

  // --- alias automatiques pour les transformateurs ---
  if (/^(tt|tc|tsa)/i.test(a)) {
    alias.add("transformateur");
    alias.add("transfo");                        // ‚úÖ abr√©viation
    alias.add(`transformateur ${a}`);
    alias.add(`transfo ${a}`);                   // ‚úÖ variante abr√©g√©e
    if (n) {
      alias.add(`transformateur ${n}`);
      alias.add(`transfo ${n}`);                 // ‚úÖ abr√©viation + nom
    }
  }

  // --- alias automatiques pour les sectionneurs ---
  if (/^s?\d+$/i.test(a) || /^sm/i.test(a) || /^st/i.test(a)) {   // ex: "5068", "S5068", "SM123", "ST45"
    alias.add("sectionneur");
    alias.add(`sectionneur ${a}`);
    if (n) alias.add(`sectionneur ${n}`);
  }

  // --- combinaisons appareil + chaque mot du nom ---
  if (n) {
    const mots = n.split(/\s+/); // s√©pare chaque mot
    mots.forEach(m => {
      alias.add(`${letters} ${m}`);
      alias.add(`${m} ${letters}`);
      alias.add(`${letters.toUpperCase()} ${m}`);
      alias.add(`${m} ${letters.toUpperCase()}`);
    });
  }

  // --- combinaisons avec SAT ---
  if (s) {
    alias.add(`${a} ${s}`);
    alias.add(`${s} ${a}`);
    if (n) {
      alias.add(`${a} ${n} ${s}`);
      alias.add(`${n} ${s} ${a}`);
      alias.add(`${letters} ${n} ${s}`);
      alias.add(`${n} ${s} ${letters}`);
    }
  }

  // --- combinaisons avec type de poste ---
  if (t && n) {
    alias.add(`${n} ${t}`);
    alias.add(`${t} ${n}`);
  }

  return Array.from(alias);
} // ‚Üê ferme bien generateAlias


function incrementCounter() {
  fetch(compteurURL + "?increment=true").catch(() => {});
}

function incrementCounterAppareil() {
  fetch(compteurAppareilURL + "?increment=true").catch(() => {});
}

function showLieu(lieu) {
    currentItem = lieu; // ‚úÖ m√©morise le poste affich√©
// üîπ Cas sp√©cial : acc√®s g√©n√©rique ‚Üí affichage r√©duit
if (lieu.special === true) {
  const result = document.getElementById("result");
  document.getElementById("suggestions").innerHTML = "";
  result.style.display = "block";

  let html = `<h2>
  üìç ${lieu.nom}
</h2>`;

  // Bloc Rep√©rer l‚Äôacc√®s
  html += `
  <div class="rep-block">
    <p><span class="emoji">üõ£Ô∏è</span> Rep√©rer l‚Äôacc√®s :</p>
    <div class="inline-links pills-3">
      <a href="${myMapsViewer(lieu.latitude, lieu.longitude, 19)}" target="_blank" rel="noopener">üõ∞Ô∏è Vue satellite</a>
      <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lieu.latitude},${lieu.longitude}" target="_blank" rel="noopener">üëÅÔ∏è Street View</a>
    </div>
  </div>`;

  // Bloc Itin√©raires
  html += `
  <div class="rep-block">
    <p><span class="emoji">üöô</span> Itin√©raires disponibles :</p>
    <div class="inline-links pills-3">
      <a href="https://www.google.com/maps?q=${lieu.latitude},${lieu.longitude}" target="_blank" rel="noopener">üó∫Ô∏è Maps</a>
      <a href="https://maps.apple.com/?daddr=${lieu.latitude},${lieu.longitude}" target="_blank" rel="noopener">üçé Plans</a>
      <a href="https://waze.com/ul?ll=${lieu.latitude},${lieu.longitude}&navigate=yes" target="_blank" rel="noopener">üöó Waze</a>
    </div>
  </div>`;

    // Ajoute description et portail
  const blocs = [];

  blocs.push(formatDescription(lieu.description));
  blocs.push(formatPortail(lieu.portail));

  if (blocs.length > 0) {
    html += `<hr class="separator" />` +
            blocs.map((b,i)=> i===0 ? b : `<hr class="separator" />${b}`).join("");
  }

  result.innerHTML = html;
  return; // ‚õî stoppe ici ‚Üí pas d‚Äôaffichage PK / RSS / Portail etc.
}
  
  const result = document.getElementById("result");
  document.getElementById("suggestions").innerHTML = "";
  result.style.display = "block";
  incrementCounter();

// URL MyMaps : priorit√© aux coords gu√©rite si pr√©sentes, sinon acc√®s
const _latPoste = (lieu.poste_latitude ?? "").toString();
const _lonPoste = (lieu.poste_longitude ?? "").toString();
const usePoste = _latPoste !== "" && _lonPoste !== "";
const targetLat = usePoste ? _latPoste : lieu.latitude;
const targetLon = usePoste ? _lonPoste : lieu.longitude;
const urlMyMapsPoste = myMapsViewer(
  targetLat,
  targetLon,
  20,
  [lieu.nom, lieu.type, lieu.SAT, "poste"].filter(Boolean).join(" ")
);

let html = `<h2>
  üìç <span id="editable-nom">${lieu.nom}</span> 
  <span id="editable-type">${lieu.type}</span>
  ${lieu.SAT ? `<span id="editable-sat"> ${lieu.SAT}</span>` : ""}
  ${lieu.acc√®s ? `<span id="editable-acces"> ‚Äì acc√®s ${lieu.acc√®s}</span>` : ""}
  <a href="#" id="edit-toggle">[modifier]</a>
</h2>`;
    
// ‚úÖ Affiche "Rep√©rer le poste" seulement si les coordonn√©es poste sont pr√©sentes
html += `
<div class="rep-block poste-only">
  <p id="editable-rep-poste"><span class="emoji">‚ö°Ô∏è</span> Rep√©rer le poste (sat/gu√©rite)</p>
  <div class="inline-links pills-3">
    ${
      usePoste
        ? `<a href="${urlMyMapsPoste}">üõ∞Ô∏è Vue satellite</a>`
        : `<span class="placeholder">(non renseign√© ‚Äì fournir un lien Maps)</span>`
    }
  </div>
</div>`;

html += `
<div class="rep-block">
  <p id="editable-rep-acces"><span class="emoji">üõ£Ô∏è</span> Rep√©rer l‚Äôacc√®s :</p>
  <div class="inline-links pills-3">
<a href="${myMapsViewer(
  lieu.latitude,
  lieu.longitude,
  19,
  [lieu.nom, lieu.type, lieu.SAT, lieu.acc√®s].filter(Boolean).join(" ")
)}">üõ∞Ô∏è Vue satellite</a>
    <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lieu.latitude},${lieu.longitude}" target="_blank" rel="noopener">üëÅÔ∏è Street View</a>
  </div>
</div>`;
  
html += `
<div class="rep-block">
  <p><span class="emoji">üöô</span> Itin√©raires disponibles :</p>
  <div class="inline-links pills-3">
    <a href="https://www.google.com/maps?q=${lieu.latitude},${lieu.longitude}" target="_blank" rel="noopener">üó∫Ô∏è Maps</a>
    <a href="https://maps.apple.com/?daddr=${lieu.latitude},${lieu.longitude}" target="_blank" rel="noopener">üçé Plans</a>
    <a href="https://waze.com/ul?ll=${lieu.latitude},${lieu.longitude}&navigate=yes" target="_blank" rel="noopener">üöó Waze</a>
  </div>
</div>`;

const blocs = [];

// RSS ‚Üí s‚Äôil existe, on le met en premier
if (lieu.rss) {
blocs.push(formatRSS(lieu.rss, true));
}

// üöÑ PK + Ligne (m√™me si incomplet)
const pk = lieu.pk 
  ? `<strong id="editable-pk">${lieu.pk}</strong>` 
  : `<span id="editable-pk" class="placeholder">(non renseign√©)</span>`;

const numLigne = lieu.numero_ligne 
  ? `<strong id="editable-numero_ligne">${lieu.numero_ligne}</strong>` 
  : `<span id="editable-numero_ligne" class="placeholder">(non renseign√©)</span>`;

const ligneNom = lieu.lignes 
  ? ` <span id="ligne-nom">‚Äì ${lieu.lignes}</span>` 
  : "";

blocs.push(`
  <p>
    <strong>üöÑ PK</strong> ${pk}
    sur la ligne n¬∞${numLigne}${ligneNom}
  </p>
`);

// Informations
blocs.push(formatDescription(lieu.description));
  
// Contact
blocs.push(
  formatContact(lieu.contact) ||
  `<p><strong id="editable-contact">üë§ Contact :</strong> <span class="contact-value"><span class="placeholder">(non renseign√©)</span></span></p>`
);

// Portail
blocs.push(
  formatPortail(lieu.portail) ||
  `<p><strong id="editable-portail">üöß Portail :</strong> <span class="portail-value"><span class="placeholder">(non renseign√©)</span></span></p>`
);

  
  if (blocs.length > 0) {
    html += `<hr class="separator" />` +
            blocs.map((b,i)=> i===0 ? b : `<hr class="separator" />${b}`).join("");
  }

  const appareilsHTML = generateAppareilListHTML(lieu);
  if (appareilsHTML) {
    html += `<hr class="separator" />${appareilsHTML}`;
  }

  result.innerHTML = html;
}

  let allItems = [], fuseMix;

// Charger postes + appareils
Promise.all([
  fetch(jsonUrl).then(r => r.json()),
  fetch(appareilsUrl).then(r => r.json())
]).then(([postes, apps]) => {
  lieux = postes;
  appareils = apps;

  // G√©n√®re dynamiquement les alias pour les appareils
  appareils.forEach(app => {
    app.alias = generateAlias(app.appareil, app.nom, app.SAT, app.type);
  });


  // --- FUSE mixte (postes + appareils) ---
  const postesTagged = postes.map(p => ({ ...p, category: "poste" }));
  const appsTagged   = apps.map(a => ({ ...a, category: "appareil" }));
  allItems = [...postesTagged, ...appsTagged];

  fuseMix = new Fuse(allItems, {
    keys: [
      { name: "nom", weight: 0.8 },
      { name: "type", weight: 0.2 },
      { name: "SAT", weight: 0.2 },
      { name: "appareil", weight: 0.6 },
      { name: "alias", weight: 0.7 },
      { name: "acc√®s", getFn: o => o.acc√®s?.toString?.() || "", weight: 0.2 }
    ],
    includeScore: true,
    threshold: 0.30,
    distance: 50,
    minMatchCharLength: 2,
    ignoreLocation: true
  });
});

document.getElementById("search").addEventListener("input", e => {
  const query = normalize(e.target.value.trim());
  const suggestionsEl = document.getElementById("suggestions");
  const resultEl = document.getElementById("result");

  // Nettoyage affichage
  suggestionsEl.innerHTML = "";
  resultEl.innerHTML = "";
  resultEl.style.display = "none";

  // N'affiche qu'√† partir de 2 lettres
  if (!query || query.length < 2 || !fuseMix) return;

  // R√©sultats bruts
let results = fuseMix.search(query).map(r => r.item);
  const cleanedQuery = query.replace(/\s+/g, "").toLowerCase();

// -------- Filtre sp√©cial pr√©fixe appareils --------
const queryWords = query.split(/\s+/);
const prefixes = ["tt","i","tc","tsa","il","ip","imp","s"];
const lowerWords = queryWords.map(w => w.toLowerCase());

const prefixWord = lowerWords.find(w => prefixes.includes(w));

if (prefixWord) {
  // S√©pare pr√©fixe et autres mots
  const otherWords = lowerWords.filter(w => w !== prefixWord);

  results = results.filter(item => {
    const appareilOk = item.appareil && item.appareil.toLowerCase().startsWith(prefixWord);
    const nomOk = otherWords.every(w => normalize(item.nom || "").includes(w));
    return appareilOk && nomOk;
  });
}
// -------- Fin filtre sp√©cial --------
// Boost si la requ√™te correspond exactement √† un alias
results.forEach(it => {
  const aliases = Array.isArray(it.alias) ? it.alias : [];
  it.__directAliasHit = aliases.some(a => normalize(a) === query);
});
// -------- TRI AVANC√â ----------
results.sort((a, b) => {
  const q = query.toLowerCase();

  // Normalisations utiles
  const norm = s => (s || "").toString().toLowerCase().normalize("NFD").replace(/[ÃÄ-ÕØ]/g, "").trim().replace(/\s+/g, " ");
  const id = x => (x.appareil || "").toString().replace(/\s+/g, "").toLowerCase();     // ex: "i7216"
  const idDigits = x => id(x).replace(/\D/g, "");                                       // ex: "7216"

  // Utilise la cleanedQuery d√©finie plus haut
  const qId = cleanedQuery;             // ex: "i7216" ou "7216"
  const qDigits = cleanedQuery.replace(/\D/g, "");

  // --- priorit√© -2 : correspondance EXACTE sur l'identifiant d'appareil (avec ou sans lettre) ---
  const aExactId = a.category === "appareil" && (id(a) === qId || (qDigits && idDigits(a) === qDigits));
  const bExactId = b.category === "appareil" && (id(b) === qId || (qDigits && idDigits(b) === qDigits));
  if (aExactId && !bExactId) return -1;
  if (bExactId && !aExactId) return 1;

  // --- priorit√© -1 : correspondance EXACTE sur un alias normalis√© ---
  const aliasHit = (x) => Array.isArray(x.alias) && x.alias
      .map(s => s.replace(/\s+/g, "").toLowerCase())
      .some(s => s === qId || (qDigits && s.replace(/\D/g, "") === qDigits));
  const aAlias = a.category === "appareil" && aliasHit(a);
  const bAlias = b.category === "appareil" && aliasHit(b);
  if (aAlias && !bAlias) return -1;
  if (bAlias && !aAlias) return 1;

  // --- le reste comme avant ---
  const aNom = norm(a.nom || "");
  const bNom = norm(b.nom || "");

  // 0 : le nom qui COMMENCE par la requ√™te
  const aStarts = aNom.startsWith(q);
  const bStarts = bNom.startsWith(q);
  if (aStarts && !bStarts) return -1;
  if (bStarts && !aStarts) return 1;

  // 1 : correspondance exacte sur le nom
  const aExact = aNom === q;
  const bExact = bNom === q;
  if (aExact && !bExact) return -1;
  if (bExact && !aExact) return 1;

  // 2 : postes simples avant tout
  const aIsPoste = a.category === "poste" && !a.acc√®s;
  const bIsPoste = b.category === "poste" && !b.acc√®s;
  if (aIsPoste && !bIsPoste) return -1;
  if (bIsPoste && !aIsPoste) return 1;

  // 3 : postes avec acc√®s ensuite
  const aIsAcces = a.category === "poste" && !!a.acc√®s;
  const bIsAcces = b.category === "poste" && !!b.acc√®s;
  if (aIsAcces && !bIsAcces) return -1;
  if (bIsAcces && !aIsAcces) return 1;

  // 4 : appareils en dernier vis-√†-vis des postes
  if (a.category === "appareil" && b.category !== "appareil") return 1;
  if (b.category === "appareil" && a.category !== "appareil") return -1;

  // 5 : tri alphab√©tique stable
  const label = x =>
    x.category === "poste"
      ? `${x.nom || ""} ${x.type || ""} ${x.SAT || ""}`.trim()
      : `${x.appareil} (${x.nom}${x.type ? " " + x.type : ""}${x.SAT ? " / " + x.SAT : ""})`;

  return label(a).localeCompare(label(b), "fr", { sensitivity: "base" });
});
  // -------- fin TRI AVANC√â ----------
  // ‚Äî‚Äî‚Äî 0 r√©sultat : proposer l‚Äôajout ‚Äî‚Äî‚Äî
const rawQuery = e.target.value.trim();  // on garde tel quel pour l‚Äôaffichage + pr√©remplissage
if (results.length === 0 && rawQuery.length >= 3) {
  const li = document.createElement("li");
  li.style.fontStyle = "italic"; // l√©ger pour signaler que c'est une action sp√©ciale

  if (isAppareilLike(rawQuery)) {
    li.textContent = `‚ûï Ajouter cet appareil ¬´ ${rawQuery} ¬ª`;
    li.onclick = () => {
      location.href = `ajout_appareil.html?appareil=${encodeURIComponent(rawQuery)}`;
    };
} else if (isPosteLike(rawQuery)) {
  li.textContent = `‚ûï Ajouter ce poste ¬´ ${rawQuery} ¬ª`;
  li.onclick = () => {
    location.href = `ajout_poste.html?poste=${encodeURIComponent(rawQuery)}`;
  };
} else {
    // Trop court / bruit ‚Üí on ne propose rien
    return;
  }

  suggestionsEl.appendChild(li);
  return; // on s'arr√™te ici : pas d‚Äôautres lignes √† afficher
}
// --- Affichage des r√©sultats (avec ic√¥nes) ---
suggestionsEl.innerHTML = "";

const labelFor = (item) =>
  (item.category === "poste")
    ? formatNomCompletLieu(item)
    : `${item.appareil} (${item.nom}${item.type ? ' ' + item.type : ''}${item.SAT ? ' / ' + item.SAT : ''})`;

results.forEach((item, i) => {
  const li = document.createElement("li");
const icon = (item.category === "poste")
  ? `üöô${item.poste_latitude && item.poste_longitude ? " üìç" : ""}`
  : "üí°";

li.innerHTML = `${icon} ${labelFor(item)}`;

  if (i === 0) li.classList.add("best");

  li.onclick = () => {
    if (item.category === "poste") showLieu(item);
    else showAppareil(item);
  };

  suggestionsEl.appendChild(li);
});

// ‚ûï Ajouter seulement si aucun r√©sultat n‚Äôest un match exact
if (rawQuery.length >= 3) {
  const queryNorm = normalizeNomPoste(rawQuery);

  const exactMatch = results.some(item => {
    if (item.category === "poste") {
      return normalizeNomPoste(item.nom) === queryNorm;
    } else {
      return normalize(item.appareil || "") === normalize(rawQuery);
    }
  });

  if (!exactMatch) {
    const liAdd = document.createElement("li");
      // V√©rifie si un poste ou appareil existe d√©j√† (apr√®s normalisation)
  const posteExiste = lieux.some(l => normalizeNomPoste(l.nom) === queryNorm);
  const appareilExiste = appareils.some(a => normalize(a.appareil) === normalize(rawQuery));

  // Si un match exact existe d√©j√† ‚Üí on ne propose pas l‚Äôajout
  if (posteExiste || appareilExiste) return;
    liAdd.style.fontStyle = "italic";

    if (isAppareilLike(rawQuery)) {
      liAdd.textContent = `‚ûï Ajouter cet appareil ¬´ ${rawQuery} ¬ª`;
      liAdd.onclick = () => {
        location.href = `ajout_appareil.html?appareil=${encodeURIComponent(rawQuery)}`;
      };
} else if (isPosteLike(rawQuery)) {
  liAdd.textContent = `‚ûï Ajouter ce poste ¬´ ${rawQuery} ¬ª`;
  liAdd.onclick = () => {
    location.href = `ajout_poste.html?poste=${encodeURIComponent(rawQuery)}`;
  };
}

    suggestionsEl.insertBefore(liAdd, suggestionsEl.firstChild);
  }
}

  
// ‚úÖ ici on ferme correctement l‚Äôevent listener
});

// maintenant seulement on d√©clare la fonction
function showAppareil(app) {
  incrementCounterAppareil();
  const result = document.getElementById("result");
  const suggestionsEl = document.getElementById("suggestions");

  suggestionsEl.innerHTML = "";
  result.style.display = "block";

  let html = `<h2>
    üîå ${app.appareil} (${app.nom}${app.type ? ' ' + app.type : ''}${app.SAT ? ' / ' + app.SAT : ''})
  </h2>

<div class="inline-links pills-3" style="margin-top:10px; margin-bottom:1.5rem;">
<a href="${myMapsViewer(
  app.latitude,
  app.longitude,
  19,
  [app.nom, app.type, app.SAT, app.appareil].filter(Boolean).join(" ")
)}">üõ∞Ô∏è Vue satellite</a>`;

  // üîó Cherche le poste correspondant
  const posteTrouv√© = lieux.find(l => 
    normalize(l.nom) === normalize(app.nom) &&
    normalize(l.type) === normalize(app.type) &&
    normalize(l.SAT || "") === normalize(app.SAT || "")
  );

  // üîó Cherche un acc√®s correspondant (compare avec app.acc√®s puis app.appareil)
  const accesTrouv√© = lieux.find(l => {
    const sameBase = normalize(l.nom) === normalize(app.nom)
      && normalize(l.type) === normalize(app.type)
      && normalize(l.SAT || "") === normalize(app.SAT || "");
    if (!sameBase) return false;

    const accLieu = normalize(String(l.acc√®s || ""));
    const accFromApp = normalize(String(app.acc√®s || ""));
    const accFromId  = normalize(String(app.appareil || ""));

    // 1) Priorit√©: app.acc√®s (cas Haute Loge "sectionneur" ou Hondeghem si pr√©sent)
    if (accFromApp && accLieu === accFromApp) return true;

    // 2) Fallback: acc√®s == code appareil (cas Hondeghem "I608")
    return accLieu === accFromId;
  });

  const lieuCible = accesTrouv√© || posteTrouv√©;
  if (lieuCible) {
    html += `
      <a href="#" onclick='showLieu(${JSON.stringify(lieuCible)})'>üöó Infos & itin√©raire</a>
    `;
  }

  html += `</div>`;

  const blocs = [];
  if (app.description) blocs.push(`<p>${app.description}</p>`);

  if (blocs.length > 0) {
    html += blocs.map((b,i)=> i===0 ? b : `<hr class="separator" />${b}`).join("");
  }

  result.innerHTML = html;
}

  /* === Train al√©atoire + changement au clic ===
   Mets le nombre EXACT d'images => train1.gif ... trainN.gif */
const TOTAL_TRAINS = 11; // ‚¨ÖÔ∏è change ce nombre selon tes fichiers

const trainImg = document.getElementById('train');
  // Fallback global si une image manque
trainImg.onerror = () => { trainImg.src = 'images/train1.gif'; };
let lastN = null;

function pickRandomTrain() {
  // Tire un nombre entre 1 et TOTAL_TRAINS, diff√©rent du pr√©c√©dent si possible
  let n;
  do {
    n = Math.floor(Math.random() * TOTAL_TRAINS) + 1;
  } while (TOTAL_TRAINS > 1 && n === lastN);
  lastN = n;

  trainImg.src = `images/train${n}.gif`;

}

// 1) Tirage au chargement
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', pickRandomTrain);
} else {
  pickRandomTrain();
}

// 2) Tirage au clic (sans recharger la page)
trainImg.addEventListener('click', pickRandomTrain);
// === Calcul de distance (Haversine) ===
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // rayon Terre en km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c; // distance en km
}
// --- Utilitaires d'affichage pour la proximit√© ---
const km = d => d.toFixed(2).replace(".", ","); // format FR

const labelPoste = p =>
  (`${p.nom || ""}${p.type ? " " + p.type : ""}${p.SAT ? " " + p.SAT : ""}`.trim()) +
  (p.acc√®s ? ` ‚Äì acc√®s ${p.acc√®s}` : "");

const labelAppareil = p =>
  `${p.appareil} (${p.nom}${p.type ? " " + p.type : ""}${p.SAT ? " / " + p.SAT : ""})`;
    
    // Masquer le bouton sur PC, afficher uniquement sur mobile
function isMobile() {
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
}

if (!isMobile()) {
  document.getElementById("btn-localiser").style.display = "none";
}
// === Bouton "Me localiser" ===
document.getElementById("btn-localiser").addEventListener("click", () => {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      showNearby,
      (error) => {
        if (error.code === error.PERMISSION_DENIED) {
          alert("‚ùå Autorisation refus√©e pour la g√©olocalisation.");
        } else if (error.code === error.POSITION_UNAVAILABLE) {
          alert("‚ö†Ô∏è Position indisponible (pas de GPS ou r√©seau).");
        } else if (error.code === error.TIMEOUT) {
          alert("‚åõ La demande de localisation a expir√©.");
        } else {
          alert("‚ùå Erreur inconnue de g√©olocalisation.");
        }
      }
    );
  } else {
    alert("La g√©olocalisation n‚Äôest pas support√©e.");
  }
});

    // Affiche la page suivante de r√©sultats (+10)
function renderProximitePage() {
  const container = document.getElementById("proximite");
  const ul = container.querySelector("ul");
  const btnVoirPlus = document.getElementById("voir-plus");

  const slice = proximiteSorted.slice(proximiteIndex, proximiteIndex + PROX_STEP);

  slice.forEach(p => {
    const icon = p.category === "poste" ? "üöô" : "üí°";
    const label = p.category === "poste" ? labelPoste(p) : labelAppareil(p);

    const li = document.createElement("li");
    li.style.margin = "15px 0";

    const a = document.createElement("a");
    a.href = "#";
    a.style.textDecoration = "none";
    a.style.color = "inherit";
    a.style.cursor = "pointer";
  a.innerHTML = `${icon} ${label} ‚Äì ${km(p.distance)} km`;

    a.addEventListener("click", ev => {
      ev.preventDefault();
      // Nettoie la zone proximit√© et masque "Voir plus"
      container.innerHTML = "";
      btnVoirPlus.style.display = "none";
      if (p.category === "poste") {
        showLieu(p);
      } else {
        showAppareil(p);
      }
    });

    li.appendChild(a);
    ul.appendChild(li);
  });

  proximiteIndex += slice.length;

  // Affiche / masque le bouton "Voir plus"
  if (proximiteIndex < proximiteSorted.length) {
    btnVoirPlus.style.display = "inline-block";
  } else {
    btnVoirPlus.style.display = "none";
  }
}

// === √Ä proximit√© avec pagination par 10 ===
function showNearby(position) {
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;

  if (!allItems || allItems.length === 0) {
    alert("Les donn√©es ne sont pas encore charg√©es.");
    return;
  }

  // Calcule & trie toute la liste une fois
  proximiteSorted = allItems
    .map(it => ({ ...it, distance: getDistance(lat, lon, it.latitude, it.longitude) }))
    .sort((a, b) => a.distance - b.distance);

  proximiteIndex = 0;

  // Pr√©pare le conteneur
  const container = document.getElementById("proximite");
  container.innerHTML = `<h3>üìç √Ä proximit√© :</h3><ul style="margin:0; padding-left:20px;"></ul>`;

  // Branche le bouton "Voir plus"
  const btnVoirPlus = document.getElementById("voir-plus");
  btnVoirPlus.onclick = renderProximitePage;

  // Affiche la premi√®re page (10)
  renderProximitePage();
}

const compteurContributionURL = "https://script.google.com/macros/s/AKfycbwSZ6PEcRuNYb-tyVgNnuStsAQgo_oXkbzuOh41ovRmiZMD30iJfyti6WvqdqMhKfuE/exec";

function updateContrib() {
  // 1) Lecture du cache
  const cached = localStorage.getItem("counterContrib");
  if (cached) {
  const el1 = document.getElementById("compteur-valeur");
if (el1) el1.textContent = `(${cached})`;
  }

  // 2) Mise √† jour depuis le serveur
  fetch(compteurContributionURL).then(r => r.json()).then(data => {
    if (data && typeof data.count !== "undefined") {
      const el2 = document.getElementById("compteur-valeur");
if (el2) el2.textContent = `(${data.count})`;
      localStorage.setItem("counterContrib", data.count); // ‚úÖ sauvegarde en cache
    }
  }).catch(() => {});
}

    // === √âdition Nom + Type ===
let editMode = false;
let originalValues = {};

// Quand on clique sur (modifier)
document.addEventListener("click", function(e){
  if (e.target.id === "edit-toggle") {
    e.preventDefault();
    if (!editMode) {
      editMode = true;
      originalValues.nom = document.getElementById("editable-nom").textContent;
      originalValues.type = document.getElementById("editable-type").textContent;
      // ‚úÖ Forcer RSS en lettre (A/B/C) d√®s le d√©part
if (currentItem.rss) {
  originalValues.rss = currentItem.rss;  // d√©j√† A/B/C
} else {
  originalValues.rss = "";
}
        originalValues.pk = currentItem.pk || "";
  originalValues.numero_ligne = currentItem.numero_ligne || "";
      
      if (document.getElementById("editable-sat")) {
        originalValues.sat = document.getElementById("editable-sat").textContent.trim();
      }
      if (document.getElementById("editable-acces")) {
       originalValues["acc√®s"] = document.getElementById("editable-acces").textContent.replace("‚Äì acc√®s ","").trim();
      }
        if (document.getElementById("editable-description")) {
    originalValues.description = document.getElementById("editable-description").textContent.trim();
  }

      // ‚ö°Ô∏è On prend la valeur brute du JSON affich√©, pas le rendu cliquable
originalValues.contact = currentItem.contact || "";
originalValues.portail = currentItem.portail || "";

      // Ajoute halo + vibration sur les zones modifiables existantes
["editable-nom","editable-type","editable-sat","editable-acces",
 "editable-description","editable-contact","editable-portail",
 "editable-pk","editable-numero_ligne","editable-rss"].forEach(id=>{
  const el = document.getElementById(id);
  if (el) {
    el.classList.add("editable-halo", "editable-wiggle");
  }
});
      ["editable-rep-poste","editable-rep-acces"].forEach(id=>{
  const el = document.getElementById(id);
  if (el) {
    el.classList.add("editable-halo", "editable-wiggle");
  }
});

// Masque le nom de ligne pendant l‚Äô√©dition
const ligneNomEl = document.getElementById("ligne-nom");
if (ligneNomEl) ligneNomEl.style.display = "none";

      document.getElementById("edit-buttons").style.display = "flex";
      navigator.vibrate?.(80);
    }
  }
});

// Quand on clique sur une zone modifiable
document.addEventListener("click", function(e){
  if (editMode && (
      ["editable-nom","editable-type","editable-sat","editable-acces","editable-rss",
       "editable-description","editable-contact","editable-portail",
       "editable-pk","editable-numero_ligne"].includes(e.target.id) ||
      e.target.closest("#editable-rss")
  )) {

    // üëâ Stoppe la vibration mais garde le halo pour certains champs
if (["editable-nom","editable-type","editable-sat","editable-acces","editable-pk","editable-numero_ligne"].includes(e.target.id)) {
  e.target.classList.remove("editable-wiggle");
}
    
// Cas sp√©cial RSS ‚Üí choix direct A / B / C
if (e.target.id === "editable-rss" || e.target.closest("#editable-rss")) {
const rssEl = document.getElementById("editable-rss");
if (!rssEl) return;

// ‚û°Ô∏è On remplace uniquement le bloc RSS (le <p> + les num√©ros) par les boutons
const rssBlock = rssEl.closest("p"); // juste le <p> contenant üìû RSS
const phonesEl = document.getElementById("rss-phones"); // la ligne avec les num√©ros
if (phonesEl) phonesEl.remove(); // on supprime la ligne num√©ros

rssBlock.outerHTML = `
  <div id="editable-rss" class="inline-links">
    <button class="btn-primary btn-rss" data-code="A">Table 1</button>
    <button class="btn-primary btn-rss" data-code="B">Table 2</button>
    <button class="btn-primary btn-rss" data-code="C">Table 3</button>
  </div>
`;

document.querySelectorAll(".btn-rss").forEach(btn => {
  btn.addEventListener("click", () => {
    const code = btn.dataset.code;
    currentItem.rssTemp = code;          // ‚úÖ valeur temporaire
    currentItem.rssChanged = true;       // ‚úÖ on note que l‚Äôutilisateur a modifi√©
    document.querySelector("#editable-rss").innerHTML =
      `<strong>üìû RSS Table ${code === "A" ? "1" : code === "B" ? "2" : "3"}</strong>`;
  });
});

  return; // ‚õî stoppe ici pour √©viter le reste
}
  
// Description (cliquable sur tout le bloc)
if (editMode && (e.target.id === "editable-description" || e.target.closest("#editable-description"))) {
  const parent = document.getElementById("editable-description").parentNode;
  const val = currentItem.description || ""; // ‚úÖ valeur brute du JSON

  parent.innerHTML = `
    <strong id="editable-description">‚ÑπÔ∏è Informations :</strong>
    <textarea id="input-description" style="width:100%; min-height:60px; border:2px solid #1a73e8; padding:4px; border-radius:6px;">${val}</textarea>
  `;

  document.getElementById("edit-buttons").style.display = "block";
  navigator.vibrate?.(50);
  return;
}

if (e.target.id === "editable-portail") {
  const parent = e.target.parentNode;
 const val = originalValues.portail || "";
  parent.innerHTML = `
    <strong id="editable-portail">üöß Portail :</strong>
    <input type="text" id="input-portail" value="${val}" 
      style="border:2px solid #1a73e8; padding:3px; border-radius:6px; margin-left:6px; width:80%;" />
  `;
  document.getElementById("edit-buttons").style.display = "block";
  navigator.vibrate?.(50);
  return;
}
  if (e.target.id === "editable-contact") {
  const val = currentItem.contact || ""; // ‚úÖ valeur brute du JSON
  const parent = e.target.parentNode;

  parent.innerHTML = `
    <strong id="editable-contact">üë§ Contact :</strong>
    <input type="text" id="input-contact" value="${val}" 
      style="border:2px solid #1a73e8; padding:3px; border-radius:6px; margin-left:6px; width:80%;" />
  `;

  document.getElementById("edit-buttons").style.display = "block";
  navigator.vibrate?.(50);
  return;
}
  
    // Cas normal (nom, type, sat, acc√®s)
    const field = e.target.id.replace("editable-","");
    let currentVal = e.target.textContent.replace("‚Äì acc√®s ","").trim();
    e.target.innerHTML = `<input type="text" id="input-${field}" value="${currentVal}" style="border:2px solid #1a73e8; padding:3px; border-radius:6px;" />`;
    document.getElementById("edit-buttons").style.display = "block";
    navigator.vibrate?.(50);
  }
   // üîπ AJOUT ICI
// Bloc POSTE ‚Üí remplacer boutons par champ texte
if (editMode && e.target.id === "editable-rep-poste") {
  const bloc = e.target.closest(".rep-block").querySelector(".inline-links");
  bloc.innerHTML = `
    <input type="text" id="input-poste-link"
      placeholder="Coller ici le lien Google Maps"
      style="width:100%; border:2px solid #1a73e8; border-radius:6px; padding:4px;" />
  `;
  navigator.vibrate?.(50);
  return;
}

// Bloc ACCES ‚Üí remplacer boutons par champ texte
if (editMode && e.target.id === "editable-rep-acces") {
  const bloc = e.target.closest(".rep-block").querySelector(".inline-links");
  bloc.innerHTML = `
    <input type="text" id="input-acces-link"
      placeholder="Coller ici le lien Google Maps"
      style="width:100%; border:2px solid #1a73e8; border-radius:6px; padding:4px;" />
  `;
  navigator.vibrate?.(50);
  return;
}
  });

function getDemandeur() {
  let demandeur = localStorage.getItem("demandeur");
  const regexNom = /^[A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\s\-]{2,}$/;

  while (!demandeur || !regexNom.test(demandeur)) {
    demandeur = prompt("üëâ Entrez votre pr√©nom et nom").trim();

    if (!demandeur || !regexNom.test(demandeur)) {
      alert("‚ö†Ô∏è Nom invalide. Utilisez uniquement lettres / espaces / accents.");
      demandeur = "";
    }
  }

  // ‚úÖ On garde le nom en m√©moire dans le navigateur
  localStorage.setItem("demandeur", demandeur);
  return demandeur;
}
    
// Sauvegarde
document.getElementById("btn-save").addEventListener("click", function(){
  const btnSave = document.getElementById("btn-save");
  btnSave.disabled = true;
  btnSave.textContent = "‚è≥ Envoi..."; // sablier qui tourne

  const newNom   = document.getElementById("input-nom")?.value   || originalValues.nom;
  const newType  = document.getElementById("input-type")?.value  || originalValues.type;
  const newSat   = document.getElementById("input-sat")?.value   || originalValues.sat || "";
  const newAcces = document.getElementById("input-acces")?.value || originalValues["acc√®s"] || "";
const newDescription = document.getElementById("input-description")?.value || originalValues.description || "";
const newContact     = document.getElementById("input-contact")?.value     || originalValues.contact || "";
const newPortail     = document.getElementById("input-portail")?.value     || originalValues.portail || "";
const newPk   = document.getElementById("input-pk")?.value || currentItem.pk || "";
const newNumLigne = document.getElementById("input-numero_ligne")?.value || currentItem.numero_ligne || "";
    const newPosteLink = document.getElementById("input-poste-link")?.value || "";
  const newAccesLink = document.getElementById("input-acces-link")?.value || "";
  
  const demandeur = getDemandeur();
  const ficheOrigine = currentItem
    ? `${currentItem.nom || ''} ${currentItem.type || ''} ${currentItem.SAT || ''} ${currentItem.acc√®s || ''}`.trim()
    : "";

  // ‚úÖ Ne garde que les vraies modifications
  const payload = {
    demandeur,
    ficheOrigine
  };
if (currentItem.rssTemp) {
  payload.rss = currentItem.rssTemp;
  payload.rssChanged = true;   // ‚úÖ indique au serveur que RSS a √©t√© modifi√©
  originalValues.rss = currentItem.rssTemp;
  delete currentItem.rssTemp;
}

  if (newNom !== originalValues.nom) payload.nom = newNom;
  if (newType !== originalValues.type) payload.type = newType;
  if (newSat !== (originalValues.sat || "")) payload.sat = newSat;
 if (newAcces !== (originalValues["acc√®s"] || "")) payload["acc√®s"] = newAcces;
  if (originalValues.rss) payload.rss = originalValues.rss;
if (newDescription !== (originalValues.description || "")) payload.description = newDescription;
if (newContact !== (originalValues.contact || "")) payload.contact = newContact;
if (newPortail !== (originalValues.portail || "")) payload.portail = newPortail;
 if (newPk !== (currentItem.pk || "")) payload.pk = newPk;
if (newNumLigne !== (currentItem.numero_ligne || "")) payload.numero_ligne = newNumLigne;
    if (newPosteLink) payload.lien_poste = newPosteLink;
  if (newAccesLink) payload.lien_acces = newAccesLink;
  
fetch("https://script.google.com/macros/s/AKfycbyxh3HGR6iHcn0ynwfGzSzOm5Djc7o2e1uA4dvdPurolDerZlNiARcpsiY4daDRPSV1tw/exec", {
  method: "POST",
  mode: "no-cors",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload)
})
.then(() => {
  showNotification("‚úÖ Modification envoy√©e (en attente d‚Äôapprobation)", "success");
  // ‚ö°Ô∏è Mets √† jour l‚Äôaffichage avec les nouvelles valeurs locales
  originalValues.description = newDescription;
  originalValues.contact = newContact;
  originalValues.portail = newPortail;
  quitEditMode(newNom, newType, newSat, newAcces);

  // ‚ûï Incr√©mente le compteur de contributions (‚ö†Ô∏è bien √† l‚Äôint√©rieur du .then)
  return fetch("https://script.google.com/macros/s/AKfycbwSZ6PEcRuNYb-tyVgNnuStsAQgo_oXkbzuOh41ovRmiZMD30iJfyti6WvqdqMhKfuE/exec?increment=true");
})
.then(() => console.log("‚úÖ Contribution cr√©dit√©e"))
.catch(() => showNotification("‚ùå √âchec d‚Äôenvoi (r√©seau)", "error"))
.finally(() => {
  setTimeout(() => {
    btnSave.disabled = false;
    btnSave.textContent = "üíæ Sauvegarder"; // retour normal
  }, 3000);
});
  });  // ‚Üê fin du addEventListener("click", ...)

function quitEditMode(nom, type, sat = "", acces = ""){
  document.getElementById("editable-nom").textContent = nom;
  document.getElementById("editable-type").textContent = type;
  if (document.getElementById("editable-sat")) {
    document.getElementById("editable-sat").textContent = " " + sat;
  }
  if (document.getElementById("editable-acces")) {
    document.getElementById("editable-acces").textContent = " ‚Äì acc√®s " + acces;
  }
  // ‚û°Ô∏è Reconstruit le bloc PK + ligne
const pkVal = originalValues.pk || currentItem.pk || "(non renseign√©)";
const numVal = originalValues.numero_ligne || currentItem.numero_ligne || "(non renseign√©)";
const ligneNomEl = document.getElementById("ligne-nom");
const ligneNomTxt = ligneNomEl ? ligneNomEl.textContent : "";

const pkParent = document.getElementById("editable-pk")?.parentNode;
if (pkParent) {
  pkParent.innerHTML = `
    üöÑ PK <strong id="editable-pk">${pkVal}</strong>
    sur la ligne n¬∞<strong id="editable-numero_ligne">${numVal}</strong>
    ${ligneNomTxt ? `<span id="ligne-nom">${ligneNomTxt}</span>` : ""}
  `;
}

[
  "editable-nom","editable-type","editable-sat","editable-acces","editable-rss",
  "editable-description","editable-contact","editable-portail",
  "editable-pk","editable-numero_ligne"
].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.classList.remove("editable-halo", "editable-wiggle"); 
    // ‚úÖ On enl√®ve les effets
  }
});

  document.getElementById("edit-buttons").style.display = "none";
 
if (document.getElementById("input-description")) {
  const descVal = document.getElementById("input-description").value.trim();
  originalValues.description = descVal; // on garde la valeur locale

  // ‚û°Ô∏è remplace le textarea par le bloc normal format√©
  document.getElementById("input-description").parentNode.outerHTML =
    formatDescription(descVal);
}

if (document.getElementById("editable-contact")) {
  const contactVal = originalValues.contact || "";
  document.getElementById("editable-contact").parentNode.outerHTML =
    formatContact(contactVal);
}

if (document.getElementById("editable-portail")) {
  const portailVal = originalValues.portail || "";
  document.getElementById("editable-portail").parentNode.outerHTML =
    formatPortail(portailVal);
}
  

  // R√©affiche le nom de la ligne apr√®s √©dition
if (ligneNomEl) ligneNomEl.style.display = "inline";

// ‚û°Ô∏è Restaurer le RSS si modifi√© OU si rest√© en mode boutons
const rssEl = document.getElementById("editable-rss");
if (rssEl) {
  if (currentItem.rssChanged) {
    // cas : l‚Äôutilisateur a vraiment choisi une table
    const rssVal = originalValues.rss || currentItem.rss || "";
rssEl.outerHTML = formatRSS(rssVal, true);
    delete currentItem.rssChanged;
  } else if (rssEl.querySelector(".btn-rss")) {
    // cas : le bloc est rest√© sous forme de boutons sans choix
    const rssVal = originalValues.rss || currentItem.rss || "";
rssEl.outerHTML = formatRSS(rssVal, true);
  }
}
  // üîÅ Remet les blocs "Rep√©rer..." si on les avait pass√©s en champ texte
const repPosteInput = document.getElementById("input-poste-link");
if (repPosteInput) {
  const bloc = repPosteInput.closest(".inline-links");
  const latPoste = (currentItem.poste_latitude ?? "").toString();
  const lonPoste = (currentItem.poste_longitude ?? "").toString();
  const usePoste = latPoste !== "" && lonPoste !== "";
  const targetLat = usePoste ? latPoste : currentItem.latitude;
  const targetLon = usePoste ? lonPoste : currentItem.longitude;
  bloc.innerHTML = usePoste
    ? `<a href="${myMapsViewer(targetLat, targetLon, 20)}" target="_blank" rel="noopener">üõ∞Ô∏è Vue satellite</a>`
    : `<span class="placeholder">(non renseign√© ‚Äì fournir un lien Maps)</span>`;
}

const repAccesInput = document.getElementById("input-acces-link");
if (repAccesInput) {
  const bloc = repAccesInput.closest(".inline-links");
  bloc.innerHTML = `
    <a href="${myMapsViewer(currentItem.latitude, currentItem.longitude, 19)}" target="_blank" rel="noopener">üõ∞Ô∏è Vue satellite</a>
    <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${currentItem.latitude},${currentItem.longitude}" target="_blank" rel="noopener">üëÅÔ∏è Street View</a>
  `;
}
    // Nettoie tous les halos/vibrations restants
  document.querySelectorAll(".editable-halo, .editable-wiggle").forEach(el => {
    el.classList.remove("editable-halo", "editable-wiggle");
  });
  editMode = false;
}
    // Annuler √©dition
document.getElementById("btn-cancel").addEventListener("click", function(){
  quitEditMode(
    originalValues.nom,
    originalValues.type,
    originalValues.sat || "",
     originalValues["acc√®s"] || ""
  );
  showNotification("üîô √âdition annul√©e", "info");
});
    
    function showNotification(message, type = "info") {
  const notif = document.getElementById("notification");
  notif.textContent = message;
  notif.className = type; // "success", "error" ou "info"
  notif.style.display = "block";

  setTimeout(() => {
    notif.style.display = "none";
  }, 4000);
}

    // --- Lecture param√®tres URL ---
const params = new URLSearchParams(window.location.search);
const id = params.get("id");

// Ouvrir directement la fiche si un ID est fourni
if (id) {
  const tryShow = () => {
    if (!allItems || allItems.length === 0) {
      setTimeout(tryShow, 200);
      return;
    }

function buildCustomId(it) {
  if (it.category === "poste" && !it.acc√®s) {
    // Poste (gu√©rite)
    return [it.nom, it.type, it.SAT, "poste"].filter(Boolean).join(" ");
  } else if (it.category === "poste" && it.acc√®s) {
    // Acc√®s
    return [it.nom, it.type, it.SAT, it.acc√®s].filter(Boolean).join(" ");
  } else if (it.category === "appareil") {
    // Appareil
    return [it.nom, it.type, it.SAT, "appareil", it.appareil].filter(Boolean).join(" ");
  }
  return it.nom || "";
}

    // Recherche l‚Äôitem dont l‚Äôid correspond
    const found = allItems.find(it =>
      normalize(buildCustomId(it)) === normalize(id)
    );

    if (found) {
      if (found.category === "appareil") {
        showAppareil(found);
      } else {
        showLieu(found);
      }
    }
  };

  tryShow();
}
    
</script> </main>
<!-- Lien installer au-dessus du footer -->
<div id="install-container" style="text-align:center; margin:10px 0;">
  <a id="installLink" href="#" style="display:none;">üì≤ Installer l‚Äôapp</a>
</div>

<!-- Footer classique en dessous -->
<div id="about-footer">
  üîß <a href="arnaud.html">√Ä propos</a> ‚Äì 
  <span class="footer-version">Nono Maps V1.04</span>
</div>
<script>
(function(){
  // ===== Config =====
  var INTRO_DURATION_MS = 3000;             // Dur√©e d‚Äôaffichage (ms)
  var STORAGE_KEY       = 'eale_intro_last_day'; // Cl√© de m√©mo 1/jour

  // Date locale AAAA-MM-JJ (pas en UTC, √©vite les d√©calages)
  function todayLocal(){
    var d=new Date();
    var y=d.getFullYear();
    var m=String(d.getMonth()+1).padStart(2,'0');
    var day=String(d.getDate()).padStart(2,'0');
    return y+'-'+m+'-'+day;
  }

  // Afficher 1 fois par jour
  function shouldShowIntro(){
    try{
      var last = localStorage.getItem(STORAGE_KEY);
      var today = todayLocal();
      if (last === today) return false;
      localStorage.setItem(STORAGE_KEY, today);
      return true;
    }catch(e){ return true; } // si stockage bloqu√©, on affiche
  }

  function pickPhrase(){
    var phrases = [
      "Propuls√© par Arnaud.",
      "Une r√©alisation sign√©e Arnaud.",
      "Con√ßu et d√©velopp√© par Arnaud.",
      "R√©alis√© avec soin par Arnaud.",
      "Par Arnaud.",
      "Fait par Arnaud.",
      "Pens√© par Arnaud.",
      "Cr√©√© par Arnaud.",
      "Une id√©e d‚ÄôArnaud.",
      "Mis en place par Arnaud.",
      "Lanc√© par Arnaud.",
      "Con√ßu par Arnaud.",
      "Mis en ligne par Arnaud.",
      "Mis en route par Arnaud.",
      "Fait maison par Arnaud.",
      "D√©clench√© par Arnaud.",
      "Organis√© par Arnaud.",
      "Initi√© par Arnaud.",
      "Coordonn√© par Arnaud.",
      "Centralis√© par Arnaud.",
      "Simplifi√© par Arnaud.",
      "G√©r√© par Arnaud.",
      "Compil√© par Arnaud.",
      "Pr√©par√© par Arnaud.",
      "Pilot√© par Arnaud.",
      "Structur√© par Arnaud.",
      "Distribu√© par Arnaud.",
      "Diffus√© par Arnaud.",
      "Rendu accessible par Arnaud.",
      "Charg√© par Arnaud.",
      "Interface pens√©e par Arnaud."
    ];
    return phrases[Math.floor(Math.random()*phrases.length)];
  }

  function mountIntro(){
    var overlay = document.createElement('div');
    overlay.className = 'eale-intro-overlay';
    overlay.setAttribute('aria-hidden','true');
    overlay.innerHTML =
   '<img class="eale-intro-img" alt="Logo EALE" src="https://raw.githubusercontent.com/arnaud-upmre/carto3f9b7d1a5c8e4f2b/main/Logo%20EALE.png">' +
      '<div class="eale-intro-text" id="eale-intro-text"></div>';
    document.body.appendChild(overlay);
    document.getElementById('eale-intro-text').textContent = pickPhrase();

    setTimeout(function(){
      overlay.classList.add('eale-intro-hide');
      setTimeout(function(){ overlay.remove(); }, 380);
    }, INTRO_DURATION_MS);
  }

  // Lance d√®s que le DOM est pr√™t
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){ if (shouldShowIntro()) mountIntro(); });
  } else {
    if (shouldShowIntro()) mountIntro();
  }
})();
</script>
  <script>
let deferredPrompt;
const installLink = document.getElementById("installLink");

// V√©rifie si l'app est d√©j√† install√©e
const isStandalone = window.matchMedia('(display-mode: standalone)').matches 
                  || window.navigator.standalone === true;

if (!isStandalone) {
  // --- Android / Chrome ---
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installLink.style.display = "inline"; // montrer le lien

    installLink.addEventListener("click", async (evt) => {
      evt.preventDefault();
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        if (choice.outcome === "accepted") {
          console.log("PWA install√©e ‚úÖ");
        }
        deferredPrompt = null;
        installLink.style.display = "none"; 
      }
    });
  });

  // --- iOS ---
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  if (isIOS) {
    installLink.style.display = "inline";
    installLink.addEventListener("click", (evt) => {
      evt.preventDefault();
      alert("‚ÑπÔ∏è Sur iPhone : touchez le bouton de partage Safari (carr√© avec fl√®che ‚Üë), puis ¬´ Ajouter √† l‚Äô√©cran d‚Äôaccueil ¬ª.");
    });
  }
}
</script>
  <div id="notification"></div>
</body>
</html>
