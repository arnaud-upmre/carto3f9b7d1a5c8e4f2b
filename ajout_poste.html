<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>‚ûï Ajouter un poste</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    
    .hint {
      font-size: 13px;
      color: #777;       /* gris plus clair */
      font-style: italic;
      margin-top: 4px;
    }
    *,*::before,*::after{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0; padding:16px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:var(--fg);
    }
    :root{
      --bg:#f7f7f8; --fg:#202124; --card:#fff; --border:#d0d7de;
      --accent:#0b6cff; --accent-ink:#fff; --muted:#666;
    }
    @media(prefers-color-scheme:dark){
      :root{
        --bg:#0b0b0b; --fg:#eceff1; --card:#141414; --border:#2a2a2a;
        --accent:#5aa3ff; --accent-ink:#081018; --muted:#999;
      }
    }
    h2{text-align:center;margin:0 0 12px}
    .card{max-width:640px;margin:auto;background:var(--card);padding:16px;
      border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    label{display:block;margin-top:12px;font-weight:600}
    input,textarea{
      width:100%;padding:12px;font-size:16px;margin-top:6px;
      border:1px solid var(--border);border-radius:10px;
      background:var(--card);color:var(--fg);min-height:44px
    }
    textarea{min-height:96px;resize:none;overflow:auto}
    .pill-group{display:flex;gap:10px;margin-top:8px}
    .pill{flex:1;text-align:center;padding:12px;border:1px solid var(--border);
      border-radius:999px;cursor:pointer;user-select:none}
    .pill.active{background:var(--accent);color:var(--accent-ink)}
    .pill.active{background:var(--accent);color:var(--accent-ink)}

.pill:focus {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}
    .map-wrap{display:none;margin-top:12px;border:1px solid var(--border);
      border-radius:10px;overflow:hidden}
    #mapAccess,#mapPoste{height:300px;width:100%}
    .map-toolbar{display:flex;gap:8px;padding:6px;background:var(--card)}
    .map-toolbar button{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);cursor:pointer}
    .btn-row{display:flex;gap:12px;margin-top:18px}
    #coordsAccess,
#lienAccessField,
#coordsPoste,
#lienPosteField {
  margin-top: 12px;
}
    .btn{flex:1;padding:12px;font-size:16px;border:none;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-ink)}
    .btn.secondary{background:#ccc}
    @media(prefers-color-scheme:dark){.btn.secondary{background:#2a2f36;color:#eee}}

    /* Champs en erreur */
input.error, textarea.error {
  border: 2px solid red !important;
  background: #ffecec;
}
    
  </style>
</head>
<body>
  <h2>‚ûï Ajouter un poste</h2>

  <div class="card">
<form id="formPoste" novalidate>
      <label>Votre nom</label>
  <input id="demandeur" required autofocus>

      <label>Poste</label>
      <input id="nomPoste" placeholder="Ex : Cambrai" required>

      <label>Type</label>
      <input id="typePoste" placeholder="Ex : SP, SSP, PRCI, L‚Ä¶">

      <label>SAT (optionnel)</label>
      <input id="sat" placeholder="Ex : SAT1, SAT2‚Ä¶">

      <!-- ACC√àS (prioritaire / obligatoire d'une mani√®re ou d'une autre) -->
      <label>Souhaitez-vous g√©olocaliser l‚Äôacc√®s ?</label>
      <div class="pill-group">
      <div class="pill" id="pill-acc-oui" data-value="oui" tabindex="0" role="button" aria-pressed="false">Oui</div>
<div class="pill" id="pill-acc-non" data-value="non" tabindex="0" role="button" aria-pressed="false">Non</div>
      </div>
      <input type="hidden" id="presentAccess">

<!-- Carte acc√®s si oui -->
<div class="map-wrap" id="mapAccessWrap">
  <div class="hint" id="hintAccess">D√©placez le curseur pour ajuster la position de l‚Äôacc√®s.</div>
  <div id="mapAccess"></div>
  <div class="map-toolbar">
    <button type="button" id="btnRecenterAccess">üìç Localiser</button>
    <button type="button" id="btnToggleAccess">üó∫Ô∏è Plan</button>
  </div>
</div>
      <div id="coordsAccess" style="display:none;">
        <label>Latitude acc√®s</label>
        <input id="latAccess" inputmode="decimal">
        <label>Longitude acc√®s</label>
        <input id="lonAccess" inputmode="decimal">
      </div>

      <!-- Lien acc√®s si non -->
      <div id="lienAccessField" style="display:none;">
        <label>Coller le lien Google Maps de l‚Äôacc√®s</label>
        <input id="lienAccess" type="url" placeholder="https://maps.app.goo.gl/‚Ä¶">
      </div>

      <!-- POSTE / GU√âRITE (facultatif) -->
      <label>Souhaitez-vous g√©olocaliser le poste / gu√©rite ?</label>
      <div class="pill-group">
       <div class="pill" id="pill-pos-oui" data-value="oui" tabindex="0" role="button" aria-pressed="false">Oui</div>
<div class="pill" id="pill-pos-non" data-value="non" tabindex="0" role="button" aria-pressed="false">Non</div>
        
      </div>
      <input type="hidden" id="presentPoste">

<!-- Carte poste si oui -->
<div class="map-wrap" id="mapPosteWrap">
  <div class="hint" id="hintPoste">D√©placez le curseur pour ajuster la position du poste.</div>
  <div id="mapPoste"></div>
  <div class="map-toolbar">
    <button type="button" id="btnRecenterPoste">üìç Localiser</button>
    <button type="button" id="btnTogglePoste">üó∫Ô∏è Plan</button>
  </div>
</div>
      <div id="coordsPoste" style="display:none;">
        <label>Latitude poste / gu√©rite</label>
        <input id="latPoste" inputmode="decimal">
        <label>Longitude poste / gu√©rite</label>
        <input id="lonPoste" inputmode="decimal">
      </div>

      <!-- Lien poste si non (optionnel) -->
      <div id="lienPosteField" style="display:none;">
        <label>Coller le lien Google Maps du poste / gu√©rite (optionnel)</label>
        <input id="lienPoste" type="url" placeholder="https://maps.app.goo.gl/‚Ä¶">
      </div>

      <!-- PK + Ligne fusionn√©s -->
      <label>PK / Num√©ro de ligne (optionnel)</label>
      <input id="pkLigne" placeholder="Ex : PK 114.100 ‚Äì Ligne 216000">

      <label>Description / notes utiles</label>
      <textarea id="notes" placeholder="Code portail, acc√®s Carmillon, rep√®re visuel, proximit√© gare‚Ä¶"></textarea>

      <div class="btn-row">
        <button type="submit" class="btn primary">üì© Envoyer la contribution</button>
        <button type="button" class="btn secondary" onclick="location.href='index.html'">‚¨ÖÔ∏è Retour √† l‚Äôaccueil</button>
      </div>
    </form>
  </div>

  <script>
    // --- Pr√©remplissage depuis l'URL (?nom=...)
    (function () {
      const q = new URLSearchParams(location.search).get("nom");
      if (q) document.getElementById("nomPoste").value = q;  // reste √©ditable
    })();

    // --- Pr√©remplissage du nom du demandeur depuis le localStorage ---
    (function prefillName() {
      const savedName = localStorage.getItem("nom_demandeur");
      if (savedName) {
        document.getElementById("demandeur").value = savedName;
      }
    })();

    const DEST_EMAIL = "arnaud.debaecker@sncf.fr";
    const COUNTER_URL = "https://script.google.com/macros/s/AKfycbwSZ6PEcRuNYb-tyVgNnuStsAQgo_oXkbzuOh41ovRmiZMD30iJfyti6WvqdqMhKfuE/exec";

    let mapAccess, mapPoste, markerAccess, markerPoste;

    function $(id){return document.getElementById(id);}
    function toggle(el,show){el.style.display = show ? "block" : "none";}
    function sanitizeCoord(v){return (v||"").toString().replace(",",".").trim();}
    function isValidLatLon(lat,lon){
      const la=parseFloat(lat), lo=parseFloat(lon);
      return !isNaN(la) && !isNaN(lo) && la>=-90 && la<=90 && lo>=-180 && lo<=180;
    }
    function isValidUrl(str){return /^https?:\/\/.+/i.test((str||"").trim());}

    // ‚ñº‚ñº‚ñº AJOUTS POUR AM√âLIORATION LOCALISATION (identiques √† "appareil") ‚ñº‚ñº‚ñº
    const HAZE = [50.72454, 2.54311];
    let lastFix = null;
    let GEO_BLOCKED = false;
    const GEO_OPTS = { enableHighAccuracy: true, timeout: 7000, maximumAge: 15000 };

    function setMapTo(map, marker, lat, lon, kind){
      if(!map || !marker) return;
      map.setView([lat, lon], 18);
      marker.setLatLng([lat, lon]);
      if(kind === "access"){ $("latAccess").value = lat; $("lonAccess").value = lon; }
      else if(kind === "poste"){ $("latPoste").value = lat; $("lonPoste").value = lon; }
    }

    function applyFix(lat, lon){
      lastFix = { lat, lon, ts: Date.now() };
      if(mapAccess && markerAccess) setMapTo(mapAccess, markerAccess, lat, lon, "access");
      if(mapPoste && markerPoste) setMapTo(mapPoste, markerPoste, lat, lon, "poste");
    }

    function onGeoDenied(target){
      GEO_BLOCKED = true;
      if(target === "access"){
        $("presentAccess").value = "non";
        $("pill-acc-oui").classList.remove("active");
        $("pill-acc-non").classList.add("active");
        toggle($("mapAccessWrap"), 0);
        toggle($("coordsAccess"), 0);
        toggle($("lienAccessField"), 1);
        alert("La g√©olocalisation est refus√©e. Renseignez un lien Google Maps pour l‚Äôacc√®s.");
      } else if(target === "poste"){
        $("presentPoste").value = "non";
        $("pill-pos-oui").classList.remove("active");
        $("pill-pos-non").classList.add("active");
        toggle($("mapPosteWrap"), 0);
        toggle($("coordsPoste"), 0);
        toggle($("lienPosteField"), 1);
        alert("La g√©olocalisation est refus√©e. Vous pouvez fournir un lien Google Maps pour le poste (facultatif).");
      }
    }

    // Pr√©-r√©cup√©ration de la position au chargement
    document.addEventListener("DOMContentLoaded", () => {
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          p => applyFix(p.coords.latitude, p.coords.longitude),
          err => { if(err && err.code === 1) { GEO_BLOCKED = true; } },
          GEO_OPTS
        );
      }
    });
    // ‚ñ≤‚ñ≤‚ñ≤ FIN AJOUTS ‚ñ≤‚ñ≤‚ñ≤

    // ‚Äî‚Äî‚Äî Pills ACC√àS
    $("pill-acc-oui").onclick = () => setAccess("oui");
    $("pill-acc-non").onclick = () => setAccess("non");
   function setAccess(v){
  $("presentAccess").value = v;
  $("pill-acc-oui").classList.toggle("active", v==="oui");
  $("pill-acc-non").classList.toggle("active", v==="non");

  if(v==="oui"){
    if(GEO_BLOCKED){ onGeoDenied("access"); return; }
    toggle($("mapAccessWrap"), true);
    toggle($("coordsAccess"), true);
    toggle($("lienAccessField"), true);
    toggle($("hintAccess"), true);   // üëà AJOUT
    startLocAccess();
    requestAnimationFrame(() => mapAccess && mapAccess.invalidateSize());
  } else if(v==="non"){
    toggle($("mapAccessWrap"), false);
    toggle($("coordsAccess"), false);
    toggle($("lienAccessField"), true);
    toggle($("hintAccess"), false);  // üëà AJOUT
  } else {
    toggle($("mapAccessWrap"), false);
    toggle($("coordsAccess"), false);
    toggle($("lienAccessField"), false);
    toggle($("hintAccess"), false);  // üëà AJOUT
  }
}

    // ‚Äî‚Äî‚Äî Pills POSTE (facultatif)
    $("pill-pos-oui").onclick = () => setPoste("oui");
    $("pill-pos-non").onclick = () => setPoste("non");
    function setPoste(v){
  $("presentPoste").value = v;
  $("pill-pos-oui").classList.toggle("active", v==="oui");
  $("pill-pos-non").classList.toggle("active", v==="non");

  if(v==="oui"){
    if(GEO_BLOCKED){ onGeoDenied("poste"); return; }
    toggle($("mapPosteWrap"), true);
    toggle($("coordsPoste"), true);
    toggle($("lienPosteField"), false);
    toggle($("hintPoste"), true);   // üëà AJOUT
    startLocPoste();
    requestAnimationFrame(() => mapPoste && mapPoste.invalidateSize());
  } else if(v==="non"){
    toggle($("mapPosteWrap"), false);
    toggle($("coordsPoste"), false);
    toggle($("lienPosteField"), true);
    toggle($("hintPoste"), false);  // üëà AJOUT
  } else {
    toggle($("mapPosteWrap"), false);
    toggle($("coordsPoste"), false);
    toggle($("lienPosteField"), false);
    toggle($("hintPoste"), false);  // üëà AJOUT
  }
}
    // --- Accessibilit√© : gestion clavier et aria-pressed pour les pills ---
["pill-acc-oui","pill-acc-non","pill-pos-oui","pill-pos-non"].forEach(id=>{
  const el = $(id);
  if(!el) return;

  // Active la pill au clavier
  el.addEventListener("keydown", e=>{
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      el.click(); // simule un clic
    }
  });

  // Mets √† jour aria-pressed selon √©tat actif
  el.addEventListener("click", ()=>{
    const group = el.parentNode.querySelectorAll(".pill");
    group.forEach(p => 
      p.setAttribute("aria-pressed", p.classList.contains("active") ? "true" : "false")
    );
  });
});

    // ‚Äî‚Äî‚Äî Cartes (align√© sur la page "appareil")
    function ensureMap(mapId, btnToggle, btnRecenter, lat, lon){
      let map, marker;
      map = L.map(mapId).setView(HAZE, 18);  // Hazebrouck par d√©faut
      setTimeout(() => map.invalidateSize(), 300);

      const esri = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");
      const osm  = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");

      // Par d√©faut on d√©marre en OSM (plan rapide)
      osm.addTo(map);

      // On est en mode "plan" au d√©part
      let isSat = false;
      $(btnToggle).textContent = "üõ∞Ô∏è Satellite"; // propose de passer en satellite

      // point de d√©part : dernier fix si dispo, sinon param√®tres pass√©s
      const startLat = (lastFix ? lastFix.lat : lat);
      const startLon = (lastFix ? lastFix.lon : lon);
      marker = L.marker([startLat, startLon], { draggable:true }).addTo(map);

      marker.on("dragend", ()=>{
        const p = marker.getLatLng();
        if(mapId==="mapAccess"){
          $("latAccess").value=p.lat; $("lonAccess").value=p.lng;
        } else {
          $("latPoste").value=p.lat; $("lonPoste").value=p.lng;
        }
      });

      $(btnToggle).onclick = () => {
        isSat = !isSat;
        if (isSat) {
          if (map.hasLayer(osm)) map.removeLayer(osm);
          esri.addTo(map);
          $(btnToggle).textContent = "üó∫Ô∏è Plan";
        } else {
          if (map.hasLayer(esri)) map.removeLayer(esri);
          osm.addTo(map);
          $(btnToggle).textContent = "üõ∞Ô∏è Satellite";
        }
        requestAnimationFrame(() => map.invalidateSize());
      };

      $(btnRecenter).onclick = ()=>{
        const target = (mapId==="mapAccess") ? "access" : "poste";
        if(GEO_BLOCKED){ onGeoDenied(target); return; }

        // 1) applique imm√©diatement le dernier fix si pr√©sent
        if (lastFix){
          const isAccess = (mapId==="mapAccess");
          const mapRef    = isAccess ? mapAccess   : mapPoste;
          const markerRef = isAccess ? markerAccess: markerPoste;
          const kind      = isAccess ? "access"    : "poste";
          setMapTo(mapRef, markerRef, lastFix.lat, lastFix.lon, kind);
        }

        // 2) demande une position plus fra√Æche
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(
            p => applyFix(p.coords.latitude, p.coords.longitude),
            err => { if(err && err.code === 1){ onGeoDenied(target); } },
            GEO_OPTS
          );
        }
      };

      if(mapId==="mapAccess"){ mapAccess=map; markerAccess=marker; }
      else{ mapPoste=map; markerPoste=marker; }
    }

    function startLocAccess(){
      if(GEO_BLOCKED){ onGeoDenied("access"); return; }
      if(!mapAccess){
        ensureMap("mapAccess","btnToggleAccess","btnRecenterAccess", HAZE[0], HAZE[1]);
      }
      if(lastFix) setMapTo(mapAccess, markerAccess, lastFix.lat, lastFix.lon, "access");

      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          p => applyFix(p.coords.latitude, p.coords.longitude),
          err => { if(err && err.code === 1) onGeoDenied("access"); },
          GEO_OPTS
        );
      }
    }

    function startLocPoste(){
      if(GEO_BLOCKED){ onGeoDenied("poste"); return; }
      if(!mapPoste){
        ensureMap("mapPoste","btnTogglePoste","btnRecenterPoste", HAZE[0], HAZE[1]);
      }
      if(lastFix) setMapTo(mapPoste, markerPoste, lastFix.lat, lastFix.lon, "poste");

      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          p => applyFix(p.coords.latitude, p.coords.longitude),
          err => { if(err && err.code === 1) onGeoDenied("poste"); },
          GEO_OPTS
        );
      }
    }

    // ‚Äî‚Äî‚Äî Submit
    $("formPoste").onsubmit = (e)=>{
      e.preventDefault();

      const demandeur   = $("demandeur").value.trim();
      if (demandeur) {
        localStorage.setItem("nom_demandeur", demandeur);
      }
      const nomPoste    = $("nomPoste").value.trim();
      const typePoste   = $("typePoste").value.trim().toUpperCase();
      const satellite   = $("sat").value.trim().toUpperCase();
      const pkLigne     = $("pkLigne").value.trim();
      const notes       = $("notes").value.trim();

 // R√©initialise l'√©tat erreur
["demandeur","nomPoste"].forEach(id => $(id).classList.remove("error"));

let missing = [];
if (!demandeur) { missing.push("Votre nom"); $("demandeur").classList.add("error"); }
if (!nomPoste)  { missing.push("Nom du poste"); $("nomPoste").classList.add("error"); }

if (missing.length > 0) {
  alert("‚ö†Ô∏è Merci de renseigner les champs obligatoires :\n" + missing.join(" / "));
  requestAnimationFrame(() => {
    const premierChamp = document.querySelector("input.error, textarea.error");
    if (premierChamp) {
      premierChamp.focus({ preventScroll: true });
      premierChamp.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  });
  return;
}

      // ACC√àS : choix obligatoire + donn√©e obligatoire (coords OU lien)
    if(!$("presentAccess").value){
  alert("‚ö†Ô∏è Merci d‚Äôindiquer si vous souhaitez g√©olocaliser l‚Äôacc√®s (Oui / Non).");
  requestAnimationFrame(() => $("pill-acc-oui")?.focus());
  return;
}

      let accesStr = "";
      if($("presentAccess").value === "oui"){
        const la = sanitizeCoord($("latAccess").value);
        const lo = sanitizeCoord($("lonAccess").value);
        if(!isValidLatLon(la,lo)){
          alert("‚ö†Ô∏è Les coordonn√©es de l‚Äôacc√®s ne sont pas valides.");
          return;
        }
        accesStr = `${la},${lo}`;
      }else{ // non
        const lienA = $("lienAccess").value.trim();
        if(!isValidUrl(lienA)){
          alert("‚ö†Ô∏è Merci de fournir un lien Google Maps valide pour l‚Äôacc√®s.");
          return;
        }
        accesStr = lienA;
      }

      // POSTE / GU√âRITE : facultatif
      let posteStr = "";
      if($("presentPoste").value === "oui"){
        const laP = sanitizeCoord($("latPoste").value);
        const loP = sanitizeCoord($("lonPoste").value);
        if(!isValidLatLon(laP,loP)){
          alert("‚ö†Ô∏è Les coordonn√©es du poste / de la gu√©rite ne sont pas valides.");
          return;
        }
        posteStr = `${laP},${loP}`;
      }else if($("presentPoste").value === "non"){
        const lienP = $("lienPoste").value.trim();
        if(lienP){ // optionnel : s'il est rempli, on le v√©rifie
          if(!isValidUrl(lienP)){
            alert("‚ö†Ô∏è Le lien Google Maps du poste / de la gu√©rite n‚Äôest pas valide.");
            return;
          }
          posteStr = lienP;
        }
      }

      // Email
      const subject = `Contribution : ajout d‚Äôun poste ‚Äî ${nomPoste}`;
      let body  = `Bonjour Arnaud,%0D%0A%0D%0A${encodeURIComponent(demandeur)} propose l‚Äôajout du poste suivant :%0D%0A%0D%0A`;
      body += `Nom du poste : ${encodeURIComponent(nomPoste)}%0D%0A`;
      if(typePoste) body += `Type : ${encodeURIComponent(typePoste)}%0D%0A`;
      if(satellite) body += `Satellite : ${encodeURIComponent(satellite)}%0D%0A`;
      body += `Acc√®s : ${encodeURIComponent(accesStr)}%0D%0A`;
      if(posteStr) body += `Poste / gu√©rite : ${encodeURIComponent(posteStr)}%0D%0A`;
      if(pkLigne) body += `PK / Ligne : ${encodeURIComponent(pkLigne)}%0D%0A`;
      if(notes) body += `Notes : ${encodeURIComponent(notes)}%0D%0A`;
      body += `%0D%0ACordialement,%0D%0A${encodeURIComponent(demandeur)}`;

      // Envoi mail via mailto
      location.href = `mailto:${DEST_EMAIL}?subject=${encodeURIComponent(subject)}&body=${body}`;

      // Incr√©ment compteur contributions (identique)
      fetch(COUNTER_URL + "?increment=true").catch(()=>{});

      alert("L‚Äôe-mail de contribution est g√©n√©r√©, v√©rifiez et envoyez-le.");

      // Sauvegarde le nom avant reset
      const savedName = demandeur;

      // Reset complet du formulaire
      $("formPoste").reset();
      setAccess("");
      setPoste("");

      // R√©injecte le nom sauvegard√©
      if (savedName) {
        $("demandeur").value = savedName;
      }
    };

// Supprimer automatiquement le rouge quand on corrige un champ
document.addEventListener("DOMContentLoaded", () => {
  ["demandeur","nomPoste"]
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("input", () => el.classList.remove("error"));
    });
});

// Normalisation automatique des coordonn√©es : virgule ‚Üí point
["latAccess","lonAccess","latPoste","lonPoste"].forEach(id=>{
  const el = $(id);
  if (!el) return;
  el.addEventListener("input", ()=>{
    if (el.value.includes(",")) {
      el.value = el.value.replace(",",".");
    }
  });
});
</script>
</body>
</html>
