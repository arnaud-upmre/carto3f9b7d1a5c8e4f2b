<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>‚ûï Ajouter un poste</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    .hint {
  font-size: 13px;
  color: #777;       /* gris plus clair */
  font-style: italic;
  margin-top: 4px;
}
    *,*::before,*::after{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0; padding:16px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:var(--fg);
    }
    :root{
      --bg:#f7f7f8; --fg:#202124; --card:#fff; --border:#d0d7de;
      --accent:#0b6cff; --accent-ink:#fff; --muted:#666;
    }
    @media(prefers-color-scheme:dark){
      :root{
        --bg:#0b0b0b; --fg:#eceff1; --card:#141414; --border:#2a2a2a;
        --accent:#5aa3ff; --accent-ink:#081018; --muted:#999;
      }
    }
    h2{text-align:center;margin:0 0 12px}
    .card{max-width:640px;margin:auto;background:var(--card);padding:16px;
      border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    label{display:block;margin-top:12px;font-weight:600}
    input,textarea{
      width:100%;padding:12px;font-size:16px;margin-top:6px;
      border:1px solid var(--border);border-radius:10px;
      background:var(--card);color:var(--fg);min-height:44px
    }
    textarea{min-height:96px;resize:none;overflow:auto}
    .pill-group{display:flex;gap:10px;margin-top:8px}
    .pill{flex:1;text-align:center;padding:12px;border:1px solid var(--border);
      border-radius:999px;cursor:pointer;user-select:none}
    .pill.active{background:var(--accent);color:var(--accent-ink)}
    .map-wrap{display:none;margin-top:12px;border:1px solid var(--border);
      border-radius:10px;overflow:hidden}
    #mapAccess,#mapPoste{height:300px;width:100%}
    .map-toolbar{display:flex;gap:8px;padding:6px;background:var(--card)}
    .map-toolbar button{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);cursor:pointer}
    .btn-row{display:flex;gap:12px;margin-top:18px}
    .btn{flex:1;padding:12px;font-size:16px;border:none;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-ink)}
    .btn.secondary{background:#ccc}
    @media(prefers-color-scheme:dark){.btn.secondary{background:#2a2f36;color:#eee}}
  </style>
</head>
<body>
  <h2>‚ûï Ajouter un poste</h2>

  <div class="card">
    <form id="formPoste">
      <label>Votre nom</label>
      <input id="demandeur" required>

      <label>Nom du poste</label>
      <input id="nomPoste" placeholder="Ex : Cambrai" required>

      <label>Type</label>
      <input id="typePoste" placeholder="Ex : SP, SSP, PRCI, L‚Ä¶">

      <label>SAT associ√© (optionnel)</label>
<input id="sat" placeholder="Si SAT, pr√©cisez, ex : SAT1, SAT2‚Ä¶">

      <!-- ACC√àS (prioritaire / obligatoire d'une mani√®re ou d'une autre) -->
<label>Souhaitez-vous g√©olocaliser l‚Äôacc√®s ?</label>
<div class="hint">D√©placez le curseur pour ajuster la position de l‚Äôacc√®s.</div>
<div class="pill-group">
  <div class="pill" id="pill-acc-oui" data-value="oui">Oui</div>
  <div class="pill" id="pill-acc-non" data-value="non">Non</div>
</div>
      <input type="hidden" id="presentAccess">

      <!-- Carte acc√®s si oui -->
      <div class="map-wrap" id="mapAccessWrap">
        <div id="mapAccess"></div>
        <div class="map-toolbar">
          <button type="button" id="btnRecenterAccess">üìç Localiser</button>
          <button type="button" id="btnToggleAccess">üó∫Ô∏è Plan</button>
        </div>
      </div>
      <div id="coordsAccess" style="display:none;">
        <label>Latitude acc√®s</label>
        <input id="latAccess" inputmode="decimal">
        <label>Longitude acc√®s</label>
        <input id="lonAccess" inputmode="decimal">
      </div>

      <!-- Lien acc√®s si non -->
      <div id="lienAccessField" style="display:none;">
        <label>Coller le lien Google Maps de l‚Äôacc√®s</label>
        <input id="lienAccess" type="url" placeholder="https://maps.app.goo.gl/‚Ä¶">
      </div>

      <!-- POSTE / GU√âRITE (facultatif) -->
<label>Souhaitez-vous g√©olocaliser le poste / gu√©rite ?</label>
<div class="hint">D√©placez le curseur pour ajuster la position du poste.</div>
<div class="pill-group">
  <div class="pill" id="pill-pos-oui" data-value="oui">Oui</div>
  <div class="pill" id="pill-pos-non" data-value="non">Non</div>
</div>
      <input type="hidden" id="presentPoste">

      <!-- Carte poste si oui -->
      <div class="map-wrap" id="mapPosteWrap">
        <div id="mapPoste"></div>
        <div class="map-toolbar">
          <button type="button" id="btnRecenterPoste">üìç Localiser</button>
          <button type="button" id="btnTogglePoste">üó∫Ô∏è Plan</button>
        </div>
      </div>
      <div id="coordsPoste" style="display:none;">
        <label>Latitude poste / gu√©rite</label>
        <input id="latPoste" inputmode="decimal">
        <label>Longitude poste / gu√©rite</label>
        <input id="lonPoste" inputmode="decimal">
      </div>

      <!-- Lien poste si non (optionnel) -->
      <div id="lienPosteField" style="display:none;">
        <label>Coller le lien Google Maps du poste / gu√©rite (optionnel)</label>
        <input id="lienPoste" type="url" placeholder="https://maps.app.goo.gl/‚Ä¶">
      </div>

      <!-- PK + Ligne fusionn√©s -->
      <label>PK / Num√©ro de ligne (optionnel)</label>
      <input id="pkLigne" placeholder="Ex : PK 114.100 ‚Äì Ligne 216000">

      <label>Description / notes utiles</label>
      <textarea id="notes" placeholder="Code portail, acc√®s Carmillon, rep√®re visuel, proximit√© gare‚Ä¶"></textarea>

      <div class="btn-row">
        <button type="submit" class="btn primary">üì© Envoyer la contribution</button>
        <button type="button" class="btn secondary" onclick="location.href='index.html'">‚¨ÖÔ∏è Retour √† l‚Äôaccueil</button>
      </div>
    </form>
  </div>

  <script>
      // --- Pr√©remplissage depuis l'URL (?nom=...)
  (function () {
    const q = new URLSearchParams(location.search).get("nom");
    if (q) document.getElementById("nomPoste").value = q;  // reste √©ditable
  })();
    // --- Pr√©remplissage du nom du demandeur depuis le localStorage ---
(function prefillName() {
  const savedName = localStorage.getItem("nom_demandeur");
  if (savedName) {
    document.getElementById("demandeur").value = savedName;
  }
})();
    const DEST_EMAIL = "arnaud.debaecker@sncf.fr";
    const COUNTER_URL = "https://script.google.com/macros/s/AKfycbwSZ6PEcRuNYb-tyVgNnuStsAQgo_oXkbzuOh41ovRmiZMD30iJfyti6WvqdqMhKfuE/exec";

let mapAccess, mapPoste, markerAccess, markerPoste;

    function $(id){return document.getElementById(id);}
    function toggle(el,show){el.style.display = show ? "block" : "none";}
    function sanitizeCoord(v){return (v||"").toString().replace(",",".").trim();}
    function isValidLatLon(lat,lon){
      const la=parseFloat(lat), lo=parseFloat(lon);
      return !isNaN(la) && !isNaN(lo) && la>=-90 && la<=90 && lo>=-180 && lo<=180;
    }
    function isValidUrl(str){return /^https?:\/\/.+/i.test((str||"").trim());}

    // ‚Äî‚Äî‚Äî Pills ACC√àS
    $("pill-acc-oui").onclick = () => setAccess("oui");
    $("pill-acc-non").onclick = () => setAccess("non");
    function setAccess(v){
      $("presentAccess").value = v;
      $("pill-acc-oui").classList.toggle("active", v==="oui");
      $("pill-acc-non").classList.toggle("active", v==="non");
      if(v==="oui"){
        toggle($("mapAccessWrap"), true);
        toggle($("coordsAccess"), true);
        toggle($("lienAccessField"), false);
        startLocAccess();
      }else if(v==="non"){
        toggle($("mapAccessWrap"), false);
        toggle($("coordsAccess"), false);
        toggle($("lienAccessField"), true);
      }else{
        toggle($("mapAccessWrap"), false);
        toggle($("coordsAccess"), false);
        toggle($("lienAccessField"), false);
      }
    }

    // ‚Äî‚Äî‚Äî Pills POSTE (facultatif)
    $("pill-pos-oui").onclick = () => setPoste("oui");
    $("pill-pos-non").onclick = () => setPoste("non");
    function setPoste(v){
      $("presentPoste").value = v;
      $("pill-pos-oui").classList.toggle("active", v==="oui");
      $("pill-pos-non").classList.toggle("active", v==="non");
      if(v==="oui"){
        toggle($("mapPosteWrap"), true);
        toggle($("coordsPoste"), true);
        toggle($("lienPosteField"), false);
        startLocPoste();
      }else if(v==="non"){
        toggle($("mapPosteWrap"), false);
        toggle($("coordsPoste"), false);
        toggle($("lienPosteField"), true);
      }else{
        toggle($("mapPosteWrap"), false);
        toggle($("coordsPoste"), false);
        toggle($("lienPosteField"), false);
      }
    }

// ‚Äî‚Äî‚Äî Cartes
function ensureMap(mapId, btnToggle, btnRecenter, lat, lon, kind){
  const map = L.map(mapId).setView([lat, lon], 18);

  const esri = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");
  const osm  = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");

  // Par d√©faut on d√©marre en satellite
  esri.addTo(map);

  const marker = L.marker([lat,lon], {draggable:true}).addTo(map);

  marker.on("dragend", ()=>{
    const p = marker.getLatLng();
    if(kind==="access"){ $("latAccess").value=p.lat; $("lonAccess").value=p.lng; }
    else{ $("latPoste").value=p.lat; $("lonPoste").value=p.lng; }
  });

  // Chaque carte garde son propre √©tat plan/satellite
  let isSat = true;
  $(btnToggle).onclick = ()=>{
    isSat = !isSat;
    if(isSat){
      map.removeLayer(osm); esri.addTo(map);
      $(btnToggle).textContent="üó∫Ô∏è Plan";
    }else{
      map.removeLayer(esri); osm.addTo(map);
      $(btnToggle).textContent="üõ∞Ô∏è Satellite";
    }
  };

  $(btnRecenter).onclick = ()=>{
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(p=>{
        map.setView([p.coords.latitude,p.coords.longitude],18);
        marker.setLatLng([p.coords.latitude,p.coords.longitude]);
        if(kind==="access"){ $("latAccess").value=p.coords.latitude; $("lonAccess").value=p.coords.longitude; }
        else{ $("latPoste").value=p.coords.latitude; $("lonPoste").value=p.coords.longitude; }
      });
    }
  };

  if(kind==="access"){ mapAccess=map; markerAccess=marker; }
  else{ mapPoste=map; markerPoste=marker; }
}

    function startLocAccess(){
      if(mapAccess) return;
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
          ensureMap("mapAccess","btnToggleAccess","btnRecenterAccess", p.coords.latitude, p.coords.longitude, "access");
          $("latAccess").value=p.coords.latitude; $("lonAccess").value=p.coords.longitude;
        }, ()=>{
          ensureMap("mapAccess","btnToggleAccess","btnRecenterAccess", 50.62925, 3.057256, "access");
        });
      }else{
        ensureMap("mapAccess","btnToggleAccess","btnRecenterAccess", 50.62925, 3.057256, "access");
      }
    }

    function startLocPoste(){
      if(mapPoste) return;
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
          ensureMap("mapPoste","btnTogglePoste","btnRecenterPoste", p.coords.latitude, p.coords.longitude, "poste");
          $("latPoste").value=p.coords.latitude; $("lonPoste").value=p.coords.longitude;
        }, ()=>{
          ensureMap("mapPoste","btnTogglePoste","btnRecenterPoste", 50.62925, 3.057256, "poste");
        });
      }else{
        ensureMap("mapPoste","btnTogglePoste","btnRecenterPoste", 50.62925, 3.057256, "poste");
      }
    }

    // ‚Äî‚Äî‚Äî Submit
    $("formPoste").onsubmit = (e)=>{
      e.preventDefault();

      const demandeur   = $("demandeur").value.trim();
      if (demandeur) {
  localStorage.setItem("nom_demandeur", demandeur);
}
      const nomPoste    = $("nomPoste").value.trim();
      const typePoste   = $("typePoste").value.trim().toUpperCase();
     const satellite   = $("sat").value.trim().toUpperCase();
      const pkLigne     = $("pkLigne").value.trim();
      const notes       = $("notes").value.trim();

      if(!demandeur || !nomPoste){
        alert("‚ö†Ô∏è Merci de renseigner votre nom et le nom du poste.");
        return;
      }

      // ACC√àS : choix obligatoire + donn√©e obligatoire (coords OU lien)
      if(!$("presentAccess").value){
        alert("‚ö†Ô∏è Merci d‚Äôindiquer si vous souhaitez g√©olocaliser l‚Äôacc√®s (Oui / Non).");
        return;
      }

      let accesStr = "";
      if($("presentAccess").value === "oui"){
        const la = sanitizeCoord($("latAccess").value);
        const lo = sanitizeCoord($("lonAccess").value);
        if(!isValidLatLon(la,lo)){
          alert("‚ö†Ô∏è Les coordonn√©es de l‚Äôacc√®s ne sont pas valides.");
          return;
        }
        accesStr = `${la},${lo}`;
      }else{ // non
        const lienA = $("lienAccess").value.trim();
        if(!isValidUrl(lienA)){
          alert("‚ö†Ô∏è Merci de fournir un lien Google Maps valide pour l‚Äôacc√®s.");
          return;
        }
        accesStr = lienA;
      }

      // POSTE / GU√âRITE : facultatif
      let posteStr = "";
      if($("presentPoste").value === "oui"){
        const laP = sanitizeCoord($("latPoste").value);
        const loP = sanitizeCoord($("lonPoste").value);
        if(!isValidLatLon(laP,loP)){
          alert("‚ö†Ô∏è Les coordonn√©es du poste / de la gu√©rite ne sont pas valides.");
          return;
        }
        posteStr = `${laP},${loP}`;
      }else if($("presentPoste").value === "non"){
        const lienP = $("lienPoste").value.trim();
        if(lienP){ // optionnel : s'il est rempli, on le v√©rifie
          if(!isValidUrl(lienP)){
            alert("‚ö†Ô∏è Le lien Google Maps du poste / de la gu√©rite n‚Äôest pas valide.");
            return;
          }
          posteStr = lienP;
        }
      }

      // Email
      const subject = `Contribution : ajout d‚Äôun poste ‚Äî ${nomPoste}`;
      let body  = `Bonjour Arnaud,%0D%0A%0D%0A${encodeURIComponent(demandeur)} propose l‚Äôajout du poste suivant :%0D%0A%0D%0A`;
      body += `Nom du poste : ${encodeURIComponent(nomPoste)}%0D%0A`;
      if(typePoste) body += `Type : ${encodeURIComponent(typePoste)}%0D%0A`;
      if(satellite) body += `Satellite : ${encodeURIComponent(satellite)}%0D%0A`;
      body += `Acc√®s : ${encodeURIComponent(accesStr)}%0D%0A`;
      if(posteStr) body += `Poste / gu√©rite : ${encodeURIComponent(posteStr)}%0D%0A`;
      if(pkLigne) body += `PK / Ligne : ${encodeURIComponent(pkLigne)}%0D%0A`;
      if(notes) body += `Notes : ${encodeURIComponent(notes)}%0D%0A`;
      body += `%0D%0ACordialement,%0D%0A${encodeURIComponent(demandeur)}`;

      // Envoi mail via mailto
      location.href = `mailto:${DEST_EMAIL}?subject=${encodeURIComponent(subject)}&body=${body}`;

      // Incr√©ment compteur contributions (identique)
      fetch(COUNTER_URL + "?increment=true").catch(()=>{});

  alert("L‚Äôe-mail de contribution est g√©n√©r√©, v√©rifiez et envoyez-le.");

// Sauvegarde le nom avant reset
const savedName = demandeur;

// Reset complet du formulaire
$("formPoste").reset();
setAccess("");
setPoste("");

// R√©injecte le nom sauvegard√©
if (savedName) {
  $("demandeur").value = savedName;
}
    };
  </script>
</body>
</html>
