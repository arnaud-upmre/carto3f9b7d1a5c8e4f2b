<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nono Maps – Mini-Jeu GeoGuessr (Mapillary)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #streetview {
      height: 55vh;
      width: 100%;
      border-bottom: 3px solid #222;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#aaa;
    }

    #map {
      height: 45vh;
      width: 100%;
    }

    #scoreBox {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.55);
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 18px;
      backdrop-filter: blur(8px);
    }

    #nextBtn {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #0a84ff;
      color: white;
      border: none;
      padding: 12px 22px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      display:none;
    }

    #nextBtn:hover { background: #006bd6; }
  </style>
</head>
<body>

<div id="scoreBox">Clique sur la carte pour deviner l'emplacement</div>
<div id="streetview">Chargement Mapillary…</div>
<div id="map"></div>
<button id="nextBtn">Round suivant</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@mapillary/mjs/dist/mapillary.js"></script>
<script>
// --------------------------
//  Chargement postes.json
// --------------------------
let data = [];
fetch("postes.json")
  .then(r => r.json())
  .then(json => {
    data = json.map(p => ({ nom: p.nom, lat: p.latitude, lon: p.longitude }));
    newRound();
  });

// --------------------------
//  Variables globales
// --------------------------
let trueLat = 0;
let trueLon = 0;
let map;
let guessMarker;
let trueMarker;
let poly;
let roundActive = true;
let viewer;

// --------------------------
//  INIT CARTE
// --------------------------
function initMap() {
  map = L.map('map').setView([50.7, 2.6], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  map.on('click', onMapClick);
}
initMap();

// --------------------------
//  CHARGER IMAGE MAPILLARY
// --------------------------
async function loadMapillary(lat, lon) {
  const div = document.getElementById("streetview");
  div.innerHTML = "Chargement Mapillary…";

  const url = `https://graph.mapillary.com/images?fields=id&access_token=MLY|1795850130056096|4d1828732fdedb70b9cd27663e41fb35&closeto=${lon},${lat}`;

  const res = await fetch(url);
  const js = await res.json();

  if (!js.data || js.data.length === 0) {
    div.innerHTML = "Aucune image, nouveau point…";
    setTimeout(newRound, 600);
    return;
  }

  const imageId = js.data[0].id;

  div.innerHTML = "";
  viewer = new mapillary.Viewer({
    container: "streetview",
    imageId: imageId,
    accessToken: "MLY|1795850130056096|4d1828732fdedb70b9cd27663e41fb35",
    component: { cover: false, attribution: false },
    ui: false
  });
}

// --------------------------
//  HAVERSINE
// --------------------------
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = x => x * Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function scoreFromDistance(d) {
  if (d < 50) return 5000;
  if (d < 100) return 4000;
  if (d < 500) return 2000;
  if (d < 2000) return 500;
  return 0;
}

// --------------------------
//  CLICK CARTE
// --------------------------
function onMapClick(e) {
  if (!roundActive) return;
  roundActive = false;

  const guess = e.latlng;
  const dist = haversine(guess.lat, guess.lng, trueLat, trueLon);
  const pts = scoreFromDistance(dist);

  if (guessMarker) map.removeLayer(guessMarker);
  if (trueMarker) map.removeLayer(trueMarker);
  if (poly) map.removeLayer(poly);

  guessMarker = L.marker([guess.lat, guess.lng]).addTo(map);
  trueMarker  = L.marker([trueLat, trueLon]).addTo(map);
  poly = L.polyline([[guess.lat, guess.lng],[trueLat,trueLon]],{color:'red'}).addTo(map);

  document.getElementById("scoreBox").textContent =
    `Distance : ${Math.round(dist)} m — Score : ${pts} pts`;

  document.getElementById("nextBtn").style.display = "block";
}

// --------------------------
//  NOUVEAU ROUND
// --------------------------
function newRound() {
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("scoreBox").textContent = "Clique sur la carte pour deviner l'emplacement";
  roundActive = true;

  const choice = data[Math.floor(Math.random()*data.length)];
  trueLat = choice.lat;
  trueLon = choice.lon;

  loadMapillary(trueLat, trueLon);
  map.setView([50.7, 2.6], 8);
}

document.getElementById("nextBtn").onclick = newRound;
</script>
</body>
</html>
