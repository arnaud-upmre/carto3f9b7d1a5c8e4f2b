<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nono Maps – Mini-Jeu GeoGuessr</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #streetview {
      height: 55vh;
      width: 100%;
      border-bottom: 3px solid #222;
    }

    #map {
      height: 45vh;
      width: 100%;
    }

    #scoreBox {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.55);
      padding: 10px 20px;
      border-radius: 12px;
      font-size: 18px;
      backdrop-filter: blur(8px);
    }

    #nextBtn {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #0a84ff;
      color: white;
      border: none;
      padding: 12px 22px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      display: none;
    }

    #nextBtn:hover { background: #006bd6; }
  </style>

  <script async defer src="https://maps.googleapis.com/maps/api/js?callback=initStreetViewAPI"></script>
</head>
<body>

<div id="scoreBox">Clique sur la carte pour deviner l'emplacement</div>
<div id="streetview"></div>
<div id="map"></div>
<button id="nextBtn">Round suivant</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let gmapAPIReady = false;
function initStreetViewAPI() {
  gmapAPIReady = true;
}

let data = [];
fetch("postes.json")
  .then(r => r.json())
  .then(json => {
    data = json.map(p => ({ nom: p.nom, lat: p.latitude, lon: p.longitude }));
    newRound();
  });

let trueLat = 0;
let trueLon = 0;
let map;
let guessMarker;
let trueMarker;
let poly;
let roundActive = true;

function initMap() {
  map = L.map('map').setView([50.7, 2.6], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  map.on('click', onMapClick);
}
initMap();

function loadStreetView(lat, lon) {
  const div = document.getElementById("streetview");

  if (!gmapAPIReady) {
    div.innerHTML = "<div style='padding:20px;text-align:center;'>Chargement…</div>";
    setTimeout(() => loadStreetView(lat, lon), 300);
    return;
  }

  const sv = new google.maps.StreetViewService();

  sv.getPanorama({ location: { lat, lng: lon }, radius: 100 }, (data, status) => {
    if (status === "OK") {
      new google.maps.StreetViewPanorama(div, {
        pano: data.location.pano,
        pov: { heading: 0, pitch: 0 },
        zoom: 0,
        disableDefaultUI: true,
        showRoadLabels: false,
        linksControl: true,
        clickToGo: true
      });
    } else {
      div.innerHTML = "<div style='display:flex;align-items:center;justify-content:center;height:100%;color:#bbb;'>Aucune image, nouveau point…</div>";
      setTimeout(() => newRound(), 600);
    }
  });
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371e3;
  const toRad = x => x * Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function scoreFromDistance(d) {
  if (d < 50) return 5000;
  if (d < 100) return 4000;
  if (d < 500) return 2000;
  if (d < 2000) return 500;
  return 0;
}

function onMapClick(e) {
  if (!roundActive) return;
  roundActive = false;

  const guess = e.latlng;
  const dist = haversine(guess.lat, guess.lng, trueLat, trueLon);
  const pts = scoreFromDistance(dist);

  if (guessMarker) map.removeLayer(guessMarker);
  if (trueMarker) map.removeLayer(trueMarker);
  if (poly) map.removeLayer(poly);

  guessMarker = L.marker([guess.lat, guess.lng]).addTo(map);
  trueMarker  = L.marker([trueLat, trueLon]).addTo(map);
  poly = L.polyline([[guess.lat, guess.lng],[trueLat,trueLon]],{color:'red'}).addTo(map);

  document.getElementById("scoreBox").textContent =
    `Distance : ${Math.round(dist)} m — Score : ${pts} pts`;

  document.getElementById("nextBtn").style.display = "block";
}

function newRound() {
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("scoreBox").textContent = "Clique sur la carte pour deviner l'emplacement";
  roundActive = true;

  const choice = data[Math.floor(Math.random()*data.length)];
  trueLat = choice.lat;
  trueLon = choice.lon;

  loadStreetView(trueLat, trueLon);
  map.setView([50.7, 2.6], 8);
}

document.getElementById("nextBtn").onclick = newRound;
</script>
</body>
</html>
