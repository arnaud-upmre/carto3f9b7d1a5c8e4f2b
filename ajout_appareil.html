<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>â• Ajouter un appareil</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    form {
  display: flex;
  flex-direction: column;
  gap: 18px; /* espace vertical entre les champs */
}
    
    
    .hint {
  font-size: 12px;
  color: #999;
  font-style: italic;
  margin: 2px 0 6px;
}
    *,*::before,*::after{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0; padding:16px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:var(--fg);
    }
    :root{
      --bg:#f7f7f8; --fg:#202124; --card:#fff; --border:#d0d7de;
      --accent:#0b6cff; --accent-ink:#fff; --muted:#666;
    }
    @media(prefers-color-scheme:dark){
      :root{
        --bg:#0b0b0b; --fg:#eceff1; --card:#141414; --border:#2a2a2a;
        --accent:#5aa3ff; --accent-ink:#081018; --muted:#999;
      }
    }
    h2{text-align:center;margin:0 0 12px}
    .card{max-width:640px;margin:auto;background:var(--card);padding:16px;
      border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
   label {
  display: block;
  margin-bottom: 0px;   /* espace juste sous le label */
  margin-top: 0;        /* pas dâ€™espace au-dessus */
  font-weight: 600;
}

input,textarea {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  margin-top: 0;        /* on supprime le dÃ©calage inutile */
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--card);
  color: var(--fg);
  min-height: 44px;
}
    textarea{min-height:96px;resize:none;overflow:auto}
   .pill-group {
  display: flex;
  gap: 10px;
  margin-top: 4px;   /* rÃ©duit lâ€™espace, colle mieux */
}
    .pill{flex:1;text-align:center;padding:12px;border:1px solid var(--border);
      border-radius:999px;cursor:pointer}
    .pill.active{background:var(--accent);color:var(--accent-ink)}
    .map-wrap{display:none;margin-top:12px;border:1px solid var(--border);
      border-radius:10px;overflow:hidden}
    #mapDevice,#mapAccess{height:300px;width:100%}
    .map-toolbar{display:flex;gap:8px;padding:6px;background:var(--card)}
    .map-toolbar button{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);cursor:pointer}
    .btn-row{display:flex;gap:12px;margin-top:18px}
    .btn{flex:1;padding:12px;font-size:16px;border:none;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-ink)}
    .btn.secondary{background:#ccc}
    @media(prefers-color-scheme:dark){.btn.secondary{background:#2a2f36;color:#eee}}
  </style>
</head>
<body>
  <h2>â• Ajouter un appareil</h2>

  <div class="card">
    <form id="formAppareil">
      <label>ğŸ‘¤ Demandeur : </label>
      <input id="demandeur" required>

      <label>Poste</label>
      <input id="poste">

      <label>SAT (optionnel)</label>
<input id="sat" placeholder="Ex : SAT1, SAT2â€¦">

      <label>ğŸ’¡ Nom de lâ€™appareil</label>
      <input id="appareil" placeholder="Ex : I7112" required>

     <label>ğŸ“Localiser lâ€™appareil via GPS ?</label>
<div class="hint">DÃ©placez le curseur pour ajuster la position de lâ€™appareil.</div>
<div class="pill-group">
  <div class="pill" id="pill-oui" data-value="oui">Oui</div>
  <div class="pill" id="pill-non" data-value="non">Non</div>
</div>
      <input type="hidden" id="presentValue">

      <!-- Carte si oui -->
      <div class="map-wrap" id="mapDeviceWrap">
        <div id="mapDevice"></div>
        <div class="map-toolbar">
          <button type="button" id="btnRecenterDevice">ğŸ“ Localiser</button>
          <button type="button" id="btnToggleDevice">ğŸ—ºï¸ Plan</button>
        </div>
      </div>
      <div id="coordsDevice" style="display:none;">
        <label>Latitude de lâ€™appareil</label>
        <input id="latDevice">
        <label>Longitude de lâ€™appareil</label>
        <input id="lonDevice">
      </div>

      <!-- Lien si non -->
      <div id="lienField" style="display:none;">
        <label>Coller le lien Google Maps</label>
        <input id="lien" type="url" placeholder="https://maps.app.goo.gl/â€¦">
      </div>

      <!-- AccÃ¨s spÃ©cifique -->
    <label>ğŸ“Lâ€™appareil a un accÃ¨s distinct ?</label>
<div class="hint">DÃ©placez le curseur pour ajuster la position de lâ€™accÃ¨s.</div>
<div class="pill-group">
  <div class="pill" id="pill-acces-oui" data-value="oui">Oui</div>
  <div class="pill" id="pill-acces-non" data-value="non">Non</div>
</div>
      <input type="hidden" id="accessValue">

      <div class="map-wrap" id="mapAccessWrap">
        <div id="mapAccess"></div>
        <div class="map-toolbar">
          <button type="button" id="btnRecenterAccess">ğŸ“ Localiser</button>
          <button type="button" id="btnToggleAccess">ğŸ—ºï¸ Plan</button>
        </div>
      </div>
      <div id="coordsAccess" style="display:none;">
        <label>Latitude accÃ¨s</label>
        <input id="latAccess">
        <label>Longitude accÃ¨s</label>
        <input id="lonAccess">
      </div>
      <div id="lienAccessField" style="display:none;">
  <label>Lien Google Maps de lâ€™accÃ¨s (optionnel)</label>
  <input id="lienAccess" type="url" placeholder="https://maps.app.goo.gl/â€¦">
  <div class="hint">Si vous indiquez Â« Oui Â» : complÃ©tez soit les coordonnÃ©es GPS de lâ€™accÃ¨s, soit un lien Google Maps valide.</div>
</div>

      <label>Notes complÃ©mentaires</label>
      <textarea id="infos" placeholder="Indiquez un repÃ¨re ou une info utile (accÃ¨s, portail, etc.)"></textarea>

      <div class="btn-row">
        <button type="submit" class="btn primary">ğŸ“© Envoyer la contribution</button>
        <button type="button" class="btn secondary" onclick="location.href='index.html'">â¬…ï¸ Retour Ã  lâ€™accueil</button>
      </div>
    </form>
  </div>

  <script>
    const DEST_EMAIL = "arnaud.debaecker@sncf.fr";
// PrÃ©remplir uniquement selon l'origine (poste OU appareil)
(function prefillFromURL(){
  const $ = (id)=>document.getElementById(id);
  const params   = new URLSearchParams(location.search);
  const appareil = params.get("appareil");
  const poste    = params.get("poste");

  // 1) Si on vient depuis la fiche dâ€™un poste â†’ on affiche et on mÃ©morise
  if (poste) {
    $("poste").value = poste;
    try { localStorage.setItem("poste_selectionne", poste); } catch(e){}
  }
  // 2) Si on vient depuis une recherche dâ€™appareil â†’ on NE prÃ©remplit PAS le poste
  //    et on nettoie le cache pour Ã©viter d'afficher un vieux poste
  else if (appareil) {
    $("appareil").value = appareil;
    try { localStorage.removeItem("poste_selectionne"); } catch(e){}
  }
  // 3) AccÃ¨s direct Ã  la page â†’ on peut rÃ©utiliser le dernier poste du cache
  else {
    try {
      const cached = localStorage.getItem("poste_selectionne");
      if (cached) $("poste").value = cached;
    } catch(e){}
  }

  // Toujours prÃ©remplir lâ€™appareil si prÃ©sent dans lâ€™URL (cas 1 + 2)
  if (appareil) $("appareil").value = appareil;
})();

    // --- PrÃ©remplissage du nom du demandeur ---
(function prefillName() {
  const savedName = localStorage.getItem("nom_demandeur");
  if (savedName) {
    document.getElementById("demandeur").value = savedName;
  }
})();
    const COUNTER_URL = "https://script.google.com/macros/s/AKfycbwSZ6PEcRuNYb-tyVgNnuStsAQgo_oXkbzuOh41ovRmiZMD30iJfyti6WvqdqMhKfuE/exec";

    let mapDevice, mapAccess, markerDevice, markerAccess;

    function $(id){return document.getElementById(id);}
    function toggle(el,show){el.style.display=show?"block":"none";}
   function sanitizeCoord(v){return (v||"").toString().replace(",",".");}
    function isValidLatLon(lat,lon){
      const la=parseFloat(lat),lo=parseFloat(lon);
      return !isNaN(la)&&!isNaN(lo)&&la>=-90&&la<=90&&lo>=-180&&lo<=180;
    }
   function isValidUrl(str){return /^https?:\/\/.+/i.test((str||"").trim());}

    // â–¼â–¼â–¼ AJOUTS POUR AMÃ‰LIORATION LOCALISATION â–¼â–¼â–¼
    const HAZE = [50.72454, 2.54311];
    let lastFix = null;
    let GEO_BLOCKED = false;
    const GEO_OPTS = { enableHighAccuracy: true, timeout: 7000, maximumAge: 15000 };

    function setMapTo(map, marker, lat, lon, kind){
      if(!map || !marker) return;
      map.setView([lat, lon], 18);
      marker.setLatLng([lat, lon]);
      if(kind === "device"){ $("latDevice").value = lat; $("lonDevice").value = lon; }
      else if(kind === "access"){ $("latAccess").value = lat; $("lonAccess").value = lon; }
    }

    function applyFix(lat, lon){
      lastFix = { lat, lon, ts: Date.now() };
      if(mapDevice && markerDevice) setMapTo(mapDevice, markerDevice, lat, lon, "device");
      if(mapAccess && markerAccess) setMapTo(mapAccess, markerAccess, lat, lon, "access");
    }

    function onGeoDenied(target){
      GEO_BLOCKED = true;
      if(target === "device"){
        $("presentValue").value = "non";
        $("pill-oui").classList.remove("active");
        $("pill-non").classList.add("active");
        toggle($("mapDeviceWrap"), 0);
        toggle($("coordsDevice"), 0);
        toggle($("lienField"), 1);
        alert("La gÃ©olocalisation est refusÃ©e. Renseignez un lien Google Maps.");
      } else if(target === "access"){
        $("accessValue").value = "non";
        $("pill-acces-oui").classList.remove("active");
        $("pill-acces-non").classList.add("active");
        toggle($("mapAccessWrap"), 0);
        toggle($("coordsAccess"), 0);
        toggle($("lienAccessField"), 1);
        alert("La gÃ©olocalisation est refusÃ©e. Renseignez un lien Google Maps pour lâ€™accÃ¨s.");
      }
    }

    // PrÃ©-rÃ©cupÃ©ration de la position au chargement
    document.addEventListener("DOMContentLoaded", () => {
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          p => applyFix(p.coords.latitude, p.coords.longitude),
          err => { if(err && err.code === 1) { GEO_BLOCKED = true; } },
          GEO_OPTS
        );
      }
    });
    // â–²â–²â–² FIN AJOUTS â–²â–²â–²

    // Pills appareil
    $("pill-oui").onclick=()=>setPill("oui");
    $("pill-non").onclick=()=>setPill("non");
    function setPill(v){
      $("presentValue").value=v;
      $("pill-oui").classList.toggle("active",v==="oui");
      $("pill-non").classList.toggle("active",v==="non");
      if(v==="oui"){
        if(GEO_BLOCKED){ onGeoDenied("device"); return; }
        toggle($("mapDeviceWrap"),1);toggle($("coordsDevice"),1);toggle($("lienField"),0);startLocDevice();
      }
      else{toggle($("mapDeviceWrap"),0);toggle($("coordsDevice"),0);toggle($("lienField"),1);}
    }

    // Pills accÃ¨s
    $("pill-acces-oui").onclick=()=>setAccess("oui");
    $("pill-acces-non").onclick=()=>setAccess("non");
    function setAccess(v){
  $("accessValue").value=v;
  $("pill-acces-oui").classList.toggle("active",v==="oui");
  $("pill-acces-non").classList.toggle("active",v==="non");
  if(v==="oui"){
    if(GEO_BLOCKED){ onGeoDenied("access"); return; }
    toggle($("mapAccessWrap"),1);
    toggle($("coordsAccess"),1);
    toggle($("lienAccessField"),1);
    startLocAccess();
  } else {
    toggle($("mapAccessWrap"),0);
    toggle($("coordsAccess"),0);
    toggle($("lienAccessField"),0);
  }
}

    // Maps
     // Maps
    function ensureMap(mapId,btnToggle,btnRecenter,lat,lon){
      let map,marker;
    map = L.map(mapId).setView([50.72454, 2.54311], 18);  // Hazebrouck par dÃ©faut, zoom plus doux
setTimeout(() => map.invalidateSize(), 300);

const esri = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");
const osm  = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");

// Par dÃ©faut on dÃ©marre en OSM (plan rapide)
osm.addTo(map);

// On est en mode "plan" au dÃ©part
let isSat = false;
$(btnToggle).textContent = "ğŸ›°ï¸ Satellite"; // bouton propose de passer en satellite

      // point de dÃ©part : dernier fix si dispo, sinon paramÃ¨tres passÃ©s
      const startLat = (lastFix ? lastFix.lat : lat);
      const startLon = (lastFix ? lastFix.lon : lon);
      marker = L.marker([startLat,startLon],{draggable:true}).addTo(map);

      marker.on("dragend",()=>{
        let p=marker.getLatLng();
        if(mapId==="mapDevice"){
          $("latDevice").value=p.lat;
          $("lonDevice").value=p.lng;
        } else {
          $("latAccess").value=p.lat;
          $("lonAccess").value=p.lng;
        }
      });

  $(btnToggle).onclick = () => {
  isSat = !isSat;
  if (isSat) {
    // passer en satellite
    if (map.hasLayer(osm)) map.removeLayer(osm);
    esri.addTo(map);
    $(btnToggle).textContent = "ğŸ—ºï¸ Plan";
  } else {
    // repasser en plan (OSM)
    if (map.hasLayer(esri)) map.removeLayer(esri);
    osm.addTo(map);
    $(btnToggle).textContent = "ğŸ›°ï¸ Satellite";
  }
};

      $(btnRecenter).onclick=()=>{
        if(GEO_BLOCKED){
          const target = (mapId === "mapDevice") ? "device" : "access";
          onGeoDenied(target);
          return;
        }
        // 1) applique immÃ©diatement le dernier fix si prÃ©sent
        if (lastFix){
          const isDevice = (mapId === "mapDevice");
          const mapRef    = isDevice ? mapDevice   : mapAccess;
          const markerRef = isDevice ? markerDevice: markerAccess;
          const kind      = isDevice ? "device"    : "access";
          setMapTo(mapRef, markerRef, lastFix.lat, lastFix.lon, kind);
        }
        // 2) demande une position plus fraÃ®che en arriÃ¨re-plan
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(
            p => applyFix(p.coords.latitude,p.coords.longitude),
            err => { if(err && err.code === 1){ const t=(mapId==="mapDevice")?"device":"access"; onGeoDenied(t); } },
            GEO_OPTS
          );
        }
      };

      if(mapId==="mapDevice"){ mapDevice=map; markerDevice=marker; }
      else{ mapAccess=map; markerAccess=marker; }
    }

function startLocDevice(){
  if(GEO_BLOCKED){ onGeoDenied("device"); return; }
  // CrÃ©e immÃ©diatement la carte sur Hazebrouck si pas dÃ©jÃ  affichÃ©e
  if(!mapDevice){
    ensureMap("mapDevice","btnToggleDevice","btnRecenterDevice",50.72454,2.54311);
  }

  // Applique une position dÃ©jÃ  connue si dispo
  if(lastFix) setMapTo(mapDevice, markerDevice, lastFix.lat, lastFix.lon, "device");

  // Puis recadre quand le GPS rÃ©pond
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      p=>applyFix(p.coords.latitude,p.coords.longitude),
      err=>{ if(err && err.code===1) onGeoDenied("device"); },
      GEO_OPTS
    );
  }
}
    
    function startLocAccess(){
  if(GEO_BLOCKED){ onGeoDenied("access"); return; }
  // CrÃ©e immÃ©diatement la carte sur Hazebrouck si pas dÃ©jÃ  affichÃ©e
  if(!mapAccess){
    ensureMap("mapAccess","btnToggleAccess","btnRecenterAccess",50.72454,2.54311);
  }

  // Applique une position dÃ©jÃ  connue si dispo
  if(lastFix) setMapTo(mapAccess, markerAccess, lastFix.lat, lastFix.lon, "access");

  // Puis recadre quand le GPS rÃ©pond
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      p=>applyFix(p.coords.latitude,p.coords.longitude),
      err=>{ if(err && err.code===1) onGeoDenied("access"); },
      GEO_OPTS
    );
  }
}
    // Submit (validations harmonisÃ©es)
    $("formAppareil").onsubmit=e=>{
      e.preventDefault();
      let demandeur=$("demandeur").value.trim();
      // Sauvegarde du nom pour la prochaine fois
if (demandeur) {
  localStorage.setItem("nom_demandeur", demandeur);
}
      let poste=$("poste").value.trim();
      let appareil=$("appareil").value.trim();
      let infos=$("infos").value.trim();
      if(!demandeur||!poste||!appareil){
        alert("âš ï¸ Merci de renseigner tous les champs obligatoires.");
        return;
      }

      // Q1 obligatoire : gÃ©olocaliser OU fournir un lien
      if(!$("presentValue").value){
        alert("âš ï¸ Merci dâ€™indiquer si vous souhaitez gÃ©olocaliser lâ€™appareil ou fournir un lien.");
        return;
      }

      // Q2 obligatoire : accÃ¨s spÃ©cifique Oui / Non
      if(!$("accessValue").value){
        alert("âš ï¸ Merci dâ€™indiquer si lâ€™appareil a son propre accÃ¨s (Oui / Non).");
        return;
      }

      let coordAppareil="",coordAcces="";
      if($("presentValue").value==="oui"){
        let la=sanitizeCoord($("latDevice").value),lo=sanitizeCoord($("lonDevice").value);
        if(!isValidLatLon(la,lo)){alert("âš ï¸ Les coordonnÃ©es GPS de lâ€™appareil ne sont pas valides.");return;}
        coordAppareil=la+","+lo;
      }else if($("presentValue").value==="non"){
        if(!isValidUrl($("lien").value)){alert("âš ï¸ Merci de fournir un lien valide.");return;}
        coordAppareil=$("lien").value;
      }

     if($("accessValue").value==="oui"){
  let la=sanitizeCoord($("latAccess").value),lo=sanitizeCoord($("lonAccess").value);
  let lienAcces=$("lienAccess").value.trim();
  if(isValidLatLon(la,lo)){
    coordAcces=la+","+lo;
  } else if(isValidUrl(lienAcces)){
    coordAcces=lienAcces;
  } else {
    alert("âš ï¸ Merci de renseigner soit les coordonnÃ©es GPS de lâ€™accÃ¨s, soit un lien Google Maps valide.");
    return;
  }
}

      let subject=`Contribution : ajout dâ€™un appareil au poste de ${poste}`;
      let body=`Bonjour Arnaud,%0D%0A%0D%0A${demandeur} propose lâ€™ajout de lâ€™appareil suivant :%0D%0A%0D%0A`
        +`Poste : ${poste}%0D%0A`
        +`SAT : ${$("sat").value.trim()}%0D%0A`
        +`Appareil : ${appareil}%0D%0A`
        +`Localisation : ${coordAppareil}%0D%0A`
        +(coordAcces?`AccÃ¨s spÃ©cifique : ${coordAcces}%0D%0A`:"")
        +`Notes : ${infos}%0D%0A%0D%0A`
        +`Cordialement,%0D%0A${demandeur}`;

      // Envoi mail
      location.href=`mailto:${DEST_EMAIL}?subject=${encodeURIComponent(subject)}&body=${body}`;

      // IncrÃ©ment compteur contributions
      fetch(COUNTER_URL+"?increment=true").catch(()=>{});

alert("Lâ€™e-mail de contribution est gÃ©nÃ©rÃ©, vÃ©rifiez et envoyez-le.");

// Sauvegarde le nom avant reset
const savedName = demandeur;

// Reset complet du formulaire
$("formAppareil").reset();
setPill("");setAccess("");

// RÃ©injecte le nom sauvegardÃ©
if (savedName) {
  $("demandeur").value = savedName;
}
    };
  </script>
</body>
</html>
