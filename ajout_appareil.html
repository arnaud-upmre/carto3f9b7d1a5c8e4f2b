<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>â• Ajouter un appareil</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0; padding:16px;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--fg);
    }
    :root{
      --bg:#f7f7f8; --fg:#202124; --card:#fff; --border:#d0d7de;
      --accent:#0b6cff; --accent-ink:#fff; --muted:#666;
    }
    @media(prefers-color-scheme:dark){
      :root{
        --bg:#0b0b0b; --fg:#eceff1; --card:#141414; --border:#2a2a2a;
        --accent:#5aa3ff; --accent-ink:#081018; --muted:#999;
      }
    }
    h2{text-align:center;margin:0 0 12px}
    .card{
      max-width:640px;margin:auto;
      background:var(--card);
      padding:16px;border-radius:14px;
      box-shadow:0 2px 6px rgba(0,0,0,.15);
    }
    label{display:block;margin:12px 0 6px;font-weight:600}
    input,textarea{
      width:100%;padding:12px;font-size:16px;
      border:1px solid var(--border);border-radius:10px;
      background:var(--card);color:var(--fg);
      min-height:44px;
    }
    textarea{min-height:96px;resize:none}
    .pill-group{display:flex;gap:10px;margin:12px 0}
    .pill{
      flex:1;text-align:center;padding:12px;
      border:1px solid var(--border);border-radius:999px;cursor:pointer;
    }
    .pill.active{background:var(--accent);color:var(--accent-ink)}
    .map-wrap{margin:12px 0;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    #mapDevice,#mapAccess{height:300px;width:100%}
    .map-toolbar{display:flex;gap:8px;padding:6px;background:var(--card)}
    .map-toolbar button{
      flex:1;padding:8px;border-radius:8px;
      border:1px solid var(--border);cursor:pointer;
    }
    .btn-row{display:flex;gap:12px;margin-top:18px}
    .btn{
      flex:1;padding:12px;font-size:16px;border:none;border-radius:10px;cursor:pointer;
    }
    .btn.primary{background:var(--accent);color:var(--accent-ink)}
    .btn.secondary{background:#ccc}
    @media(prefers-color-scheme:dark){
      .btn.secondary{background:#2a2f36;color:#eee}
    }
    .step{display:none;animation:fade .3s ease}
    .step.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateX(10px)}to{opacity:1;transform:translateX(0)}}
    #progress{margin-bottom:12px;text-align:center;color:var(--muted)}
#progressbar {
  width: 100%;
  height: 6px;
  background: var(--border);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}
#progressbar-fill {
  height: 100%;
  width: 0%;
  background: var(--accent);
  transition: width 0.3s ease;
}
    
    input.error,textarea.error{border:2px solid red!important;background:#ffecec}
  </style>
</head>
<body>
  <h2>â• Ajouter un appareil</h2>
  <div class="card"><div id="progressbar"><div id="progressbar-fill"></div></div>
    <div id="progress">Ã‰tape 1/10</div>
    <form id="formAppareil" novalidate>

      <!-- Ã‰tape 1 -->
      <div class="step active">
        <label>ğŸ‘¤ Demandeur :</label>
        <input id="demandeur" required>
        <div class="btn-row">
          <button type="button" class="btn primary next">Suivant â¡ï¸</button>
        </div>
      </div>

      <!-- Ã‰tape 2 -->
      <div class="step">
        <label>ğŸ“Œ Poste :</label>
        <input id="poste" required>
        <label>ğŸ“Œ Type (optionnel) :</label>
<input id="type" placeholder="Ex : SP, SSP, PRCI....">
        <div class="btn-row">
          <button type="button" class="btn secondary prev">â¬…ï¸ Retour</button>
          <button type="button" class="btn primary next">Suivant â¡ï¸</button>
        </div>
      </div>

      <!-- Ã‰tape 3 -->
      <div class="step">
        <label>ğŸ“Œ SAT :</label>
        <input id="sat" placeholder="Ex : SAT1, SAT2â€¦ (optionnel)">
        <div class="btn-row">
          <button type="button" class="btn secondary prev">â¬…ï¸ Retour</button>
          <button type="button" class="btn primary next">Suivant â¡ï¸</button>
        </div>
      </div>

      <!-- Ã‰tape 4 -->
      <div class="step">
        <label>ğŸ’¡ Nom de lâ€™appareil :</label>
        <input id="appareil" required placeholder="Ex : I7112">
        <div class="btn-row">
          <button type="button" class="btn secondary prev">â¬…ï¸ Retour</button>
          <button type="button" class="btn primary next">Suivant â¡ï¸</button>
        </div>
      </div>

      <!-- Ã‰tape 5 -->
      <div class="step">
      <label>ğŸ“ Comment localiser lâ€™appareil ?</label>
<div class="pill-group">
  <div class="pill" id="pill-oui" data-value="oui">ğŸ“¡ Avec ma position GPS</div>
  <div class="pill" id="pill-non" data-value="non">ğŸ”— Lien Google Maps</div>
</div>
        <input type="hidden" id="presentValue">
        <div class="btn-row">
          <button type="button" class="btn secondary prev">â¬…ï¸ Retour</button>
          <button type="button" class="btn primary next">Suivant â¡ï¸</button>
        </div>
      </div>

      <!-- Ã‰tape 6 -->
      <div class="step">
        <div id="mapDeviceWrap" class="map-wrap" style="display:none">
          <div>DÃ©placez le curseur pour ajuster la position de lâ€™appareil.</div>
          <div id="mapDevice"></div>
          <div class="map-toolbar">
            <button type="button" id="btnRecenterDevice">ğŸ“ Localiser</button>
            <button type="button" id="btnToggleDevice">ğŸ—ºï¸ Plan</button>
          </div>
        </div>
        <div id="coordsDeviceDisplay" style="display:none;color:var(--muted);margin:8px 0"></div>
        <input type="hidden" id="latDevice"><input type="hidden" id="lonDevice">
        <div id="lienField" style="display:none">
          <label>ğŸ”— Lien Google Maps :</label>
          <input id="lien" type="url" placeholder="https://maps.app.goo.gl/â€¦">
        </div>
        <div class="btn-row">
          <button type="button" class="btn secondary prev">â¬…ï¸ Retour</button>
          <button type="button" class="btn primary next">Suivant â¡ï¸</button>
        </div>
      </div>

<!-- Ã‰tape 7 -->
<div class="step">
  <label>ğŸšª Lâ€™appareil a-t-il un accÃ¨s routier distinct ?<br>
  <span style="font-weight:normal;color:var(--muted);font-size:14px">
  Si vous rÃ©pondez Â« Non Â», on considÃ©rera que lâ€™accÃ¨s est le mÃªme que celui du poste indiquÃ© au dÃ©but.
  </span>
  </label>

  <div class="pill-group">
    <div class="pill" id="pill-acces-oui" data-value="oui">âœ… Oui</div>
    <div class="pill" id="pill-acces-non" data-value="non">âŒ Non</div>
  </div>

  <input type="hidden" id="accessValue">

  <div class="btn-row">
    <button type="button" class="btn secondary prev">â¬…ï¸ Retour</button>
    <button type="button" class="btn primary next">Suivant â¡ï¸</button>
  </div>
</div>

      <!-- Ã‰tape 8 -->
      <div class="step">
<div id="mapAccessWrap" class="map-wrap" style="display:none">
  <div>DÃ©placez le curseur pour ajuster la position de lâ€™accÃ¨s.</div>
  <div id="mapAccess"></div>
  <div class="map-toolbar">
    <button type="button" id="btnRecenterAccess">ğŸ“ Localiser</button>
    <button type="button" id="btnToggleAccess">ğŸ—ºï¸ Plan</button>
  </div>
</div>
<div id="coordsAccessDisplay" style="display:none;color:var(--muted);margin:8px 0"></div>

<!-- SÃ©parateur OU -->
<div style="text-align:center;margin:12px 0;font-weight:bold;color:var(--muted)">â€” OU â€”</div>

<!-- Champ lien toujours visible Ã  lâ€™Ã©tape 8 -->
<div id="lienAccessField">
  <label>ğŸ”— Lien Google Maps accÃ¨s :</label>
  <input id="lienAccess" type="url" placeholder="https://maps.app.goo.gl/â€¦">
</div>
        <div class="btn-row">
          <button type="button" class="btn secondary prev">â¬…ï¸ Retour</button>
          <button type="button" class="btn primary next">Suivant â¡ï¸</button>
        </div>
      </div>

      <!-- Ã‰tape 9 -->
      <div class="step">
        <label>ğŸ“ Notes complÃ©mentaires :</label>
        <textarea id="infos" placeholder="AccÃ¨s, portailâ€¦"></textarea>
        <div class="btn-row">
          <button type="button" class="btn secondary prev">â¬…ï¸ Retour</button>
          <button type="button" class="btn primary next">Suivant â¡ï¸</button>
        </div>
      </div>

      <!-- Ã‰tape 10 -->
      <div class="step">
        <p>âœ… VÃ©rifiez vos informations puis envoyez.</p>
        <div class="btn-row">
          <button type="button" class="btn secondary prev">â¬…ï¸ Retour</button>
          <button type="submit" class="btn primary">ğŸ“© Envoyer</button>
        </div>
      </div>
<!-- Ã‰tape confirmation (nâ€™est pas comptÃ©e comme une Ã©tape normale) -->
<div class="step" id="confirmationStep">
  <h3 style="text-align:center;margin:16px 0">âœ… Merci ! Votre demande a bien Ã©tÃ© envoyÃ©e.</h3>
  <div class="btn-row">
    <button type="button" class="btn secondary" onclick="window.location.href='index.html'">ğŸ  Retour Ã  lâ€™accueil</button>
    <button type="button" class="btn primary" onclick="resetForm()">â• Ajouter un autre appareil</button>
  </div>
</div>
    </form>
  </div>

<script>
let currentStep=0;
const steps=document.querySelectorAll(".step");
const progress=document.getElementById("progress");
function showStep(i){
  steps.forEach((s,idx)=>s.classList.toggle("active",idx===i));
  progress.textContent=`Ã‰tape ${i+1}/${steps.length}`;
  document.getElementById("progressbar-fill").style.width = ((i+1)/steps.length*100) + "%";

  // ğŸ”§ Initialisation + redessin des cartes Leaflet
  if(i===5){ // Ã©tape 6 = carte appareil
    if(!mapDevice){
      startLocDevice(); // initialise la carte si pas dÃ©jÃ  fait
    }
    setTimeout(()=>mapDevice && mapDevice.invalidateSize(),300);
  }
  if(i===7){ // Ã©tape 8 = carte accÃ¨s
    if(!mapAccess){
      startLocAccess(); // initialise la carte si pas dÃ©jÃ  fait
    }
    setTimeout(()=>mapAccess && mapAccess.invalidateSize(),300);
  }
}
document.querySelectorAll(".next").forEach(btn=>{
  btn.addEventListener("click", e=>{
    e.preventDefault();
    if(validateStep(currentStep)){
      // ğŸ”§ Cas particulier Ã©tape 7 (index 6 car 0-based)
      if(currentStep === 6){
        if($("accessValue").value === "non"){
          currentStep = 8; // saute directement aux notes (Ã©tape 9)
          showStep(currentStep);
          return;
        }
      }
      currentStep++;
      showStep(currentStep);
    }
  });
});

document.querySelectorAll(".prev").forEach(btn=>{
  btn.addEventListener("click", e=>{
    e.preventDefault();
    if(currentStep>0){
      // ğŸ”§ Cas particulier : retour depuis Ã©tape 9 (index 8) avec accÃ¨s = non
      if(currentStep === 8 && $("accessValue").value === "non"){
        currentStep = 6; // retour direct Ã  lâ€™Ã©tape 7
        showStep(currentStep);
        return;
      }
      currentStep--;
      showStep(currentStep);
    }
  });
});
function validateStep(i){
  const step=steps[i];
  const input=step.querySelector("input[required],textarea[required]");
  if(input && !input.value.trim()){
    input.classList.add("error");
    alert("âš ï¸ Merci de remplir ce champ");
    return false;
  }
  return true;
}

// GPS / lien logique simplifiÃ©e
function $(id){return document.getElementById(id);}
function toggle(el,show){el.style.display=show?"block":"none";}
$("pill-oui").onclick=()=>{
  $("presentValue").value="oui";
  $("pill-oui").classList.add("active");
  $("pill-non").classList.remove("active");
  toggle($("mapDeviceWrap"),1);
  toggle($("lienField"),0);

  // ğŸ‘‡ ajout
  setTimeout(()=>mapDevice && mapDevice.invalidateSize(),300);
};
  
$("pill-non").onclick=()=>{ $("presentValue").value="non";$("pill-non").classList.add("active");$("pill-oui").classList.remove("active");toggle($("mapDeviceWrap"),0);toggle($("lienField"),1);};
$("pill-acces-oui").onclick=()=>{
  $("accessValue").value="oui";
  $("pill-acces-oui").classList.add("active");
  $("pill-acces-non").classList.remove("active");
  toggle($("mapAccessWrap"),1);

  // ğŸ‘‡ ajout
  setTimeout(()=>mapAccess && mapAccess.invalidateSize(),300);
};

$("pill-acces-non").onclick=()=>{
  $("accessValue").value="non";
  $("pill-acces-non").classList.add("active");
  $("pill-acces-oui").classList.remove("active");
  toggle($("mapAccessWrap"),0); // cache la carte
};
// ---------------- LOGIQUE COMPLÃˆTE LEAFLET + ENVOI ----------------

const COUNTER_URL = "https://script.google.com/macros/s/AKfycbwSZ6PEcRuNYb-tyVgNnuStsAQgo_oXkbzuOh41ovRmiZMD30iJfyti6WvqdqMhKfuE/exec";

let mapDevice,mapAccess,markerDevice,markerAccess;
let lastFix=null; let GEO_BLOCKED=false;
const HAZE=[50.72454,2.54311];
const GEO_OPTS={enableHighAccuracy:true,timeout:7000,maximumAge:15000};

function sanitizeCoord(v){return (v||"").toString().replace(",",".");}
function isValidLatLon(lat,lon){
  const la=parseFloat(lat),lo=parseFloat(lon);
  return !isNaN(la)&&!isNaN(lo)&&la>=-90&&la<=90&&lo>=-180&&lo<=180;
}
function isValidUrl(str){return /^https?:\/\/.+/i.test((str||"").trim());}

function setMapTo(map,marker,lat,lon,kind){
  if(!map||!marker)return;
  map.setView([lat,lon],18);
  marker.setLatLng([lat,lon]);
  const la=Number(lat).toFixed(6), lo=Number(lon).toFixed(6);
  if(kind==="device"){
    $("latDevice").value=la; $("lonDevice").value=lo;
    $("coordsDeviceDisplay").textContent=`CoordonnÃ©es relevÃ©es : ${la}, ${lo}`;
    $("coordsDeviceDisplay").style.display="block";
  } else if(kind==="access"){
    $("coordsAccessDisplay").textContent=`CoordonnÃ©es relevÃ©es (accÃ¨s) : ${la}, ${lo}`;
    $("coordsAccessDisplay").style.display="block";
  }
}
function applyFix(lat,lon){
  lastFix={lat,lon,ts:Date.now()};
  if(mapDevice&&markerDevice)setMapTo(mapDevice,markerDevice,lat,lon,"device");
  if(mapAccess&&markerAccess)setMapTo(mapAccess,markerAccess,lat,lon,"access");
}
function onGeoDenied(target){
  GEO_BLOCKED=true;
  if(target==="device"){ $("presentValue").value="non"; toggle($("mapDeviceWrap"),0); toggle($("lienField"),1); }
  if(target==="access"){ $("accessValue").value="non"; toggle($("mapAccessWrap"),0); toggle($("lienAccessField"),1); }
  alert("âš ï¸ La gÃ©olocalisation a Ã©tÃ© refusÃ©e, utilisez un lien Google Maps.");
}
function ensureMap(mapId,btnToggle,btnRecenter,lat,lon){
  let map=L.map(mapId).setView([lat,lon],18);
  setTimeout(()=>map.invalidateSize(),300);
  const esri=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");
  const osm=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
  osm.addTo(map);
  $(btnToggle).textContent = "ğŸ›°ï¸ Satellite"; // par dÃ©faut on propose de passer en satellite
  let marker=L.marker([lat,lon],{draggable:true}).addTo(map);
  marker.on("dragend",()=>{
    let p=marker.getLatLng();
    if(mapId==="mapDevice"){ $("latDevice").value=p.lat.toFixed(6); $("lonDevice").value=p.lng.toFixed(6);
      $("coordsDeviceDisplay").textContent=`CoordonnÃ©es relevÃ©es : ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`; }
    else{ $("coordsAccessDisplay").textContent=`CoordonnÃ©es relevÃ©es (accÃ¨s) : ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`; }
  });
  $(btnToggle).onclick=()=>{
    if(map.hasLayer(osm)){map.removeLayer(osm); esri.addTo(map); $(btnToggle).textContent="ğŸ—ºï¸ Plan";}
    else{map.removeLayer(esri); osm.addTo(map); $(btnToggle).textContent="ğŸ›°ï¸ Satellite";}
    map.invalidateSize();
  };
  $(btnRecenter).onclick=()=>{
    if(GEO_BLOCKED){onGeoDenied(mapId==="mapDevice"?"device":"access");return;}
    if(lastFix){setMapTo(map,marker,lastFix.lat,lastFix.lon,mapId==="mapDevice"?"device":"access");}
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        p=>applyFix(p.coords.latitude,p.coords.longitude),
        err=>{if(err.code===1)onGeoDenied(mapId==="mapDevice"?"device":"access");},
        GEO_OPTS);
    }
  };
  if(mapId==="mapDevice"){mapDevice=map;markerDevice=marker;}
  else{mapAccess=map;markerAccess=marker;}
}
function startLocDevice(){
  if(!mapDevice)ensureMap("mapDevice","btnToggleDevice","btnRecenterDevice",HAZE[0],HAZE[1]);
  if(lastFix)setMapTo(mapDevice,markerDevice,lastFix.lat,lastFix.lon,"device");
}
function startLocAccess(){
  if(!mapAccess)ensureMap("mapAccess","btnToggleAccess","btnRecenterAccess",HAZE[0],HAZE[1]);
  if(lastFix)setMapTo(mapAccess,markerAccess,lastFix.lat,lastFix.lon,"access");
}

// PrÃ©charger position si dispo
document.addEventListener("DOMContentLoaded",()=>{
    // PrÃ©remplir poste si passÃ© en paramÃ¨tre d'URL
  const params = new URLSearchParams(window.location.search);
  if(params.has("poste")){
    $("poste").value = params.get("poste");
  }
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(
      p=>applyFix(p.coords.latitude,p.coords.longitude),
      err=>{if(err.code===1)GEO_BLOCKED=true;},
      GEO_OPTS);
  }
    // Charger Demandeur depuis localStorage
  const savedDemandeur = localStorage.getItem("demandeur");
  if(savedDemandeur){
    $("demandeur").value = savedDemandeur;
  }

  // Sauvegarder Demandeur Ã  chaque modification
$("demandeur").addEventListener("input", ()=>{
  localStorage.setItem("demandeur", $("demandeur").value.trim());
});
  });

  function resetForm(){
  $("formAppareil").reset();
  // remettre les variables et visuels
  currentStep = 0;
  document.getElementById("progress").style.display = "block";
  document.getElementById("progressbar").style.display = "block";
  showStep(currentStep);
}

// Soumission finale
$("formAppareil").onsubmit=e=>{
  e.preventDefault();
  let demandeur=$("demandeur").value.trim();
  let poste=$("poste").value.trim();
  let appareil=$("appareil").value.trim();
  let infos=$("infos").value.trim();
if(!$("presentValue").value){
  alert("âš ï¸ Choisissez une mÃ©thode de localisation de lâ€™appareil (GPS ou lien).");
  return;
}
if(!$("accessValue").value){
  alert("âš ï¸ Indiquez si lâ€™appareil possÃ¨de un accÃ¨s routier distinct (Oui ou Non).");
  return;
}

  let coordAppareil="",coordAcces="";
  if($("presentValue").value==="oui"){
    let la=sanitizeCoord($("latDevice").value), lo=sanitizeCoord($("lonDevice").value);
    if(!isValidLatLon(la,lo)){alert("âš ï¸ CoordonnÃ©es invalides.");return;}
    coordAppareil=la+","+lo;
  } else {
    if(!isValidUrl($("lien").value)){alert("âš ï¸ Lien invalide.");return;}
    coordAppareil=$("lien").value;
  }
if($("accessValue").value==="oui"){
  let accessCoords = $("coordsAccessDisplay").textContent
    .replace("CoordonnÃ©es relevÃ©es (accÃ¨s) : ","").trim();
  let lienAcces = $("lienAccess").value.trim();

  if (isValidUrl(lienAcces)) {
    // Si un lien est fourni â†’ on garde uniquement le lien et on masque les coordonnÃ©es
    coordAcces = lienAcces;
    $("coordsAccessDisplay").style.display = "none";
  } else if (/^[-]?\d+(\.\d+)?,\s*[-]?\d+(\.\d+)?$/.test(accessCoords)) {
    // Sinon on prend les coordonnÃ©es si valides
    coordAcces = accessCoords;
    $("coordsAccessDisplay").style.display = "block";
  } else {
    alert("âš ï¸ Merci dâ€™indiquer soit les coordonnÃ©es GPS, soit un lien Google Maps valide pour lâ€™accÃ¨s.");
    return;
  }
}

  const formData=new URLSearchParams();
  formData.append("demandeur",demandeur);
  formData.append("poste",poste);
  formData.append("type",$("type").value.trim());
  formData.append("sat",$("sat").value.trim());
  formData.append("appareil",appareil);
  formData.append("localisation",coordAppareil);
  formData.append("acces",coordAcces);
  formData.append("notes",infos);

  const submitBtn=document.querySelector('.btn.primary[type="submit"]');
  const oldLabel=submitBtn.textContent;
  submitBtn.disabled=true; submitBtn.textContent="â³ Envoi en coursâ€¦";

  fetch("https://script.google.com/macros/s/AKfycbz8lUhVMKOrRSdeNBeA0p4ZsQCNOesB0Y4DL27KAoHkHWS78hOqrW-t-9bC_azgN-mY/exec",{method:"POST",body:formData})
  .then(r=>r.text())
.then(()=>{
  fetch(COUNTER_URL+"?increment=true").catch(()=>{});
  // masquer tout le formulaire
  steps.forEach(s=>s.classList.remove("active"));
  document.getElementById("confirmationStep").classList.add("active");
  // masquer la barre de progression
  document.getElementById("progress").style.display = "none";
  document.getElementById("progressbar").style.display = "none";
})
  .catch(err=>{alert("âš ï¸ Erreur dâ€™envoi : "+err.message);})
  .finally(()=>{submitBtn.disabled=false;submitBtn.textContent=oldLabel;});
};
showStep(currentStep);
</script>
</body>
</html>
