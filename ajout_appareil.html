<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>‚ûï Ajouter un appareil</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>    
    /* Champs en erreur */
    input.error, textarea.error {
      border: 2px solid red !important;
      background: #ffecec;
    }
    
    .hint {
      font-size: 12px;
      color: #999;
      font-style: italic;
      margin: 2px 0 6px;
    }

    *, *::before, *::after { box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; }

    body {
      margin: 0; padding: 16px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg); color: var(--fg);
    }

    :root{
      --bg:#f7f7f8; --fg:#202124; --card:#fff; --border:#d0d7de;
      --accent:#0b6cff; --accent-ink:#fff; --muted:#666;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0b0b; --fg:#eceff1; --card:#141414; --border:#2a2a2a;
        --accent:#5aa3ff; --accent-ink:#081018; --muted:#999;
      }
    }

    h2 { text-align: center; margin: 0 0 12px; }

    .card {
      max-width: 640px;
      margin: auto;
      background: var(--card);
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,.15);
    }

    label { display: block; margin-top: 12px; font-weight: 600; }

    input, textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      margin-top: 6px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      color: var(--fg);
      min-height: 44px;
    }

    textarea { min-height: 96px; resize: none; overflow: auto; }

    /* Groupe Oui/Non */
    .pill-group{
      display: flex;
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 16px;
    }

    .pill{
      flex: 1;
      text-align: center;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      cursor: pointer;
    }
    .pill.active { background: var(--accent); color: var(--accent-ink); }

    /* Blocs cartes */
    .map-wrap{
      display: none;
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    #mapDevice, #mapAccess { height: 300px; width: 100%; }

    .map-toolbar{
      display: flex;
      gap: 8px;
      padding: 6px;
      background: var(--card);
    }
    .map-toolbar button{
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      cursor: pointer;
    }

    /* Boutons de fin */
    .btn-row { display: flex; gap: 12px; margin-top: 18px; }
    .btn{
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .btn.primary{ background: var(--accent); color: var(--accent-ink); }
    .btn.secondary{ background: #ccc; }
    @media (prefers-color-scheme: dark){
      .btn.secondary{ background: #2a2f36; color: #eee; }
    }

    #coordsDeviceDisplay {
      margin-top: 6px;
      margin-bottom: 18px;
      color: var(--muted);
    }
    #coordsDeviceText { font-family: monospace; }

    /* Espace apr√®s les blocs conditionnels (cartes, coordonn√©es, liens) */
    .map-wrap,
    #lienField,
    #lienAccessField {
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <h2>‚ûï Ajouter un appareil</h2>

  <div class="card">
    <form id="formAppareil" novalidate>
      <label>üë§ Demandeur : </label>
      <input id="demandeur" required>

      <label>üìå Poste : </label>
      <input id="poste">

      <label>üìå SAT :</label>
      <input id="sat" placeholder="Ex : SAT1, SAT2‚Ä¶ (optionnel)">

      <label>üí° Nom de l‚Äôappareil : </label>
      <input id="appareil" placeholder="Ex : I7112" required>

      <label>üìç Localiser l'appareil via GPS ? </label>
      <div class="pill-group">
        <div class="pill" id="pill-oui" data-value="oui">Oui</div>
        <div class="pill" id="pill-non" data-value="non">Non</div>
      </div>
      <input type="hidden" id="presentValue">

      <!-- Carte si oui -->
      <div class="map-wrap" id="mapDeviceWrap">
        <div class="hint">D√©placez le curseur pour ajuster la position de l‚Äôappareil.</div>
        <div id="mapDevice"></div>
        <div class="map-toolbar">
          <button type="button" id="btnRecenterDevice">üìç Localiser</button>
          <button type="button" id="btnToggleDevice">üó∫Ô∏è Plan</button>
        </div>
      </div>

      <div id="coordsDeviceDisplay" class="hint" style="display:none; font-family: monospace; font-size: 12px;">
        Coordonn√©es relev√©es : <span id="coordsDeviceText">‚Äî</span>
      </div>
      <input type="hidden" id="latDevice">
      <input type="hidden" id="lonDevice">

      <!-- Lien si non -->
      <div id="lienField" style="display:none;">
        <label>üîó Fournir manuellement le lien Google Maps :</label>
        <input id="lien" type="url" placeholder="https://maps.app.goo.gl/‚Ä¶">
      </div>

      <!-- Acc√®s sp√©cifique -->
      <label>üìç L‚Äôappareil a un acc√®s distinct ?</label>
      <div class="pill-group">
        <div class="pill" id="pill-acces-oui" data-value="oui">Oui</div>
        <div class="pill" id="pill-acces-non" data-value="non">Non</div>
      </div>
      <input type="hidden" id="accessValue">

      <div class="map-wrap" id="mapAccessWrap">
        <div class="hint">D√©placez le curseur pour ajuster la position de l‚Äôacc√®s.</div>
        <div id="mapAccess"></div>
        <div class="map-toolbar">
          <button type="button" id="btnRecenterAccess">üìç Localiser</button>
          <button type="button" id="btnToggleAccess">üó∫Ô∏è Plan</button>
        </div>
      </div>

      <div id="coordsAccessDisplay" class="hint" style="display:none; font-family: monospace; font-size: 12px; margin-bottom: 18px;">
        Coordonn√©es relev√©es (acc√®s) : <span id="coordsAccessText">‚Äî</span>
      </div>

      <div id="lienAccessField" style="display:none;">
        <label>Ou ajouter le lien Google Maps de l‚Äôacc√®s (optionnel)</label>
        <input id="lienAccess" type="url" placeholder="https://maps.app.goo.gl/‚Ä¶">
        <div class="hint">Localisation auto (lat/long) ou lien Google Maps</div>
      </div>

      <label>üìù Notes compl√©mentaires</label>
      <textarea id="infos" placeholder="Indiquez un rep√®re ou une info utile (acc√®s, portail, etc.)"></textarea>

      <div class="btn-row">
        <button type="submit" class="btn primary">üì© Envoyer </button>
        <button type="button" class="btn secondary" onclick="location.href='index.html'">‚¨ÖÔ∏è Retour </button>
      </div>
    </form>
  </div>

  <script>
    const DEST_EMAIL = "arnaud.debaecker@sncf.fr";

    // Pr√©remplir uniquement selon l'origine (poste OU appareil)
    (function prefillFromURL(){
      const $ = (id)=>document.getElementById(id);
      const params   = new URLSearchParams(location.search);
      const appareil = params.get("appareil");
      const poste    = params.get("poste");

      if (poste) {
        $("poste").value = poste;
        try { localStorage.setItem("poste_selectionne", poste); } catch(e){}
      }
      else if (appareil) {
        $("appareil").value = appareil;
        try { localStorage.removeItem("poste_selectionne"); } catch(e){}
      }
      else {
        try {
          const cached = localStorage.getItem("poste_selectionne");
          if (cached) $("poste").value = cached;
        } catch(e){}
      }

      if (appareil) $("appareil").value = appareil;
    })();

    // --- Pr√©remplissage du nom du demandeur ---
    (function prefillName() {
      const savedName = localStorage.getItem("nom_demandeur");
      if (savedName) {
        document.getElementById("demandeur").value = savedName;
      }
    })();

    const COUNTER_URL = "https://script.google.com/macros/s/AKfycbwSZ6PEcRuNYb-tyVgNnuStsAQgo_oXkbzuOh41ovRmiZMD30iJfyti6WvqdqMhKfuE/exec";

    let mapDevice, mapAccess, markerDevice, markerAccess;

    function $(id){return document.getElementById(id);}
    function toggle(el,show){el.style.display=show?"block":"none";}

    // --- Fonctions utilitaires d'affichage --- //
    function showDeviceGPS(){
      toggle($("mapDeviceWrap"),1);
      toggle($("coordsDeviceDisplay"),1);
      toggle($("lienField"),0);
    }

    function showDeviceLink(){
      toggle($("mapDeviceWrap"),0);
      toggle($("coordsDeviceDisplay"),0);
      toggle($("lienField"),1);
    }

    function showAccessGPS(){
      toggle($("mapAccessWrap"),1);
      toggle($("coordsAccessDisplay"),1);
      toggle($("lienAccessField"),0);
    }

    function showAccessLink(){
      toggle($("mapAccessWrap"),0);
      toggle($("coordsAccessDisplay"),0);
      toggle($("lienAccessField"),1);
    }

    function sanitizeCoord(v){return (v||"").toString().replace(",",".");}
    function isValidLatLon(lat,lon){
      const la=parseFloat(lat),lo=parseFloat(lon);
      return !isNaN(la)&&!isNaN(lo)&&la>=-90&&la<=90&&lo>=-180&&lo<=180;
    }
    function isValidUrl(str){return /^https?:\/\/.+/i.test((str||"").trim());}

    // ‚ñº‚ñº‚ñº Localisation ‚ñº‚ñº‚ñº
    const HAZE = [50.72454, 2.54311];
    let lastFix = null;
    let GEO_BLOCKED = false;
    const GEO_OPTS = { enableHighAccuracy: true, timeout: 7000, maximumAge: 15000 };

    function setMapTo(map, marker, lat, lon, kind){
      if(!map || !marker) return;
      map.setView([lat, lon], 18);
      marker.setLatLng([lat, lon]);

      if (kind === "device") {
        const la = Number(lat).toFixed(6), lo = Number(lon).toFixed(6);
        $("latDevice").value = la;
        $("lonDevice").value = lo;
        $("coordsDeviceText").textContent = `${la}, ${lo}`;
        $("coordsDeviceDisplay").style.display = "block";
      }
      else if (kind === "access"){ 
        const la = Number(lat).toFixed(6), lo = Number(lon).toFixed(6);
        $("coordsAccessText").textContent = `${la}, ${lo}`;
        $("coordsAccessDisplay").style.display = "block";
      }
    } // üîß ferme correctement setMapTo

    function applyFix(lat, lon){
      lastFix = { lat, lon, ts: Date.now() };
      if(mapDevice && markerDevice) setMapTo(mapDevice, markerDevice, lat, lon, "device");
      if(mapAccess && markerAccess) setMapTo(mapAccess, markerAccess, lat, lon, "access");
    }

    function onGeoDenied(target){
      GEO_BLOCKED = true;
      if(target === "device"){
        $("presentValue").value = "non";
        $("pill-oui").classList.remove("active");
        $("pill-non").classList.add("active");
        showDeviceLink();
        alert("La g√©olocalisation est refus√©e. Renseignez un lien Google Maps.");
      } else if(target === "access"){
        $("accessValue").value = "non";
        $("pill-acces-oui").classList.remove("active");
        $("pill-acces-non").classList.add("active");
        showAccessLink();
        alert("La g√©olocalisation est refus√©e. Renseignez un lien Google Maps pour l‚Äôacc√®s.");
      }
    }

    // Pr√©-r√©cup√©ration de la position au chargement
    document.addEventListener("DOMContentLoaded", () => {
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          p => applyFix(p.coords.latitude, p.coords.longitude),
          err => { if(err && err.code === 1) { GEO_BLOCKED = true; } },
          GEO_OPTS
        );
      }
    });

    // Pills appareil
    $("pill-oui").onclick = () => setPill("oui");
    $("pill-non").onclick = () => setPill("non");

    function setPill(v){
      $("presentValue").value = v;
      $("pill-oui").classList.toggle("active", v === "oui");
      $("pill-non").classList.toggle("active", v === "non");

      if (v === "oui") {
        if (GEO_BLOCKED) { onGeoDenied("device"); return; }
        showDeviceGPS();
        startLocDevice();
        requestAnimationFrame(() => mapDevice && mapDevice.invalidateSize());
      } else {
        showDeviceLink();
      }
    }

    // Pills acc√®s
    $("pill-acces-oui").onclick = () => setAccess("oui");
    $("pill-acces-non").onclick = () => setAccess("non");

    function setAccess(v){
      $("accessValue").value = v;
      $("pill-acces-oui").classList.toggle("active", v === "oui");
      $("pill-acces-non").classList.toggle("active", v === "non");

      if (v === "oui") {
        if (GEO_BLOCKED) { onGeoDenied("access"); return; }
        showAccessGPS();
        startLocAccess();
        requestAnimationFrame(() => mapAccess && mapAccess.invalidateSize());
      } else {
        showAccessLink();
      }
    }

    // Maps
    function ensureMap(mapId,btnToggle,btnRecenter,lat,lon){
      let map,marker;
      map = L.map(mapId).setView([lat, lon], 18);
      setTimeout(() => map.invalidateSize(), 300);

      const esri = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");
      const osm  = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");

      // Par d√©faut on d√©marre en OSM (plan)
      osm.addTo(map);

      let isSat = false;
      $(btnToggle).textContent = "üõ∞Ô∏è Satellite";

      const startLat = (lastFix ? lastFix.lat : lat);
      const startLon = (lastFix ? lastFix.lon : lon);
      marker = L.marker([startLat,startLon],{draggable:true}).addTo(map);

      marker.on("dragend",()=>{
        let p=marker.getLatLng();
        if(mapId==="mapDevice"){
          $("latDevice").value = p.lat.toFixed(6);
          $("lonDevice").value = p.lng.toFixed(6);
          $("coordsDeviceText").textContent = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
          $("coordsDeviceDisplay").style.display = "block";
        } else {
          $("coordsAccessText").textContent = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
          $("coordsAccessDisplay").style.display = "block";
        }
      });

      $(btnToggle).onclick = () => {
        isSat = !isSat;
        if (isSat) {
          if (map.hasLayer(osm)) map.removeLayer(osm);
          esri.addTo(map);
          $(btnToggle).textContent = "üó∫Ô∏è Plan";
        } else {
          if (map.hasLayer(esri)) map.removeLayer(esri);
          osm.addTo(map);
          $(btnToggle).textContent = "üõ∞Ô∏è Satellite";
        }
        requestAnimationFrame(() => map.invalidateSize());
      };

      $(btnRecenter).onclick=()=>{
        if(GEO_BLOCKED){
          const target = (mapId === "mapDevice") ? "device" : "access";
          onGeoDenied(target);
          return;
        }
        if (lastFix){
          const isDevice = (mapId === "mapDevice");
          const mapRef    = isDevice ? mapDevice   : mapAccess;
          const markerRef = isDevice ? markerDevice: markerAccess;
          const kind      = isDevice ? "device"    : "access";
          setMapTo(mapRef, markerRef, lastFix.lat, lastFix.lon, kind);
        }
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(
            p => applyFix(p.coords.latitude,p.coords.longitude),
            err => { if(err && err.code === 1){ const t=(mapId==="mapDevice")?"device":"access"; onGeoDenied(t); } },
            GEO_OPTS
          );
        }
      };

      if(mapId==="mapDevice"){ mapDevice=map; markerDevice=marker; }
      else{ mapAccess=map; markerAccess=marker; }
    }

    function startLocDevice(){
      if(GEO_BLOCKED){ onGeoDenied("device"); return; }
      if(!mapDevice){
        ensureMap("mapDevice","btnToggleDevice","btnRecenterDevice",HAZE[0],HAZE[1]);
      }
      if(lastFix) setMapTo(mapDevice, markerDevice, lastFix.lat, lastFix.lon, "device");
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          p=>applyFix(p.coords.latitude,p.coords.longitude),
          err=>{ if(err && err.code===1) onGeoDenied("device"); },
          GEO_OPTS
        );
      }
    }
    
    function startLocAccess(){
      if(GEO_BLOCKED){ onGeoDenied("access"); return; }
      if(!mapAccess){
        ensureMap("mapAccess","btnToggleAccess","btnRecenterAccess",HAZE[0],HAZE[1]);
      }
      if(lastFix) setMapTo(mapAccess, markerAccess, lastFix.lat, lastFix.lon, "access");
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(
          p=>applyFix(p.coords.latitude,p.coords.longitude),
          err=>{ if(err && err.code===1) onGeoDenied("access"); },
          GEO_OPTS
        );
      }
    }

    // Remise √† z√©ro compl√®te des choix Oui/Non et des blocs conditionnels
    function resetConditionnels(){
      $("presentValue").value = "";
      $("accessValue").value  = "";

      ["pill-oui","pill-non","pill-acces-oui","pill-acces-non"]
        .forEach(id => $(id).classList.remove("active"));

      showDeviceLink();
      showAccessLink();
    }

    // Submit (validations harmonis√©es)
    $("formAppareil").onsubmit=e=>{
      e.preventDefault();
      let demandeur=$("demandeur").value.trim();
      if (demandeur) {
        localStorage.setItem("nom_demandeur", demandeur);
      }
      let poste=$("poste").value.trim();
      let appareil=$("appareil").value.trim();
      let infos=$("infos").value.trim();

      ["demandeur","poste","appareil"].forEach(id => $(id).classList.remove("error"));

      let missing = [];
      if (!demandeur) { missing.push("Demandeur"); $("demandeur").classList.add("error"); }
      if (!poste)     { missing.push("Poste"); $("poste").classList.add("error"); }
      if (!appareil)  { missing.push("Nom de l‚Äôappareil"); $("appareil").classList.add("error"); }

      if (missing.length > 0) {
        alert("‚ö†Ô∏è Merci de renseigner tous les champs obligatoires :\n" + missing.join(" / "));
        requestAnimationFrame(() => {
          const premierChamp = document.querySelector("input.error, textarea.error");
          if (premierChamp) {
            premierChamp.focus({ preventScroll: true });
            premierChamp.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        });
        return;
      }

      // Q1 obligatoire : g√©olocaliser OU fournir un lien
      if(!$("presentValue").value){
        alert("‚ö†Ô∏è Merci d‚Äôindiquer si vous souhaitez g√©olocaliser l‚Äôappareil ou fournir un lien.");
        requestAnimationFrame(() => $("pill-oui")?.focus());
        return;
      }

      // Q2 obligatoire : acc√®s sp√©cifique Oui / Non
      if(!$("accessValue").value){
        alert("‚ö†Ô∏è Merci d‚Äôindiquer si l‚Äôappareil a son propre acc√®s (Oui / Non).");
        requestAnimationFrame(() => $("pill-acces-oui")?.focus());
        return;
      }

      let coordAppareil="",coordAcces="";
      if($("presentValue").value==="oui"){
        let la = sanitizeCoord($("latDevice").value);
        let lo = sanitizeCoord($("lonDevice").value);
        if(!isValidLatLon(la,lo)){
          alert("‚ö†Ô∏è Les coordonn√©es GPS de l‚Äôappareil ne sont pas valides.");
          return;
        }
        coordAppareil = la+","+lo;
      } else if($("presentValue").value==="non"){
        if(!isValidUrl($("lien").value)){alert("‚ö†Ô∏è Merci de fournir un lien valide.");return;}
        coordAppareil=$("lien").value;
      }

      if($("accessValue").value==="oui"){
        let accessCoords = $("coordsAccessText").textContent.trim();
        let lienAcces = $("lienAccess").value.trim();

        if (/^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/.test(accessCoords)) {
          coordAcces = accessCoords;
        } else if (isValidUrl(lienAcces)) {
          coordAcces = lienAcces;
        } else {
          alert("‚ö†Ô∏è Merci de renseigner soit les coordonn√©es GPS de l‚Äôacc√®s, soit un lien Google Maps valide.");
          return;
        }
      }

      const subject = `Contribution : ajout d‚Äôun appareil au poste de ${poste}`;

      const bodyText =
`Bonjour Arnaud,

${demandeur} propose l‚Äôajout de l‚Äôappareil suivant :

Poste : ${poste}
SAT : ${$("sat").value.trim()}
Appareil : ${appareil}
Localisation : ${coordAppareil}
${coordAcces ? `Acc√®s sp√©cifique : ${coordAcces}\n` : ""}Notes : ${infos}

Cordialement,
${demandeur}`;

         // üîÑ Envoi vers Google Sheets
      alert("‚è≥ Envoi en cours‚Ä¶");

fetch("https://script.google.com/macros/s/AKfycbz8lUhVMKOrRSdeNBeA0p4ZsQCNOesB0Y4DL27KAoHkHWS78hOqrW-t-9bC_azgN-mY/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        demandeur: demandeur,
        poste: poste,
        sat: $("sat").value.trim(),
        appareil: appareil,
        localisation: coordAppareil,
        acces: coordAcces,
        notes: infos
      })
})
.then(res => {
  console.log("üëâ Status HTTP :", res.status);
  return res.text();
})
.then((txt) => {
  console.log("üëâ R√©ponse brute du script :", txt);
  alert("‚úÖ R√©ponse re√ßue du serveur !");
})
.catch((err) => {
  console.error("üëâ Erreur attrap√©e :", err);
  alert("‚ö†Ô∏è Erreur attrap√©e : " + err.message);
});
  // Incr√©ment compteur contributions
  fetch(COUNTER_URL+"?increment=true").catch(()=>{});

  alert("‚úÖ Merci ! Votre demande a bien √©t√© envoy√©e. L‚Äôappareil sera ajout√© dans un d√©lai maximum de 48h.");

        // Sauvegarde le nom avant reset
        const savedName = demandeur;

        // Reset complet du formulaire
        $("formAppareil").reset();
        resetConditionnels();

        // R√©injecte le nom sauvegard√©
        if (savedName) {
          $("demandeur").value = savedName;
        }
        
      })
      .catch((err) => {
        alert("‚ö†Ô∏è Erreur d‚Äôenvoi : " + (err && err.message ? err.message : "r√©seau/serveur"));
      });
      
    };

    // Supprimer automatiquement le rouge quand on corrige un champ
    document.addEventListener("DOMContentLoaded", () => {
      ["demandeur","poste","appareil","lien","lienAccess","infos"]
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("input", () => el.classList.remove("error"));
        });
    });
  </script>
</body>
</html>
