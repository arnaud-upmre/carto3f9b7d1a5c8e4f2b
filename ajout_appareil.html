<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>‚ûï Ajouter un appareil ‚Äî VForm 2025-09-01</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html{-webkit-text-size-adjust:100%}
    body{
      margin:0; padding:16px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:var(--fg);
    }
    :root{
      --bg:#f7f7f8; --fg:#202124; --card:#fff; --border:#d0d7de;
      --accent:#0b6cff; --accent-ink:#fff; --muted:#666;
    }
    @media(prefers-color-scheme:dark){
      :root{
        --bg:#0b0b0b; --fg:#eceff1; --card:#141414; --border:#2a2a2a;
        --accent:#5aa3ff; --accent-ink:#081018; --muted:#999;
      }
    }
    h2{text-align:center;margin:0 0 12px}
    .card{max-width:640px;margin:auto;background:var(--card);padding:16px;
      border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    label{display:block;margin-top:12px;font-weight:600}
    input,textarea{
      width:100%;padding:12px;font-size:16px;margin-top:6px;
      border:1px solid var(--border);border-radius:10px;
      background:var(--card);color:var(--fg);min-height:44px
    }
    textarea{min-height:96px;resize:none;overflow:auto}
    .pill-group{display:flex;gap:10px;margin-top:8px}
    .pill{flex:1;text-align:center;padding:12px;border:1px solid var(--border);
      border-radius:999px;cursor:pointer}
    .pill.active{background:var(--accent);color:var(--accent-ink)}
    .map-wrap{display:none;margin-top:12px;border:1px solid var(--border);
      border-radius:10px;overflow:hidden}
    #mapDevice,#mapAccess{height:300px;width:100%}
    .map-toolbar{display:flex;gap:8px;padding:6px;background:var(--card)}
    .map-toolbar button{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);cursor:pointer}
    .btn-row{display:flex;gap:12px;margin-top:18px}
    .btn{flex:1;padding:12px;font-size:16px;border:none;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-ink)}
    .btn.secondary{background:#ccc}
    @media(prefers-color-scheme:dark){.btn.secondary{background:#2a2f36;color:#eee}}
  </style>
</head>
<body>
  <h2>‚ûï Ajouter un appareil</h2>

  <div class="card">
    <form id="formAppareil">
      <label>Demandeur</label>
      <input id="demandeur" required>

      <label>Poste (li√©)</label>
      <input id="poste" value="Alleux SP" readonly>

      <label>Nom de l‚Äôappareil</label>
      <input id="appareil" placeholder="Ex : I7112" required>

      <label>√ätes-vous devant l‚Äôappareil ?</label>
      <div class="pill-group">
        <div class="pill" id="pill-oui" data-value="oui">Oui</div>
        <div class="pill" id="pill-non" data-value="non">Non</div>
      </div>
      <input type="hidden" id="presentValue">

      <!-- Carte si oui -->
      <div class="map-wrap" id="mapDeviceWrap">
        <div id="mapDevice"></div>
        <div class="map-toolbar">
          <button type="button" id="btnRecenterDevice">üìç Recentrer</button>
          <button type="button" id="btnToggleDevice">üó∫Ô∏è Plan</button>
        </div>
      </div>
      <div id="coordsDevice" style="display:none;">
        <label>Latitude</label>
        <input id="latDevice">
        <label>Longitude</label>
        <input id="lonDevice">
      </div>

      <!-- Lien si non -->
      <div id="lienField" style="display:none;">
        <label>Lien Google Maps</label>
        <input id="lien" type="url" placeholder="https://maps.app.goo.gl/‚Ä¶">
      </div>

      <!-- Acc√®s sp√©cifique -->
      <label>Y a-t-il un acc√®s sp√©cifique ?</label>
      <div class="pill-group">
        <div class="pill" id="pill-acces-non" data-value="non">Non</div>
        <div class="pill" id="pill-acces-oui" data-value="oui">Oui</div>
      </div>
      <input type="hidden" id="accessValue">

      <div class="map-wrap" id="mapAccessWrap">
        <div id="mapAccess"></div>
        <div class="map-toolbar">
          <button type="button" id="btnRecenterAccess">üìç Recentrer</button>
          <button type="button" id="btnToggleAccess">üó∫Ô∏è Plan</button>
        </div>
      </div>
      <div id="coordsAccess" style="display:none;">
        <label>Latitude acc√®s</label>
        <input id="latAccess">
        <label>Longitude acc√®s</label>
        <input id="lonAccess">
      </div>

      <label>Infos utiles</label>
      <textarea id="infos" placeholder="Notes utiles : rep√®re visuel, consignes‚Ä¶"></textarea>

      <div class="btn-row">
        <button type="submit" class="btn primary">üì© Envoyer</button>
        <button type="button" class="btn secondary" onclick="location.href='index.html'">‚¨ÖÔ∏è Accueil</button>
      </div>
    </form>
  </div>

  <script>
    const DEST_EMAIL = "arnaud.debaecker@sncf.fr";
    const COUNTER_URL = "https://script.google.com/macros/s/AKfycbwSZ6PEcRuNYb-tyVgNnuStsAQgo_oXkbzuOh41ovRmiZMD30iJfyti6WvqdqMhKfuE/exec";

    let mapDevice,mapAccess,markerDevice,markerAccess,esri,osm,sat=true;

    function $(id){return document.getElementById(id);}
    function toggle(el,show){el.style.display=show?"block":"none";}
    function sanitizeCoord(v){return v.replace(",",".");}
    function isValidLatLon(lat,lon){
      const la=parseFloat(lat),lo=parseFloat(lon);
      return !isNaN(la)&&!isNaN(lo)&&la>=-90&&la<=90&&lo>=-180&&lo<=180;
    }
    function isValidUrl(str){return /^https?:\/\/.+/i.test(str);}

    // Pills appareil
    $("pill-oui").onclick=()=>setPill("oui");
    $("pill-non").onclick=()=>setPill("non");
    function setPill(v){
      $("presentValue").value=v;
      $("pill-oui").classList.toggle("active",v==="oui");
      $("pill-non").classList.toggle("active",v==="non");
      if(v==="oui"){toggle($("mapDeviceWrap"),1);toggle($("coordsDevice"),1);toggle($("lienField"),0);startLocDevice();}
      else{toggle($("mapDeviceWrap"),0);toggle($("coordsDevice"),0);toggle($("lienField"),1);}
    }

    // Pills acc√®s
    $("pill-acces-oui").onclick=()=>setAccess("oui");
    $("pill-acces-non").onclick=()=>setAccess("non");
    function setAccess(v){
      $("accessValue").value=v;
      $("pill-acces-oui").classList.toggle("active",v==="oui");
      $("pill-acces-non").classList.toggle("active",v==="non");
      if(v==="oui"){toggle($("mapAccessWrap"),1);toggle($("coordsAccess"),1);startLocAccess();}
      else{toggle($("mapAccessWrap"),0);toggle($("coordsAccess"),0);}
    }

    // Maps
    function ensureMap(mapId,btnToggle,btnRecenter,lat,lon){
      let map,marker;
      map=L.map(mapId).setView([lat,lon],18);
      esri=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}").addTo(map);
      osm=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png");
      marker=L.marker([lat,lon],{draggable:true}).addTo(map);
      marker.on("dragend",()=>{let p=marker.getLatLng();if(mapId==="mapDevice"){$("latDevice").value=p.lat;$("lonDevice").value=p.lng;}else{$("latAccess").value=p.lat;$("lonAccess").value=p.lng;}});
      $(btnToggle).onclick=()=>{sat=!sat;if(sat){map.removeLayer(osm);esri.addTo(map);$(btnToggle).textContent="üó∫Ô∏è Plan";}else{map.removeLayer(esri);osm.addTo(map);$(btnToggle).textContent="üõ∞Ô∏è Satellite";}};
      $(btnRecenter).onclick=()=>{if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>{map.setView([p.coords.latitude,p.coords.longitude],18);marker.setLatLng([p.coords.latitude,p.coords.longitude]);if(mapId==="mapDevice"){$("latDevice").value=p.coords.latitude;$("lonDevice").value=p.coords.longitude;}else{$("latAccess").value=p.coords.latitude;$("lonAccess").value=p.coords.longitude;}})};
      if(mapId==="mapDevice"){mapDevice=map;markerDevice=marker;}else{mapAccess=map;markerAccess=marker;}
    }
    function startLocDevice(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>{if(!mapDevice)ensureMap("mapDevice","btnToggleDevice","btnRecenterDevice",p.coords.latitude,p.coords.longitude);});}
    function startLocAccess(){if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>{if(!mapAccess)ensureMap("mapAccess","btnToggleAccess","btnRecenterAccess",p.coords.latitude,p.coords.longitude);});}

    // Submit
    $("formAppareil").onsubmit=e=>{
      e.preventDefault();
      let demandeur=$("demandeur").value.trim();
      let poste=$("poste").value.trim();
      let appareil=$("appareil").value.trim();
      let infos=$("infos").value.trim();
      if(!demandeur||!poste||!appareil){alert("Merci de remplir tous les champs obligatoires.");return;}

      let coordAppareil="",coordAcces="";
      if($("presentValue").value==="oui"){
        let la=sanitizeCoord($("latDevice").value),lo=sanitizeCoord($("lonDevice").value);
        if(!isValidLatLon(la,lo)){alert("Coordonn√©es appareil invalides.");return;}
        coordAppareil=la+","+lo;
      }else if($("presentValue").value==="non"){
        if(!isValidUrl($("lien").value)){alert("Merci de fournir un lien valide.");return;}
        coordAppareil=$("lien").value;
      }else{alert("Merci d‚Äôindiquer si vous √™tes devant l‚Äôappareil.");return;}

      if($("accessValue").value==="oui"){
        let la=sanitizeCoord($("latAccess").value),lo=sanitizeCoord($("lonAccess").value);
        if(!isValidLatLon(la,lo)){alert("Coordonn√©es acc√®s invalides.");return;}
        coordAcces=la+","+lo;
      }

      let subject=`Ajout d'un appareil au poste de : ${poste}`;
      let body=`Bonjour Arnaud,%0D%0A%0D%0A${demandeur} souhaite ajouter l'appareil suivant :%0D%0A%0D%0A`
        +`Poste : ${poste}%0D%0A`
        +`Appareil : ${appareil}%0D%0A`
        +`Coordonn√©es de l‚Äôappareil : ${coordAppareil}%0D%0A`
        +(coordAcces?`Acc√®s sp√©cifique : ${coordAcces}%0D%0A`:"")
        +`Infos utiles : ${infos}`;

      // Envoi mail
      location.href=`mailto:${DEST_EMAIL}?subject=${encodeURIComponent(subject)}&body=${body}`;

      // Incr√©ment compteur contributions
      fetch(COUNTER_URL+"?increment=true").catch(()=>{});

      alert("Merci ! Votre contribution a √©t√© transmise.");
      $("formAppareil").reset();
      setPill("");setAccess("");
    };
  </script>
</body>
</html>
