<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>‚ûï Ajouter un appareil</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <style>
    :root{
      --bg:#f7f7f8; --fg:#202124; --card:#fff; --muted:#6a6f76;
      --border:#d0d7de; --accent:#0b6cff; --accent-ink:#fff;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0b0b; --fg:#eceff1; --card:#141414; --muted:#9aa0a6;
        --border:#2a2a2a; --accent:#5aa3ff; --accent-ink:#081018;
      }
    }
    body{font-family:Inter,system-ui;background:var(--bg);color:var(--fg);margin:0;padding:16px}
    h2{text-align:center;margin-bottom:12px}
    .card{max-width:640px;margin:auto;background:var(--card);padding:16px;border-radius:14px;box-shadow:0 2px 6px rgba(0,0,0,.15)}
    label{display:block;margin-top:12px;font-weight:600}
    input,textarea{
      width:100%;padding:10px;font-size:16px;margin-top:6px;
      border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--fg)
    }
    textarea{resize:vertical;min-height:72px}
    .pill-group{display:flex;gap:10px;margin-top:8px}
    .pill{flex:1;text-align:center;padding:10px;border:1px solid var(--border);border-radius:999px;cursor:pointer}
    .pill.active{background:var(--accent);color:var(--accent-ink);border-color:var(--accent)}
    #map{height:40vh;min-height:260px}
    .map-wrap{display:none;margin-top:12px;border-radius:10px;overflow:hidden;border:1px solid var(--border)}
    .map-toolbar{display:flex;gap:8px;padding:6px;background:var(--card)}
    .map-toolbar button{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);cursor:pointer}
    .btn-row{display:flex;gap:12px;margin-top:18px}
    .btn{flex:1;padding:12px;font-size:16px;border:none;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:var(--accent-ink)}
    .btn.secondary{background:#ccc}
    @media(prefers-color-scheme:dark){.btn.secondary{background:#2a2f36;color:#eee}}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:1000;padding:16px}
    .dialog{background:var(--card);padding:16px;border-radius:12px;max-width:600px;width:100%}
    .dialog h3{margin-top:0}
    .list{margin:10px 0;padding:0;list-style:none}
    .list li{border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;background:var(--card)}
    .list strong{display:block}
    .actions{display:flex;gap:6px;margin-top:6px}
    .actions button{flex:1;padding:6px;font-size:14px;border-radius:8px;border:none;cursor:pointer}
    .actions .edit{background:#ffd54f}
    .actions .del{background:#ef5350;color:#fff}
  </style>
</head>
<body>
  <h2>‚ûï Ajouter un appareil</h2>

  <div class="card">
    <form id="formAppareil">
      <label>Demandeur</label>
      <input id="demandeur" required>

      <label>Poste (li√©)</label>
      <input id="poste" value="Alleux SP" readonly>

      <label>Nom de l‚Äôappareil</label>
      <input id="appareil" placeholder="Ex : I7112" required>

      <label>√ätes-vous devant l‚Äôappareil ?</label>
      <div class="pill-group">
        <div class="pill" id="pill-oui" data-value="oui">Oui</div>
        <div class="pill" id="pill-non" data-value="non">Non</div>
      </div>
      <input type="hidden" id="presentValue">

      <div class="map-wrap" id="mapWrap">
        <div id="map"></div>
        <div class="map-toolbar">
          <button type="button" id="btnRecenter">üìç Recentrer</button>
          <button type="button" id="btnToggle">üó∫Ô∏è Plan</button>
        </div>
      </div>

      <div id="coordsFields" style="display:none;">
        <label>Latitude</label>
        <input id="lat">
        <label>Longitude</label>
        <input id="lon">
      </div>

      <div id="lienField" style="display:none;">
        <label>Lien Google Maps</label>
        <input id="lien" type="url" placeholder="https://maps.app.goo.gl/‚Ä¶">
      </div>

      <label>Infos libres</label>
      <textarea id="infos" placeholder="Notes utiles : lien Google Maps, acc√®s, rep√®re visuel‚Ä¶"></textarea>

      <div class="btn-row">
        <button type="submit" class="btn primary">üì© Envoyer</button>
        <button type="button" class="btn secondary" onclick="location.href='index.html'">‚¨ÖÔ∏è Accueil</button>
      </div>
    </form>
  </div>

  <!-- Recap -->
  <div class="overlay" id="ovrRecap">
    <div class="dialog">
      <h3>R√©capitulatif</h3>
      <ul class="list" id="listRecap"></ul>
      <div class="btn-row">
        <button id="btnAddMore" class="btn secondary">‚ûï Ajouter un autre</button>
        <button id="btnFinish" class="btn primary">Terminer</button>
      </div>
    </div>
  </div>

  <!-- Choix envoi -->
  <div class="overlay" id="ovrFinal">
    <div class="dialog">
      <h3>Envoi final</h3>
      <p>Choisis le mode d‚Äôenvoi :</p>
      <div class="btn-row">
        <button id="btnMail" class="btn secondary">‚úâÔ∏è E-mail</button>
        <button id="btnServer" class="btn primary">üöÄ Serveur</button>
      </div>
    </div>
  </div>

  <!-- Merci -->
  <div class="overlay" id="ovrThanks">
    <div class="dialog">
      <h3>‚úÖ Merci</h3>
      <p>Vos contributions seront trait√©es sous 48h (jours ouvr√©s).</p>
      <div class="btn-row">
        <button class="btn primary" onclick="location.href='index.html'">‚¨ÖÔ∏è Accueil</button>
      </div>
    </div>
  </div>

  <script>
    const DEST_EMAIL = "arnaud.debaecker@sncf.fr";
    const SERVER_URL = "YOUR_APPS_SCRIPT_URL";

    let map, marker, esri, osm, sat=true;
    let contributions = [];
    let editIndex = null;

    function $(id){return document.getElementById(id);}
    function toggle(el,show){el.style.display=show?"block":"none";}
    function fillForm(d){
      $("appareil").value=d.appareil||"";
      $("infos").value=d.infos||"";
      if(d.method==="geoloc"){setPill("oui");$("lat").value=d.latitude;$("lon").value=d.longitude;}
      else{setPill("non");$("lien").value=d.lien;}
    }

    // Pills
    $("pill-oui").onclick=()=>setPill("oui");
    $("pill-non").onclick=()=>setPill("non");
    function setPill(v){
      $("presentValue").value=v;
      $("pill-oui").classList.toggle("active",v==="oui");
      $("pill-non").classList.toggle("active",v==="non");
      if(v==="oui"){toggle($("mapWrap"),1);toggle($("coordsFields"),1);toggle($("lienField"),0);startLoc();}
      else{toggle($("mapWrap"),0);toggle($("coordsFields"),0);toggle($("lienField"),1);}
    }

    // Map
    function ensureMap(lat,lon){
      if(!map){
        map=L.map("map").setView([lat,lon],18);
        esri=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"Esri"}).addTo(map);
        osm=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"OSM"});
        marker=L.marker([lat,lon],{draggable:true}).addTo(map);
        marker.on("dragend",()=>{let p=marker.getLatLng();$("lat").value=p.lat.toFixed(6);$("lon").value=p.lng.toFixed(6);});
        $("btnToggle").onclick=()=>{sat=!sat;if(sat){map.removeLayer(osm);esri.addTo(map);$("btnToggle").textContent="üó∫Ô∏è Plan";}else{map.removeLayer(esri);osm.addTo(map);$("btnToggle").textContent="üõ∞Ô∏è Satellite";}};
        $("btnRecenter").onclick=startLoc;
      }
      marker.setLatLng([lat,lon]);map.setView([lat,lon],18);
      $("lat").value=lat.toFixed(6);$("lon").value=lon.toFixed(6);
    }
    function startLoc(){
      if(navigator.geolocation)navigator.geolocation.getCurrentPosition(p=>ensureMap(p.coords.latitude,p.coords.longitude));
    }

    // Validation helper
    function isValidLatLon(lat,lon){
      return !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lon));
    }
    function isValidUrl(str){
      return /^https?:\/\/.+/i.test(str);
    }

    // Form submit
    $("formAppareil").onsubmit=e=>{
      e.preventDefault();
      let item={demandeur:$("demandeur").value.trim(),poste:$("poste").value.trim(),appareil:$("appareil").value.trim(),infos:$("infos").value.trim()};
      if(!item.demandeur||!item.poste||!item.appareil){alert("Merci de remplir Demandeur, Poste et Appareil.");return;}

      if($("presentValue").value==="oui"){
        if(!isValidLatLon($("lat").value,$("lon").value)){alert("Merci d‚Äôindiquer des coordonn√©es valides.");return;}
        item.method="geoloc";item.latitude=$("lat").value;item.longitude=$("lon").value;
      }else if($("presentValue").value==="non"){
        if(!isValidUrl($("lien").value)){alert("Merci de coller un lien Google Maps valide.");return;}
        item.method="lien";item.lien=$("lien").value;
      }else{
        alert("Merci de choisir Oui ou Non pour la pr√©sence devant l‚Äôappareil.");return;
      }

      if(editIndex!==null){contributions[editIndex]=item;editIndex=null;}else{contributions.push(item);}
      updateRecap();$("ovrRecap").style.display="flex";
    };

    function updateRecap(){
      let ul=$("listRecap");ul.innerHTML="";
      contributions.forEach((c,i)=>{
        let li=document.createElement("li");
        li.innerHTML=`<strong>${c.appareil}</strong><div>${c.method==="geoloc"?c.latitude+","+c.longitude:c.lien}</div><div class="actions"><button class="edit">‚úèÔ∏è Modifier</button><button class="del">üóëÔ∏è Supprimer</button></div>`;
        li.querySelector(".edit").onclick=()=>{editIndex=i;fillForm(c);$("ovrRecap").style.display="none";};
        li.querySelector(".del").onclick=()=>{contributions.splice(i,1);updateRecap();};
        ul.appendChild(li);
      });
    }

    $("btnAddMore").onclick=()=>{$("ovrRecap").style.display="none";$("formAppareil").reset();};
    $("btnFinish").onclick=()=>{$("ovrRecap").style.display="none";$("ovrFinal").style.display="flex";};

    $("btnMail").onclick=()=>{
      let subj=`Ajout d‚Äôappareil ‚Äì Poste ${$("poste").value} (${contributions.length})`;
      let body=contributions.map((c,i)=>`#${i+1} ${c.appareil} ‚Äì ${c.method==="geoloc"?c.latitude+","+c.longitude:c.lien} ‚Äì ${c.infos||""}`).join("\n");
      location.href=`mailto:${DEST_EMAIL}?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
      $("ovrFinal").style.display="none";$("ovrThanks").style.display="flex";
    };

    $("btnServer").onclick=async()=>{
      try{
        await fetch(SERVER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({poste:$("poste").value,demandeur:$("demandeur").value,items:contributions})});
        $("ovrFinal").style.display="none";$("ovrThanks").style.display="flex";
      }catch{alert("Erreur serveur");}
    };
  </script>
</body>
</html>
