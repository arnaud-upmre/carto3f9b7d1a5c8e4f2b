<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>‚ûï Ajouter un appareil</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    :root {
      --bg:#f9f9f9; --fg:#222; --card:#fff; --accent:#0066cc; --border:#ccc;
    }
    @media (prefers-color-scheme: dark){
      :root {--bg:#0b0b0b;--fg:#eee;--card:#1a1a1a;--accent:#3399ff;--border:#444;}
    }
    body{font-family:Inter,system-ui;background:var(--bg);color:var(--fg);margin:0;padding:20px}
    form{max-width:600px;margin:auto;background:var(--card);padding:18px;border-radius:14px;
         box-shadow:0 3px 8px rgba(0,0,0,.2)}
    h2{text-align:center;margin-bottom:15px}
    label{display:block;margin-top:12px;font-weight:600}
    input,textarea{
      width:100%;padding:12px;font-size:16px;margin-top:6px;border:1px solid var(--border);
      border-radius:8px;background:var(--card);color:var(--fg);-webkit-appearance:none
    }
    textarea{resize:vertical;min-height:60px}
    #map{height:35vh;margin-top:12px;display:none;border-radius:10px;overflow:hidden}
    .pill-group{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
    .pill{flex:1;text-align:center;padding:12px;font-size:16px;border:1px solid var(--border);
      border-radius:20px;cursor:pointer;user-select:none;transition:.2s;min-width:44%}
    .pill.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn-row{display:flex;gap:12px;margin-top:18px;flex-wrap:wrap}
    .btn-row button{flex:1;padding:12px;font-size:16px;border:none;border-radius:10px;cursor:pointer}
    .btn-send{background:var(--accent);color:#fff}
    .btn-send:hover{opacity:0.9}
    .btn-back{background:#ccc;color:#222}
    .btn-back:hover{background:#bbb}
    #popup{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.6);z-index:1000
    }
    #popup div{
      background:var(--card);color:var(--fg);padding:20px 25px;border-radius:12px;
      box-shadow:0 4px 10px rgba(0,0,0,.4);text-align:center;font-size:16px;max-width:320px
    }
    #recap{max-width:600px;margin:20px auto;background:var(--card);padding:15px;
           border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.2);display:none}
    #recap h3{text-align:center;margin-top:0}
    .app-item{border-bottom:1px solid var(--border);padding:8px 0;font-size:15px}
    .app-item:last-child{border-bottom:none}
  </style>
</head>
<body>
  <h2>‚ûï Ajouter un appareil</h2>

  <form id="appareilForm">
    <label>Demandeur</label>
    <input type="text" name="demandeur" id="demandeur" required>

    <label>Poste (li√©)</label>
    <input type="text" name="poste" id="poste" value="Alleux SP" readonly>

    <label>Nom de l‚Äôappareil</label>
    <input type="text" name="appareil" id="appareil" placeholder="Ex : I7112" required>

    <label>√ätes-vous devant l‚Äôappareil ?</label>
    <div class="pill-group">
      <div class="pill" id="pill-oui" data-value="oui">Oui</div>
      <div class="pill" id="pill-non" data-value="non">Non</div>
    </div>
    <input type="hidden" name="present" id="presentValue">

    <div id="map"></div>

    <div id="coordsFields" style="display:none;">
      <label>Latitude</label>
      <input type="text" id="lat" name="latitude">
      <label>Longitude</label>
      <input type="text" id="lon" name="longitude">
    </div>

    <div id="lienField" style="display:none;">
      <label>Coller le lien Google Maps</label>
      <input type="url" name="lien" id="lien">
    </div>

    <label>Infos libres</label>
    <textarea name="infos" id="infos" placeholder="Notes utiles, acc√®s difficile, √©tat de l‚Äôappareil‚Ä¶"></textarea>

    <div class="btn-row">
      <button type="submit" class="btn-send">üì© Ajouter</button>
      <button type="button" class="btn-back" onclick="window.location.href='index.html'">‚¨ÖÔ∏è Retour √† l‚Äôaccueil</button>
    </div>
  </form>

  <div id="recap">
    <h3>üìã R√©capitulatif des appareils ajout√©s</h3>
    <div id="recap-list"></div>
    <div class="btn-row">
      <button type="button" class="btn-send" id="sendMail">üìß Envoyer par e-mail</button>
      <button type="button" class="btn-back" id="sendServer">‚òÅÔ∏è Envoyer au serveur</button>
    </div>
  </div>

  <div id="popup"><div id="popupMsg">Envoi en cours...</div></div>

  <script>
    const mapDiv = document.getElementById("map");
    const popup = document.getElementById("popup");
    const popupMsg = document.getElementById("popupMsg");
    const recap = document.getElementById("recap");
    const recapList = document.getElementById("recap-list");
    let map, marker;
    let appareils = [];

    function showPopup(msg){popupMsg.textContent = msg;popup.style.display="flex";}
    function hidePopup(){popup.style.display="none";}

    // pills
    const pills = document.querySelectorAll(".pill");
    pills.forEach(p=>{
      p.addEventListener("click", ()=>{
        pills.forEach(x=>x.classList.remove("active"));
        p.classList.add("active");
        document.getElementById("presentValue").value = p.dataset.value;
        if(p.dataset.value==="oui"){
          mapDiv.style.display="block";
          document.getElementById("coordsFields").style.display="block";
          document.getElementById("lienField").style.display="none";
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos=>{
              initMap(pos.coords.latitude, pos.coords.longitude);
            }, ()=>alert("Impossible d‚Äôobtenir votre position."), {enableHighAccuracy:true});
          }
        }else{
          mapDiv.style.display="none";
          document.getElementById("coordsFields").style.display="none";
          document.getElementById("lienField").style.display="block";
        }
      });
    });

    function initMap(lat, lon){
      document.getElementById("lat").value = lat.toFixed(6);
      document.getElementById("lon").value = lon.toFixed(6);
      if(!map){
        map = L.map("map").setView([lat, lon], 18);
        L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
          attribution: "Tiles ¬© Esri"
        }).addTo(map);
        marker = L.marker([lat, lon], {draggable:true}).addTo(map);
        marker.on("dragend", e=>{
          const pos = e.target.getLatLng();
          document.getElementById("lat").value = pos.lat.toFixed(6);
          document.getElementById("lon").value = pos.lng.toFixed(6);
        });
      }else{
        map.setView([lat, lon], 18);
        marker.setLatLng([lat, lon]);
      }
    }

    // form submit
    document.getElementById("appareilForm").addEventListener("submit", e=>{
      e.preventDefault();
      const demandeur = document.getElementById("demandeur").value.trim();
      const poste = document.getElementById("poste").value.trim();
      const appareil = document.getElementById("appareil").value.trim();
      const present = document.getElementById("presentValue").value;
      const lat = document.getElementById("lat").value.trim();
      const lon = document.getElementById("lon").value.trim();
      const lien = document.getElementById("lien").value.trim();
      const infos = document.getElementById("infos").value.trim();

      if(!appareil){alert("Veuillez saisir le nom de l‚Äôappareil");return;}

      let loc = "";
      let methode = "";
      if(present==="oui"){loc = lat+","+lon;methode="G√©olocalisation";}
      else if(lien){loc = lien;methode="Lien Google Maps";}
      else{alert("Veuillez fournir la localisation.");return;}

      appareils.push({demandeur, poste, appareil, loc, methode, infos});

      // clear only appareil & localisation fields for multi-ajout
      document.getElementById("appareil").value="";
      document.getElementById("lat").value="";
      document.getElementById("lon").value="";
      document.getElementById("lien").value="";
      document.getElementById("infos").value="";
      pills.forEach(x=>x.classList.remove("active"));
      document.getElementById("presentValue").value="";

      // ask to add more or finalize
      if(confirm("‚úÖ Appareil ajout√©. Voulez-vous en ajouter un autre ?")){
        return; // reste sur le formulaire
      } else {
        showRecap();
      }
    });

    function showRecap(){
      document.getElementById("appareilForm").style.display="none";
      recap.style.display="block";
      recapList.innerHTML="";
      appareils.forEach((a,i)=>{
        recapList.innerHTML+=`<div class="app-item">
        <b>Appareil ${i+1} :</b> ${a.appareil}<br>
        Localisation : ${a.loc}<br>
        M√©thode : ${a.methode}<br>
        Infos : ${a.infos||"-"}
        </div>`;
      });
    }

    // envoyer par email
    document.getElementById("sendMail").addEventListener("click", ()=>{
      if(appareils.length===0)return;
      const demandeur = appareils[0].demandeur;
      const poste = appareils[0].poste;
      let corps = `Demandeur : ${demandeur}\nPoste : ${poste}\nNombre d‚Äôappareils ajout√©s : ${appareils.length}\n\n`;
      appareils.forEach((a,i)=>{
        corps+=`‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nAppareil ${i+1} :\n‚Ä¢ Nom : ${a.appareil}\n‚Ä¢ Localisation : ${a.loc}\n‚Ä¢ M√©thode : ${a.methode}\n‚Ä¢ Infos : ${a.infos||"-"}\n`;
      });
      const subject = `Ajout d‚Äôappareil ‚Äì Poste ${poste} (${appareils.length})`;
      window.location.href=`mailto:arnaud.debaecker@sncf.fr?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(corps)}`;
    });

    // envoyer au serveur
    document.getElementById("sendServer").addEventListener("click", ()=>{
      showPopup("Envoi en cours...");
      // ‚ö†Ô∏è remplacer l‚ÄôURL par ton Apps Script
      fetch("TON_SCRIPT_URL", {
        method:"POST",
        body: JSON.stringify(appareils),
        headers:{"Content-Type":"application/json"}
      }).then(r=>r.json()).then(data=>{
        popupMsg.textContent="‚úÖ Merci, vos contributions ont √©t√© transmises.";
        setTimeout(()=>hidePopup(),3000);
      }).catch(err=>{
        popupMsg.textContent="‚ùå Erreur d‚Äôenvoi. R√©essayez.";
        setTimeout(()=>hidePopup(),3000);
      });
    });
  </script>
</body>
</html>
