<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mon Tableau Blanc â€“ Nono Maps</title>

<style>
/* --------------------------------------------------
   ðŸŸ¦ STYLES GÃ‰NÃ‰RAUX + DARK MODE
-------------------------------------------------- */
:root {
  --bg: #f5f6fa;
  --card: #ffffff;
  --text: #111;
  --pill-poste: #2563eb;
  --pill-sat: #facc15;
  --pill-hp: #dc2626;
  --border: #dcdcdc;
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f0f0f;
    --card: #1a1a1a;
    --text: #f8f8f8;
    --border: #333;
  }
}
body {
  margin: 0;
  padding: 0;
  background: var(--bg);
  font-family: system-ui, sans-serif;
  color: var(--text);
}

/* --------------------------------------------------
   ðŸŸ¦ EN-TÃŠTE + ONGLET + FILTRES
-------------------------------------------------- */
header {
  padding: 15px 20px;
  background: var(--card);
  position: sticky;
  top: 0;
  z-index: 20;
  border-bottom: 1px solid var(--border);
}

.tabs {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
.tab {
  padding: 8px 14px;
  background: var(--border);
  border-radius: 12px;
  cursor: pointer;
}
.tab.active {
  background: var(--pill-poste);
  color: white;
}

#searchBox {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-top: 15px;
}

.filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}
.filter-btn {
  padding: 6px 12px;
  background: var(--border);
  border-radius: 10px;
  cursor: pointer;
}
.filter-btn.active {
  background: var(--pill-poste);
  color: #fff;
}

/* --------------------------------------------------
   ðŸŸ¦ GRILLE DES CARTES
-------------------------------------------------- */
#cardsContainer {
  padding: 20px;
  display: grid;
  gap: 18px;
}
@media(min-width: 700px) {
  #cardsContainer { grid-template-columns: repeat(2,1fr); }
}
@media(min-width: 1100px) {
  #cardsContainer { grid-template-columns: repeat(3,1fr); }
}
@media(min-width: 1500px) {
  #cardsContainer { grid-template-columns: repeat(4,1fr); }
}

.card {
  background: var(--card);
  border-radius: 18px;
  padding: 18px;
  border: 1px solid var(--border);
  transition: transform .2s, box-shadow .2s;
}
.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 16px rgba(0,0,0,0.15);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-title {
  font-size: 20px;
  font-weight: 700;
}

.badge-type {
  background: var(--pill-poste);
  color: #fff;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
}

.section {
  border: 1px dashed var(--border);
  border-radius: 12px;
  padding: 12px;
  margin-top: 12px;
}

.section-title {
  font-size: 17px;
  font-weight: 600;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.pill-poste   { background: var(--pill-poste); color:white; padding:4px 10px; border-radius:12px; font-size:12px; }
.pill-sat     { background: var(--pill-sat); color:black; padding:4px 10px; border-radius:12px; font-size:12px; }
.pill-app     { background:#d1d5db; color:black; padding:6px 12px; border-radius:12px; display:inline-block; margin:4px; transition:.15s; }
.pill-app:hover { transform: scale(1.08); }

.pill-hp      { background: var(--pill-hp); color:white !important; }

.toggle-btn {
  cursor: pointer;
  font-size: 13px;
  opacity: .7;
  margin-top: 4px;
}

/* Animation survol appareils */
.pill-app { transition: transform .2s, background .2s; }
.pill-app:hover {
  transform: translateY(-2px) scale(1.05);
  background: #e2e3e4;
}
</style>
</head>

<body>

<header>
  <h2>Mon tableau blanc â€“ Nono Maps</h2>

  <div class="tabs">
    <div class="tab active" data-tab="patrimoine">Patrimoine</div>
    <div class="tab" data-tab="hp">Hors Patrimoine</div>
  </div>

  <input id="searchBox" placeholder="Rechercher un poste...">

  <div class="filters">
    <div class="filter-btn" data-filter="az">A â†’ Z</div>
    <div class="filter-btn" data-filter="za">Z â†’ A</div>
    <div class="filter-btn" data-filter="plus">+ appareils</div>
    <div class="filter-btn" data-filter="moins">â€“ appareils</div>
    <div class="filter-btn" data-filter="ligne">NumÃ©ro ligne</div>
    <div class="filter-btn" data-filter="gps">GPS</div>
  </div>

  <div id="globalCounters" style="margin-top:10px; font-size:14px; opacity:.8;"></div>
</header>


<div id="cardsContainer"></div>

<script>
/* --------------------------------------------------
   ðŸŸ§ CHARGEMENT DES JSON
-------------------------------------------------- */
const URL_POSTES = "https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/postes.json";
const URL_APP = "https://arnaud-upmre.github.io/carto3f9b7d1a5c8e4f2b/appareils.json";

let postes = [];
let appareils = [];
let currentTab = "patrimoine";
let currentFilter = null;
let searchTerm = "";

/* Distance GPS simple */
function dist(a,b) {
  const dx = a.poste_latitude - b.poste_latitude;
  const dy = a.poste_longitude - b.poste_longitude;
  return Math.sqrt(dx*dx+dy*dy);
}

/* Regroupe par nom */
function groupByPoste(list) {
  const m = {};
  for (const p of list) {
    if (!m[p.nom]) m[p.nom] = [];
    m[p.nom].push(p);
  }
  return m;
}

/* Appareils dâ€™un poste+SAT */
function getApps(nom, type, SAT) {
  return appareils.filter(a =>
    a.nom === nom &&
    a.type === type &&
    (SAT ? a.SAT === SAT : (!a.SAT || a.SAT === "")) &&
    (!a.hors_patrimoine || currentTab === "hp")
  );
}

/* --------------------------------------------------
   ðŸŸ§ CONSTRUCTION DES CARTES
-------------------------------------------------- */
function buildCards() {
  const cont = document.getElementById("cardsContainer");
  cont.innerHTML = "";

  const filteredPostes = postes.filter(p => {
    if (currentTab === "patrimoine") {
      if (p.special) return false;
      if (p.hors_patrimoine) return false;
      return true;
    }
    if (currentTab === "hp") {
      return p.hors_patrimoine === true;
    }
    return true;
  });

  const grouped = groupByPoste(filteredPostes);

  /* Tri selon filtre */
  let names = Object.keys(grouped);

  if (currentFilter === "az") names.sort();
  if (currentFilter === "za") names.sort().reverse();
  if (currentFilter === "plus") {
    names.sort((a,b)=> countApps(grouped[b]) - countApps(grouped[a]));
  }
  if (currentFilter === "moins") {
    names.sort((a,b)=> countApps(grouped[a]) - countApps(grouped[b]));
  }
  if (currentFilter === "gps") {
    names.sort((a,b)=> dist(grouped[a][0], grouped[b][0]) - dist(grouped[b][0], grouped[a][0]));
  }

  if (searchTerm.length > 0)
    names.sort((a,b)=> (a.toLowerCase().includes(searchTerm) ? -1 : 1));

  /* Affichage */
  for (const nom of names) {
    const blocPoste = grouped[nom];

    const card = document.createElement("div");
    card.className = "card";

    const p0 = blocPoste.find(x => !x.SAT || x.SAT==="");

    const isHP = (currentTab==="hp");

    let title = nom;
    if (isHP) title += ` (${nom})`;

    card.innerHTML = `
      <div class="card-header">
        <div class="card-title">${title}</div>
        <div>
          ${p0 && !isHP ? `<span class="badge-type">${p0.type}</span>` : ""}
        </div>
      </div>
    `;

    /* Poste principal */
    if (p0) {
      const apps = getApps(nom, p0.type, "");
      card.innerHTML += sectionHTML("Poste principal", apps, false);
    }

    /* SAT */
    for (const sat of blocPoste.filter(x=> x.SAT && x.SAT!=="" )) {
      const appsSAT = getApps(nom, sat.type, sat.SAT);
      card.innerHTML += sectionHTML(sat.SAT.toUpperCase(), appsSAT, true);
    }

    cont.appendChild(card);
  }

  updateCounters(filteredPostes, currentTab);
}

/* --------------------------------------------------
   ðŸŸ§ SECTION HTML
-------------------------------------------------- */
function sectionHTML(title, apps, isSAT) {
  return `
  <div class="section">
    <div class="section-title">
      <span class="${isSAT ? "pill-sat" : "pill-poste"}">${title}</span>
    </div>
    <div>
      ${apps.length===0 ? "<em>Aucun appareil trouvÃ©</em>" :
        apps.map(a=> `
          <span class="pill-app ${a.hors_patrimoine ? "pill-hp" : ""}">
            ${a.appareil}
          </span>`).join("")
      }
    </div>
  </div>
  `;
}

/* --------------------------------------------------
   ðŸŸ§ COMPTEURS GLOBALS
-------------------------------------------------- */
function countApps(list) {
  let n=0;
  for (const p of list) {
    const apps = appareils.filter(a=>
      a.nom===p.nom &&
      a.type===p.type &&
      ((!a.SAT && !p.SAT) || a.SAT===p.SAT) &&
      (!a.hors_patrimoine || currentTab==="hp")
    );
    n += apps.length;
  }
  return n;
}

function updateCounters(list) {
  const posts = list.length;
  const sats = list.filter(x=> x.SAT && x.SAT!=="").length;

  const appsCount = appareils.filter(a=>{
    if (currentTab==="patrimoine") return !a.hors_patrimoine;
    return a.hors_patrimoine===true;
  }).length;

  document.getElementById("globalCounters").innerHTML =
    `Postes : ${posts} Â· SAT : ${sats} Â· Appareils : ${appsCount}`;
}

/* --------------------------------------------------
   ðŸŸ§ INTERACTIONS
-------------------------------------------------- */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    currentTab = t.dataset.tab;
    buildCards();
  };
});

document.querySelectorAll(".filter-btn").forEach(f=>{
  f.onclick=()=>{
    document.querySelectorAll(".filter-btn").forEach(x=>x.classList.remove("active"));
    f.classList.add("active");
    currentFilter = f.dataset.filter;
    buildCards();
  };
});

document.getElementById("searchBox").oninput = e=>{
  searchTerm = e.target.value.toLowerCase().trim();
  buildCards();
};

/* --------------------------------------------------
   ðŸŸ§ DÃ‰MARRAGE
-------------------------------------------------- */
Promise.all([
  fetch(URL_POSTES).then(r=>r.json()),
  fetch(URL_APP).then(r=>r.json())
]).then(([p, a])=>{
  postes = p;
  appareils = a;
  buildCards();
});
</script>

</body>
</html>
