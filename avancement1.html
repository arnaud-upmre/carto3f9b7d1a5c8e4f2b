<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mon tableau blanc – Nono Maps</title>

<style>
:root {
  --bg:#f6f7fb; --card:#fff; --border:#d6d6d6; --text:#111;
  --pill-poste:#2563eb; --pill-sat:#eab308; --pill-hp:#dc2626;
}
@media(prefers-color-scheme:dark){
  :root { --bg:#0f0f0f; --card:#1a1a1a; --border:#333; --text:#fafafa; }
}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,sans-serif;}
header{background:var(--card);border-bottom:1px solid var(--border);padding:15px 20px;position:sticky;top:0;z-index:10;}
h2{margin:0 0 6px;font-size:20px;}
.tabs{display:flex;gap:10px;margin-top:5px;}
.tab{padding:7px 14px;border-radius:10px;background:var(--border);cursor:pointer;}
.tab.active{background:var(--pill-poste);color:#fff;}
#searchBox{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;margin-top:12px;}
.filters{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
.filter-btn{padding:5px 12px;border-radius:10px;background:var(--border);cursor:pointer;}
.filter-btn.active{background:var(--pill-poste);color:#fff;}
#globalCounters{margin-top:10px;font-size:13px;opacity:.8;}
#cardsContainer{padding:20px;display:grid;gap:18px;}
@media(min-width:700px){#cardsContainer{grid-template-columns:repeat(2,1fr);}}
@media(min-width:1100px){#cardsContainer{grid-template-columns:repeat(3,1fr);}}
@media(min-width:1500px){#cardsContainer{grid-template-columns:repeat(4,1fr);}}

/* CARDS */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;transition:.2s;}
.card:hover{transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,.15);}
.card-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
.card-title{font-size:18px;font-weight:700;}
.badge-type{background:var(--pill-poste);color:#fff;padding:4px 8px;border-radius:8px;font-size:12px;}
.card-content{margin-top:12px;display:block;}
.card.collapsed .card-content{display:none;}
.toggle-btn{font-size:12px;opacity:.6;margin-left:10px;}

.section{border:1px dashed var(--border);border-radius:12px;padding:10px;margin-top:10px;}
.section-title{font-size:14px;font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:6px;}
.pill-poste,.pill-sat{padding:3px 10px;border-radius:12px;font-size:12px;color:#fff;}
.pill-poste{background:var(--pill-poste);}
.pill-sat{background:var(--pill-sat);color:#111;}
.pill-app{display:inline-block;padding:6px 12px;border-radius:12px;background:#d1d5db;margin:3px;transition:.2s;}
.pill-app:hover{transform:scale(1.08);}
.pill-hp{background:var(--pill-hp)!important;color:#fff!important;}
em{font-size:13px;opacity:.7;}
</style>
</head>
<body>

<header>
  <h2>Mon tableau blanc – Nono Maps</h2>
  <div class="tabs">
    <div class="tab active" data-tab="patrimoine">Patrimoine</div>
    <div class="tab" data-tab="hp">Hors Patrimoine</div>
  </div>
  <input id="searchBox" placeholder="Rechercher un poste...">
  <div class="filters">
    <div class="filter-btn" data-filter="az">A → Z</div>
    <div class="filter-btn" data-filter="za">Z → A</div>
    <div class="filter-btn" data-filter="plus">+ appareils</div>
    <div class="filter-btn" data-filter="moins">– appareils</div>
    <div class="filter-btn" data-filter="gps">GPS</div>
  </div>
  <div id="globalCounters"></div>
</header>

<div id="cardsContainer"></div>

<script>
const URL_POSTES="postes.json";
const URL_APP="appareils.json";

let postes=[], appareils=[];
let currentTab="patrimoine";
let currentFilter=null;
let searchTerm="";

/* DISTANCE */
function dist(a,b){
  const dx=(a.latitude||0)-(b.latitude||0),
        dy=(a.longitude||0)-(b.longitude||0);
  return Math.sqrt(dx*dx+dy*dy);
}

/* GROUP BY poste */
function groupByPoste(list){
  const m={};
  for(const p of list){
    if(!m[p.nom]) m[p.nom]=[];
    m[p.nom].push(p);
  }
  return m;
}

/* GET APPS – VERSION FINALE CORRECTE */
function getApps(nom){
  return appareils.filter(a =>
    a.nom===nom &&
    (currentTab==="hp" ? a.hors_patrimoine===true : a.hors_patrimoine!==true)
  );
}

/* COUNT APPS */
function countAppsNom(nom){
  return appareils.filter(a =>
    a.nom===nom &&
    (currentTab==="hp"?a.hors_patrimoine===true:a.hors_patrimoine!==true)
  ).length;
}

/* BUILD */
function buildCards(){
  const cont=document.getElementById("cardsContainer");
  cont.innerHTML="";

  const filteredPostes=postes.filter(p=>{
    if(currentTab==="patrimoine") return !p.special && !p.hors_patrimoine;
    if(currentTab==="hp"){
      const hasHP=appareils.some(a=>a.nom===p.nom && a.hors_patrimoine);
      return p.hors_patrimoine===true || hasHP;
    }
    return true;
  });

  const grouped=groupByPoste(filteredPostes);
  let names=Object.keys(grouped);

  /* tri */
  if(currentFilter==="az") names.sort();
  if(currentFilter==="za") names.sort().reverse();
  if(currentFilter==="plus") names.sort((a,b)=>countAppsNom(b)-countAppsNom(a));
  if(currentFilter==="moins") names.sort((a,b)=>countAppsNom(a)-countAppsNom(b));
  if(currentFilter==="gps") names.sort((a,b)=>dist(grouped[a][0],grouped[b][0]));

  /* search */
  if(searchTerm) names=names.sort((a,b)=>a.toLowerCase().includes(searchTerm)?-1:1);

  /* BUILD EACH */
  for(const nom of names){
    const bloc=grouped[nom];
    const card=document.createElement("div");
    card.className="card";

    const isHP = currentTab==="hp";
    const ficheHP = bloc.some(x=>x.hors_patrimoine===true);

    let title = ficheHP ? nom+" (Ville)" : nom;
    let typeShow = ficheHP ? "" : (bloc[0].type || "");

    const apps = getApps(nom);

    card.innerHTML=`
      <div class="card-header">
        <div class="card-title">${title}</div>
        <div>${typeShow?`<span class="badge-type">${typeShow}</span>`:""}</div>
        <span class="toggle-btn">(plier / déplier)</span>
      </div>
      <div class="card-content"></div>
    `;

    const content = card.querySelector(".card-content");

    /* FICHE HP : ON AFFICHE DIRECTEMENT LES APPAREILS HP */
    if(ficheHP){
      if(apps.length===0){
        content.innerHTML+=`<div class="section"><div><em>Aucun appareil trouvé</em></div></div>`;
      } else {
        content.innerHTML+=`
          <div class="section">
            <div class="section-title"><span class="pill-hp">Appareils</span></div>
            <div>${apps.map(a=>`<span class="pill-app pill-hp">${a.appareil}</span>`).join("")}</div>
          </div>`;
      }
    }

    /* PATRIMOINE : poste + SAT */
    else{
      /* poste principal */
      content.innerHTML+=`
        <div class="section">
          <div class="section-title"><span class="pill-poste">Poste principal</span></div>
          <div>${apps.length===0?`<em>Aucun appareil trouvé</em>`:apps.map(a=>`<span class="pill-app">${a.appareil}</span>`).join("")}</div>
        </div>`;
    }

    /* TOGGLE */
    card.querySelector(".card-header").onclick=()=>card.classList.toggle("collapsed");

    cont.appendChild(card);
  }

  updateCounters(filteredPostes);
}

/* COUNTERS */
function updateCounters(list){
  const posts=list.length;
  const sats=list.filter(x=>x.SAT && x.SAT!=="").length;
  const appsCount=appareils.filter(a=>currentTab==="hp"?a.hors_patrimoine===true:a.hors_patrimoine!==true).length;

  document.getElementById("globalCounters").innerText=
    `Postes : ${posts} · SAT : ${sats} · Appareils : ${appsCount}`;
}

/* EVENTS */
document.querySelectorAll(".tab").forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    currentTab=t.dataset.tab;
    buildCards();
  };
});

document.querySelectorAll(".filter-btn").forEach(f=>{
  f.onclick=()=>{
    document.querySelectorAll(".filter-btn").forEach(x=>x.classList.remove("active"));
    f.classList.add("active");
    currentFilter=f.dataset.filter;
    buildCards();
  };
});

document.getElementById("searchBox").oninput=e=>{
  searchTerm=e.target.value.toLowerCase().trim();
  buildCards();
};

/* INIT */
Promise.all([
  fetch(URL_POSTES).then(r=>r.json()),
  fetch(URL_APP).then(r=>r.json())
]).then(([p,a])=>{
  postes=p;
  appareils=a;
  buildCards();
});
</script>
</body>
</html>
